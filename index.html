<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=0">
  <title>Finapsis - Ultimate Suite</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    // --- ORTAK GLOBAL VERÄ°LER & SABÄ°TLER ---
    // Åžirket veri yapÄ±sÄ± Ã¶rn: { ticker, name, group: "bist"|"sp"|"doviz"|"emtia"|"kripto", logourl, slug, unit }
// --- CLOUDFLARE DATA URL ---
    window.COMPANIES_DATA_URL = "https://finapsis-data.nameless-dream-696b.workers.dev/static/companies.min.v1.json";

    // --- METRÄ°KLER Ä°Ã‡Ä°N AYARLAR ---
    window.FIN_DATA_BASE = "https://finapsis-data.nameless-dream-696b.workers.dev";    
    // KÄ±sa kod (JSON) -> Uzun isim (Uygulama) HaritasÄ±
    // Not: Hesaplananlar (mc, pe, pb vs.) burada yok, onlar kod iÃ§inde Ã¼retilecek.
    // KÄ±sa kod (JSON) -> Uzun isim (Uygulama) HaritasÄ±
const METRIC_KEY_MAP = {
    // Ham Veriler (WANT Listesinin TERSÄ°)
    "sh": "Hisse Adedi", // Veya "Total Common Shares Outstanding"
    "ev": "Firma DeÄŸeri",
    "evs": "Gelir Ã‡arpanÄ±",
    "eve": "FVÃ–K Ã‡arpanÄ±",
    "cr": "Cari Oran",
    "gm": "BrÃ¼t Kar MarjÄ±",
    "om": "Faaliyet KÃ¢r MarjÄ±",
    "qr": "Asit Test OranÄ±",
    "de": "BorÃ§/Ã–z Kaynak",
    "itr": "Stok Devir HÄ±zÄ±",
    "itd": "Stok SÃ¼resi",
    "rtr": "Alacak Devir HÄ±zÄ±",
    "roic": "ROIC",
    "roa": "ROA",
    "roe": "ROE",
    "ptr": "BorÃ§ Devir HÄ±zÄ±",
    "rds": "Alacak SÃ¼resi",
    "pds": "BorÃ§ SÃ¼resi",
    "ccc": "Nakit DÃ¶ngÃ¼sÃ¼",
    "fcf": "Serbest Nakit AkÄ±ÅŸÄ±",
    "ni": "DÃ¶nem KarÄ± (ZararÄ±)",
    "wacc": "WACC",
    "ta": "Toplam VarlÄ±klar",
    "rev": "SatÄ±ÅŸ Gelirleri",
    "rg3y": "SatÄ±ÅŸ BÃ¼yÃ¼mesi 3Y",
    "rgttm": "SatÄ±ÅŸ BÃ¼yÃ¼mesi TTM",
    "opgttm": "Faaliyet Kar BÃ¼yÃ¼mesi TTM",
    "capex": "VarlÄ±k AlÄ±mlarÄ±",
    "rgnet": "SatÄ±ÅŸ BÃ¼yÃ¼mesi Net",
    "cash": "Nakit ve Nakit Benzerleri",
    "eq": "Ana OrtaklÄ±ÄŸa Ait Ã–zkaynaklar",
    "beta": "Beta"
};

    // Global Veri YÃ¼kleyici (Async)
    // Global Veri YÃ¼kleyici (Åžirketler + Fiyatlar)
    async function loadFinapsisData() {
        // Ä°kisini paralel baÅŸlat (biri diÄŸerini beklemesin)
        const pCompanies = fetch(window.COMPANIES_DATA_URL);
        
        // FiyatlarÄ± artÄ±k R2'dan Ã§ekiyoruz (Ã‡OK HIZLI)
// FiyatlarÄ± ve GÃ¶stergeleri paralel Ã§ekiyoruz
        const pPrices = fetch(`${window.FIN_DATA_BASE}/price/detail.v1.json`);
        const pIndMap = fetch(`${window.FIN_DATA_BASE}/indicators/indicatorsmap.json`);
        const pIndSum = fetch(`${window.FIN_DATA_BASE}/indicators/summary.v1.json`);
        

        try {
            const [resComp, resPrice, resIndMap, resIndSum] = await Promise.all([
  pCompanies, pPrices, pIndMap, pIndSum
]);

// GÃ¶sterge Verilerini Global DeÄŸiÅŸkenlere Ata
if (resIndMap.ok) window.__INDICATORS_MAP = await resIndMap.json();
if (resIndSum.ok) {
  const s = await resIndSum.json();

  // âœ… Geriye dÃ¶nÃ¼k uyum:
  // - eski format: Array
  // - yeni format: { asOf, items }
  if (Array.isArray(s)) {
    window.__INDICATORS_SUMMARY = { asOf: null, items: s };
  } else {
    window.__INDICATORS_SUMMARY = {
      asOf: s?.asOf || null,
      items: Array.isArray(s?.items) ? s.items : []
    };
  }
}


// ArtÄ±k last yok (geriye dÃ¶nÃ¼k kÄ±rÄ±lmasÄ±n diye boÅŸ bÄ±rakÄ±yoruz)
window.__INDICATORS_LAST = {};


            if (resComp.ok) {
                const data = await resComp.json();
                window.companies = Array.isArray(data) ? data : (data.companies || []);
            } else {
                window.companies = [];
            }

            if (resPrice.ok) {
                const rawDetail = await resPrice.json();
                
                // Yeni format: [{ asOf: "...", data: [...] }]
                // Veri array iÃ§inde ilk elemanda geliyor
                const detailList =
  (rawDetail && Array.isArray(rawDetail.data)) ? rawDetail.data :
  (Array.isArray(rawDetail) && rawDetail[0]?.data && Array.isArray(rawDetail[0].data)) ? rawDetail[0].data :
  (Array.isArray(rawDetail)) ? rawDetail :
  [];


                window.currentPriceData = {};
                window.prevPriceData = {};

                // Map'i doldur ve window.__FIN_MAP iÃ§ine de fiyatÄ± enjekte et (SÄ±ralama Ã§alÄ±ÅŸsÄ±n diye)
                window.__FIN_MAP = window.__FIN_MAP || {};

                detailList.forEach(item => {
                    if (item.ticker) {
                        // 1. Ticker'Ä± temizle ve bÃ¼yÃ¼k harf yap (EÅŸleÅŸme Garantisi)
                        const t = String(item.ticker).trim().toUpperCase();
                        const p = Number(item.price);
                        const prev = Number(item.prev);

                        // 2. Global FiyatlarÄ± GÃ¼ncelle
                        window.currentPriceData[t] = p;
                        window.prevPriceData[t] = prev;

                        // 3. Map Verisini GÃ¼ncelle
                        if(!window.__FIN_MAP[t]) window.__FIN_MAP[t] = {};
                        const target = window.__FIN_MAP[t];
                        
                        target["price"] = p;
                        target["prev"] = prev;

                        // 4. KRÄ°TÄ°K: PÄ°YASA DEÄžERÄ° HESAPLAMA (Fix)
                        // EÄŸer metrik verileri (Hisse Adedi) fiyattan Ã¶nce indiyse, fiyat gelince MC'yi hemen hesapla.
                        // Metriklerde hisse adedi 'sh', 'Hisse Adedi' veya 'Shares Outstanding' olarak gelebilir.
                        const shares = target["Hisse Adedi"] || target["sh"] || target["Total Common Shares Outstanding"];
                        
                        if (p > 0 && shares > 0) {
                            let finalShares = shares;
                            // ADR kontrolÃ¼ (varsa)
                            if (window.__ADR_CACHE && window.__ADR_CACHE[t]) {
                                finalShares = shares / window.__ADR_CACHE[t];
                            }
                            target["Piyasa DeÄŸeri"] = p * finalShares;
                        }
                    }
                });
                
                console.log(`[DATA] ${detailList.length} detaylÄ± fiyat yÃ¼klendi.`);
                
                // 5. ZORLA YENÄ°LEME: Fiyatlar yÃ¼klendi, tabloyu hemen gÃ¼ncelle!
                if (typeof window.renderCompanyList === "function") {
                    window.renderCompanyList();
                }
            }

        } catch (e) {
            console.error("[DATA] YÃ¼kleme hatasÄ±:", e);
            // Hata olsa bile uygulama aÃ§Ä±lsÄ±n
            window.companies = window.companies || [];
            window.currentPriceData = window.currentPriceData || {};
        }
    }

window.__CALENDAR_LIST_RAW = window.__CALENDAR_LIST_RAW || `[
  { "id": "101", "name": "ABD TarÄ±m DÄ±ÅŸÄ± Ä°stihdam", "country_code": "us", "date_full": "07 Åžubat 2026 - 16:30", "timestamp": "2026-02-07T16:30:00", "impact": 3, "expected": "185K", "actual": "", "prev": "216K" },
  { "id": "102", "name": "TCMB Faiz KararÄ±", "country_code": "tr", "date_full": "20 Åžubat 2026 - 14:00", "timestamp": "2026-02-20T14:00:00", "impact": 3, "expected": "%45", "actual": "", "prev": "%42.5" },
  { "id": "103", "name": "Euro BÃ¶lgesi TÃœFE (YÄ±llÄ±k)", "country_code": "eu", "date_full": "15 Åžubat 2026 - 13:00", "timestamp": "2026-02-15T13:00:00", "impact": 2, "expected": "%2.8", "actual": "", "prev": "%2.9" }
]`
window.__INDICATORS_RAW = window.__INDICATORS_RAW || ``;

    // Fiyat verileri: { TICKER: price } formatÄ±nda
    window.currentPriceData = window.currentPriceData || {};
    window.prevPriceData = window.prevPriceData || {};

    // Portfolio API / Auth sabitleri
    window.FINAPSIS_CONFIG = Object.assign({
      BUBBLE_USER_ID: "",
      BUBBLE_USER_NAME: "",
      BUBBLE_API_TOKEN: "",
      API_BASE: "https://eap-35848.bubbleapps.io/api/1.1/wf",
      GOOGLE_CLIENT_ID: "",
      REDIRECT_URI: "https://finapsis.co/portfolio/",
      MIDAS_PROXY_URL: "https://unitplan.app.n8n.cloud/webhook/31d8bf64-8c6d-4573-9c4f-e947db8d7041",
      PRICE_PROXY_URL: "https://script.google.com/macros/s/AKfycbwRt12DlJcWkIE5Vn3Cg8LLyDAhf7PYPeuzH9Do3FYfoMEukwhhDHav7e7IkLZna4cfIA/exec"
    },
    (window.FINAPSIS_CONFIG || {})
  );
    window.FINAPSIS_CONFIG.PRICE_PROXY_URL = "https://script.google.com/macros/s/AKfycbwRt12DlJcWkIE5Vn3Cg8LLyDAhf7PYPeuzH9Do3FYfoMEukwhhDHav7e7IkLZna4cfIA/exec";

// ====== STABLE DATA LOADER (RESTORE + DECODE) ======

function finDecodeHtmlEntities(s){
  if (typeof s !== "string") return "";
  if (!s.includes("&")) return s;
  const ta = document.createElement("textarea");
  ta.innerHTML = s;
  return ta.value;
}

function finGetRawJson(raw, fallback="[]"){
  return finDecodeHtmlEntities(String(raw ?? fallback)).trim();
}

function finEnsureCompanies(){
  // ArtÄ±k veri asenkron yÃ¼kleniyor. 
  // EÄŸer veri henÃ¼z gelmediyse boÅŸ dizi dÃ¶ndÃ¼rÃ¼r, uygulama patlamaz.
  if (!window.companies) window.companies = [];
}
// âœ… YENÄ°: GÃ¶stergeler verisini hazÄ±rla
function finEnsureIndicators(){
  if (Array.isArray(window.indicators) && window.indicators.length) return;
  try {
    // Bubble HTML entity decode + JSON parse
    window.indicators = JSON.parse(finGetRawJson(window.__INDICATORS_RAW, "[]"));
  } catch(e){
    console.error("indicators JSON.parse failed", e);
    window.indicators = [];
  }
}

function finEnsureBenchmarks(){
  if (Array.isArray(window.benchmarks) && window.benchmarks.length) return;
  try {
    window.benchmarks = JSON.parse(finGetRawJson(window.__BENCHMARKS_RAW, "[]"));
  } catch(e){
    console.error("benchmarks JSON.parse failed", e);
    window.benchmarks = [];
  }
}



// Companies List iÃ§in hÄ±zlÄ± lookup map (ticker -> {type:value})
window.__FIN_MAP = window.__FIN_MAP || Object.create(null);

let __mapGroup = "";



// --- YENÄ° MAP BUILDER (DRS.JSON OTO-HESAPLAMA) ---
let __loadingMetrics = false;
window.__ADR_CACHE = null; // ADR verisini hafÄ±zada tutmak iÃ§in

// âœ… Map yÃ¼kleme sÄ±rasÄ±nda gelen talepleri sÄ±raya al
window.__FIN_METRICS_WAITERS = window.__FIN_METRICS_WAITERS || [];

// âœ… OPTÄ°MÄ°ZE EDÄ°LMÄ°Åž MAP BUILDER (DOÄžRU SAYFA SAYISI & PARALEL FETCH)
async function finBuildMapForActiveGroup(done) {
    // KuyruÄŸa ekle
    if (typeof done === "function") window.__FIN_METRICS_WAITERS.push(done);
    
    // Zaten Ã§alÄ±ÅŸÄ±yorsa tekrar baÅŸlatma
    if (__loadingMetrics) return; 
    __loadingMetrics = true;

    const g = String(window.activeGroup || "bist");

    // 1. Map'i hazÄ±rla
    window.__FIN_MAP = window.__FIN_MAP || {};
    
    // Aktif gruptaki tickerlarÄ± performans iÃ§in set'e al
    const activeTickers = new Set(
        (window.companies || [])
        .filter(c => {
            if (c.group === g) return true;
            if ((g === 'nyse' || g === 'nasdaq') && c.group === 'sp') return true;
            return false;
        })
        .map(c => String(c.ticker).trim().toUpperCase())
    );

    try {
        console.time("VeriIndirme");

        // A. ADR Verisini Ã‡ek (Cache yoksa)
        if (!window.__ADR_CACHE) {
            try {
                const adrRes = await fetch(`${window.FIN_DATA_BASE}/static/drs.json`);
                if (adrRes.ok) {
                    const rawAdr = await adrRes.json();
                    window.__ADR_CACHE = {};
                    for (const [tick, ratioStr] of Object.entries(rawAdr)) {
                        const parts = ratioStr.split(':');
                        if (parts.length === 2) window.__ADR_CACHE[tick] = parseFloat(parts[1]) / parseFloat(parts[0]);
                    }
                }
            } catch (e) { window.__ADR_CACHE = {}; }
        }

        // ---------------------------------------------------------
        // B. SAYFA SAYISINI Ã–ÄžREN (DÃœZELTÄ°LDÄ°: .page OKUNUYOR)
        // ---------------------------------------------------------
        let totalPages = 1;
        try {
            const stateRes = await fetch(`${window.FIN_DATA_BASE}/__state/metrics_v1.json?t=${Date.now()}`);
            if (stateRes.ok) {
                const stateData = await stateRes.json();
                // âœ… DÃœZELTME BURADA: Senin JSON yapÄ±n "page": 32 dÃ¶ndÃ¼rÃ¼yor.
                // 32 demek 0'dan 31'e kadar dosya var demek.
                if (stateData.page) {
                    totalPages = stateData.page; 
                }
            }
        } catch (e) { 
            console.warn("State okunamadÄ±, varsayÄ±lan 1."); 
        }

        console.log(`[METRICS] Toplam ${totalPages} sayfa paralel indirilecek.`);

        // ---------------------------------------------------------
        // ðŸš€ PARALLEL FETCH (TURBO MODE)
        // 32 dosyanÄ±n hepsine aynÄ± anda istek atÄ±yoruz.
        // ---------------------------------------------------------
        const fetchPromises = [];
        for (let i = 0; i < totalPages; i++) {
            const pageId = String(i).padStart(3, '0');
            const pageUrl = `${window.FIN_DATA_BASE}/metrics/page/${pageId}.v1.json`;
            
            fetchPromises.push(
                fetch(pageUrl)
                    .then(res => res.ok ? res.json() : [])
                    .catch(() => []) // Hata olursa zinciri kÄ±rma
            );
        }

        // TÃ¼m indirmelerin bitmesini bekle
        const allPagesData = await Promise.all(fetchPromises);
        
        console.timeEnd("VeriIndirme");

        // ---------------------------------------------------------
        // VERÄ°YÄ° Ä°ÅžLEME (Senkron)
        // ---------------------------------------------------------
        allPagesData.flat().forEach(item => {
            if (!item || !item.t) return;

            const rawTicker = item.t;
            const ticker = String(rawTicker).trim().toUpperCase();

            // Sadece seÃ§ili borsadaki hisseleri hafÄ±zaya al
            if (!activeTickers.has(ticker)) return;

            if (!window.__FIN_MAP[ticker]) window.__FIN_MAP[ticker] = {};
            const target = window.__FIN_MAP[ticker];
            const vals = item.v || {};

            // 1. Metrikleri EÅŸle
            for (const [shortKey, val] of Object.entries(vals)) {
                if (val === null) continue;
                const longKey = METRIC_KEY_MAP[shortKey];
                if (longKey) target[longKey] = val;
            }

            // 2. Kritik Hesaplamalar (Piyasa DeÄŸeri, F/K vb.)
            const price = (window.currentPriceData && window.currentPriceData[ticker]) 
                        ? Number(window.currentPriceData[ticker]) : 0;
            
            let shares = vals.sh;
            if (shares && window.__ADR_CACHE && window.__ADR_CACHE[ticker]) {
                shares = shares / window.__ADR_CACHE[ticker];
            }

            if (price > 0 && shares) {
                const mc = price * shares;
                target["Piyasa DeÄŸeri"] = mc; // âœ… SÄ±ralama iÃ§in gerekli

                if (vals.ni) target["F/K"] = mc / vals.ni;
                if (vals.rev) target["Fiyat/SatÄ±ÅŸlar"] = mc / vals.rev;
                
                if (vals.eq && vals.eq > 0) {
                    target["PD/DD"] = mc / vals.eq;
                } else if (vals.ta && vals.de !== undefined) {
                    const equity = vals.ta / (1 + vals.de);
                    if (equity > 0) target["PD/DD"] = mc / equity;
                }
            }
        });

    } catch (e) {
        console.error("[METRICS] Kritik Hata:", e);
    } finally {
        __loadingMetrics = false;
        // Ä°ndirme bitti, bekleyen Ã§izim iÅŸlemlerini (render) baÅŸlat
        const q = (window.__FIN_METRICS_WAITERS || []).splice(0);
        q.forEach(fn => { try { fn(); } catch (e) {} });
    }
}
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

  <style>
    /* --- GENEL ORTAK AYARLAR --- */
    :root {
      --finapsis-bg: #000000;
      --finapsis-card: rgba(255,255,255,0.03);
      --finapsis-neon: #c2f50e; 
      --finapsis-red: #ff4d4d;
      --text-main: #ffffff;
      --text-muted: rgba(255,255,255,0.5);
      --border: rgba(255,255,255,0.1);
    }

    * { box-sizing: border-box; }

    body {
      font-family: 'Inter', sans-serif;
      background: #000;
      color: var(--text-main);
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    /* --- ANA TAB NAVÄ°GASYONU (Screener vs List) --- */
    .app-tabs {
        display: flex;
        gap: 2px;
        background: #050505;
        border-bottom: 1px solid var(--border);
        padding: 0 20px;
        flex-shrink: 0;
        height: 45px;
        align-items: flex-end;
        overflow-x: auto;
overflow-y: hidden;
-webkit-overflow-scrolling: touch;
scrollbar-width: none;

    }
    .app-tabs::-webkit-scrollbar { display: none; }


    nav.app-tabs .tab-btn {
        padding: 8px 20px;
        background: rgba(255,255,255,0.02);
        border: 1px solid transparent;
        border-bottom: none;
        color: var(--text-muted);
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        cursor: pointer;
        border-radius: 8px 8px 0 0;
        transition: all 0.2s;
        letter-spacing: 0.5px;
        flex: 0 0 auto;

    }

    nav.app-tabs .tab-btn:hover { background: rgba(255,255,255,0.05); color: #fff; }

    nav.app-tabs .tab-btn.active {
        background: rgba(194, 245, 14, 0.05);
        color: var(--finapsis-neon);
        border-color: rgba(194, 245, 14, 0.2);
        border-bottom: 1px solid #000;
        margin-bottom: -1px;
        z-index: 10;
    }

    /* --- ALT TAB NAVÄ°GASYONU (BIST vs SP) --- */
    .sub-tabs-container {
        display: flex;
        justify-content: center;
        background: #000;
        padding: 10px 0;
        border-bottom: 1px solid var(--border);
        flex-shrink: 0;
    }
    
    .sub-tabs {
        display: flex;
        background: rgba(255,255,255,0.05);
        border-radius: 6px;
        padding: 3px;
        gap: 2px;
    }

    .sub-tab-btn {
        padding: 4px 24px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 700;
        color: rgba(255,255,255,0.4);
        background: transparent;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
    }

    .sub-tab-btn:hover { color: #fff; }

    .sub-tab-btn.active {
        background: var(--finapsis-neon);
        color: #000;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    /* GÃ¶rÃ¼nÃ¼m Konteynerleri */
    .view-section {
        flex: 1;
        overflow: hidden;
        position: relative;
        display: none; 
    }
    .view-section.active {
        display: flex; 
        flex-direction: column;
    }

    /* =========================================
       SCREENER CSS
       ========================================= */
    #view-screener {
        padding: 10px 20px 20px 20px;
        background: linear-gradient(to bottom, #050505, #000000);
    }

    #view-screener .finapsis-master {
      width: 100%;
      max-width: 1600px;
      height: 100%; 
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin: 0 auto;
    }

    #view-screener .header-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    #view-screener .header-title h1 { margin: 0; font-size: 20px; font-weight: 700; text-transform: uppercase; letter-spacing: -0.5px; color: #e5e5e5; }
    #view-screener .header-title span { color: var(--finapsis-neon); }
    #view-screener .header-subtitle { font-size: 11px; font-weight: 500; color: var(--text-muted); margin-top: 2px; text-transform: uppercase; letter-spacing: 0.5px; }

    #view-screener .controls-wrapper { display: flex; gap: 12px; align-items: center; }
    #view-screener .control-pill {
        padding: 5px 12px; border-radius: 999px; border: 1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.02);
        font-size: 10px; font-weight: 600; letter-spacing: 0.5px; text-transform: uppercase; color: rgba(255,255,255,0.5);
        cursor: pointer; transition: background 0.2s, color 0.2s; user-select: none;
    }
    #view-screener .control-pill:hover { border-color: rgba(255,255,255,0.2); color: #fff; }
    #view-screener .control-pill.active { border-color: var(--finapsis-neon); color: var(--finapsis-neon); background: rgba(194, 245, 14, 0.04); }
    #view-screener .divider-v { width: 1px; height: 16px; background: var(--border); }

    #view-screener .main-grid { display: grid; grid-template-columns: 300px 1fr; gap: 16px; flex: 1; overflow: hidden; }
    #view-screener .glass-panel { background: var(--finapsis-card); border: 1px solid var(--border); border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; }
    #view-screener .panel-header { padding: 12px; border-bottom: 1px solid var(--border); background: rgba(255,255,255,0.01); }
    
    #view-screener .search-box {
        background: rgba(0,0,0,0.2); border: 1px solid var(--border); border-radius: 6px; padding: 8px 10px; display: flex; align-items: center; gap: 8px; color: var(--text-muted);
    }
    #view-screener .search-box input { background: transparent; border: none; outline: none; color: #fff; font-size: 11px; width: 100%; font-family: 'Inter'; font-weight: 500; text-transform: uppercase; }

    #view-screener .metric-list { padding: 12px; overflow-y: auto; display: flex; flex-direction: column; gap: 6px; }
    #view-screener .metric-item {
        background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05); border-radius: 8px; padding: 8px 10px; display: flex; align-items: center; gap: 10px; cursor: grab; transition: border-color 0.1s; user-select: none;
    }
    #view-screener .metric-item:hover { border-color: rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); }
    #view-screener .metric-item:active { cursor: grabbing; }
    #view-screener .metric-icon { width: 24px; height: 24px; border-radius: 4px; background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; font-size: 10px; }

    #view-screener .content-area { display: flex; flex-direction: column; gap: 16px; overflow: hidden; }
    #view-screener .drop-zone-container {
        background: var(--finapsis-card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; min-height: 140px; display: flex; flex-direction: column; flex-shrink: 0;
    }
    #view-screener .drop-zone-target {
        flex: 1; border: 1px dashed rgba(255,255,255,0.15); border-radius: 8px; background: rgba(0,0,0,0.1); display: flex; flex-wrap: wrap; align-items: flex-start; align-content: flex-start; padding: 10px; gap: 8px; overflow-y: auto;
    }
    #view-screener .drop-zone-target.drag-over { border-color: var(--finapsis-neon); background: rgba(194, 245, 14, 0.02); }
    #view-screener .active-metric-tag {
        background: rgba(194, 245, 14, 0.08); border: 1px solid rgba(194, 245, 14, 0.2); color: var(--finapsis-neon); border-radius: 6px; padding: 6px 10px; font-size: 11px; font-weight: 600; display: flex; align-items: center; gap: 8px; animation: fadeIn 0.3s ease;
    }
    #view-screener .remove-btn { cursor: pointer; opacity: 0.5; }
    #view-screener .remove-btn:hover { opacity: 1; color: #fff; }

    #view-screener .table-panel {
        background: var(--finapsis-card); border: 1px solid var(--border); border-radius: 12px; flex: 1; overflow: hidden; display: flex; flex-direction: column;
    }
    #view-screener .table-scroll { flex: 1; overflow-y: auto; overflow-x: hidden; }
    #view-screener table { width: 100%; border-collapse: collapse; font-family: 'Inter'; table-layout: fixed; }
    #view-screener th {
        background: rgba(15,15,15,0.95); color: var(--text-muted); font-size: 9px; font-weight: 700; text-transform: uppercase; padding: 12px 14px; text-align: left; position: sticky; top: 0; z-index: 10; border-bottom: 1px solid var(--border); white-space: nowrap;
    }
    #view-screener td {
        padding: 10px 14px; border-bottom: 1px solid rgba(255,255,255,0.04); color: #d4d4d4; font-size: 12px; font-weight: 500; vertical-align: middle; overflow: hidden; text-overflow: ellipsis;
    }
    #view-screener th:nth-child(1) { width: 50px; text-align: center; } 
    #view-screener th:nth-child(2) { width: 220px; } 
    #view-screener th:nth-child(3) { width: 130px; } 
    #view-screener th:nth-child(4) { width: 70px; text-align: center; } 
    #view-screener th:nth-child(5) { width: auto; }

    #view-screener .result-box {
        display: flex; flex-direction: column; align-items: center; width: 75px; padding: 4px; border-radius: 6px; border: 1px solid transparent; background: rgba(255,255,255,0.01); margin-bottom: 4px;
    }
    #view-screener .result-box.good { border-color: rgba(194, 245, 14, 0.15); background: rgba(194, 245, 14, 0.03); color: var(--finapsis-neon); }
    #view-screener .result-box.bad { border-color: rgba(255, 77, 77, 0.15); background: rgba(255, 77, 77, 0.03); color: var(--finapsis-red); }
    #view-screener .res-label { font-size: 8px; opacity: 0.7; font-weight: 600; text-transform: uppercase; margin-bottom: 2px; white-space: nowrap; overflow: hidden; width: 100%; text-align: center;}
    #view-screener .res-val { font-size: 12px; font-weight: 700; letter-spacing: -0.2px; }
    #view-screener .res-avg { font-size: 8px; opacity: 0.5; margin-top: 1px; }
    #view-screener .score-badge { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 11px; margin: 0 auto; }
    #view-screener .score-badge.active { background: var(--finapsis-neon); color: #000; }
    #view-screener .score-badge.inactive { background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.3); }

    /* =========================================
       COMPANIES LIST CSS
       ========================================= */
    #view-companies {
        padding: 0 20px 20px 20px;
        background: #000;
    }

    #view-companies .top-controls { display: flex; gap: 10px; margin-bottom: 15px; width: 100%; align-items: center; position: sticky; top:0; z-index:2000; background:#000; padding:10px 0; }
    #view-companies .search-wrapper { flex: 1; position: relative; }
    #view-companies .search-input-top { width: 100%; background: #111; border: 1px solid #333; color: #fff; padding: 12px 15px; border-radius: 10px; font-size: 14px; outline: none; box-sizing: border-box; }
    #view-companies .search-input-top:focus { border-color: #c2f50e; }
    #view-companies .filter-btn-icon { flex: 0 0 45px; height: 45px; background: #111; color: #fff; border: 1px solid #333; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    
    #view-companies .table-wrapper { 
        width: 100%; 
        height: calc(100vh - 180px); /* Tab + Alt Tab + Header payÄ± */
        overflow: auto; 
        border: 1px solid rgba(255,255,255,.08); 
        border-radius: 12px; 
        background: #0b0b0b; 
        position: relative; 
    }
    
    #view-companies table { width: 100%; min-width: 2200px; border-collapse: separate; border-spacing: 0; table-layout: fixed; }
    
    #view-companies thead th { 
        font-size: 11px; text-transform: uppercase; text-align: right; padding: 0 10px; height: 50px; background: #111; border-bottom: 1px solid rgba(255,255,255,0.1); color: rgba(255,255,255,.6); position: sticky; top: 0; z-index: 100; cursor: pointer; 
    }
    #view-companies th:nth-child(1) { position: sticky; left: 0; z-index: 150; background: #111; text-align: left !important; width: 300px; }
    #view-companies td:nth-child(1) { position: sticky; left: 0; z-index: 110; background: #0b0b0b; text-align: left !important; width: 300px; border-right: 1px solid rgba(255,255,255,0.1); }
    
    #view-companies th, #view-companies td { width: 150px; }
    #view-companies thead th.active-sort{
  background: #1a2205 !important;
  color: #c2f50e !important;
  border-bottom: 2px solid #c2f50e !important;
}

#view-companies thead th.active-sort::after{
  content: attr(data-icon);
  margin-left: 6px;
  font-weight: 900;
}

    
    #view-companies tbody tr { height: 50px; }
    #view-companies tbody td { padding: 0 10px; border-bottom: 1px solid rgba(255,255,255,.04); font-size: 13px; text-align: right; color: #eee; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    
    #view-companies .val-up { color: #00ff88 } 
    #view-companies .val-down { color: #ff4444 }

    #filterOverlay { display:none; position: absolute; top: 180px; right: 35px; z-index: 10000; }
    .filter-card { background: #0f0f0f; border: 1px solid #222; width: 440px; padding: 24px; border-radius: 20px; box-shadow: 0 25px 50px rgba(0,0,0,0.7); }
    .f-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px; }
    .f-row label { display: block; font-size: 11px; color: #555; margin-bottom: 8px; text-transform: uppercase; font-weight: 700; }
    .f-row input, .f-row select { width: 100%; background: #161616; border: 1px solid #222; color: #fff; padding: 10px; border-radius: 10px; outline: none; box-sizing: border-box; }
    .pct-input-wrapper { position: relative; display: flex; align-items: center; }
    .pct-input-wrapper::after { content: "%"; position: absolute; right: 12px; color: #c2f50e; font-size: 11px; font-weight: bold; }

    #preloader{position:fixed;inset:0;background:#000;display:flex;align-items:center;justify-content:center;z-index:10001}
    .spinner{width:40px;height:40px;border:3px solid rgba(194,245,14,.1);border-top:3px solid #c2f50e;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    @keyframes fadeIn { from { opacity: 0; transform: translateY(3px); } to { opacity: 1; transform: translateY(0); } }

    ::-webkit-scrollbar { width: 5px; height: 5px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }

    /* MOBÄ°L DÃœZENLEMELER */
    @media screen and (max-width: 768px) {
        #view-companies .table-wrapper { height: auto; overflow: visible; }
        #view-companies table { width: 100% !important; min-width: 0 !important; table-layout: auto !important; display: block !important; }
        #view-companies thead { display: none !important; }
        #view-companies tbody, #view-companies tr { display: block !important; width: 100% !important; }
        #view-companies tbody tr { 
            margin-bottom: 20px; background: #0f0f0f; border-radius: 16px; border: 1px solid #222; 
            padding: 15px; height: auto !important; box-sizing: border-box; 
        }
        #view-companies tbody td { 
            display: flex !important; justify-content: space-between; align-items: center;
            width: 100% !important; padding: 12px 0 !important; position: static !important;
            background: transparent !important; border-bottom: 1px solid rgba(255,255,255,0.05);
            height: auto !important; white-space: normal !important;
        }
        #view-companies tbody td:first-child { border-bottom: 2px solid #c2f50e !important; margin-bottom: 10px; padding-bottom: 15px !important; justify-content: flex-start !important; }
        #view-companies tbody td:not(:first-child)::before { content: attr(data-label); font-weight: 600; color: #555; font-size: 11px; text-transform: uppercase; margin-right: 10px; }

        #filterOverlay { 
            position: fixed !important; top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important; 
            width: 100% !important; height: 100% !important; z-index: 99999 !important; background: #000 !important;
        }
        .filter-card { 
            width: 100% !important; height: 100% !important; max-height: 100vh !important; border-radius: 0 !important; 
            padding: 20px !important; overflow-y: auto !important; box-sizing: border-box !important; border: none !important;
        }
        .f-grid { grid-template-columns: 1fr !important; gap: 15px !important; }
        .f-row input { height: 45px !important; font-size: 16px !important; }
    }
  

    /* =========================================
       PORTFOLYO (Ä°ZOLE)
       ========================================= */
/* TEMEL CSS */
#view-portfolio{ --primary: #c2f50e; --bg: #000000; --panel-bg: #0d0d0d; --item-bg: #161616; --border: #2a2a2a; --text-main: #ffffff; --text-muted: #888888; --danger: #ff4d4d; --success: #00e676; }
#view-portfolio *{ box-sizing: border-box; }
#view-portfolio{ margin: 0; background: var(--bg); color: var(--text-main); font-family: 'Inter', sans-serif; height: 100%; width: 100%; overflow: hidden; }
#view-portfolio #app{ display: flex; height: 100%; width: 100%; }
#view-portfolio .left-panel{ width: 380px; border-right: 1px solid var(--border); display: flex; flex-direction: column; background: var(--panel-bg); flex-shrink: 0; }
#view-portfolio .right-panel{ flex: 1; padding: 30px; overflow-y: auto; background: #050505; position: relative; }
#view-portfolio ::-webkit-scrollbar{ width: 6px; height: 6px; } #view-portfolio ::-webkit-scrollbar-track { background: var(--bg); } #view-portfolio ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

    /* LEFT PANEL */
#view-portfolio .header-bar{ padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
#view-portfolio .search-box{ margin: 15px 20px 10px 20px; position: relative; }
#view-portfolio .search-box input{ width: 100%; background: var(--item-bg); border: 1px solid var(--border); padding: 12px 44px 12px 40px; color: #fff; border-radius: 10px; font-size: 13px; outline: none; transition:0.2s; }
#view-portfolio .search-box input:focus{ border-color: var(--primary); }
#view-portfolio .search-icon{ position: absolute; left: 14px; top: 14px; color: #666; font-size: 12px; }
#view-portfolio .category-menu{ display: flex; gap: 8px; padding: 0 20px 15px 20px; overflow-x: auto; border-bottom: 1px solid var(--border); scrollbar-width: none; }
#view-portfolio .cat-item{ padding: 6px 14px; border-radius: 20px; background: #1a1a1a; color: #888; font-size: 11px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: 0.2s; border: 1px solid transparent; }
#view-portfolio .cat-item.active{ background: rgba(194, 245, 14, 0.1); color: var(--primary); border-color: var(--primary); }
#view-portfolio .market-list{ flex: 1; overflow-y: auto; padding: 0 10px; margin-top: 5px; }
#view-portfolio .market-item{ display: flex; align-items: center; padding: 12px 16px; border-bottom: 1px solid #1a1a1a; cursor: pointer; transition: 0.2s; border-radius: 10px; margin-bottom: 2px; }
/* âœ… PortfÃ¶y listesi: fiyat ile menÃ¼ arasÄ±nda boÅŸluk */
#view-portfolio .market-actions{
  display:flex;
  align-items:center;
  gap:10px;            /* boÅŸluk burada */
  margin-left:12px;    /* fiyat bloÄŸundan biraz ayrÄ±ÅŸsÄ±n */
}

#view-portfolio .market-actions .price-box{
  text-align:right;
  min-width: 110px;    /* fiyat alanÄ± sabit olsun, menÃ¼ yapÄ±ÅŸmasÄ±n */
}

#view-portfolio .market-item:hover{ background: #1f1f1f; }
#view-portfolio .ticker-logo{ width: 36px; height: 36px; background: #fff; border-radius: 8px; padding: 2px; object-fit: contain; margin-right: 12px; }
#view-portfolio .ticker-symbol{ font-weight: 700; font-size: 15px; display: block; color: #fff; }
#view-portfolio .ticker-name{ font-size: 11px; color: var(--text-muted); display: block; margin-top: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 140px; }
#view-portfolio .price-val{ font-weight: 600; font-size: 15px; display: block; text-align: right; }
#view-portfolio .price-change{ font-size: 11px; margin-top: 2px; display: block; font-weight: 500; text-align: right; }

    /* DASHBOARD */
#view-portfolio .dash-header{ display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 25px; }
#view-portfolio .portfolio-select{ background: #1a1a1a; color: #fff; border: 1px solid var(--border); padding: 10px 15px; border-radius: 8px; font-size: 13px; outline: none; cursor: pointer; min-width: 200px; }
#view-portfolio .stats-row{ display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
#view-portfolio .stat-card{ background: var(--item-bg); border: 1px solid var(--border); border-radius: 16px; padding: 25px; display: flex; flex-direction: column; justify-content: center; position: relative; overflow: hidden; }
#view-portfolio .stat-card.primary{ border-color: var(--primary); background: rgba(194, 245, 14, 0.05); }
#view-portfolio .stat-label{ font-size: 11px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px; letter-spacing: 0.5px; font-weight: 600; }
#view-portfolio .stat-val{ font-size: 28px; font-weight: 800; color: #fff; }
#view-portfolio .stat-sub{ font-size: 12px; margin-top: 6px; }
#view-portfolio .charts-grid{ display: grid; grid-template-columns: 1fr 2fr; gap: 20px; margin-bottom: 30px; height: 320px; }
#view-portfolio .chart-box{ background: var(--item-bg); border: 1px solid var(--border); border-radius: 16px; padding: 20px; display: flex; flex-direction: column; height: 100%; min-height: 0; }
#view-portfolio .chart-title{ font-size: 14px; font-weight: 600; color: #fff; margin-bottom: 15px; flex-shrink: 0; }
#view-portfolio .chart-wrapper{ flex: 1; position: relative; min-height: 0; width: 100%; }

    /* UPDATED TABLES (Horizontal Scroll & No Wrap) */
#view-portfolio .asset-table-wrap{ border: 1px solid var(--border); border-radius: 16px; overflow: hidden; background: var(--item-bg); margin-bottom: 30px; overflow-x: auto; }
#view-portfolio .asset-table{ width: 100%; border-collapse: collapse; font-size: 13px; min-width: 800px; }
#view-portfolio .asset-table th{ text-align: left; padding: 15px 20px; color: var(--text-muted); border-bottom: 1px solid var(--border); font-weight: 600; font-size: 11px; background: rgba(255,255,255,0.02); white-space: nowrap; }
#view-portfolio .asset-table td{ padding: 18px 20px; border-bottom: 1px solid #222; color: #eee; white-space: nowrap; }
#view-portfolio .asset-table tr:hover{ background: rgba(255,255,255,0.02); cursor: pointer; }
#view-portfolio .table-ticker{ display: flex; align-items: center; gap: 10px; font-weight: 700; }
/* VarlÄ±k adÄ± + tarihÃ§e ikonu */
#view-portfolio .asset-id{ display:flex; flex-direction:column; line-height:1.05; }
#view-portfolio .asset-ticker{ font-weight:800; font-size:13px; color:#fff; }
#view-portfolio .asset-name{ font-size:11px; color:var(--text-muted); font-weight:600; margin-top:3px; max-width:220px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

#view-portfolio .pf-hist-btn{
  margin-left:auto;
  width:30px; height:30px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.14);
  background: rgba(255,255,255,0.03);
  color:#c2f50e;
  display:flex; align-items:center; justify-content:center;
  cursor:pointer;
}
#view-portfolio .pf-hist-btn:hover{ background: rgba(194,245,14,0.10); border-color: rgba(194,245,14,0.35); }

/* TarihÃ§e modal */
#view-portfolio .hist-modal{
  width: 620px;
  max-width: 92vw;
  background:#111;
  border-radius: 24px;
  padding: 18px 18px 16px 18px;
  border: 1px solid #333;
  box-shadow: 0 20px 60px rgba(0,0,0,0.8);
}
#view-portfolio .hist-head{
  display:flex; justify-content:space-between; align-items:flex-start;
  gap:14px; margin-bottom:12px;
}
#view-portfolio .hist-title{ font-weight:900; font-size:16px; color:#fff; margin:0; }
#view-portfolio .hist-sub{ font-size:11px; color:#777; margin-top:4px; }
#view-portfolio .hist-close{ cursor:pointer; color:#777; font-size:18px; padding:6px 8px; }
#view-portfolio .hist-body{
  background:#000;
  border:1px solid #222;
  border-radius:16px;
  padding:12px;
}
#view-portfolio #pfHistCanvas{ width:100%; height:260px; }
#view-portfolio .hist-loading{ color:#777; font-size:12px; padding:10px 2px; }


#view-portfolio .tab-header{ display: flex; gap: 20px; margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
#view-portfolio .tab-btn{ font-size: 14px; font-weight: 600; color: var(--text-muted); cursor: pointer; padding: 5px 10px; transition: 0.2s; position: relative; }
#view-portfolio .tab-btn.active{ color: #fff; }
#view-portfolio .tab-btn.active::after{ content:''; position: absolute; bottom: -11px; left: 0; width: 100%; height: 2px; background: var(--primary); }

#view-portfolio .center-card{ max-width: 420px; width: 100%; margin: 80px auto; background: var(--item-bg); padding: 40px; border-radius: 24px; border: 1px solid var(--border); text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.5); animation: fadeIn 0.4s ease-out; }
#view-portfolio .form-input{ width: 100%; background: #000; border: 1px solid #333; padding: 15px; border-radius: 10px; color: #fff; margin-bottom: 15px; outline:none; transition:0.2s; }
#view-portfolio .form-input:focus{ border-color: var(--primary); }
#view-portfolio .text-green{ color: var(--success); }
#view-portfolio .text-red{ color: var(--danger); }

#view-portfolio .btn{ padding: 14px 20px; border-radius: 10px; font-weight: 700; border:none; cursor: pointer; transition: 0.2s; font-size: 14px; }
#view-portfolio .btn-primary{ background: var(--primary); color: #000; }
#view-portfolio .btn-primary:hover{ background: #d4ff33; transform: translateY(-2px); box-shadow: 0 10px 20px rgba(194, 245, 14, 0.15); }
#view-portfolio .btn-primary:disabled{ background: #333; color: #666; cursor: not-allowed; box-shadow: none; transform: none; opacity: 0.7; }
#view-portfolio .btn-google{ background: #fff; color: #000; display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 15px; width: 100%; }

#view-portfolio .modal-overlay{ position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); z-index: 999; display: none; align-items: center; justify-content: center; animation: fadeIn 0.2s; }
#view-portfolio .trade-modal{ background: #111; width: 380px; border-radius: 24px; padding: 30px; border: 1px solid #333; box-shadow: 0 20px 60px rgba(0,0,0,0.8); }

#view-portfolio .trade-tab-btn{ flex:1; text-align:center; padding:10px; cursor:pointer; border-radius:10px; font-weight:700; font-size:13px; transition:0.2s; }
#view-portfolio .trade-tab-btn.disabled{ opacity: 0.3; cursor: not-allowed; pointer-events: none; }

#view-portfolio .loader-wrap{ height: 100%; display:flex; flex-direction:column; align-items:center; justify-content:center; color:#666; }
#view-portfolio .spinner{ width: 40px; height: 40px; border: 4px solid rgba(194, 245, 14, 0.2); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 15px; }
#view-portfolio .settings-wrap{ position:relative; }
#view-portfolio .settings-btn{
  width:auto; min-width:auto;
  padding:10px 12px;
  display:flex; align-items:center; justify-content:center;
  gap:8px;
}
#view-portfolio .settings-menu{
  position:absolute;
  right:0; top:calc(100% + 8px);
  width:220px;
  background:#111;
  border:1px solid #333;
  border-radius:14px;
  box-shadow:0 20px 60px rgba(0,0,0,0.7);
  overflow:hidden;
  display:none;
  z-index:9999;
}
#view-portfolio .settings-menu.show{ display:block; }
#view-portfolio .settings-item{
  display:flex; align-items:center; gap:10px;
  padding:12px 14px;
  cursor:pointer;
  font-weight:700;
  font-size:13px;
  color:#fff;
  border-bottom:1px solid rgba(255,255,255,0.06);
}
#view-portfolio .settings-item:last-child{ border-bottom:none; }
#view-portfolio .settings-item:hover{ background:rgba(255,255,255,0.04); }
#view-portfolio .settings-item.danger{ color:#ff8080; }
/* Portfolio sector filter button */
#view-portfolio .pf-filter-btn{
  position:absolute;
  right:10px;
  top:9px;
  width:30px;
  height:30px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.14);
  background: rgba(255,255,255,0.03);
  color: rgba(255,255,255,0.65);
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
}
#view-portfolio .pf-filter-btn:hover{
  border-color: rgba(194,245,14,0.35);
  background: rgba(194,245,14,0.10);
  color: #c2f50e;
}
#view-portfolio .pf-filter-btn.active{
  border-color: rgba(194,245,14,0.55);
  background: rgba(194,245,14,0.12);
  color: #c2f50e;
}
#view-portfolio .pf-filter-btn.disabled{
  opacity: .35;
  pointer-events:none;
}

/* Popup */
#view-portfolio .pf-sector-popup{
  position:absolute;
  right:0;
  top:46px;
  width: 260px;
  background: linear-gradient(to bottom, #141414, #0b0b0b);
  border:1px solid rgba(255,255,255,0.12);
  border-radius: 16px;
  box-shadow: 0 18px 60px rgba(0,0,0,0.65);
  z-index: 9999;
  overflow:hidden;
}
#view-portfolio .pf-sector-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:12px 12px;
  border-bottom:1px solid rgba(255,255,255,0.10);
}
#view-portfolio .pf-sector-title{
  font-weight:900;
  font-size:12px;
  color:#fff;
}
#view-portfolio .pf-sector-actions{
  display:flex;
  align-items:center;
  gap:10px;
}
#view-portfolio .pf-sector-clear{
  font-size:11px;
  font-weight:800;
  color:#c2f50e;
  background:transparent;
  border:0;
  cursor:pointer;
}
#view-portfolio .pf-sector-close{
  color:#777;
  cursor:pointer;
  font-size:14px;
}
#view-portfolio .pf-sector-list{
  max-height: 280px;
  overflow:auto;
  padding:8px;
}
#view-portfolio .pf-sector-item{
  padding:10px 10px;
  border-radius:12px;
  cursor:pointer;
  color:#ddd;
  font-size:12px;
  font-weight:700;
  border:1px solid transparent;
}
#view-portfolio .pf-sector-item:hover{
  background: rgba(255,255,255,0.04);
}
#view-portfolio .pf-sector-item.active{
  background: rgba(194,245,14,0.12);
  border-color: rgba(194,245,14,0.35);
  color:#c2f50e;
}




    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    @media (max-width: 1000px) {
#view-portfolio #app{ flex-direction: column; overflow-y: auto; }
#view-portfolio .left-panel{ width: 100%; height: 400px; border-right: none; border-bottom: 1px solid var(--border); }
#view-portfolio .stats-row{ grid-template-columns: 1fr 1fr; }
#view-portfolio .charts-grid{ grid-template-columns: 1fr; height: auto; }
#view-portfolio .chart-box{ height: 300px; }
    }

/* =========================================
   SEKTORLER (Ä°ZOLE) - CompaniesList gibi tam yÃ¼kseklik
   ========================================= */
/* =======================================================
   âœ… SEKTÃ–RLER TABLOSU (FIXED & ALIGNED)
   ======================================================= */

#view-sectors {
  background: #000;
  padding: 10px 20px 20px 20px;
  overflow: hidden;
}

#view-sectors .sec-wrap {
  flex: 1;
  min-height: 0;
  display: flex;
  flex-direction: column;
}

/* Tablo KapsayÄ±cÄ±sÄ± */
#view-sectors .table-wrapper {
  flex: 1;
  min-height: 0;
  width: 100%;
  overflow: auto;
  border: 1px solid rgba(255, 255, 255, .08);
  border-radius: 12px;
  background: #0b0b0b;
  position: relative;
}

/* Tablo Temel AyarlarÄ± - SÃ¼tun GeniÅŸliklerini KÄ°LÄ°TLE */
#view-sectors table {
  table-layout: fixed !important;
  width: 100%;
  min-width: 2400px;
  border-collapse: separate;
  border-spacing: 0;
}

/* --- TÃœM HÃœCRELER (TH ve TD) --- */
#view-sectors th,
#view-sectors td {
  box-sizing: border-box !important;
  padding: 0 10px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  vertical-align: middle;
  height: 50px;
  border-bottom: 1px solid rgba(255, 255, 255, .04);
  font-size: 13px;
  color: #eee;
}

/* --- 1. SÃœTUN (Ä°SÄ°M ALANI) AYARLARI --- */
/* Hem baÅŸlÄ±k hem satÄ±r iÃ§in sabit geniÅŸlik ve sticky */
#view-sectors th:first-child,
#view-sectors td:first-child {
  position: sticky;
  left: 0;
  z-index: 100;
  width: 360px !important;      /* GeniÅŸlik KÄ°LÄ°TLÄ° */
  min-width: 360px !important;
  max-width: 360px !important;
  border-right: 1px solid rgba(255, 255, 255, 0.1);
  background: #0b0b0b; /* Arkadan yazÄ± geÃ§mesin diye opak */
  padding: 0 !important; /* Padding'i iÃ§indeki div halledecek */
}

/* Header (BaÅŸlÄ±k) Ã–zel AyarlarÄ± */
#view-sectors thead th {
  background: #111;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: .05em;
  color: rgba(255, 255, 255, .6);
  position: sticky;
  top: 0;
  z-index: 200;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  cursor: pointer !important;
}

#view-sectors th:first-child{
  z-index: 300 !important;
  background: #111;
  display: table-cell !important;   /* âœ… flex KALDIR */
  padding: 0 10px !important;            /* padding'i inner alacak */
  text-align: left !important;

}

#view-sectors .sec-th-inner{
  display:flex;
  align-items:center;
  gap:10px;
  height:50px;
  padding: 0 10px;
  box-sizing:border-box;
  justify-content: flex-start;

}

/* --- Ä°Ã‡ERÄ°K HÄ°ZALAMA KUTUSU (JS ile eklediÄŸimiz div) --- */
/* Bu div sayesinde TD'nin geniÅŸliÄŸi bozulmadan iÃ§erik saÄŸa kayar */
.sec-cell-inner {
    display: flex;
    align-items: center;
    width: 100%;
    height: 100%;
    padding-right: 10px;
    box-sizing: border-box;
}

/* --- GÄ°RÄ°NTÄ°LER (TREE VIEW INDENTATION) --- */
/* Girintiyi TD'ye deÄŸil, iÃ§indeki DIV'e veriyoruz */

/* Level 1: Ana SektÃ¶r */
tr.sec-row-level-1 td:first-child { background: #0b0b0b; }
tr.sec-row-level-1 .sec-cell-inner { 
    padding-left: 10px; 
    font-weight: 700; color: #fff;
}

/* Level 2: Alt SektÃ¶r */
tr.sec-row-level-2 td:first-child { background: #141414; }
tr.sec-row-level-2 .sec-cell-inner { 
    padding-left: 45px; /* Girinti */
    font-weight: 600; color: #fff;
}

/* Level 3: Åžirket */
tr.sec-row-level-3 td:first-child { background: #1a1a1a; }
tr.sec-row-level-3 .sec-cell-inner { 
    padding-left: 80px; /* Daha fazla girinti */
    color: #aaa; font-size: 12px;
}

/* --- DÄ°ÄžER SÃœTUNLAR (VERÄ° ALANLARI) --- */
#view-sectors th:not(:first-child),
#view-sectors td:not(:first-child) {
  width: 140px !important; /* Sabit geniÅŸlik */
  min-width: 140px !important;
  max-width: 140px !important;
  text-align: right;
}

/* --- GÃ–RSEL EFEKTLER --- */
/* Hover Efektleri */
tr.sec-row-level-1:hover td { background: #161616 !important; }
tr.sec-row-level-2:hover td { background:#1f1f1f !important; }
tr.sec-row-level-3:hover td { background: #252525 !important; }

/* Sort Ä°konu */
#view-sectors th.active-sort { 
  background: #1a2205 !important; 
  color: #c2f50e !important; 
  border-bottom: 2px solid #c2f50e !important; 
}
#view-sectors th.active-sort::after { 
  content: attr(data-icon); 
  margin-left: 5px; font-weight: bold; 
}

/* Renk SÄ±nÄ±flarÄ± */
#view-sectors .pos { color: #9dffb3; }
#view-sectors .neg { color: #ff9d9d; }
#view-sectors .muted { color: rgba(255, 255, 255, .4); }

/* Logo ve SayaÃ§ */
.sec-comp-logo { 
    margin-right: 8px; width: 18px; height: 18px; 
    border-radius: 4px; object-fit: contain; background: #fff; 
}
.comp-count { 
    margin-left: auto; font-size: 10px; opacity: 0.5; font-weight: 400; 
}
.sec-caret { 
    width: 20px; text-align: center; margin-right: 5px; color: #666; transition: 0.2s; 
}
.sec-expanded .sec-caret { transform: rotate(90deg); color: #c2f50e; }
#view-sectors td[colspan] {
    position: static !important;
    width: auto !important;
    max-width: none !important;
    text-align: center !important;
    background: transparent !important;
    border: none !important;
}

/* SektÃ¶rler > Åžirket satÄ±rÄ± aksiyon ikonu saÄŸa dayansÄ±n */
#view-sectors .sec-cell-inner .sec-row-actions{
  margin-left: auto;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}
#view-sectors .sec-cell-inner .fp-menu-btn{
  flex: 0 0 auto;
}


/* --- MOBÄ°L UYUM (CARD VIEW) --- */
@media screen and (max-width: 768px) {
  #view-sectors .table-wrapper { flex: none; min-height: 0; overflow: visible; }
  #view-sectors table { width: 100% !important; min-width: 0 !important; table-layout: auto !important; display: block !important; }
  #view-sectors thead { display: none !important; }
  #view-sectors tbody, #view-sectors tr { display: block !important; width: 100% !important; }
  
  #view-sectors tbody tr {
    margin-bottom: 20px; background: #0f0f0f; border-radius: 16px; border: 1px solid #222;
    padding: 15px; height: auto !important;
  }
  
  #view-sectors tbody td {
    display: flex !important; justify-content: space-between; align-items: center;
    width: 100% !important; padding: 12px 0 !important; position: static !important;
    background: transparent !important; border-bottom: 1px solid rgba(255,255,255,0.05);
    height: auto !important; white-space: normal !important; text-align: right !important;
    border-right: none !important;
  }
  
  #view-sectors tbody td:first-child {
    border-bottom: 2px solid #c2f50e !important; margin-bottom: 10px; padding-bottom: 15px !important; justify-content: flex-start !important;
    width: 100% !important; max-width: none !important;
  }
  
  /* Mobilde .sec-cell-inner padding'ini sÄ±fÄ±rla veya azalt */
  .sec-cell-inner { padding-left: 0 !important; }
  tr.sec-row-level-2 .sec-cell-inner { padding-left: 20px !important; }
  tr.sec-row-level-3 .sec-cell-inner { padding-left: 40px !important; }

  #view-sectors tbody td:not(:first-child)::before {
    content: attr(data-label);
    font-weight: 600; color: #555; font-size: 11px; text-transform: uppercase; margin-right: 10px; text-align: left;
  }
}

  

    /* =========================================
       KARÅžILAÅžTIRMA (Ä°ZOLE)
       ========================================= */
    @keyframes cmpSpin { to { transform: rotate(360deg); } }
    @keyframes cmpFadeIn { from { opacity: 0; transform: translateY(-5px);} to { opacity: 1; transform: translateY(0);} }

    #view-compare {
      --primary: #c2f50e;
      --bg: #050505;
      --card-bg: #0f0f0f;
      --border: rgba(255, 255, 255, 0.12);
      --text-muted: rgba(255, 255, 255, 0.5);
      height: 100%;
      width: 100%;
      overflow: hidden;
      background: #000;
      padding: 0;
      box-sizing: border-box;
      padding: 10px 20px 20px 20px;

    }

    /* âœ… DÃœZELTME: Fontu kapsayÄ±cÄ±ya ver, yÄ±ldÄ±za deÄŸil. */
    #view-compare {
      font-family: 'Inter', sans-serif;
      /* DiÄŸer ayarlar */
      height: 100%;
      width: 100%;
      background: #000;
      padding: 10px 20px 20px 20px;
      overflow: hidden;
    }

    /* YÄ±ldÄ±z sadece box-sizing yapsÄ±n, fontu ellemesin */
    #view-compare * { box-sizing: border-box; }

    #view-compare .cmp-main-container {
      width: 100%;
      max-width: 100%;
      margin: 0 auto;
      position: relative;
      background: var(--bg);
      height: 100%;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    #view-compare .cmp-search-section {
      background: #0a0a0a;
      padding: 0px 0px 20px 0px;
      position: sticky;
      top: 0;
      z-index: 100;
      flex-shrink: 0;
    }

    #view-compare .cmp-search-input-wrapper { position: relative; display: flex; align-items: center; }
    #view-compare i.cmp-search-icon { position: absolute; left: 16px; color: var(--text-muted); font-size: 14px; }

    #view-compare #cmpSearch {
      width: 100%;
      background: #111;
      color: #fff;
      border: 1px solid rgba(255,255,255,0.15);
      padding: 14px 16px 14px 44px;
      border-radius: 12px;
      outline: none;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    #view-compare #cmpSearch:focus {
      border-color: var(--primary);
      background: rgba(194, 245, 14, 0.05);
      box-shadow: 0 0 0 1px rgba(194, 245, 14, 0.2);
    }

    #view-compare .cmp-search-results {
      position: absolute; top: calc(100% + 8px); left: 0; right: 0;
      background: #161616; border: 1px solid var(--border); border-radius: 12px;
      max-height: 280px; overflow-y: auto; display: none;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.8); z-index: 9999;
    }

    #view-compare .cmp-result-item {
      padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05); transition: background 0.15s;
    }

    #view-compare .cmp-result-item:hover { background: rgba(194, 245, 14, 0.1); }
    #view-compare .cmp-result-item img { width: 24px; height: 24px; object-fit: contain; border-radius: 4px; background: #fff; padding: 2px; }
    #view-compare .cmp-result-item span { font-size: 13px; font-weight: 600; color: #fff; }

    #view-compare .cmp-badge-area { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 16px; min-height: 32px; }

    #view-compare .cmp-badge {
      background: rgba(255, 255, 255, 0.08); color: #fff; padding: 6px 12px;
      border-radius: 8px; font-weight: 600; font-size: 11px; border: 1px solid rgba(255,255,255,0.1);
      display: flex; align-items: center; gap: 8px; animation: cmpFadeIn 0.3s ease;
    }

    #view-compare .cmp-badge i { cursor: pointer; color: rgba(255,255,255,0.5); transition: color 0.2s; }
    #view-compare .cmp-badge i:hover { color: #ff4d4d; }

    #view-compare .cmp-table-wrapper {
      width: 100%;
      background: var(--bg);
      overflow: auto;
      padding-bottom: 20px;
      flex: 1;
      border: 1px solid rgba(255,255,255,.08); 
        border-radius: 12px; 
    }

    #view-compare table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 900px; }

    #view-compare th, #view-compare td {
      padding: 16px 12px; text-align: center; border-bottom: 1px solid var(--border);
      font-size: 13px; vertical-align: middle; color: #e0e0e0;
    }

    #view-compare tr:hover td { background-color: rgba(255, 255, 255, 0.03); }

    #view-compare th:first-child, #view-compare td:first-child {
      position: sticky; left: 0; z-index: 20; background: var(--bg);
      border-right: 1px solid var(--border); text-align: left !important;
      width: 220px; min-width: 220px; font-weight: 600; color: rgba(255,255,255,0.7);
    }

    #view-compare thead th {
      background: var(--card-bg); color: #fff; font-size: 11px; font-weight: 700;
      text-transform: uppercase; letter-spacing: 0.5px; height: 70px;
      position: sticky; top: 0;
    }

    #view-compare thead th:first-child { z-index: 30; background: var(--card-bg); }

    #view-compare .cmp-flag-head { width: 32px; height: 32px; object-fit: contain; border-radius: 6px; background: #fff; padding: 2px; display: block; margin: 0 auto 8px auto; }
    #view-compare .cmp-country-title { display: block; font-size: 12px; font-weight: 800; color: #fff; }

    #view-compare .cmp-mobile-meta { display: none; }

    #view-compare .cell-green { background-color: rgba(194, 245, 14, 0.15) !important; color: #c2f50e !important; font-weight: 700; }
    #view-compare .cell-yellow { background-color: rgba(255, 235, 59, 0.08) !important; color: #ffeb3b !important; }
    #view-compare .cell-orange { background-color: rgba(255, 152, 0, 0.08) !important; color: #ff9800 !important; }
    #view-compare .cell-red { background-color: rgba(255, 77, 77, 0.1) !important; color: #ff4d4d !important; }

    #view-compare .val-highlight { color: #fff; font-weight: 700; }
    #view-compare .muted { opacity: 0.3; }

    @media (max-width: 768px) {
      #view-compare table { display: flex; flex-direction: column; width: 100%; min-width: auto; padding: 15px; }
      #view-compare thead { display: none; }
      #view-compare tbody { display: flex; flex-direction: column; gap: 20px; }
      #view-compare tr { display: flex; flex-direction: column; background: var(--card-bg); border: 1px solid var(--border); border-radius: 16px; overflow: hidden; }
      #view-compare td:first-child { position: static; width: 100%; border-right: none; background: rgba(255,255,255,0.03); padding: 14px 16px; color: var(--primary); font-size: 13px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid var(--border); }
      #view-compare td:not(:first-child) { display: flex; justify-content: space-between; align-items: center; width: 100%; text-align: right; padding: 14px 16px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 14px; background: transparent !important; }
      #view-compare tr td:last-child { border-bottom: none; }
      #view-compare .cell-green { border-left: 3px solid #c2f50e; color: #c2f50e !important; }
      #view-compare .cell-red { border-left: 3px solid #ff4d4d; color: #ff4d4d !important; }
      #view-compare .cell-yellow { border-left: 3px solid #ffeb3b; color: #ffeb3b !important; }
      #view-compare .cell-orange { border-left: 3px solid #ff9800; color: #ff9800 !important; }
      #view-compare .cmp-mobile-meta { display: flex; align-items: center; gap: 10px; font-size: 13px; font-weight: 600; color: #fff; }
      #view-compare .cmp-mobile-meta img { width: 20px; height: 20px; object-fit: contain; background: #fff; border-radius: 4px; padding: 1px; }
    }

    /* Add-to-Portfolio mini icon (Screener/List/Compare) */
    .fp-add-btn{
      width:26px;
      height:26px;
      border-radius:8px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      background: rgba(194,245,14,0.10);
      border: 1px solid rgba(194,245,14,0.25);
      color: #c2f50e;
      cursor: pointer;
      transition: background 0.15s ease, transform 0.15s ease;
    }
    /* Menu button (replaces +) */
.fp-menu-btn{
  width:26px;
  height:26px;
  border-radius:8px;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.14);
  color: rgba(255,255,255,0.85);
  cursor: pointer;
  transition: background 0.15s ease, transform 0.15s ease;
}
.fp-menu-btn:hover{ background: rgba(255,255,255,0.10); transform: translateY(-1px); }
.fp-menu-btn i{ font-size: 12px; line-height: 1; }

/* Row action menu modal */
#fpRowMenuOverlay{
  position: fixed;
  inset: 0;
  display: none;
  z-index: 999999;
  background: transparent;        /* âœ… artÄ±k karartma yok */
  backdrop-filter: none;          /* âœ… blur yok */
}
#fpRowMenu{
  position: fixed;               /* âœ… konumlandÄ±racaÄŸÄ±z */
  width: 260px;
  background: #0f0f0f;
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: 14px;
  overflow: hidden;
  box-shadow: 0 30px 70px rgba(0,0,0,0.75);
}

.fpMenuHead{
  padding: 12px 14px;
  border-bottom: 1px solid rgba(255,255,255,0.08);
  display:flex;
  align-items:center;
  justify-content:space-between;
}
.fpMenuTitle{
  font-weight: 900;
  font-size: 12px;
  letter-spacing: .08em;
  text-transform: uppercase;
  color: rgba(255,255,255,0.75);
}
.fpMenuTicker{
  font-weight: 900;
  color: #c2f50e;
}
.fpMenuItem{
  padding: 12px 14px;
  display:flex;
  align-items:center;
  gap:10px;
  cursor:pointer;
  font-weight: 800;
  font-size: 13px;
  color:#fff;
  border-bottom: 1px solid rgba(255,255,255,0.06);
}
.fpMenuItem:last-child{ border-bottom:none; }
.fpMenuItem:hover{ background: rgba(255,255,255,0.05); }
.fpMenuItem.disabled{
  opacity: .35;
  cursor: not-allowed;
  pointer-events: none;
}
.fpMenuIcon{ width:18px; text-align:center; opacity:.85; }
.fpMenuClose{
  cursor:pointer;
  width:28px; height:28px;
  border-radius:10px;
  display:flex; align-items:center; justify-content:center;
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.10);
}
.fpMenuClose:hover{ background: rgba(255,255,255,0.10); }

    .fp-add-btn:hover{
      background: rgba(194,245,14,0.18);
      transform: translateY(-1px);
    }
    .fp-add-btn i{ font-size: 12px; line-height: 1; }

    /* Compare badge buttons */
    #view-compare .cmp-badge .cmp-xbtn{
      width:20px;
      height:20px;
      border-radius:6px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.25);
      color: rgba(255,255,255,0.65);
      cursor:pointer;
      font-weight: 900;
      font-size: 14px;
      line-height: 1;
      padding: 0;
    }
    #view-compare .cmp-badge .cmp-xbtn:hover{ color:#ff4d4d; border-color: rgba(255,77,77,0.35); }
    #view-compare .cmp-badge .cmp-addbtn{ margin-left: 2px; }



    /* =========================================
       DETAIL (comdetail) - SCOPED
       ========================================= */
    #view-detail{ 
      --neon:#c2f50e;
      --bg:#000;
      --border:rgba(255,255,255,.08);
      --shadow: 0 10px 30px rgba(0,0,0,.45);
      width:100%;
      height:100%;
      overflow:auto;
      background:
        radial-gradient(1200px 700px at 25% -10%, rgba(194,245,14,.12), transparent 60%),
        radial-gradient(900px 500px at 90% 10%, rgba(255,216,77,.06), transparent 55%),
        var(--bg);
    }
    #view-detail *{ box-sizing:border-box; }
    #view-detail .wrap{ max-width:1400px; width:100%; margin:0 auto; padding:18px; }
    #view-detail .fin-card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid var(--border);
      border-radius:18px;
      overflow:hidden;
      box-shadow: var(--shadow);
      backdrop-filter: blur(6px);
    }
    #view-detail .card-head{
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      background: rgba(255,255,255,0.03);
    }
    #view-detail .tab-scroll{
      display:flex; gap:8px; overflow-x:auto; padding-bottom:4px;
      -webkit-overflow-scrolling: touch; scrollbar-width:none;
    }
    #view-detail .tab-scroll::-webkit-scrollbar{ display:none; }
    #view-detail .tab-btn{
      white-space:nowrap; font-size:12px; font-weight:800; color:#9b9b9b;
      background:transparent; border-radius:10px; padding:8px 12px;
      transition:all .18s ease; border:1px solid rgba(255,255,255,0);
      outline:none;
      cursor: pointer;

    }
    #view-detail .tab-btn:hover{ color:#fff; background: rgba(255,255,255,.05); }
    #view-detail .tab-btn.active{ background: var(--neon); color:#000; font-weight:900; }

    #view-detail .fin-table{ width:100%; border-collapse:separate; border-spacing:0; }
    #view-detail .fin-table thead th{
      text-align:right; color:#7d7d7d; font-size:11px; text-transform:uppercase;
      letter-spacing:.06em; font-weight:900; padding:12px;
      border-bottom:1px solid var(--border);
      background: rgba(255,255,255,.02);
      position: sticky; top: 0; z-index: 3;
    }
    #view-detail .fin-table thead th:first-child{ text-align:left; left:0; z-index:4; }
    #view-detail .fin-table tbody td{
      text-align:right; padding:12px; border-bottom:1px solid rgba(255,255,255,0.04);
      font-size:13px; font-variant-numeric: tabular-nums;
    }
    #view-detail .fin-table tbody td:first-child{
      text-align:left; color:#e5e5e5; font-weight:800;
      position: sticky; left: 0;
      background: linear-gradient(90deg, rgba(12,12,12,1), rgba(12,12,12,.92) 70%, rgba(12,12,12,0));
      z-index:2;
    }

    #view-detail .range-container{ position:relative; height:44px; display:flex; align-items:center; }
    #view-detail .range-track{ width:100%; height:10px; background:#1f1f1f; border-radius:999px; position:relative; overflow:hidden; border:1px solid rgba(255,255,255,.06); }
    #view-detail .range-fill{ height:100%; background: linear-gradient(90deg, rgba(194,245,14,.25) 0%, rgba(194,245,14,1) 100%); border-radius:999px; position:absolute; left:0; top:0; }
    #view-detail .range-thumb{ width:20px; height:20px; background:#fff; border:4px solid #000; border-radius:50%; position:absolute; top:50%; transform: translate(-50%, -50%); z-index:2; box-shadow: 0 0 0 6px rgba(194,245,14,.10), 0 10px 25px rgba(0,0,0,.45); }
    #view-detail .range-label-float{ position:absolute; top:-30px; left:50%; transform: translateX(-50%); background:#111; padding:3px 8px; border-radius:8px; border:1px solid rgba(255,255,255,.12); font-size:11px; font-weight:900; white-space:nowrap; color:#fff; }

    #view-detail .metric-row{ display:flex; justify-content:space-between; align-items:center; padding: 12px 12px; border-bottom: 1px solid rgba(255,255,255,0.04); transition: background 0.18s ease; }
    #view-detail .metric-row:hover{ background: rgba(255,255,255,0.02); }
    #view-detail .metric-row:last-child{ border-bottom:none; }

    #view-detail .badge{ display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border-radius:999px; font-size:10px; font-weight:900; border:1px solid rgba(255,255,255,.10); color:#d7d7d7; background: rgba(255,255,255,.04); text-transform: uppercase; letter-spacing:.06em; }
    #view-detail .badge.neon{ background: rgba(194,245,14,.18); border-color: rgba(194,245,14,.35); color: var(--neon); }

    #view-detail .news-item{ padding:12px; border-bottom:1px solid rgba(255,255,255,0.04); transition: background 0.18s ease; cursor:pointer; text-decoration:none; display:block; }
    #view-detail .news-item:hover{ background: rgba(255,255,255,0.03); }
    #view-detail .news-item:last-child{ border-bottom:none; }

    #view-detail #priceChart{ width:100%; min-height:280px; }
    /* Snapshot (Genel Bilgiler) */
#view-detail .snapshot-grid{ display:flex; flex-direction:column; gap:10px; margin-top:12px; }
#view-detail .snapshot-row{
  display:flex; justify-content:space-between; align-items:center;
  padding:10px 12px; border:1px solid rgba(255,255,255,.08);
  background: rgba(255,255,255,.03); border-radius:12px;
}
#view-detail .snapshot-row .k{
  color:#8b8b8b; font-size:11px; font-weight:900;
  text-transform:uppercase; letter-spacing:.06em;
}
#view-detail .snapshot-row .v{
  color:#fff; font-weight:900; font-variant-numeric: tabular-nums;
}

/* Mini Bars */
#view-detail .mini-legend{
  display:flex;
  gap:12px;
  align-items:center;
  margin: 8px 0 10px 0;
  color: rgba(255,255,255,.60);
  font-size: 11px;
  font-weight: 900;
  letter-spacing: .04em;
  text-transform: uppercase;
}
#view-detail .mini-leg-item{ display:flex; align-items:center; gap:8px; }
#view-detail .mini-legend .dot{
  width:10px; height:10px; border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  display:inline-block;
}
#view-detail .mini-legend .dot.rev{ background: rgba(194,245,14,.65); }
#view-detail .mini-legend .dot.prof{ background: rgba(0,230,118,.70); }

#view-detail .mini-bars-wrap{
  display:flex; gap:10px; align-items:flex-end;
  height:140px; padding:10px 8px;
  border:1px solid rgba(255,255,255,.08);
  background: rgba(255,255,255,.02);
  border-radius:12px;
}
#view-detail .mini-col{ flex:1; display:flex; flex-direction:column; align-items:center; gap:6px; }
#view-detail .mini-bars-stack{
  width:100%;
  height:96px;
  display:flex;
  align-items:flex-end;
  justify-content:center;
  gap:6px;
}
#view-detail .mini-bar{
  width:10px; border-radius:8px 8px 3px 3px;
  background: rgba(194,245,14,.65);
  box-shadow: 0 10px 24px rgba(194,245,14,.12);
}
#view-detail .mini-bar.profit{
  background: rgba(0,230,118,.70);
  box-shadow: 0 10px 24px rgba(0,230,118,.10);
}
#view-detail .mini-bar.profit.neg{
  background: rgba(255,77,77,.75);
  box-shadow: 0 10px 24px rgba(255,77,77,.10);
}
#view-detail .mini-label{
  font-size:10px; font-weight:900; color: rgba(255,255,255,.55);
  letter-spacing:.04em;
}


    #view-detail .search-wrap{ position: relative; }
    #view-detail .search-input{ width: 320px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.10); border-radius: 12px; padding: 10px 12px; color: #fff; font-weight: 900; outline: none; }
    #view-detail .search-input::placeholder{ color: rgba(255,255,255,0.35); font-weight:800; }
    #view-detail .search-input:focus{ border-color: rgba(194,245,14,.55); box-shadow: 0 0 0 4px rgba(194,245,14,.12); }
    #view-detail .search-btn{ background: var(--neon); color:#000; font-weight: 900; border-radius: 12px; padding: 10px 12px; border: none; cursor:pointer; white-space: nowrap; }
    #view-detail .search-btn:disabled{ opacity:.5; cursor:not-allowed; }

    #view-detail .search-dd{ position:absolute; top: 44px; right: 0; width: 420px; max-width: calc(100vw - 36px); background: rgba(15,15,15,.98); border: 1px solid rgba(255,255,255,.12); border-radius: 14px; box-shadow: 0 20px 40px rgba(0,0,0,.55); overflow: hidden; display:none; z-index: 50; }
    #view-detail .dd-item{ padding: 10px 12px; border-bottom: 1px solid rgba(255,255,255,0.06); cursor:pointer; display:flex; justify-content:space-between; gap: 10px; align-items:center; }
    #view-detail .dd-item:hover{ background: rgba(255,255,255,0.04); }
    #view-detail .dd-item:last-child{ border-bottom:none; }
    #view-detail .dd-left{ display:flex; flex-direction:column; min-width: 0; }
    #view-detail .dd-title{ font-weight: 900; color:#fff; font-size: 13px; white-space:nowrap; overflow:hidden; text-overflow: ellipsis; }
    #view-detail .dd-sub{ font-size: 11px; color: rgba(255,255,255,0.55); font-weight: 800; white-space:nowrap; overflow:hidden; text-overflow: ellipsis; margin-top:2px; }
    #view-detail .dd-right{ display:flex; gap:8px; align-items:center; flex-shrink:0; }
    #view-detail .dd-ticker{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-weight: 900; color: var(--neon); font-size: 12px; }
/* Detail loading overlay */
#view-detail .wrap{ position: relative; } /* overlay'in wrap iÃ§inde oturmasÄ± iÃ§in */

#detailLoadingOverlay.detail-loading-overlay{
  position:absolute;
  inset:0;
  display:none;              /* JS aÃ§acak */
  align-items:center;
  justify-content:center;
  background: rgba(0,0,0,0.55);
  backdrop-filter: blur(2px);
  z-index: 9999;
  border-radius: 18px;
}

/* =========================================
   DIYAGRAMLAR (Ä°ZOLE)
   ========================================= */
#view-diagrams{
  padding: 10px 20px 20px 20px;
  background: #050505;
  overflow: hidden;
}

#view-diagrams .dg-container{
  flex: 1;
  min-height: 0;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

#view-diagrams .dg-header-tools{
  display:flex;
  gap:12px;
  background:#111;
  padding:12px;
  border-radius:14px;
  border:1px solid #222;
  box-shadow: 0 4px 20px rgba(0,0,0,0.5);
  flex-shrink: 0;
}

#view-diagrams .dg-header-tools select{
  background:#1a1a1a;
  color:#c2f50e;
  border:1px solid #333;
  padding:12px;
  border-radius:10px;
  font-size:14px;
  font-weight:600;
  flex:1;
  outline:none;
  cursor:pointer;
  transition:all .2s;
}
#view-diagrams .dg-header-tools select:hover{ border-color:#c2f50e; background:#222; }

#view-diagrams .dg-main-layout{
  display:flex;
  gap:20px;
  flex: 1;
  min-height: 0;
}

#view-diagrams .dg-chart-container{
  flex: 0 0 70%;
  position: relative;
  background:#0a0a0a;
  border:1px solid #1f1f1f;
  border-radius:20px;
  padding:15px;
  min-height: 520px;
}

#view-diagrams .dg-sidebar-panel{
  flex:1;
  background:#111;
  border:1px solid #222;
  border-radius:20px;
  padding:20px;
  display:flex;
  flex-direction:column;
  overflow:auto;
  box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
  min-height: 0;
}

#view-diagrams .dg-sidebar-panel h4{
  margin: 0 0 15px 0;
  color:#c2f50e;
  font-size:16px;
  text-transform:uppercase;
  border-bottom:1px solid #333;
  padding-bottom:10px;
  display:flex;
  align-items:center;
  gap:10px;
}

#view-diagrams #interp-content{
  color:#bbb;
  font-size:14px;
  line-height:1.7;
}

@media (max-width: 900px){
  #view-diagrams .dg-main-layout{ flex-direction: column; }
  #view-diagrams .dg-chart-container{ flex: none; min-height: 420px; }
}
/* --- COMPANIES FILTER (PORTFOLIO STYLE CLONE) --- */
#view-companies .cl-filter-btn {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    width: 30px;
    height: 30px;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.14);
    background: rgba(255,255,255,0.03);
    color: rgba(255,255,255,0.65);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 20;
}
#view-companies .cl-filter-btn:hover {
    border-color: rgba(194,245,14,0.35);
    background: rgba(194,245,14,0.10);
    color: #c2f50e;
}
#view-companies .cl-filter-btn.active {
    border-color: rgba(194,245,14,0.55);
    background: rgba(194,245,14,0.12);
    color: #c2f50e;
}

/* POPUP */
#view-companies .cl-sector-popup {
    position: absolute;
    right: 0;
    top: 46px;
    width: 260px;
    background: linear-gradient(to bottom, #141414, #0b0b0b);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 16px;
    box-shadow: 0 18px 60px rgba(0,0,0,0.65);
    z-index: 9999;
    overflow: hidden;
    display: none; /* JS ile aÃ§Ä±lacak */
}
#view-companies .cl-sector-head {
    display: flex; align-items: center; justify-content: space-between;
    padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.10);
}
#view-companies .cl-sector-title { font-weight: 900; font-size: 12px; color: #fff; }
#view-companies .cl-sector-actions { display: flex; align-items: center; gap: 10px; }
#view-companies .cl-sector-clear { font-size: 11px; font-weight: 800; color: #c2f50e; background: transparent; border: 0; cursor: pointer; }
#view-companies .cl-sector-close { color: #777; cursor: pointer; font-size: 14px; }

#view-companies .cl-sector-list { max-height: 280px; overflow: auto; padding: 8px; }
#view-companies .cl-sector-item {
    padding: 10px; border-radius: 12px; cursor: pointer;
    color: #ddd; font-size: 12px; font-weight: 700; border: 1px solid transparent;
}
#view-companies .cl-sector-item:hover { background: rgba(255,255,255,0.04); }
#view-companies .cl-sector-item.active {
    background: rgba(194,245,14,0.12);
    border-color: rgba(194,245,14,0.35);
    color: #c2f50e;
}
/* --- GRUP SEÃ‡Ä°M BUTONLARI (YENÄ°) --- */
    .group-toggle-row {
        display: flex;
        background: rgba(255,255,255,0.05);
        border-radius: 8px;
        padding: 4px;
        gap: 4px;
        margin-bottom: 10px; /* Popup iÃ§inde alt boÅŸluk */
    }
    .group-toggle-btn {
        flex: 1;
        background: transparent;
        border: none;
        color: #888;
        font-size: 11px;
        font-weight: 700;
        padding: 6px 0;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        text-align: center;
    }
    .group-toggle-btn:hover { color: #fff; background: rgba(255,255,255,0.05); }
    .group-toggle-btn.active {
        background: #c2f50e;
        color: #000;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
/* --- SCREENER SECTOR FILTER (PORTFOLIO STYLE) --- */
#view-screener .sc-filter-btn {
    width: 30px;
    height: 30px;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.14);
    background: rgba(255,255,255,0.03);
    color: rgba(255,255,255,0.65);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    margin-right: 8px; /* SaÄŸdaki butonlarla mesafe */
}
#view-screener .sc-filter-btn:hover {
    border-color: rgba(194,245,14,0.35);
    background: rgba(194,245,14,0.10);
    color: #c2f50e;
}
#view-screener .sc-filter-btn.active {
    border-color: rgba(194,245,14,0.55);
    background: rgba(194,245,14,0.12);
    color: #c2f50e;
}

#view-screener .sc-sector-popup {
    position: absolute;
    right: auto; 
    left: 0;
    top: calc(100% + 8px); /* Butonun hemen altÄ± */
    width: 260px;
    background: linear-gradient(to bottom, #141414, #0b0b0b);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 16px;
    box-shadow: 0 18px 60px rgba(0,0,0,0.65);
    z-index: 9999;
    overflow: hidden;
    display: none;
}
#view-screener .sc-sector-head {
    display: flex; align-items: center; justify-content: space-between;
    padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.10);
}
#view-screener .sc-sector-title { font-weight: 900; font-size: 12px; color: #fff; }
#view-screener .sc-sector-actions { display: flex; align-items: center; gap: 10px; }
#view-screener .sc-sector-clear { font-size: 11px; font-weight: 800; color: #c2f50e; background: transparent; border: 0; cursor: pointer; }
#view-screener .sc-sector-close { color: #777; cursor: pointer; font-size: 14px; }

#view-screener .sc-sector-list { max-height: 280px; overflow: auto; padding: 8px; }
#view-screener .sc-sector-item {
    padding: 10px; border-radius: 12px; cursor: pointer;
    color: #ddd; font-size: 12px; font-weight: 700; border: 1px solid transparent;
}
#view-screener .sc-sector-item:hover { background: rgba(255,255,255,0.04); }
#view-screener .sc-sector-item.active {
    background: rgba(194,245,14,0.12);
    border-color: rgba(194,245,14,0.35);
    color: #c2f50e;
}
/* --- SECTORS SEARCH BAR --- */
#view-sectors .sec-controls {
    display: flex;
    gap: 15px;
    margin-bottom: 15px;
}
#view-sectors .sec-search-box {
    flex: 1;
    position: relative;
}
#view-sectors .sec-search-input {
    width: 100%;
    background: #111;
    border: 1px solid #333;
    color: #fff;
    padding: 12px 15px 12px 38px; /* Ä°kon payÄ± */
    border-radius: 10px;
    font-size: 13px;
    outline: none;
    font-weight: 600;
}
#view-sectors .sec-search-input:focus { border-color: #c2f50e; }
#view-sectors .sec-search-icon {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: #666;
    font-size: 12px;
}
/* --- GÃ–STERGELER (INDICATORS) CSS --- */
#view-indicators {
    padding: 20px;
    background: #000;
    overflow-y: auto; /* Sayfa kaydÄ±rma */
}
#view-indicators .wrap { 
  padding: 1px; 
  width: 100%;
  max-width: none;   /* âœ… full width */
  margin: 0;         /* âœ… ortalama yok */
}


#view-indicators .table-wrapper {
  width: 100%;
  overflow: visible;
  border: 1px solid rgba(255,255,255,.08);
  border-radius: 12px;
  background: #0b0b0b;
}

#view-indicators table { width: 100%; min-width: 1150px; border-collapse: separate; border-spacing: 0;}

#view-indicators thead th{
  position: sticky;
  top: 0;
  z-index: 500;

  /* âœ… Sticky bug fix */
  background: transparent !important;

  color: rgba(255,255,255,.6);
  font-size: 11px;
  text-transform: uppercase;
  text-align: right;
  padding: 16px 12px;
  border-bottom: 1px solid rgba(255,255,255,0.10);

  isolation: isolate;
}
#view-indicators thead th::before{
  content:"";
  position:absolute;
  inset:0;
  background:#1a1a1a;
  box-shadow: 0 1px 0 #1a1a1a, 0 -1px 0 #1a1a1a;
  z-index:-1;
}


#view-indicators thead th:first-child{
  left: 0;
  z-index: 600;
  text-align: left;
}
#view-indicators thead th:first-child::before{
  box-shadow: 0 1px 0 #1a1a1a, 0 -1px 0 #1a1a1a, 1px 0 0 #1a1a1a;
}



#view-indicators tbody td:first-child { 
  position: sticky; left: 0; z-index: 90; 
  background: #0b0b0b; text-align: left;
  border-right: 1px solid rgba(255,255,255,0.1);
}

#view-indicators tbody td { 
  padding: 14px 12px; border-bottom: 1px solid rgba(255,255,255,.06); 
  text-align: right; font-size: 14px; vertical-align: middle; white-space: nowrap; 
}

/* Renkler ve Linkler */
#view-indicators .pos { color: #c2f50e; } 
#view-indicators .neg { color: #ff5a5a; }
#view-indicators .muted { color: rgba(255,255,255,0.45); }
#view-indicators .company-link { text-decoration: none; color: inherit; }
#view-indicators .company-link:hover .company-name { color: #c2f50e; }
#view-indicators .small-label { font-size: 11px; display: block; margin-top: 4px; color: rgba(255,255,255,0.3); font-weight: normal; }

/* Ä°konlar */
/* Grup SatÄ±rÄ± Stilleri */
#view-indicators .group-row {
    background: rgba(255, 255, 255, 0.05) !important;
    cursor: pointer;
}
#view-indicators .group-row td {
    padding: 12px 15px !important;
    font-weight: 800;
    color: var(--finapsis-neon);
    text-transform: uppercase;
    font-size: 12px;
    letter-spacing: 1px;
}
#view-indicators .group-caret {
    transition: transform 0.2s;
    margin-right: 10px;
}
#view-indicators .group-row.collapsed .group-caret {
    transform: rotate(-90deg);
}
#view-indicators .indicator-icon {
    width: 40px;
    height: 40px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    margin-right: 12px;
    text-align: center;
    transition: all 0.2s;
}
#view-indicators .icon-up { color: #c2f50e; border-color: rgba(194, 245, 14, 0.3); background: rgba(194, 245, 14, 0.05); }
#view-indicators .icon-down { color: #ff5a5a; border-color: rgba(255, 90, 90, 0.3); background: rgba(255, 90, 90, 0.05); }

#view-indicators .company-cell { display: flex; align-items: center; gap: 12px; }
#view-indicators .company-name { font-weight: 600; font-size: 14px; color: #eee; transition: 0.2s; }
#view-indicators .date-sub { font-size: 11px; color: rgba(255,255,255,0.4); margin-top: 2px; }

/* Mobil */
@media screen and (max-width: 768px) {
  #view-indicators .table-wrapper { border: none !important; }
  #view-indicators table { display: block !important; width: 100% !important; min-width: 0 !important; }
  #view-indicators thead { display: none !important; }
  #view-indicators tbody { display: block !important; width: 100% !important; }
  #view-indicators tbody tr { 
    display: block !important; margin-bottom: 20px; 
    background: #0f0f0f; border-radius: 16px; 
    border: 1px solid rgba(255,255,255,0.08); padding: 15px; 
  }
  #view-indicators tbody td { 
    display: flex !important; justify-content: space-between; align-items: center; 
    width: 100% !important; padding: 10px 0 !important; 
    position: static !important; background: transparent !important; 
    border-bottom: 1px solid rgba(255,255,255,0.05); white-space: normal !important; 
  }
  #view-indicators tbody td:first-child { 
    border-bottom: 2px solid #c2f50e !important; margin-bottom: 10px; padding-bottom: 15px !important; justify-content: flex-start !important;
  }
  #view-indicators tbody td:last-child { border-bottom: none !important; }
  
  #view-indicators tbody td:nth-child(2)::before { content: "Son DeÄŸer"; }
  #view-indicators tbody td:nth-child(3)::before { content: "Ã–nceki"; }
  #view-indicators tbody td:nth-child(4)::before { content: "DeÄŸiÅŸim (Ã–nceki)"; }
  #view-indicators tbody td:nth-child(5)::before { content: "DeÄŸiÅŸim (YTD)"; }
  #view-indicators tbody td:nth-child(6)::before { content: "DeÄŸiÅŸim (12 Ay)"; }
  
  #view-indicators tbody td:not(:first-child)::before {
    font-size: 11px; color: rgba(255,255,255,0.4); 
    text-transform: uppercase; font-weight: 500; margin-right: 15px;
  }
}
/* --- CALENDAR LIST VIEW CSS (FIXED) --- */
#view-calendar-list {
    padding: 20px; /* âœ… diÄŸerleriyle aynÄ±: full width hissi */
    background: #000;
    overflow-y: auto;
}

#view-calendar-list .wrap {
  width: 100%;            /* âœ… kesin full width */
  padding: 1px;
  margin: 0;
  max-width: none;
  box-sizing: border-box;
}


#view-calendar-list .table-wrapper { 
  width: 100%;
  overflow: visible;
  border: 1px solid rgba(255,255,255,.08);
  border-radius: 12px;
  background: #0b0b0b;
}


/* Tablo AyarlarÄ± */
/* --- CALENDAR LIST TABLO STÄ°LLERÄ° (DÃœZELTÄ°LDÄ°) --- */
#view-calendar-list table { 
  width: 100%; 
  min-width: 1100px; 
  border-collapse: separate; /* Sticky iÃ§in ÅŸart */
  border-spacing: 0; 
}

/* HEADER HÃœCRELERÄ° */
#view-calendar-list thead th { 
  position: sticky; 
  top: 0; 
  z-index: 500;

  /* âœ… Sticky bug fix: gerÃ§ek zemin ::before ile Ã§izilecek */
  background: transparent !important;

  color: rgba(255,255,255,.6); 
  font-size: 11px; 
  text-transform: uppercase; 
  text-align: right; 
  padding: 16px 12px; 
  border-bottom: 1px solid rgba(255,255,255,0.10);

  /* âœ… boyama hatalarÄ±nÄ± keser */
  isolation: isolate;
}
#view-calendar-list thead th::before{
  content:"";
  position:absolute;
  inset:0;
  background:#1a1a1a;
  box-shadow: 0 1px 0 #1a1a1a, 0 -1px 0 #1a1a1a;
  z-index:-1;
}


#view-calendar-list thead th:first-child { 
  left: 0; 
  z-index: 600; 
  text-align: left;
  border-right: 1px solid rgba(255,255,255,0.10);
}
#view-calendar-list thead th:first-child::before{
  box-shadow: 0 1px 0 #1a1a1a, 0 -1px 0 #1a1a1a, 1px 0 0 #1a1a1a;
}


/* SOL SÃœTUN (Sadece sola sticky) */
#view-calendar-list tbody td:first-child { 
  position: sticky; 
  left: 0; 
  z-index: 90; 
  background-color: #0b0b0b !important; /* Arka plan ÅŸart */
  text-align: left; 
  border-right: 1px solid rgba(255,255,255,0.1); 
}

/* DÄ°ÄžER HÃœCRELER */
#view-calendar-list tbody td { 
  padding: 14px 12px; 
  border-bottom: 1px solid rgba(255,255,255,.06); 
  text-align: right; 
  font-size: 14px; 
  vertical-align: middle; 
  white-space: nowrap; 
}


#view-calendar-list tbody td:first-child { 
  position: sticky; left: 0; z-index: 90; background: #0b0b0b; 
  text-align: left; border-right: 1px solid rgba(255,255,255,0.1); 
}
#view-calendar-list tbody td { 
  padding: 14px 12px; border-bottom: 1px solid rgba(255,255,255,.06); 
  text-align: right; font-size: 14px; vertical-align: middle; white-space: nowrap; 
}

#view-calendar-list .pos { color: #c2f50e; }
#view-calendar-list .muted { color: rgba(255,255,255,0.45); }
#view-calendar-list .company-cell { display: flex; align-items: center; gap: 12px; }
#view-calendar-list .data-name { font-weight: 600; font-size: 14px; color: #eee; }
#view-calendar-list .date-sub { font-size: 11px; color: rgba(255,255,255,0.4); margin-top: 2px; }
#view-calendar-list .flag-img { width: 22px; border-radius: 2px; }

/* Bildirim Butonu */
#view-calendar-list .notify-btn { 
  background: none; border: none; cursor: pointer; padding: 8px; border-radius: 6px; 
  transition: 0.2s; color: rgba(255,255,255,0.3); 
}
#view-calendar-list .notify-btn:hover:not(:disabled) { background: rgba(194, 245, 14, 0.1); color: #c2f50e; }
#view-calendar-list .notify-btn:disabled { cursor: not-allowed; opacity: 0.2; }
/* --- CALENDAR LIST FILTER TOOLBAR --- */
#view-calendar-list .cal-filter-bar {
    display: flex; flex-wrap: wrap; gap: 12px; align-items: center;
    margin-bottom: 16px; padding: 12px; background: #111; 
    border: 1px solid #222; border-radius: 12px;
}
#view-calendar-list .cal-filter-group {
    display: flex; gap: 4px; align-items: center;
    border-right: 1px solid #333; padding-right: 12px;
}
#view-calendar-list .cal-filter-group:last-child { border-right: none; }

/* Zaman HaplarÄ± (Pills) */
#view-calendar-list .cal-pill {
    padding: 6px 10px; border-radius: 6px; font-size: 11px; font-weight: 700;
    color: #888; background: transparent; border: 1px solid transparent; cursor: pointer;
    transition: 0.2s; white-space: nowrap;
}
#view-calendar-list .cal-pill:hover { color: #fff; background: rgba(255,255,255,0.05); }
#view-calendar-list .cal-pill.active { background: rgba(194,245,14,0.15); color: #c2f50e; border-color: rgba(194,245,14,0.3); }

/* Ä°kon ButonlarÄ± (Flag & Bolt) */
#view-calendar-list .cal-icon-btn {
    width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
    border-radius: 8px; border: 1px solid #333; background: #1a1a1a; cursor: pointer; opacity: 0.6; transition: 0.2s;
}
#view-calendar-list .cal-icon-btn img { width: 18px; border-radius: 2px; }
#view-calendar-list .cal-icon-btn svg { width: 14px; fill: #888; }
#view-calendar-list .cal-icon-btn:hover { opacity: 1; border-color: #555; }
#view-calendar-list .cal-icon-btn.active { opacity: 1; border-color: #c2f50e; background: rgba(194,245,14,0.05); box-shadow: 0 0 10px rgba(194,245,14,0.1); }
#view-calendar-list .cal-icon-btn.active svg { fill: #c2f50e; }
/* YENÄ°: YÄ±ldÄ±rÄ±m Derecelendirme BarÄ± */
#view-calendar-list .cal-impact-rating {
    display: flex; align-items: center; gap: 2px;
    background: #1a1a1a; border: 1px solid #333;
    padding: 6px 10px; border-radius: 8px; cursor: pointer;
}
#view-calendar-list .cal-impact-item {
    width: 14px; height: 14px; fill: #444; transition: 0.2s;
}
#view-calendar-list .cal-impact-item:hover { fill: #666; }

/* Aktiflik DurumlarÄ± */
#view-calendar-list .cal-impact-rating[data-level="1"] .cal-impact-item:nth-child(1) { fill: #c2f50e; }

#view-calendar-list .cal-impact-rating[data-level="2"] .cal-impact-item:nth-child(1),
#view-calendar-list .cal-impact-rating[data-level="2"] .cal-impact-item:nth-child(2) { fill: #c2f50e; }

#view-calendar-list .cal-impact-rating[data-level="3"] .cal-impact-item:nth-child(-n+3) { fill: #c2f50e; }


/* Search Box (En saÄŸa itmek iÃ§in margin-left auto) */
#view-calendar-list .cal-search-wrap { margin-left: auto; position: relative; width: auto; flex: 1 1 auto; }
#view-calendar-list .cal-search-input {
    width: 100%; background: #000; border: 1px solid #333; color: #fff;
    padding: 8px 10px 8px 34px; border-radius: 8px; font-size: 12px; outline: none;
}
#view-calendar-list .cal-search-input:focus { border-color: #c2f50e; }
#view-calendar-list .cal-search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #666; font-size: 12px; }

@media (max-width: 1000px) {
    #view-calendar-list .cal-filter-bar { gap: 10px; }
    #view-calendar-list .cal-filter-group { border-right: none; flex-wrap: wrap; }
    #view-calendar-list .cal-search-wrap { width: 100%; margin-left: 0; order: -1; margin-bottom: 5px; }
}

/* MODAL (Global Overlay) */
#calListModalOverlay { 
  position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); 
  display: none; align-items: center; justify-content: center; z-index: 9999; 
}
#calListModalContent { 
  background: #161616; width: 90%; max-width: 400px; padding: 24px; 
  border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); 
}
#calListModalContent .modal-title { font-size: 18px; margin-bottom: 16px; font-weight: 600; color:#fff; }
#calListModalContent .input-group { margin-bottom: 12px; }
#calListModalContent .input-group label { display: block; font-size: 12px; color: #aaa; margin-bottom: 6px; }
#calListModalContent .input-group input { 
  width: 100%; background: #222; border: 1px solid #333; padding: 10px; 
  border-radius: 8px; color: #fff; box-sizing: border-box; outline:none; 
}
#calListModalContent .check-group { display: flex; gap: 10px; font-size: 12px; color: #aaa; margin-top: 10px; line-height: 1.4; }
#calListModalContent .check-group input { margin-top: 3px; }
#calListModalContent .submit-btn { 
  width: 100%; background: #c2f50e; color: #000; border: none; padding: 12px; 
  border-radius: 8px; font-weight: 700; margin-top: 20px; cursor: pointer; 
  opacity: 0.5; transition: 0.3s; 
}
#calListModalContent .submit-btn:not(:disabled) { opacity: 1; }

@media (max-width: 768px) {
  #view-calendar-list .table-wrapper { border: none !important; }
  #view-calendar-list table { display: block !important; width: 100% !important; min-width: 0 !important; }
  #view-calendar-list thead { display: none !important; }
  #view-calendar-list tbody { display: block !important; width: 100% !important; }
  #view-calendar-list tbody tr { 
    display: block !important; margin-bottom: 20px; background: #0f0f0f; 
    border-radius: 16px; border: 1px solid rgba(255,255,255,0.08); padding: 15px; 
  }
  #view-calendar-list tbody td { 
    display: flex !important; justify-content: space-between; align-items: center; 
    width: 100% !important; padding: 10px 0 !important; position: static !important; 
    background: transparent !important; border-bottom: 1px solid rgba(255,255,255,0.05); 
    white-space: normal !important; 
  }
  #view-calendar-list tbody td:first-child { 
    border-bottom: 2px solid #c2f50e !important; margin-bottom: 10px; 
    padding-bottom: 15px !important; justify-content: flex-start !important; 
  }
  #view-calendar-list tbody td:last-child { border-bottom: none !important; }
  
  #view-calendar-list tbody td:nth-child(2)::before { content: "Etki"; color:#777; font-size:11px; font-weight:600; text-transform:uppercase; }
  #view-calendar-list tbody td:nth-child(3)::before { content: "Beklenen"; color:#777; font-size:11px; font-weight:600; text-transform:uppercase; }
  #view-calendar-list tbody td:nth-child(4)::before { content: "GerÃ§ekleÅŸen"; color:#777; font-size:11px; font-weight:600; text-transform:uppercase; }
  #view-calendar-list tbody td:nth-child(5)::before { content: "Ã–nceki"; color:#777; font-size:11px; font-weight:600; text-transform:uppercase; }
  #view-calendar-list tbody td:nth-child(6)::before { content: "HatÄ±rlat"; color:#777; font-size:11px; font-weight:600; text-transform:uppercase; }
}
/* =========================================================
   FINAL STICKY FIX (TAKVÄ°M + GÃ–STERGELER) - DOKUNMA
   ========================================================= */

/* 1) Scroll artÄ±k wrapper'da olacak (parent scroll bug'Ä±nÄ± bitirir) */
#view-calendar-list.active,
#view-indicators.active{
  /* â— display YOK: tab sistemi zaten active olunca display:flex yapÄ±yor */
  height: 100% !important;
  min-height: 0 !important;
  overflow: hidden !important;  /* âœ… parent scroll kapalÄ± kalsÄ±n */
}


#view-calendar-list.active .wrap,
#view-indicators.active .wrap{
  flex: 1 !important;
  min-height: 0 !important;
  display: flex !important;
  flex-direction: column !important;
}


/* âœ… AsÄ±l scroll container */
#view-calendar-list .table-wrapper,
#view-indicators .table-wrapper{
  flex: 1 !important;
  min-height: 0 !important;
  overflow: auto !important;    /* âœ… scroll burada */
  position: relative !important;
  background: #0b0b0b !important;

  /* âœ… Chrome sticky repaint bug azaltÄ±r */
  contain: paint !important;
  -webkit-overflow-scrolling: touch;
}

/* 2) Eski ::before "hack"lerini tamamen devre dÄ±ÅŸÄ± bÄ±rak (Ã§akÄ±ÅŸmayÄ± bitirir) */
#view-calendar-list thead th::before,
#view-indicators thead th::before{
  content: none !important;
}

/* 3) Sticky header'Ä± tek ve opak hale getir */
#view-calendar-list thead th,
#view-indicators thead th{
  position: sticky !important;
  top: 0 !important;
  z-index: 2000 !important;

  /* âœ… Opak zemin */
  background-color: #1a1a1a !important;
  background-clip: padding-box !important;

  /* âœ… repaint/stacking iyileÅŸtirme */
  transform: translateZ(0) !important;
  will-change: transform !important;
  backface-visibility: hidden !important;

  /* satÄ±r sÄ±zÄ±ntÄ±sÄ± olmasÄ±n */
  box-shadow: 0 1px 0 #1a1a1a !important;
}

/* Sol-Ã¼st header hÃ¼cresi (hem top hem left sticky) */
#view-calendar-list thead th:first-child,
#view-indicators thead th:first-child{
  left: 0 !important;
  z-index: 2100 !important;
  text-align: left !important;
  box-shadow: 0 1px 0 #1a1a1a, 1px 0 0 #1a1a1a !important;
}

/* Sol sÃ¼tun (tbody) sticky */
#view-calendar-list tbody td:first-child,
#view-indicators tbody td:first-child{
  position: sticky !important;
  left: 0 !important;
  z-index: 1500 !important;
  background: #0b0b0b !important;
}

   /* =========================================
       âœ… SCREENER BADGE UI (DÃœZELTÄ°LMÄ°Åž & TEK PARÃ‡A)
       ========================================= */
    .sc-badge-area {
        display: flex;
        gap: 10px;
        padding: 15px 0 20px 0; /* Header ile grid arasÄ± boÅŸluk */
        flex-wrap: wrap;
        align-items: center;
        position: relative;
        z-index: 50; /* Popup'Ä±n kesilmemesi iÃ§in */
        min-height: 40px; /* Ä°Ã§erik gelmeden Ã¶nce zÄ±plamayÄ± Ã¶nler */
    }

    .sc-badge {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #ddd;
        padding: 12px 16px;
        border-radius: 10px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        user-select: none;
        transition: all 0.2s ease;
        position: relative; /* Popup iÃ§in referans */
    }

    .sc-badge:hover {
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(255, 255, 255, 0.3);
        transform: translateY(-1px);
        color: #fff;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    /* Borsa (BIST/NYSE) Badge'i Ã–zel Stil */
    .sc-badge.market-badge {
        background: rgba(194, 245, 14, 0.1);
        border-color: rgba(194, 245, 14, 0.3);
        color: #c2f50e;
    }
    .sc-badge.market-badge:hover {
        background: rgba(194, 245, 14, 0.2);
        box-shadow: 0 4px 15px rgba(194, 245, 14, 0.15);
    }

    /* SÄ±fÄ±rla Butonu */
    .sc-badge.reset-btn {
        background: rgba(255, 77, 77, 0.1);
        border-color: rgba(255, 77, 77, 0.3);
        color: #ff4d4d;
        margin-left: auto; /* En saÄŸa yasla */
    }
    .sc-badge.reset-btn:hover {
        background: rgba(255, 77, 77, 0.2);
    }

    /* Badge iÃ§indeki Kapatma (X) butonu */
    .sc-badge-close {
        padding: 4px;
        margin-right: -6px;
        border-radius: 4px;
        color: rgba(255,255,255,0.5);
        transition: 0.2s;
    }
    .sc-badge-close:hover {
        background: rgba(255, 77, 77, 0.2);
        color: #ff4d4d;
    }

    /* --- MARKET & SECTOR POPUP MENU --- */
    .sc-market-popup {
        position: absolute;
        top: calc(100% + 8px); /* Badge'in tam altÄ± */
        left: 0;
        background: #111;
        border: 1px solid #333;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.9);
        z-index: 10000;
        display: none;
        overflow: hidden;
        min-width: 160px;
        animation: fadeIn 0.2s ease;
    }

    .sc-market-item {
        padding: 12px 16px;
        color: #aaa;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        border-bottom: 1px solid #222;
        transition: 0.2s;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .sc-market-item:last-child { border-bottom: none; }
    .sc-market-item:hover { background: #1a1a1a; color: #fff; }
    .sc-market-item.active { color: #c2f50e; background: rgba(194, 245, 14, 0.05); }
    /* Tik iÅŸareti iÃ§in */
    .sc-market-item.active::after { content: 'âœ“'; font-weight: 900; }
    /* --- COMPANIES LIST TOOLBAR (YENÄ°) --- */
    #view-companies .top-controls {
        position: sticky; top: 0; z-index: 2000; background: #000; padding: 10px 0;
        border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 0;
    }

    .cl-control-bar {
        display: flex; gap: 15px; align-items: center;
    }

    /* Arama Kutusu */
    .cl-search-wrap {
        position: relative; 
        flex: 1; 
        max-width: none; /* KÄ±sÄ±tlamayÄ± kaldÄ±r */
    }
    .cl-search-input {
        width: 100%; background: #111; border: 1px solid #333; color: #fff;
        padding: 10px 10px 10px 36px; border-radius: 10px; font-size: 13px; outline: none;
        transition: 0.2s;
    }
    .cl-search-input:focus { border-color: #c2f50e; background: #161616; }
    .cl-search-icon {
        position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
        color: #666; font-size: 12px;
    }

    /* Badge AlanÄ± */
    .cl-badge-area {
        display: flex; gap: 10px; align-items: center; flex: 0 0 auto;
    }

    /* Badge Stili (Screener ile uyumlu) */
    .cl-badge {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.12);
        color: #ccc;
        padding: 10px 16px; /* Biraz daha dolgun */
        border-radius: 10px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        cursor: pointer;
        display: flex; 
        align-items: center; 
        justify-content: space-between; /* Ä°kon ve yazÄ± arasÄ±nÄ± aÃ§ */
        gap: 12px;
        transition: all 0.2s;
        position: relative;
        user-select: none;
        min-width: 180px; /* âœ… Sabit geniÅŸlik (Daha tok durur) */
    }
    .cl-badge:hover { background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.3); color: #fff; }
    
    .cl-badge.active {
        background: rgba(194, 245, 14, 0.1);
        border-color: rgba(194, 245, 14, 0.3);
        color: #c2f50e;
    }

    .cl-badge.disabled {
        opacity: 0.4; pointer-events: none; filter: grayscale(1);
    }

    /* --- Companies List Market Badge --- */
    .cl-badge.market-badge {
        background: rgba(194, 245, 14, 0.1);
        border-color: rgba(194, 245, 14, 0.3);
        color: #c2f50e;
    }
    .cl-badge.market-badge:hover {
        background: rgba(194, 245, 14, 0.2);
        box-shadow: 0 4px 15px rgba(194, 245, 14, 0.15);
    }

    /* Popup MenÃ¼ (Ortak Stil) */
    .cl-popup-menu {
        position: absolute; top: calc(100% + 6px); left: 0;
        width: 240px; background: #111; border: 1px solid #333;
        border-radius: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.8);
        z-index: 9999; display: none; overflow: hidden;
    }
    .cl-popup-search {
        padding: 8px; border-bottom: 1px solid #222;
    }
    .cl-popup-input {
        width: 100%; background: #1a1a1a; border: 1px solid #333; color: #fff;
        padding: 8px; border-radius: 6px; font-size: 12px; outline: none;
    }
    .cl-popup-list {
        max-height: 250px; overflow-y: auto; padding: 4px 0;
    }
    .cl-popup-item {
        padding: 8px 12px; font-size: 12px; color: #aaa; cursor: pointer; font-weight: 600;
    }
    .cl-popup-item:hover { background: #1f1f1f; color: #fff; }
    .cl-popup-item.selected { color: #c2f50e; background: rgba(194, 245, 14, 0.05); }
    /* --- SECTORS TREE VIEW --- */
    /* Seviye 1: SektÃ¶r (Ana SatÄ±r) */
    tr.sec-row-level-1 td {
        background: #0b0b0b;
        font-weight: 700;
        border-bottom: 2px solid rgba(255,255,255,0.08);
    }
    tr.sec-row-level-1:hover td { background: rgba(255,255,255,0.02); }

    /* Seviye 2: Alt SektÃ¶r (Industry) */
    tr.sec-row-level-2 td {
        background: #111; 
        color: #ddd;
    }
    tr.sec-row-level-2 td:first-child {
        padding-left: 40px !important; /* Girinti */
        position: sticky; left: 0; z-index: 110;
        background: #111;
        border-right: 1px solid rgba(255,255,255,0.05);
    }

    /* Seviye 3: Åžirket */
    tr.sec-row-level-3 td {
        background: #161616;
        color: #aaa;
        font-size: 12px;
    }
    tr.sec-row-level-3 td:first-child {
        padding-left: 70px !important; /* Daha fazla girinti */
        position: sticky; left: 0; z-index: 110;
        background: #161616;
        border-right: 1px solid rgba(255,255,255,0.05);
    }
    
    /* Caret Ä°konu */
    .sec-caret {
        display: inline-block;
        width: 16px; 
        text-align: center;
        margin-right: 8px;
        transition: transform 0.2s;
        cursor: pointer;
        color: #666;
    }
    .sec-caret:hover { color: #fff; }
    
    /* AÃ§Ä±k Durumda Caret DÃ¶nÃ¼ÅŸÃ¼ */
    .sec-expanded .sec-caret {
        transform: rotate(90deg);
        color: #c2f50e;
    }

    /* Åžirket Logosu */
    .sec-comp-logo {
        width: 18px; height: 18px; object-fit: contain; 
        background: #fff; border-radius: 4px; padding: 1px;
        margin-right: 8px; vertical-align: middle;
    }
    /* Mobil Uyum */
    @media (max-width: 768px) {
        .cl-control-bar { flex-direction: column; align-items: stretch; }
        .cl-search-wrap { max-width: 100%; }
        .cl-badge-area { overflow-x: auto; padding-bottom: 5px; }
    }
    /* --- SECTORS TOOLBAR (TEK SATIR) --- */
    .sec-toolbar {
        display: flex;
        gap: 12px;
        align-items: center;
        margin-bottom: 20px;
        position: sticky; /* Tablo kayarken Ã¼stte sabit kalsÄ±n */
        top: 0;
        z-index: 2000;
        background: #000; /* Arkadan yazÄ± geÃ§mesin */
        padding: 10px 0;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    /* Arama KutularÄ± */
    .sec-search-box {
        flex: 1; /* Kalan alanÄ± eÅŸit paylaÅŸsÄ±nlar */
        position: relative;
    }

    .sec-search-input {
        width: 100%;
        background: #111;
        border: 1px solid #333;
        color: #fff;
        padding: 10px 10px 10px 34px;
        border-radius: 10px;
        font-size: 13px;
        outline: none;
        font-weight: 600;
        transition: 0.2s;
    }
    .sec-search-input:focus {
        border-color: #c2f50e;
        background: #161616;
    }

    .sec-search-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #666;
        font-size: 12px;
    }

    /* Mobil Uyum: Mobilde alt alta geÃ§sinler */
    @media (max-width: 900px) {
        .sec-toolbar {
            flex-direction: column;
            align-items: stretch;
            position: static; /* Mobilde Ã§ok yer kaplamasÄ±n */
        }
        #secBadgeArea {
            justify-content: center;
            margin-bottom: 5px !important;
        }
    }

    /* =========================
   INDICATORS: group badges
   (sc-badge ile karÄ±ÅŸmasÄ±n)
   ========================= */
.ind-badge{
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid rgba(255, 255, 255, 0.1);
  color: #ddd;
  padding: 12px 16px;
  border-radius: 10px;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  user-select: none;
  transition: all 0.2s ease;
}

.ind-badge:hover{
  background: rgba(255, 255, 255, 0.08);
  border-color: rgba(255, 255, 255, 0.3);
  transform: translateY(-1px);
  color: #fff;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

/* âœ… SeÃ§ili olan highlight */
.ind-badge.active{
  background: rgba(194, 245, 14, 0.10);
  border-color: rgba(194, 245, 14, 0.35);
  color: #c2f50e;
  box-shadow: 0 4px 15px rgba(194, 245, 14, 0.12);
}

.ind-badge.active:hover{
  background: rgba(194, 245, 14, 0.16);
  border-color: rgba(194, 245, 14, 0.45);
  color: #c2f50e;
}

</style>
</head>
<body>

<div id="preloader"><div class="spinner"></div></div>

<nav class="app-tabs">
    <button class="tab-btn active" onclick="switchTab('screener.html')">Skorlama</button>
    <button class="tab-btn" onclick="switchTab('companieslist.html')">Åžirketler</button>
    <button class="tab-btn" onclick="switchTab('sectors')">SektÃ¶rler</button>
    <button class="tab-btn" onclick="switchTab('diagrams')">Diyagramlar</button>
    <button class="tab-btn" onclick="switchTab('karsilastirma.html')">KarÅŸÄ±laÅŸtÄ±rma</button>
    <button class="tab-btn" onclick="switchTab('portfolio.html')">PortfÃ¶y</button>
    <button class="tab-btn" onclick="switchTab('detail')">VarlÄ±k Detay</button>
    <button class="tab-btn" onclick="switchTab('indicators')">GÃ¶stergeler</button>
    <button class="tab-btn" onclick="switchTab('calendarlist')">Takvim</button>
</nav>


<div id="view-screener" class="view-section active">
    <div class="finapsis-master">
    
        <div id="scActiveFiltersArea" class="sc-badge-area"></div>

        <div class="main-grid">
            <aside class="glass-panel">
                <div class="panel-header">
                    <div class="search-box">
                        <i class="fa-solid fa-search text-[10px]"></i>
                        <input type="text" id="metric-search" placeholder="METRÄ°K ARA..." onkeyup="filterMetrics()">
                    </div>
                </div>
                <div id="metrics-pool" class="metric-list custom-scroll"></div>
            </aside>
    
            <main class="content-area">
                <div class="drop-zone-container">
                    <div style="font-size:10px; font-weight:700; color:var(--text-muted); margin-bottom:12px; text-transform:uppercase; letter-spacing:0.5px; display:flex; justify-content:space-between;">
                        <span>Aktif Filtreler</span>
                        <span style="font-size:9px; opacity:0.5; font-weight:400;">SÃ¼rÃ¼kle & BÄ±rak</span>
                    </div>
                    <div id="active-criteria" class="drop-zone-target"></div>
                </div>
    
                <div class="table-panel">
                    <div class="table-scroll">
                        <table>
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>ÅžÄ°RKET</th>
                                    <th>SEKTÃ–R</th>
                                    <th style="text-align:center;">SKOR</th>
                                    <th style="text-align:right;">DETAYLAR (<span id="comp-label">SEKTÃ–R</span> / <span id="calc-label">MEDYAN</span>)</th>
                                </tr>
                            </thead>
                            <tbody id="screener-results-body"></tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>
</div>

<div id="view-companies" class="view-section">
   <div class="top-controls">
        <div class="cl-control-bar">
            <div class="cl-search-wrap">
                <i class="fa-solid fa-magnifying-glass cl-search-icon"></i>
                <input type="text" id="mainSearch" class="cl-search-input" placeholder="Åžirket ara..." oninput="applyMainSearch(this)">
            </div>

            <div id="clFilterBadges" class="cl-badge-area"></div>
        </div>
    </div>
    
      <div class="table-wrapper" id="fin-container">
        <table>
          <thead id="cl-thead">
            <tr>
              <th data-key="name">Åžirket</th>
              <th data-key="price" style="text-align:right;">Fiyat</th>
              <th data-key="Piyasa DeÄŸeri">Piyasa DeÄŸeri</th>
              <th data-key="Firma DeÄŸeri">Firma DeÄŸeri</th>
              <th data-key="SatÄ±ÅŸ Gelirleri">Gelirler (Son 12 Ay)</th>
              <th data-key="BrÃ¼t Kar MarjÄ±">BrÃ¼t Kar MarjÄ±</th>
              <th data-key="Faaliyet KÃ¢r MarjÄ±">Faaliyet KÃ¢r MarjÄ±</th>
              <th data-key="Cari Oran">Cari Oran</th>
              <th data-key="Asit Test OranÄ±">Asit Test OranÄ±</th>
              <th data-key="BorÃ§/Ã–z Kaynak">BorÃ§/Ã–z Kaynak</th>
              <th data-key="Nakit DÃ¶ngÃ¼sÃ¼">Nakit DÃ¶ngÃ¼sÃ¼</th>
              <th data-key="Stok Devir HÄ±zÄ±">Stok Devir HÄ±zÄ±</th>
              <th data-key="Stok SÃ¼resi">Stok SÃ¼resi</th>
              <th data-key="Alacak Devir HÄ±zÄ±">Alacak Devir HÄ±zÄ±</th>
              <th data-key="Alacak SÃ¼resi">Alacak SÃ¼resi</th>          
              <th data-key="BorÃ§ Devir HÄ±zÄ±">BorÃ§ Devir HÄ±zÄ±</th>
              <th data-key="BorÃ§ SÃ¼resi">BorÃ§ SÃ¼resi</th>    
              <th data-key="ROIC">ROIC</th>
              <th data-key="ROA">ROA</th>
              <th data-key="ROE">ROE</th>
              <th data-key="PD/DD">PD/DD</th>
              <th data-key="F/K">F/K</th>
              <th data-key="Fiyat/SatÄ±ÅŸlar">Fiyat/SatÄ±ÅŸlar</th>
            </tr>
          </thead>
          <tbody id="cl-tbody"></tbody>
        </table>
        <div id="clSentinel" style="height:1px;"></div>
      </div>
</div>
<div id="view-sectors" class="view-section">
 <div class="wrap sec-wrap" style="flex-direction:column;">
    
    <div class="sec-toolbar">
        
        <div id="secBadgeArea" class="sc-badge-area" style="padding:0; min-height:auto; margin:0;"></div>

        <div class="sec-search-box">
            <i class="fa-solid fa-magnifying-glass sec-search-icon"></i>
            <input type="text" id="secSearchCompany" class="sec-search-input" 
                   placeholder="Åžirket ara (Ã¶rn: THYAO)..." 
                   oninput="secFindSectorByCompany(this.value)">
        </div>

        <div class="sec-search-box">
            <i class="fa-solid fa-filter sec-search-icon"></i>
            <input type="text" id="secSearchName" class="sec-search-input" 
                   placeholder="SektÃ¶r filtrele..." 
                   oninput="secFilterTable(this.value)">
        </div>

    </div>
    
    <div class="table-wrapper" id="sec-height-wrapper">
      <table>
        <thead id="sec-thead">
          <tr>
            <th data-key="name" style="display:flex; align-items:center; gap:8px;">
    <i id="secMasterCaret" class="fa-solid fa-chevron-right sec-caret" 
       style="cursor:pointer; width:16px; text-align:center;" 
       onclick="secToggleAllRows(event)"></i>
    <span>SektÃ¶r / Åžirket</span>
</th>
            <th data-key="Piyasa DeÄŸeri">Piyasa DeÄŸeri</th>
            <th data-key="Firma DeÄŸeri">Firma DeÄŸeri</th>
            <th data-key="BrÃ¼t Kar MarjÄ±">BrÃ¼t Kar MarjÄ±</th>
            <th data-key="Faaliyet KÃ¢r MarjÄ±">Faaliyet MarjÄ±</th>
            <th data-key="Cari Oran">Cari Oran</th>
            <th data-key="Asit Test OranÄ±">Asit Test OranÄ±</th>
            <th data-key="BorÃ§/Ã–z Kaynak">BorÃ§/Ã–zkaynak</th>
            <th data-key="Nakit DÃ¶ngÃ¼sÃ¼">Nakit DÃ¶ngÃ¼sÃ¼</th>
            <th data-key="Stok Devir HÄ±zÄ±">Stok Devir HÄ±zÄ±</th>
            <th data-key="Stok SÃ¼resi">Stok SÃ¼resi</th>
            <th data-key="Alacak Devir HÄ±zÄ±">Alacak Devir HÄ±zÄ±</th>
            <th data-key="Alacak SÃ¼resi">Alacak SÃ¼resi</th>
            <th data-key="BorÃ§ Devir HÄ±zÄ±">BorÃ§ Devir HÄ±zÄ±</th>
            <th data-key="BorÃ§ SÃ¼resi">BorÃ§ SÃ¼resi</th>
            <th data-key="ROIC">ROIC</th>
            <th data-key="ROA">ROA</th>
            <th data-key="ROE">ROE</th>
          </tr>
        </thead>
        <tbody id="sec-tbody"></tbody>
      </table>
    </div>
  </div>
</div>
<div id="view-diagrams" class="view-section">
  <div class="dg-container" id="dg-height-wrapper">

    <div id="dgBadgeArea" class="sc-badge-area" style="padding:0; margin-bottom:20px;"></div>

    <div class="dg-main-layout">
      <div class="dg-chart-container">
        <canvas id="matrixChart"></canvas>
      </div>

      <div class="dg-sidebar-panel">
        <h4><i class="fa-solid fa-circle-info"></i> Analiz Rehberi</h4>
        <div id="interp-content">Analiz seÃ§tiÄŸinizde burasÄ± gÃ¼ncellenecektir...</div>
      </div>
    </div>

  </div>
</div>


<div id="view-compare" class="view-section">
  <div id="cmp-preloader" style="position:fixed; inset:0; z-index:99999; display:none; align-items:center; justify-content:center; background:#000;">
    <div class="cmp-spinner" style="width:40px;height:40px;border:3px solid rgba(194,245,14,.1);border-top:3px solid #c2f50e;border-radius:50%;animation:cmpSpin 1s linear infinite"></div>
  </div>

  <div class="cmp-main-container" id="cmpHeightWrapper">

    <div class="cmp-search-section">
      
      <div class="cmp-toolbar" style="display:flex; gap:12px; align-items:center; margin-bottom:15px;">
          
          <div id="cmpMarketBadge" class="sc-badge-area" style="padding:0; margin:0; min-height:auto;"></div>

          <div class="cmp-search-wrap" style="flex:1; position:relative;">
              <i class="fa-solid fa-magnifying-glass cmp-search-icon" style="position:absolute; left:12px; top:50%; transform:translateY(-50%); color:#666; font-size:12px;"></i>
              <input type="text" id="cmpSearch" 
                     style="width:100%; background:#111; border:1px solid #333; color:#fff; padding:10px 10px 10px 34px; border-radius:10px; font-size:13px; outline:none; font-weight:600; transition:0.2s;"
                     placeholder="Åžirket ara (Ã¶rn: MGROS, THYAO...)" autocomplete="off">
              <div id="cmpSearchResults" class="cmp-search-results"></div>
          </div>

      </div>

      <div id="cmpBadgeArea" class="cmp-badge-area"></div>
    </div>

    <div class="cmp-table-wrapper">
      <table>
        <thead id="cmpThead"></thead>
        <tbody id="cmpTbody"></tbody>
      </table>
    </div>

  </div>
</div>

<div id="view-portfolio" class="view-section">
<div id="app">
  <div class="left-panel">
    <div class="header-bar">
      <div style="font-weight:700; font-size:18px; display:flex; align-items:center; gap:10px;">
         Finapsis Sanal PortfÃ¶y
      </div>
      
    </div>
    <div class="search-box" id="pfSearchBox">
  <i class="fa-solid fa-search search-icon"></i>
  <input type="text" id="searchInput" placeholder="Hisse, DÃ¶viz, Emtia ara." oninput="pfRenderMarketList()">

  <!-- âœ… SektÃ¶r filtre ikonu -->
  <button class="pf-filter-btn" id="pfSectorBtn" title="SektÃ¶r Filtrele" onclick="pfToggleSectorPopup(event)">
    <i class="fa-solid fa-filter"></i>
  </button>

  <!-- âœ… Popup (ikonun yanÄ±nda aÃ§Ä±lÄ±r) -->
  <div class="pf-sector-popup" id="pfSectorPopup" style="display:none;">
    <div class="pf-sector-head">
      <div class="pf-sector-title">SektÃ¶r</div>
      <div class="pf-sector-actions">
        <button class="pf-sector-clear" onclick="pfClearSectorFilter(event)">Temizle</button>
        <i class="fa-solid fa-xmark pf-sector-close" onclick="pfCloseSectorPopup(event)"></i>
      </div>
    </div>
    <div style="padding: 8px; border-bottom:1px solid rgba(255,255,255,0.1);">
        <input type="text" id="pfSectorSearchInput" placeholder="SektÃ¶r ara..." 
               style="width:100%; background:#1a1a1a; border:1px solid #333; color:#fff; padding:8px 10px; border-radius:8px; font-size:12px; outline:none; font-weight:600;" 
               oninput="pfFilterSectorList(this.value)" onclick="event.stopPropagation()">
    </div>
    <div class="pf-sector-list" id="pfSectorList"></div>
  </div>
</div>

    <div class="category-menu">
      <div class="cat-item active" onclick="pfSetGroup('bist', this)">BIST</div>
      <div class="cat-item" onclick="pfSetGroup('nyse', this)">NYSE</div>
      <div class="cat-item" onclick="pfSetGroup('nasdaq', this)">NASDAQ</div>
      <div class="cat-item" onclick="pfSetGroup('doviz', this)">DÃ¶viz</div>
      <div class="cat-item" onclick="pfSetGroup('emtia', this)">Emtia</div>
      <div class="cat-item" onclick="pfSetGroup('kripto', this)">Kripto</div>
    </div>
    <div class="market-list" id="marketList"></div>
  </div>
  <div class="right-panel" id="mainPanel"></div>
</div>

<!-- TRADE MODAL -->
<div class="modal-overlay" id="tradeModal">
  <div class="trade-modal">
    <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
      <h3 style="margin:0;">Ä°ÅŸlem Emri</h3>
      <i class="fa-solid fa-xmark" style="cursor:pointer; color:#666;" onclick="pfCloseTradeModal()"></i>
    </div>

    <!-- NEW: all-mode portfolio selector (hidden normally) -->
    <select id="modalPortfolioSelect" class="portfolio-select" style="min-width:100%; width:100%; margin-bottom:12px; display:none;" onchange="pfSetTradePortfolio(this.value)"></select>

    <div style="display:flex; background:#000; padding:4px; border-radius:12px; margin-bottom:15px;">
      <div id="tabBuy" class="trade-tab-btn" onclick="pfUserClickSide('buy')">AL</div>
      <div id="tabSell" class="trade-tab-btn" onclick="pfUserClickSide('sell')">SAT</div>
    </div>

    <!-- Input Mode Toggle -->
    <div style="display:flex; background:#000; padding:4px; border-radius:12px; margin-bottom:25px; border:1px solid #222;">
      <div id="modeQty" class="trade-tab-btn" onclick="pfSetInputMode('qty')">MÄ°KTAR</div>
      <div id="modeAmt" class="trade-tab-btn" onclick="pfSetInputMode('amount')">TUTAR</div>
    </div>

    <div style="display:flex; align-items:center; gap:15px; margin-bottom:25px;">
      <img id="modalImg" src="" style="width:48px; height:48px; background:#fff; border-radius:10px; padding:4px;">
      <div>
        <div id="modalTicker" style="font-weight:800; font-size:20px;">-</div>
        <div id="modalPrice" style="font-size:16px; color:var(--primary); font-weight:600;">-</div>
      </div>
    </div>

    <div style="font-size:12px; color:#888; text-align:right; margin-bottom:6px;" id="modalLimit">-</div>
    <input type="number" id="tradeQty" class="form-input" placeholder="Miktar..." oninput="pfCalcTotal()">
    <div id="tradeHint" style="font-size:11px; color:#666; margin:-6px 0 12px 0; text-align:right;"></div>

    <div style="display:flex; justify-content:space-between; padding:15px; background:#000; border-radius:12px; margin-bottom:20px; border:1px solid #222;">
      <span style="color:#888; font-size:13px;">Tahmini Tutar</span>
      <div style="text-align:right;">
        <span id="tradeTotal" style="font-weight:700; font-size:15px; display:block;">0.00</span>
        <span id="tradeTotalTry" style="font-size:11px; color:#666; display:block;"></span>
      </div>
    </div>
    <button id="btnConfirmTrade" class="btn btn-primary" style="width:100%;" disabled onclick="pfSubmitTrade()">EMRÄ° GÃ–NDER</button>
  </div>
</div>

<!-- TRANSFER (VIRMAN) MODAL -->
<div class="modal-overlay" id="transferModal">
  <div class="trade-modal">
    <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
      <h3 style="margin:0;">Virman</h3>
      <i class="fa-solid fa-xmark" style="cursor:pointer; color:#666;" onclick="pfCloseTransferModal()"></i>
    </div>

    <div style="font-size:12px; color:#888; margin-bottom:6px;">Kaynak PortfÃ¶y</div>
    <select id="trFrom" class="portfolio-select" style="min-width:100%; width:100%; margin-bottom:12px;" onchange="pfOnTransferFromChange(this.value)"></select>

    <div style="font-size:12px; color:#888; margin-bottom:6px;">Hedef PortfÃ¶y</div>
    <select id="trTo" class="portfolio-select" style="min-width:100%; width:100%; margin-bottom:12px;"></select>

    <div style="font-size:12px; color:#888; margin-bottom:6px;">EnstrÃ¼man</div>
    <select id="trTicker" class="portfolio-select" style="min-width:100%; width:100%; margin-bottom:12px;" onchange="pfUpdateTransferLimit()"></select>

    <div style="font-size:12px; color:#888; margin-bottom:6px; text-align:right;" id="trLimit">-</div>
    <input type="number" id="trQty" class="form-input" placeholder="Miktar giriniz..." oninput="pfValidateTransfer()">

    <button id="btnConfirmTransfer" class="btn btn-primary" style="width:100%;" disabled onclick="pfSubmitTransfer()">VÄ°RMAN YAP</button>
    <button class="btn" style="width:100%; background:#222; color:#fff; margin-top:10px;" onclick="pfCloseTransferModal()">Ä°ptal</button>
  </div>
</div>
<!-- HISTORY MODAL -->
<div class="modal-overlay" id="pfHistModal">
  <div class="hist-modal">
    <div class="hist-head">
      <div>
        <div id="pfHistTitle" class="hist-title">-</div>
        <div id="pfHistSub" class="hist-sub">-</div>
      </div>
      <i class="fa-solid fa-xmark hist-close" onclick="pfCloseHistoryModal()"></i>
    </div>

    <div class="hist-body">
      <div id="pfHistLoading" class="hist-loading">YÃ¼kleniyor...</div>
      <canvas id="pfHistCanvas"></canvas>
    </div>
  </div>
</div>
</div>



<div id="view-detail" class="view-section">
<div class="wrap">
    <!-- DETAIL LOADING OVERLAY -->
<div id="detailLoadingOverlay" class="detail-loading-overlay" style="display:none;">
  <div style="display:flex; flex-direction:column; align-items:center; gap:10px;">
    <div class="spinner"></div>
    <div style="color:#9a9a9a; font-weight:900; font-size:12px;">YÃ¼kleniyor...</div>
  </div>
</div>


  <!-- Header -->
  <div class="flex flex-col md:flex-row justify-between items-start md:items-end mb-6 gap-4">

    <div class="flex items-center gap-4">
      <div class="w-14 h-14 bg-[#0f0f0f] border border-[#2a2a2a] rounded-2xl flex items-center justify-center p-2 overflow-hidden">
        <img id="companyLogo" src="" alt="" class="w-full h-full object-contain hidden" />
        <i id="companyLogoFallback" class="fa-solid fa-building text-2xl text-white"></i>
      </div>

      <div>
        <div class="flex items-center gap-2 mb-1">
          <span id="tickerPill" class="bg-[#1a2205] text-[#c2f50e] border border-[#c2f50e]/30 text-[10px] font-black px-2 py-0.5 rounded uppercase tracking-wide">-</span>
          <span class="text-[10px] font-extrabold text-[#8a8a8a] uppercase tracking-widest">Åžirket DetayÄ±</span>
        </div>
        <h1 id="companyTitle" class="text-2xl font-extrabold text-white tracking-tight leading-tight">-</h1>
        <div id="companyMeta" class="text-xs text-[#8a8a8a] font-semibold mt-1">-</div>
      </div>
    </div>

    <!-- Search + Price -->
    <div class="flex flex-col items-end gap-3 w-full md:w-auto">
      <div class="flex items-center gap-2 search-wrap">
        <input id="tickerSearch" class="search-input" placeholder="Åžirket ara (ticker / isim)" autocomplete="off" />
        

        <div id="searchDD" class="search-dd"></div>
      </div>

      <div class="text-right">
        <div id="headerPrice" class="text-3xl font-extrabold text-white flex items-center justify-end gap-2">
  <span id="headerCaret" class="hidden text-2xl leading-none"></span>
  <span id="headerPriceVal">-</span>
</div>

<div class="font-extrabold text-xs flex items-center justify-end gap-2 mt-1" id="headerChange" style="visibility:hidden;">
  <i id="headerTrendIcon" class="fa-solid fa-arrow-trend-up"></i>
  <span id="headerChangeVal">-</span>
</div>

      </div>
    </div>

  </div>

  <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">

    <!-- Left -->
    <div class="lg:col-span-8 flex flex-col gap-6">

      <!-- About -->
      <!-- About -->
<div class="fin-card p-6" id="cardAbout"> <h3 class="text-white font-extrabold text-sm">HakkÄ±nda</h3>
  <p class="text-sm text-[#bdbdbd] leading-relaxed mt-4" id="aboutText">-</p>
</div>


      <!-- Chart -->
      <div class="fin-card p-5">
        <div class="flex justify-between items-center mb-3 gap-3">
          <h3 class="text-white font-extrabold text-sm" id="chartTitle">Hisse FiyatÄ±</h3>

          <div class="flex gap-2 flex-wrap justify-end" id="rangeBtns" aria-label="Zaman aralÄ±ÄŸÄ±">
            <button class="tab-btn" data-range="MAX" type="button">MAX</button>
            <button class="tab-btn active" data-range="1Y" type="button">1Y</button>
            <button class="tab-btn" data-range="6M" type="button">6A</button>
            <button class="tab-btn" data-range="3M" type="button">3A</button>
            <button class="tab-btn" data-range="1M" type="button">1A</button>
          </div>
        </div>
        <div id="priceChart" class="-ml-2"></div>
      </div>

      <!-- Financials -->
      <div class="fin-card flex flex-col" id="cardFinancials"> <div class="card-head tab-scroll" id="financialTabs" role="tablist" aria-label="Finansal tablolar">
  <button class="tab-btn active" data-tab="ratios" type="button" role="tab" aria-selected="true">Genel BakÄ±ÅŸ</button>
  <button class="tab-btn" data-tab="income" type="button" role="tab" aria-selected="false">Gelir Tablosu</button>
  <button class="tab-btn" data-tab="balance-sheet" type="button" role="tab" aria-selected="false">BilanÃ§o</button>
  <button class="tab-btn" data-tab="cash-flow-statement" type="button" role="tab" aria-selected="false">Nakit AkÄ±ÅŸ Tablosu</button>
</div>


<div class="overflow-x-auto" id="financialTableWrap">
          <table class="fin-table" aria-label="Finansal tablo">
            <thead>
              <tr>
                <th width="35%">Kalem</th>
                <th width="16%">TTM</th>
                <th width="16%" id="y1Head">-</th>
                <th width="16%" id="y2Head">-</th>
                <th width="16%" id="y3Head">-</th>
              </tr>
            </thead>
            <tbody id="financialsBody">
              <tr><td colspan="5" style="text-align:center; padding:18px; color:#666; font-weight:900;">Finansallar yÃ¼kleniyor...</td></tr>
            </tbody>
          </table>
        </div>
                <!-- Genel BakÄ±ÅŸ (Oranlar) altÄ±nda metrikler -->
        <div id="overviewMetricsCard" style="display:none; padding:16px; border-top:1px solid rgba(255,255,255,.08);">
          <div class="text-[#8a8a8a] text-xs font-extrabold uppercase tracking-widest mb-3">Oranlar</div>
          <div id="overviewMetricsList">
            <div style="text-align:center; padding:18px; color:#666; font-weight:900;">Metrikler yÃ¼kleniyor...</div>
          </div>
        </div>

      </div>

    </div>

    <!-- Right -->
    <div class="lg:col-span-4 flex flex-col gap-6">

      <!-- 52 week -->
      <div class="fin-card p-5">
        <div class="flex justify-between items-center mb-5">
          <span class="text-[#8a8a8a] text-xs font-extrabold uppercase tracking-widest">52 Hafta AralÄ±k</span>
          <span class="text-[10px] font-black text-[#6b6b6b] uppercase tracking-widest">Konum</span>
        </div>

        <div class="range-container">
          <div class="range-track" aria-hidden="true">
            <div class="range-fill" id="rangeFill" style="width:0%"></div>
            <div class="range-thumb" id="rangeThumb" style="left:0%">
              <div class="range-label-float" id="currentPriceLabel">-</div>
            </div>
          </div>
        </div>

        <div class="flex justify-between mt-3">
          <div class="text-left">
            <div class="text-[#6b6b6b] text-[10px] font-black uppercase tracking-widest">En DÃ¼ÅŸÃ¼k</div>
            <div class="text-white text-sm font-extrabold font-mono" id="lowPrice">-</div>
          </div>
          <div class="text-right">
            <div class="text-[#6b6b6b] text-[10px] font-black uppercase tracking-widest">En YÃ¼ksek</div>
            <div class="text-white text-sm font-extrabold font-mono" id="highPrice">-</div>
          </div>
        </div>
      </div>

      <!-- Metrics -->
     <!-- Genel Bilgiler + Mini Finans Bar -->
<div class="fin-card p-5" id="snapshotCard">
  <div class="flex justify-between items-center mb-4">
    <span class="text-[#8a8a8a] text-xs font-extrabold uppercase tracking-widest">Genel Bilgiler</span>
  </div>

  <div class="text-xs font-black uppercase tracking-widest text-[#8a8a8a] mb-2">Son 4 DÃ¶nem: Gelir &amp; KÃ¢r</div>
  <div class="mini-legend">
  <span class="mini-leg-item"><span class="dot rev"></span> Gelir</span>
  <span class="mini-leg-item"><span class="dot prof"></span> Net KÃ¢r</span>
</div>

  <div class="mini-bars-wrap" id="miniBarsWrap">
    <div style="text-align:center; padding:18px; color:#666; font-weight:900; width:100%;">Finansallar yÃ¼kleniyor...</div>
  </div>

  <div class="snapshot-grid">
    <div class="snapshot-row"><div class="k">SektÃ¶r</div><div class="v" id="sectorVal">-</div></div>
    <div class="snapshot-row"><div class="k">Market Cap</div><div class="v" id="mcapVal">-</div></div>
    <div class="snapshot-row"><div class="k">KuruluÅŸ</div><div class="v" id="foundedVal">-</div></div>
    <div class="snapshot-row"><div class="k">Ã‡alÄ±ÅŸan</div><div class="v" id="empVal">-</div></div>
    <div class="snapshot-row"><div class="k">Ticker</div><div class="v" id="tickerVal">-</div></div>
  </div>
</div>


      <!-- News -->
      <div class="fin-card flex flex-col">
        <div class="card-head">
          <h3 class="text-[#c2f50e] font-black text-xs uppercase tracking-widest">Ä°lgili Haberler</h3>
        </div>
        <div id="newsList">
          <div class="p-4 text-sm text-[#888] font-semibold">Haberler yÃ¼kleniyor...</div>
        </div>
      </div>

    </div>

  </div>

  <div class="h-10"></div>
</div>
</div>

<div id="view-indicators" class="view-section">
  <div class="wrap">

    <div id="indBadgeArea" class="sc-badge-area" style="padding:0; margin-bottom:20px; min-height:auto;"></div>
    <div id="indAsOf" style="margin: -10px 0 12px 0; color: rgba(255,255,255,0.45); font-size: 12px; font-weight: 700;">
  Son gÃ¼ncelleme: -
</div>

    
    <div class="table-wrapper" style="overflow: auto; flex: 1; border: 1px solid rgba(255,255,255,.08); border-radius: 12px; background: #0b0b0b;">
      <table style="width: 100%; min-width: 1000px; border-collapse: separate; border-spacing: 0;">
        <thead>
          <tr>
            <th style="text-align: left; position: sticky; left: 0; top: 0; z-index: 100; background: #1a1a1a; padding: 16px 12px;">GÃ¶sterge</th>
            <th style="position: sticky; top: 0; z-index: 50; background: #1a1a1a; padding: 16px 12px; text-align: right;">Son DeÄŸer</th>
            <th style="position: sticky; top: 0; z-index: 50; background: #1a1a1a; padding: 16px 12px; text-align: right;">Ã–nceki</th>
            <th style="position: sticky; top: 0; z-index: 50; background: #1a1a1a; padding: 16px 12px; text-align: right;">DeÄŸiÅŸim (Ã–nceki)</th>
            <th style="position: sticky; top: 0; z-index: 50; background: #1a1a1a; padding: 16px 12px; text-align: right;">DeÄŸiÅŸim (YTD)</th>
            <th style="position: sticky; top: 0; z-index: 50; background: #1a1a1a; padding: 16px 12px; text-align: right;">DeÄŸiÅŸim (12 Ay)</th>
          </tr>
        </thead>
        <tbody id="indicators-tbody"></tbody>
      </table>
    </div>
  </div>
</div>
<div id="view-calendar-list" class="view-section">
  <div class="wrap">
    

    <div class="cal-filter-bar">
        <div class="cal-filter-group">
            <button class="cal-pill active" onclick="calListSetTime('today', this)">BugÃ¼n</button>
            <button class="cal-pill" onclick="calListSetTime('tomorrow', this)">YarÄ±n</button>
            <button class="cal-pill" onclick="calListSetTime('yesterday', this)">DÃ¼n</button>
            <button class="cal-pill" onclick="calListSetTime('this-week', this)">Bu Hafta</button>
            <button class="cal-pill" onclick="calListSetTime('next-week', this)">Gelecek Hafta</button>
            <button class="cal-pill" onclick="calListSetTime('prev-week', this)">GeÃ§en Hafta</button>
            <button class="cal-pill" onclick="calListSetTime('this-month', this)">Bu Ay</button>
            <button class="cal-pill" onclick="calListSetTime('next-month', this)">Gelecek Ay</button>
            <button class="cal-pill" onclick="calListSetTime('prev-month', this)">GeÃ§en Ay</button>
        </div>

        <div class="cal-filter-group">
            <button class="cal-icon-btn" onclick="calListToggleFilter('region', 'tr', this)" title="TÃ¼rkiye">
                <img src="https://flagcdn.com/w40/tr.png">
            </button>
            <button class="cal-icon-btn" onclick="calListToggleFilter('region', 'us', this)" title="ABD">
                <img src="https://flagcdn.com/w40/us.png">
            </button>
            <button class="cal-icon-btn" onclick="calListToggleFilter('region', 'eu', this)" title="Euro BÃ¶lgesi">
                <img src="https://flagcdn.com/w40/eu.png">
            </button>
        </div>

        <div class="cal-filter-group" style="padding-left:8px;">
            <div class="cal-impact-rating" id="calImpactFilter" data-level="1" title="Etki Seviyesi SeÃ§">
                <svg class="cal-impact-item" viewBox="0 0 24 24" onclick="calListSetImpact(1, event)">
                    <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                </svg>
                <svg class="cal-impact-item" viewBox="0 0 24 24" onclick="calListSetImpact(2, event)">
                    <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                </svg>
                <svg class="cal-impact-item" viewBox="0 0 24 24" onclick="calListSetImpact(3, event)">
                    <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                </svg>
            </div>
        </div>

        <div class="cal-search-wrap">
            <i class="fa-solid fa-search cal-search-icon"></i>
            <input type="text" class="cal-search-input" placeholder="Etkinlik ara..." oninput="calListSearch(this.value)">
        </div>
    </div>
    <div id="calAsOf" style="margin: -10px 0 12px 0; color: rgba(255,255,255,0.45); font-size: 12px; font-weight: 700;">
  Son gÃ¼ncelleme: -
</div>

    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Ekonomik GÃ¶sterge</th>
            <th>Etki</th>
            <th>Beklenen</th>
            <th>GerÃ§ekleÅŸen</th>
            <th>Ã–nceki</th>
            <th>HatÄ±rlat</th>
          </tr>
        </thead>
        <tbody id="calendar-list-tbody">
            </tbody>
      </table>
    </div>
  </div>
</div>

<div id="calListModalOverlay" class="modal-overlay">
  <div id="calListModalContent" class="modal-content">
    
    <div id="calFormContainer">
      <div class="modal-title">Etkinlik HatÄ±rlatÄ±cÄ±</div>
      <div class="input-group">
        <label>Ad Soyad</label>
        <input type="text" id="calUserName" placeholder="AdÄ±nÄ±z SoyadÄ±nÄ±z">
      </div>
      <div class="input-group">
        <label>E-posta Adresi</label>
        <input type="email" id="calUserEmail" placeholder="ornek@mail.com">
      </div>
      <div class="check-group">
        <input type="checkbox" id="calCheckConsent">
        <label for="calCheckConsent">Bilgilerimin kaydedilmesine ve iÅŸlenmesine izin veriyorum.</label>
      </div>
      <div class="check-group">
        <input type="checkbox" id="calCheckNews">
        <label for="calCheckNews">Finapsis geliÅŸmelerinden haberdar olmak istiyorum.</label>
      </div>
      <button id="calSendBtn" class="submit-btn" disabled>Beni Bilgilendir</button>
      <button onclick="calCloseListModal()" style="background:none; border:none; color:#aaa; width:100%; margin-top:10px; font-size:12px; cursor:pointer;">VazgeÃ§</button>
    </div>

    <div id="calSuccessContainer" style="display:none; text-align:center; padding: 20px 0;">
      <div style="font-size: 50px; color: #c2f50e; margin-bottom: 15px;">âœ“</div>
      <div class="modal-title" style="margin-bottom: 8px;">HatÄ±rlatÄ±cÄ± OluÅŸturuldu!</div>
      <p style="color: #aaa; font-size: 14px;">Etkinlik gerÃ§ekleÅŸtiÄŸinde size mail gÃ¶ndereceÄŸiz.</p>
    </div>

  </div>
</div>
<script>
    // --- GLOBAL AYARLAR ---
    let activeGroup = 'bist'; // VarsayÄ±lan grup
    window.activeGroup = activeGroup;

    // =====================
// CALENDAR REMINDER MODAL (GLOBAL)
// =====================
window.__calSelectedEventId = null;

// Popup aÃ§
window.calOpenListModal = function (eventId) {
  window.__calSelectedEventId = String(eventId || "");

  const ov = document.getElementById("calListModalOverlay");
  const form = document.getElementById("calFormContainer");
  const ok = document.getElementById("calSuccessContainer");

  if (!ov || !form || !ok) return;

  // form gÃ¶rÃ¼nÃ¼r, success gizli
  form.style.display = "";
  ok.style.display = "none";

  ov.style.display = "flex";
  // ilk inputa focus
  const nameEl = document.getElementById("calUserName");
  if (nameEl) setTimeout(() => nameEl.focus(), 0);

  // buton enable/disable gÃ¼ncelle
  window.__calUpdateSendBtn?.();
};

// Popup kapat
window.calCloseListModal = function () {
  const ov = document.getElementById("calListModalOverlay");
  if (ov) ov.style.display = "none";
  window.__calSelectedEventId = null;
};

// =====================
// CALENDAR REMINDERS (POST)
// =====================
window.__CAL_REMINDER_ENDPOINT = "https://finapsis-data.nameless-dream-696b.workers.dev/calendar/reminders";

// (Ä°stersen ileride dropdown yaparÄ±z; ÅŸimdilik sabit 5 dk)
window.__CAL_DEFAULT_NOTIFY_OFFSET_MIN = 5;

window.__calSubmitReminder = async function () {
  const eventId = String(window.__calSelectedEventId || "").trim();

  const nameEl = document.getElementById("calUserName");
  const emailEl = document.getElementById("calUserEmail");
  const consentEl = document.getElementById("calCheckConsent");
  const sendBtn = document.getElementById("calSendBtn");

  const form = document.getElementById("calFormContainer");
  const ok = document.getElementById("calSuccessContainer");

  const name = String(nameEl?.value || "").trim();
  const email = String(emailEl?.value || "").trim().toLowerCase();
  const consent = !!consentEl?.checked;

  // GÃ¼venlik: modal eventId set edilmemiÅŸse
  if (!eventId) {
    alert("Etkinlik bulunamadÄ±. LÃ¼tfen tekrar deneyin.");
    return;
  }

  // Validasyon (buton zaten disable oluyor ama burada da kontrol edelim)
  if (!name || name.length < 3) { alert("LÃ¼tfen ad soyad girin."); return; }
  if (!email || !email.includes("@")) { alert("LÃ¼tfen geÃ§erli bir e-posta girin."); return; }
  if (!consent) { alert("Devam etmek iÃ§in onay vermen gerekiyor."); return; }

  const payload = {
    eventId,
    email,
    name,
    consent: true,
    notifyOffsetMin: Number(window.__CAL_DEFAULT_NOTIFY_OFFSET_MIN || 5)
  };

  // UI: gÃ¶nderim sÄ±rasÄ±nda kilitle
  const oldTxt = sendBtn?.textContent;
  if (sendBtn) {
    sendBtn.disabled = true;
    sendBtn.textContent = "Kaydediliyor...";
  }

  try {
    const res = await fetch(window.__CAL_REMINDER_ENDPOINT, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    // Hata gÃ¶vdesini okumaya Ã§alÄ±ÅŸ (debug iÃ§in)
    if (!res.ok) {
      let msg = `Hata: ${res.status}`;
      try {
        const t = await res.text();
        if (t) msg += `\n${t}`;
      } catch (_) {}
      throw new Error(msg);
    }

    // BaÅŸarÄ±lÄ±: success ekranÄ±nÄ± gÃ¶ster
    if (form) form.style.display = "none";
    if (ok) ok.style.display = "";

    // Ä°steÄŸe baÄŸlÄ±: alanlarÄ± sÄ±fÄ±rla (bir sonraki aÃ§Ä±lÄ±ÅŸ temiz olsun)
    if (nameEl) nameEl.value = "";
    if (emailEl) emailEl.value = "";
    if (consentEl) consentEl.checked = false;

    // eventIdâ€™i temizleme (istersen kapatÄ±nca temizleniyor zaten)
    // window.__calSelectedEventId = null;

  } catch (err) {
    console.error("[CAL] reminder submit failed:", err);
    alert("HatÄ±rlatÄ±cÄ± oluÅŸturulamadÄ±. LÃ¼tfen tekrar deneyin.\n\n" + (err?.message || ""));
    // Hata olursa tekrar enable et
    if (sendBtn) sendBtn.disabled = false;
  } finally {
    if (sendBtn && oldTxt) sendBtn.textContent = oldTxt;
  }
};

// Buton click
(function bindCalReminderSubmitOnce(){
  const btn = document.getElementById("calSendBtn");
  if (!btn) return;
  if (btn.__bound) return;
  btn.__bound = true;

  btn.addEventListener("click", (e) => {
    e.preventDefault();
    window.__calSubmitReminder?.();
  });
})();


// Overlayâ€™e tÄ±klayÄ±nca kapat (iÃ§erik tÄ±klanÄ±nca kapanmasÄ±n)
document.addEventListener("click", (e) => {
  const ov = document.getElementById("calListModalOverlay");
  const content = document.getElementById("calListModalContent");
  if (!ov || !content) return;

  if (ov.style.display !== "flex") return;

  // sadece overlay boÅŸluÄŸuna tÄ±klayÄ±nca kapat
  if (e.target === ov) window.calCloseListModal();
});

// Form validasyonu -> send butonunu aÃ§
window.__calUpdateSendBtn = function () {
  const btn = document.getElementById("calSendBtn");
  const nm = document.getElementById("calUserName");
  const em = document.getElementById("calUserEmail");
  const cs = document.getElementById("calCheckConsent");

  if (!btn || !nm || !em || !cs) return;

  const nameOk = nm.value.trim().length >= 3;
  const emailOk = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(em.value.trim());
  const consentOk = !!cs.checked;
  const eventOk = !!(window.__calSelectedEventId && window.__calSelectedEventId.length);

  btn.disabled = !(nameOk && emailOk && consentOk && eventOk);
};

// Input deÄŸiÅŸince butonu gÃ¼ncelle
["calUserName", "calUserEmail", "calCheckConsent"].forEach(id => {
  const el = document.getElementById(id);
  if (el) el.addEventListener("input", window.__calUpdateSendBtn);
  if (el) el.addEventListener("change", window.__calUpdateSendBtn);
});



    // --- PARA FORMATLAYICILAR ---
    function finCurrencySuffix() {
        // NYSE, NASDAQ veya SP ise Dolar, yoksa TL
        return (['sp', 'nyse', 'nasdaq'].includes(activeGroup)) ? '$' : 'â‚º';
    }

    // 1.2Mâ‚º / 3.4B$ gibi compact format
    function finFormatMoneyCompact(v, opts = {}) {
        if (v === null || v === undefined) return '-';
        const n = Number(v);
        if (!Number.isFinite(n)) return '-';
        const abs = Math.abs(n);
        const sym = finCurrencySuffix();

        let div = 1;
        let suf = '';
        if (abs >= 1e12) { div = 1e12; suf = 'T'; }
        else if (abs >= 1e9) { div = 1e9; suf = 'B'; }
        else if (abs >= 1e6) { div = 1e6; suf = 'M'; }
        else if (abs >= 1e3) { div = 1e3; suf = 'K'; }

        if (!suf) {
            // kÃ¼Ã§Ã¼k sayÄ±larda currency iÅŸareti eklemiyoruz (oran vs. bozulmasÄ±n)
            return n.toLocaleString('tr-TR', { maximumFractionDigits: 2 });
        }

        const decimals = ('decimals' in opts) ? opts.decimals : (abs >= 1e9 ? 1 : 0);
        const scaled = n / div;
        const s = scaled.toLocaleString('tr-TR', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
        return `${s}${suf}${sym}`;
    }

    // "1.2M", "3,4B", "5.600.000" gibi deÄŸerleri sayÄ±ya Ã§evirir
    function finParseBenchmarkValue(v) {
        if (v === null || v === undefined) return null;
        if (typeof v === 'number') return Number.isFinite(v) ? v : null;

        let s = String(v).trim();
        if (!s || s === '-' || s === 'â€”') return null;

        s = s.replace(/\s+/g, '');
        // remove currency labels/symbols but keep K/M/B/T
        s = s.replace(/â‚º|\$|â‚¬|TL|TRY|USD|USDT|EUR/gi, '');

        // suffix multiplier
        let mult = 1;
        const m = s.match(/([KMBT])$/i);
        if (m) {
            const suf = m[1].toUpperCase();
            if (suf === 'K') mult = 1e3;
            else if (suf === 'M') mult = 1e6;
            else if (suf === 'B') mult = 1e9;
            else if (suf === 'T') mult = 1e12;
            s = s.slice(0, -1);
        }

        // normalize separators
        if (s.includes(',') && s.includes('.')) {
            // decimal separator is the last of , or .
            if (s.lastIndexOf(',') > s.lastIndexOf('.')) {
                s = s.replace(/\./g, '').replace(',', '.');
            } else {
                s = s.replace(/,/g, '');
            }
        } else if (s.includes(',')) {
            const cnt = (s.match(/,/g) || []).length;
            s = (cnt > 1) ? s.replace(/,/g, '') : s.replace(',', '.');
        } else if (s.includes('.')) {
            const cnt = (s.match(/\./g) || []).length;
            if (cnt > 1) s = s.replace(/\./g, '');
        }

        const n = Number(s.replace(/[^0-9.\-]/g, ''));
        return Number.isFinite(n) ? (n * mult) : null;
    }


    function hidePreloader() {
        const p = document.getElementById('preloader');
        if (p) p.style.display = 'none';
    }

// --- TAB KONTROLÃœ ---
// âœ… Lazy init bayraklarÄ±
window.__fpInit = window.__fpInit || { screener:false, companies:false };

function fpEnsureInit(tabName){
  // Screener ilk kez aÃ§Ä±lÄ±nca init
  if (tabName === 'screener.html' && !window.__fpInit.screener) {
    window.__fpInit.screener = true;
    try { initScreener(); } catch(e) {}
  }

  // Companies List ilk kez aÃ§Ä±lÄ±nca init
  if (tabName === 'companieslist.html' && !window.__fpInit.companies) {
    window.__fpInit.companies = true;
    try { initCompaniesList(); } catch(e) {}
  }
}

    function switchTab(tabName) {
      if(typeof finEnsureCompanies === "function") finEnsureCompanies();
        if(typeof finEnsureBenchmarks === "function") finEnsureBenchmarks();
        if(typeof finEnsureIndicators === "function") finEnsureIndicators();
        try { localStorage.setItem('finapsis_active_main_tab', tabName); } catch(e) {}
        // sadece Ã¼st menÃ¼ tablarÄ±
        const navBtns = document.querySelectorAll('nav.app-tabs .tab-btn');
        navBtns.forEach((b) => b.classList.remove('active'));

        const scr = document.getElementById('view-screener');
        const cl = document.getElementById('view-companies');
        const cmp = document.getElementById('view-compare');
        const pf = document.getElementById('view-portfolio');
        const det = document.getElementById('view-detail');
        const sec = document.getElementById('view-sectors');
        const subTabs = document.querySelector('.sub-tabs-container');
        const dia = document.getElementById('view-diagrams');
        const ind = document.getElementById('view-indicators');
        const calList = document.getElementById('view-calendar-list');


        // tÃ¼m view'larÄ± kapat
        if (scr) scr.classList.remove('active');
        if (cl) cl.classList.remove('active');
        if (cmp) cmp.classList.remove('active');
        if (pf) pf.classList.remove('active');
        if (det) det.classList.remove('active');
        if (sec) sec.classList.remove('active');
        if (dia) dia.classList.remove('active');
        if (ind) ind.classList.remove('active');
        if (calList) calList.classList.remove('active');




        // Screener
        if (tabName === 'screener.html') {
  navBtns[0]?.classList.add('active');
  if (scr) scr.classList.add('active');
  if (subTabs) subTabs.style.display = 'flex';

  fpEnsureInit('screener.html');
  window.pfFinapsisResize?.();

  return;
}


        // Companies List
        if (tabName === 'companieslist.html') {
  navBtns[1]?.classList.add('active');
  if (cl) cl.classList.add('active');
  if (subTabs) subTabs.style.display = 'flex';

  fpEnsureInit('companieslist.html');
  window.pfFinapsisResize?.();

  return;
}

        // SektÃ¶rler
if (tabName === 'sectors') {
  // BUTON INDEX: Screener(0), Companies(1), SektÃ¶rler(2), Compare(3), Portfolio(4), Detail(5)
  navBtns[2]?.classList.add('active');
  if (sec) sec.classList.add('active');

  // SektÃ¶rler BIST/SPâ€™ye baÄŸlÄ± olacaÄŸÄ± iÃ§in subTabs aÃ§Ä±k kalsÄ±n
  if (subTabs) subTabs.style.display = 'flex';

  // Ä°lk aÃ§Ä±lÄ±ÅŸta init, sonra sadece render
  if (window.secInitOnce) window.secInitOnce();
  else if (window.secRenderTable) window.secRenderTable();

  return;
}

// Diyagramlar
if (tabName === 'diagrams') {
  // BUTON INDEX: Skorlama(0), Åžirketler(1), SektÃ¶rler(2), Diyagramlar(3), Compare(4), Portfolio(5), Detail(6)
  navBtns[3]?.classList.add('active');
  if (dia) dia.classList.add('active');

  // Diyagramlar BIST/SPâ€™ye baÄŸlÄ± olacaÄŸÄ± iÃ§in subTabs aÃ§Ä±k kalsÄ±n
  if (subTabs) subTabs.style.display = 'flex';

  // Ä°lk aÃ§Ä±lÄ±ÅŸta init, sonra render
  if (window.dgInitOnce) window.dgInitOnce();
  else if (window.dgRender) window.dgRender();

  return;
}


        // KarÅŸÄ±laÅŸtÄ±rma
        if (tabName === 'karsilastirma.html') {
            navBtns[4]?.classList.add('active');
            if (cmp) cmp.classList.add('active');
            if (subTabs) subTabs.style.display = 'flex';
            if (window.cmpInitOnce) window.cmpInitOnce();
            if (window.cmpRender) window.cmpRender();
            return;
        }

        // PortfÃ¶y
        if (tabName === 'portfolio.html') {
            navBtns[5]?.classList.add('active');
            if (pf) pf.classList.add('active');
            if (subTabs) subTabs.style.display = 'none';
            if (window.pfFinapsisResize) setTimeout(window.pfFinapsisResize, 50);
            return;
        }

        // Detay
        if (tabName === 'detail') {
            navBtns[6]?.classList.add('active');
            if (det) det.classList.add('active');
            if (subTabs) subTabs.style.display = 'none';
            if (window.finDetailBootOnce) window.finDetailBootOnce();
            return;
        }

        // GÃ¶stergeler
        // GÃ¶stergeler
if (tabName === 'indicators') {
  // âœ… Ãœst tab highlight (index yerine daha saÄŸlam: text ile bul)
  const btnInd = Array.from(navBtns).find(b => b.textContent.trim().toLowerCase().includes("gÃ¶stergeler"));
  if (btnInd) btnInd.classList.add('active');

  // âœ… View aÃ§
  if (ind) ind.classList.add('active');

  // âœ… GÃ¶stergelerde alt subTabs gerekmiyor
  if (subTabs) subTabs.style.display = 'none';

  // âœ… tbody referansÄ± (undefined olmasÄ±n)
  const tbody = document.getElementById("indicators-tbody");

  // Veri henÃ¼z inmemiÅŸse loading gÃ¶ster, inmiÅŸse render et
  if (window.__INDICATORS_MAP && window.__INDICATORS_SUMMARY) {
    if (typeof window.renderIndicators === "function") window.renderIndicators();
  } else {
    if (tbody) {
      tbody.innerHTML =
        '<tr><td colspan="6" style="text-align:center; padding:50px;"><div class="spinner"></div></td></tr>';
    }
  }
  return;
}


        // Takvim Listesi
        if (tabName === 'calendarlist') {
            const btnCal = Array.from(navBtns).find(b => b.textContent.includes("Takvim"));
            if(btnCal) btnCal.classList.add('active');

            if (calList) calList.classList.add('active');
            if (subTabs) subTabs.style.display = 'none';
            
            // Ä°lk kez render
            if(window.renderCalendarList) window.renderCalendarList();
            return;
        }
    }


    // DÄ±ÅŸ ekranlardan (Screener/List/Compare) PortfÃ¶ye Ekle
    window.finOpenAddToPortfolio = function(ticker) {
        if (!ticker) return;
        try { localStorage.setItem('finapsis_active_main_tab', 'portfolio.html'); } catch(e) {}
        try { switchTab('portfolio.html'); } catch(e) {}
        setTimeout(() => {
            try {
                if (window.pfOpenTradeModal) window.pfOpenTradeModal(ticker, 'buy');
            } catch(e) {}
        }, 80);
    };
function fpGetWatchlist(){
  try { return JSON.parse(localStorage.getItem("finapsis_watchlist") || "[]"); }
  catch(e){ return []; }
}
function fpSetWatchlist(arr){
  try { localStorage.setItem("finapsis_watchlist", JSON.stringify(arr||[])); } catch(e){}
}

window.fpOpenRowMenu = function(ticker, ev){
  const t = String(ticker||"").toUpperCase();
  const ov = document.getElementById("fpRowMenuOverlay");
  const menu = document.getElementById("fpRowMenu");
  const elT = document.getElementById("fpMenuTicker");
  if (!ov || !menu || !elT) return;

  ov.dataset.ticker = t;
  elT.textContent = t;

  // Sat aktif mi?
  const canSell = (window.pfHasPosition ? !!window.pfHasPosition(t) : false);
  const sellBtn = document.getElementById("fpMenuSell");
  if (sellBtn) sellBtn.classList.toggle("disabled", !canSell);

  // Ä°zle label
  const wl = fpGetWatchlist();
  const watching = wl.includes(t);
  const watchBtn = document.getElementById("fpMenuWatch");
  if (watchBtn) watchBtn.innerHTML = `<div class="fpMenuIcon"><i class="fa-solid ${watching ? 'fa-eye-slash' : 'fa-eye'}"></i></div>${watching ? 'Ä°zleme' : 'Ä°zle'}`;

  // âœ… overlay aÃ§
  ov.style.display = "block";

  // âœ… ikonun yanÄ±na konumlandÄ±r
  // ev yoksa fallback: ekran ortasÄ±
  let x = window.innerWidth / 2;
  let y = window.innerHeight / 2;

  if (ev && ev.currentTarget && ev.currentTarget.getBoundingClientRect) {
    const r = ev.currentTarget.getBoundingClientRect();
    x = r.right + 8;
    y = r.top;
  } else if (ev && typeof ev.clientX === "number") {
    x = ev.clientX;
    y = ev.clientY;
  }

  // viewport taÅŸmasÄ±nÄ± engelle
  const pad = 10;
  const mw = menu.offsetWidth || 260;
  const mh = menu.offsetHeight || 220;

  if (x + mw + pad > window.innerWidth) x = window.innerWidth - mw - pad;
  if (y + mh + pad > window.innerHeight) y = window.innerHeight - mh - pad;
  if (x < pad) x = pad;
  if (y < pad) y = pad;

  menu.style.left = x + "px";
  menu.style.top  = y + "px";
};


window.fpCloseRowMenu = function(){
  const ov = document.getElementById("fpRowMenuOverlay");
  if (ov) ov.style.display = "none";
};

function fpMenuTicker(){
  const ov = document.getElementById("fpRowMenuOverlay");
  return String(ov?.dataset?.ticker || "").toUpperCase();
}

// Detaya git: Detail sekmesine geÃ§ + ticker'Ä± yÃ¼kle

// Al / Sat: Portfolio modalÄ±nÄ± aÃ§
window.finMenuTrade = function(ticker, side){
  const t = String(ticker||"").toUpperCase();
  try { localStorage.setItem('finapsis_active_main_tab', 'portfolio.html'); } catch(e){}
  try { switchTab('portfolio.html'); } catch(e){}
  setTimeout(() => {
    try {
      if (window.pfOpenTradeModal) window.pfOpenTradeModal(t, side);
    } catch(e){}
  }, 120);
};

// Ä°zle toggle
window.finToggleWatch = function(ticker){
  const t = String(ticker||"").toUpperCase();
  const wl = fpGetWatchlist();
  const idx = wl.indexOf(t);
  if (idx >= 0) wl.splice(idx, 1);
  else wl.push(t);
  fpSetWatchlist(wl);
};

// MenÃ¼ buton handlerâ€™larÄ± (1 kere baÄŸla)
document.addEventListener("DOMContentLoaded", () => {
  const d = document.getElementById("fpMenuDetail");
  const b = document.getElementById("fpMenuBuy");
  const s = document.getElementById("fpMenuSell");
  const w = document.getElementById("fpMenuWatch");

  if (d) d.onclick = () => { finOpenDetail(fpMenuTicker()); fpCloseRowMenu(); };
  if (b) b.onclick = () => { finMenuTrade(fpMenuTicker(), "buy"); fpCloseRowMenu(); };
  if (s) s.onclick = () => { finMenuTrade(fpMenuTicker(), "sell"); fpCloseRowMenu(); };
  if (w) w.onclick = () => { finToggleWatch(fpMenuTicker()); fpCloseRowMenu(); };
});

// --- GRUP KONTROLÃœ (BIST/SP) ---
 // --- GRUP KONTROLÃœ (BIST/NYSE/NASDAQ) ---
    // --- GRUP KONTROLÃœ (BIST/NYSE/NASDAQ) ---
    function setGroup(group) {
        activeGroup = group;
        window.activeGroup = group;

        // 1. TÃ¼m sayfalardaki 'group-toggle-btn' butonlarÄ±nÄ± gÃ¼ncelle
        document.querySelectorAll('.group-toggle-btn').forEach(btn => {
            if(btn.dataset.grp === group) btn.classList.add('active');
            else btn.classList.remove('active');
        });

        // 2. Diyagram sayfasÄ±ndaki select kutusunu gÃ¼ncelle
        const dgSel = document.getElementById('dgGroupSelect');
        if(dgSel) dgSel.value = group;

        // 3. Verileri Yenile (Screener'Ä± burada Ã§aÄŸÄ±rmÄ±yoruz! Bekletiyoruz.)
        finEnsureCompanies();
        finEnsureBenchmarks();
        
        // Screener tablosunu geÃ§ici olarak "YÃ¼kleniyor" moduna alalÄ±m ki kullanÄ±cÄ± dondu sanmasÄ±n
        const scrBody = document.getElementById('screener-results-body');
        if(scrBody) scrBody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:#888;">Veriler GÃ¼ncelleniyor...</td></tr>';

        // SektÃ¶r dropdown'Ä±nÄ± gÃ¼ncelle
        try { updateCompanyListSectorDropdown(); } catch(e){}
        // SektÃ¶rler sekmesi iÃ§in badge gÃ¼ncelle
        try { if(window.secUpdateBadges) window.secUpdateBadges(); } catch(e){}
        // Diyagramlar sekmesi iÃ§in badge gÃ¼ncelle
        try { if(window.dgUpdateBadges) window.dgUpdateBadges(); } catch(e){}
        // Diyagram Ã§izimini yenile
        try { if(window.dgStartAnalysis) window.dgStartAnalysis(); } catch(e){}
        // KarÅŸÄ±laÅŸtÄ±rma sekmesi gÃ¼ncelle (Badge ve Search)
        try { if(window.cmpOnGroupChange) window.cmpOnGroupChange(activeGroup); } catch(e){}
        // Companies List badge'lerini gÃ¼ncelle (Borsa deÄŸiÅŸtiÄŸi iÃ§in)
        try { if(window.clUpdateFilterBadges) window.clUpdateFilterBadges(); } catch(e){}

        // Companies List state'i sÄ±fÄ±rla
        try { clLimit = 200; } catch(e){}
        try { __clRenderedCount = 0; __clLastKey = ""; } catch(e){}

        // âœ… KRÄ°TÄ°K NOKTA: Map dolmadan kimseyi sahneye Ã§Ä±karma!
        try {
            if (typeof finBuildMapForActiveGroup === "function") {
                finBuildMapForActiveGroup(() => {
                    // --- BURASI "VERÄ° Ä°NDÄ° VE HAZIR" DEMEKTÄ°R ---
                    
                    // 1. Screener'Ä± ARTIK baÅŸlatabiliriz (Map dolu)
                    try { if(typeof initScreener === "function") initScreener(); } catch(e){ console.error(e); }
                    try { scUpdateFilterBadges(); } catch(e){} // âœ… Badge'leri gÃ¼ncelle

                    // 2. DiÄŸer listeleri gÃ¼ncelle
                    try { if(typeof clBindHeaderSortOnce === "function") clBindHeaderSortOnce(); } catch(e){}
                    try { if(typeof clUpdateSortHeaderUI === "function") clUpdateSortHeaderUI(); } catch(e){}
                    try { if(typeof renderCompanyList === "function") renderCompanyList(); } catch(e){}
                    try { if(window.secRenderTable) window.secRenderTable(); } catch(e){}
                    try { if(window.dgRender) window.dgRender(); } catch(e){}
                    try { if(window.cmpRender) window.cmpRender(); } catch(e){}
                    try { clSetupInfiniteScroll(); } catch(e){}
                });
            }
        } catch(e){ console.error(e); }

        if (window.cmpOnGroupChange) window.cmpOnGroupChange(activeGroup);
    }

const sectorIcons = {
    "AlkolsÃ¼z Ä°Ã§ecek Ãœreticileri": "fa-solid fa-bottle-water",
    "AmbalajlÄ± GÄ±dalar": "fa-solid fa-bowl-food",
    "Bira ve AlkollÃ¼ Ä°Ã§ecek Ãœreticileri": "fa-solid fa-beer-mug-empty",
    "Åžekerleme ve Ã‡ikolata Ãœretimi": "fa-solid fa-candy-cane",
    "TahÄ±l ve DeÄŸirmencilik Ãœretimi": "fa-solid fa-wheat-awn",
    "TarÄ±m ÃœrÃ¼nleri": "fa-solid fa-seedling",
    "GÄ±da DaÄŸÄ±tÄ±mÄ±": "fa-solid fa-truck-ramp-box",
    "AltyapÄ± YazÄ±lÄ±mlarÄ±": "fa-solid fa-server",
    "Bilgi Teknolojileri Hizmetleri": "fa-solid fa-laptop-code",
    "Uygulama YazÄ±lÄ±mlarÄ±": "fa-solid fa-window-maximize",
    "Ä°nternet Ä°Ã§erik PlatformlarÄ±": "fa-solid fa-icons",
    "Ä°letiÅŸim EkipmanlarÄ±": "fa-solid fa-tower-broadcast",
    "Telekom Hizmetleri": "fa-solid fa-phone-volume",
    "SaÄŸlÄ±k Bilgi Hizmetleri": "fa-solid fa-notes-medical",
    "Ambalaj ve Konteyner": "fa-solid fa-box",
    "BakÄ±r Ãœretimi": "fa-solid fa-cubes",
    "Ã‡elik": "fa-solid fa-industry",
    "Metal Ä°ÅŸleme": "fa-solid fa-gears",
    "Metal MadenciliÄŸi": "fa-solid fa-pickaxe",
    "DiÄŸer EndÃ¼striyel Metaller & Madencilik": "fa-solid fa-bore-hole",
    "UzmanlaÅŸmÄ±ÅŸ EndÃ¼striyel Makineler": "fa-solid fa-screwdriver-wrench",
    "TarÄ±m ve AÄŸÄ±r Ä°ÅŸ Makineleri": "fa-solid fa-tractor",
    "Elektrik EkipmanlarÄ±": "fa-solid fa-plug-circle-bolt",
    "BaÄŸÄ±msÄ±z Enerji Ãœreticileri": "fa-solid fa-charging-station",
    "GÃ¼neÅŸ Enerjisi": "fa-solid fa-solar-panel",
    "Yenilenebilir Enerji": "fa-solid fa-leaf",
    "Elektrik DaÄŸÄ±tÄ±m ve Ä°letim": "fa-solid fa-tower-observation",
    "DoÄŸalgaz DaÄŸÄ±tÄ±m ve Ä°letim": "fa-solid fa-pipeline",
    "DÃ¼zenlenen Elektrik Åžirketleri": "fa-solid fa-bolt",
    "DÃ¼zenlenen Gaz DaÄŸÄ±tÄ±m": "fa-solid fa-fire-flame-simple",
    "Termal KÃ¶mÃ¼r": "fa-solid fa-mound",
    "BÃ¶lgesel Bankalar": "fa-solid fa-building-columns",
    "Ticari Bankalar": "fa-solid fa-landmark",
    "Sermaye PiyasasÄ± KuruluÅŸlarÄ±": "fa-solid fa-building-ngo",
    "Kredi Hizmetleri": "fa-solid fa-credit-card",
    "VarlÄ±k YÃ¶netimi": "fa-solid fa-vault",
    "Finansal Veri Hizmetleri & Borsalar": "fa-solid fa-chart-line",
    "Hayat SigortasÄ±": "fa-solid fa-heart-pulse",
    "YangÄ±n & Kaza SigortasÄ±": "fa-solid fa-house-chimney-crack",
    "Sigorta (Ã‡ok AlanlÄ±)": "fa-solid fa-shield-halved",
    "GYO â€“ Ã‡eÅŸitlendirilmiÅŸ": "fa-solid fa-city",
    "GYO â€“ Konut": "fa-solid fa-house-chimney",
    "GYO â€“ Ofis": "fa-solid fa-building",
    "GYO â€“ Otel & Konaklama": "fa-solid fa-hotel",
    "GYO â€“ Perakende": "fa-solid fa-store",
    "GYO â€“ Sanayi": "fa-solid fa-warehouse",
    "GYO â€“ UzmanlaÅŸmÄ±ÅŸ": "fa-solid fa-tree-city",
    "Gayrimenkul GeliÅŸtirme": "fa-solid fa-trowel-bricks",
    "Gayrimenkul Hizmetleri": "fa-solid fa-handshake-angle",
    "Otomotiv Ãœreticileri": "fa-solid fa-car-side",
    "Oto Yedek ParÃ§a": "fa-solid fa-oil-can",
    "Oto ve Ticari AraÃ§ Bayileri": "fa-solid fa-car-rear",
    "Havayolu Åžirketleri": "fa-solid fa-plane-up",
    "HavalimanÄ± ve Hava Hizmetleri": "fa-solid fa-plane-arrival",
    "Demiryolu TaÅŸÄ±macÄ±lÄ±ÄŸÄ±": "fa-solid fa-train",
    "Deniz TaÅŸÄ±macÄ±lÄ±ÄŸÄ±": "fa-solid fa-ship",
    "Entegre Lojistik & Kargo": "fa-solid fa-truck-fast",
    "Market Zincirleri / SÃ¼permarketler": "fa-solid fa-basket-shopping",
    "GÄ±da & Ä°laÃ§ Perakendesi": "fa-solid fa-prescription-bottle-medical",
    "HazÄ±r Giyim Perakendesi": "fa-solid fa-bag-shopping",
    "BÃ¼yÃ¼k MaÄŸazalar / AVM Perakendesi": "fa-solid fa-shop",
    "Restoranlar": "fa-solid fa-utensils",
    "Konaklama Hizmetleri": "fa-solid fa-bed",
    "Tatil KÃ¶yleri ve Kumarhaneler": "fa-solid fa-clover",
    "Seyahat Hizmetleri": "fa-solid fa-map-location-dot",
    "TÄ±bbi Cihazlar": "fa-solid fa-stethoscope",
    "TÄ±bbi AraÃ§ GereÃ§ler": "fa-solid fa-kit-medical",
    "TÄ±bbi BakÄ±m Tesisleri": "fa-solid fa-hospital",
    "Ä°laÃ§ Ãœreticileri (Jenerik & Ã–zel)": "fa-solid fa-pills",
    "TÄ±bbi ÃœrÃ¼n DaÄŸÄ±tÄ±mÄ±": "fa-solid fa-truck-medical",
    "Biyoteknoloji": "fa-solid fa-dna",
    "Holdingler": "fa-solid fa-briefcase",
    "Sportif Faaliyetler": "fa-solid fa-volleyball",
    "Reklam AjanslarÄ±": "fa-solid fa-rectangle-ad",
    "YayÄ±ncÄ±lÄ±k": "fa-solid fa-book-open",
    "EÄŸitim Hizmetleri": "fa-solid fa-graduation-cap",
    "Savunma Sanayii": "fa-solid fa-shield-hawk",
    "HavacÄ±lÄ±k ve Savunma Sanayii": "fa-solid fa-jet-fighter",
    "Kimya": "fa-solid fa-flask",
    "Ã–zel Kimyasallar": "fa-solid fa-flask-vial",
    "Tekstil Ãœretimi": "fa-solid fa-scissors",
    "Mobilya, Ev GereÃ§leri ve Beyaz EÅŸya": "fa-solid fa-couch",
    "YapÄ± Malzemeleri": "fa-solid fa-hammer",
    "DiÄŸer": "fa-solid fa-ellipsis"
};    
    // ============================================
    // DETAIL (EMBEDDED) JAVASCRIPT
    // ============================================

(function(){
/* ============================
   CONFIG
============================ */
/* ============================
   CONFIG (R2 UPDATE)
============================ */
// Base URL global window.FIN_DATA_BASE Ã¼zerinden gelir
const DEFAULT_TICKER = "AAPL";

// Cache for large about file
window.__ABOUT_CACHE = null; 

/* globals */
window.benchmarks = window.benchmarks || [];
window.companies = window.companies || [];

/* ============================
   STATE
============================ */
let currentTicker = DEFAULT_TICKER;

let apiCompany = null;        // from /comdetail
let apiPriceHistory = [];     // from /comdetail
let apiNews = [];             // from /comdetail
let apiFinancials = [];       // from /comfinancials

let derived52w = { low: 0, high: 0, current: 0 };

let chartInstance = null;
let chartFull = { points: [] }; // [{x:ms,y:number}]
let activeRange = "1Y";

/* race control */
let loadSeq = 0;

/* ============================
   HELPERS
============================ */


function getTickerFromQuery(){
  const href = String(window.location.href || "");
  // Bubble HTML element often runs under about:blank
  if (href.startsWith("about:")){
    try{
      const t = (localStorage.getItem("finapsis_detail_ticker") || "").trim();
      return t ? t.toUpperCase() : DEFAULT_TICKER;
    }catch(e){
      return DEFAULT_TICKER;
    }
  }
  try{
    const u = new URL(window.location.href);
    const t = (u.searchParams.get("ticker") || "").trim();
    return t ? t.toUpperCase() : DEFAULT_TICKER;
  }catch(e){
    return DEFAULT_TICKER;
  }
}
function sanitizeTicker(input){
  const t = String(input || "").toUpperCase().trim();
  const clean = t.replace(/[^A-Z0-9.\-]/g, "");
  return clean || DEFAULT_TICKER;
}
function safeNum(v){
  if (v === null || v === undefined || v === "") return null;
  const n = Number(String(v).replace(",", "."));
  return Number.isFinite(n) ? n : null;
}
function formatInt(val){
  const n = safeNum(val);
  if (n === null) return "-";
  return Math.round(n).toLocaleString("tr-TR");
}
function formatPrice(val){
  const n = safeNum(val);
  if (n === null) return "-";
  return n.toLocaleString("tr-TR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}
function getLivePriceFromGlobal(ticker){
  const t = String(ticker||"").toUpperCase();
  const cur = window.currentPriceData ? Number(window.currentPriceData[t]) : NaN;
  const prev = window.prevPriceData ? Number(window.prevPriceData[t]) : NaN;
  return {
    cur: Number.isFinite(cur) ? cur : null,
    prev: Number.isFinite(prev) ? prev : null
  };
}

function formatFinancial(val, valueType){
  if (val === null || val === undefined || val === "") return "-";
  const n = safeNum(val);
  if (n === null) return "-";
  const abs = Math.abs(n);
  const sign = n < 0 ? "âˆ’" : "";
  const sym = currencySymbolForTicker(currentTicker);
  if (valueType === "ratio") return sign + abs.toLocaleString("tr-TR", { maximumFractionDigits: 2 });
  if (abs >= 1_000_000_000) return sign + (abs/1_000_000_000).toLocaleString("tr-TR", { maximumFractionDigits: 2 }) + " Mr" + sym;
if (abs >= 1_000_000)     return sign + (abs/1_000_000).toLocaleString("tr-TR", { maximumFractionDigits: 2 }) + " M" + sym;
if (abs >= 1_000)         return sign + abs.toLocaleString("tr-TR", { maximumFractionDigits: 0 }) + sym;
return sign + abs.toLocaleString("tr-TR", { maximumFractionDigits: 2 }) + sym;

  
}
function parseMMDDYYYY(s){
  const str = String(s || "").trim();
  if (str.length !== 8) return null;
  const mm = Number(str.slice(0,2));
  const dd = Number(str.slice(2,4));
  const yy = Number(str.slice(4,8));
  if (!Number.isFinite(mm) || !Number.isFinite(dd) || !Number.isFinite(yy)) return null;
  const d = new Date(yy, mm - 1, dd);
  return Number.isNaN(d.getTime()) ? null : d;
}
function fmtISODate(ms){
  const d = new Date(ms);
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${day}`;
}
function setYearHeaders(){
  const y = new Date().getFullYear();
  document.getElementById("y1Head").innerText = y - 1;
  document.getElementById("y2Head").innerText = y - 2;
  document.getElementById("y3Head").innerText = y - 3;
}
function setLoadingState(isLoading){
  const btn = document.getElementById("searchBtn");
  const inp = document.getElementById("tickerSearch");
  if (btn) btn.disabled = !!isLoading;
  if (inp) inp.disabled = !!isLoading;

  // âœ… overlay spinner
  const ov = document.getElementById("detailLoadingOverlay");
  if (ov) ov.style.display = isLoading ? "flex" : "none";
}

function updateUrlTicker(ticker){
  try{ localStorage.setItem("finapsis_detail_ticker", String(ticker||"").toUpperCase()); }catch(e){}
  const href = String(window.location.href || "");
  if (href.startsWith("about:")) return;
  try{
    const u = new URL(window.location.href);
    u.searchParams.set("ticker", ticker);
    window.history.replaceState({}, "", u.toString());
  }catch(e){
    // ignore
  }
}
function getActiveTab(){
  const active = document.querySelector('#financialTabs button.tab-btn.active');
  return active?.dataset?.tab || "income";
}
function groupLabel(g){
  const s = String(g || "").toLowerCase();
  if (s === "bist") return "BIST";
  if (s === "sp" || s === "s&p" || s === "sp500") return "S&P";
  return "TICKER";
}
function findCompanyInList(ticker){
  const t = String(ticker || "").toUpperCase();
  const list = Array.isArray(window.companies) ? window.companies : [];
  return list.find(c => String(c.ticker || "").toUpperCase() === t) || null;
}
function currencySymbolForTicker(ticker){
  const c = findCompanyInList(ticker);
  const g = String(c?.group || "").toLowerCase();
  
  // Sadece BIST ise TL, geri kalan her ÅŸey (ABD, Emtia, Kripto) Dolar
  if (g === "bist") return "â‚º";
  return "$";
}

function getBenchmarkValue(ticker, types){
  const t = String(ticker||"").toUpperCase();
  const arr = Array.isArray(window.benchmarks) ? window.benchmarks : [];
  const typeSet = new Set((types || []).map(x => String(x||"").toLowerCase().trim()));

  const hit = arr.find(b =>
    String(b.ticker||"").toUpperCase() === t &&
    typeSet.has(String(b.type||"").toLowerCase().trim())
  );

  if (!hit) return null;

  if (typeof finParseBenchmarkValue === "function") {
    const n = finParseBenchmarkValue(hit.value);
    return Number.isFinite(n) ? n : null;
  }

  const n = Number(String(hit.value||"").replace(",", "."));
  return Number.isFinite(n) ? n : null;
}

function formatCompactWithSymbol(n, sym){
  const v = Number(n);
  if (!Number.isFinite(v)) return "-";
  const abs = Math.abs(v);

  let div = 1, suf = "";
  if (abs >= 1e12) { div = 1e12; suf = "T"; }
  else if (abs >= 1e9) { div = 1e9; suf = "B"; }
  else if (abs >= 1e6) { div = 1e6; suf = "M"; }
  else if (abs >= 1e3) { div = 1e3; suf = "K"; }

  const scaled = v / div;
  const s = scaled.toLocaleString("tr-TR", { maximumFractionDigits: 2 });
  return suf ? `${s}${suf}${sym}` : `${s}${sym}`;
}

function getFinancialsEndpointForTicker(ticker){
  const c = findCompanyInList(ticker);
  const g = String(c?.group || "").toLowerCase();

  // bist -> TR
  if (g === "bist") return API_COMFIN_TR;

  // sp -> US
  if (g === "sp") return API_COMFIN_US_N;

  // default: TR (istersen baÅŸka default seÃ§ebiliriz)
  return API_COMFIN_TR;
}


/* ============================
   API (2 calls)
============================ */
/* ============================
   DATA FETCHING (R2 JSON)
============================ */

// OHLCV verisi iÃ§in bÃ¶lge belirleme (us/tr)
function getMarketCode(ticker) {
    const c = findCompanyInList(ticker);
    const g = c ? String(c.group || "").toLowerCase() : "";
    
    return 'us'; // Fallback
}

async function fetchComDetail(ticker) {
    const t = String(ticker).toUpperCase();
    const market = getMarketCode(t);
    const companyInfo = findCompanyInList(t) || {};

    // 1. About Verisi (Cacheli)
    if (!window.__ABOUT_CACHE) {
        try {
            const res = await fetch(`${window.FIN_DATA_BASE}/static/companies.about.v1.json`);
            if (res.ok) window.__ABOUT_CACHE = await res.json();
            else window.__ABOUT_CACHE = [];
        } catch (e) { window.__ABOUT_CACHE = []; }
    }
    const aboutObj = window.__ABOUT_CACHE.find(x => x.ticker === t);

    
    // 2. Price History (OHLCV)
    let price_history = [];
    try {
        let historyUrl = "";
        
        // Grup KontrolÃ¼: Sadece hisse senetleri standart yolu kullanÄ±r
        const g = companyInfo ? (companyInfo.group || "").toLowerCase() : "";
        const isStock = ['bist', 'nyse', 'nasdaq', 'sp'].includes(g);

        if (isStock) {
             // Hisse Senedi: BÃ¼yÃ¼k harf ticker, /1d.v1.json uzantÄ±sÄ±, market kodu dinamik (tr/us)
             historyUrl = `${window.FIN_DATA_BASE}/ohlcv/ticker/${market}/${t}/1d.v1.json`;
        } else {
             // GÃ¶sterge (DÃ¶viz, Emtia vb.): KÃ¼Ã§Ã¼k harf ticker, direkt .json uzantÄ±sÄ±, sabit 'us' klasÃ¶rÃ¼
             historyUrl = `${window.FIN_DATA_BASE}/ohlcv/ticker/us/${t.toLowerCase()}.json`;
        }

        const histRes = await fetch(historyUrl);
        if (histRes.ok) {
            const histJson = await histRes.json();
            // JSON formatÄ±: { rows: [{t, o, h, l, c, v}, ...] }
            price_history = histJson.rows || [];
        }
    } catch (e) { console.warn("History fetch failed", e); }

    // 3. Åžirket Objesini OluÅŸtur (UI iÃ§in uyumlu hale getir)
    const apiCompany = {
        ticker: t,
        name: companyInfo.name,
        // About JSON'dan gelen about_tr, yoksa fallback
        about: aboutObj ? (aboutObj.about_tr || aboutObj.about) : "Åžirket aÃ§Ä±klamasÄ± bulunamadÄ±.",
        founded: companyInfo.founded,
        employees: companyInfo.employees,
        sector: companyInfo.sector_tr || companyInfo.sector,
        industry: companyInfo.industry_tr || companyInfo.industry,
        market_cap: null // Hesaplanan deÄŸerler UI tarafÄ±nda hallediliyor
    };

    return {
        company: apiCompany,
        price_history: price_history,
        news: [] // R2'da haber kaynaÄŸÄ± olmadÄ±ÄŸÄ± iÃ§in boÅŸ dizi
    };
}
// âœ… PortfÃ¶y tarihÃ§e iÃ§in dÄ±ÅŸarÄ± aÃ§
window.fetchComDetail = fetchComDetail;

async function fetchComFinancials(ticker) {
    const t = String(ticker).toUpperCase();
    try {
        // URL oluÅŸtur (Proxy varsa proxyUrl fonksiyonunu kullanÄ±r, yoksa direkt)
        // EÄŸer proxyUrl fonksiyonu tanÄ±mlÄ± deÄŸilse direkt string birleÅŸtirme yaparÄ±z.
        const path = `${window.FIN_DATA_BASE}/financials/${t}.json`;
        const url = (typeof proxyUrl === 'function') ? proxyUrl(path) : path;
        
        const res = await fetch(url);
        
        if (res.ok) {
            const json = await res.json();

            // 1. SENARYO (Sizin Durumunuz): [ { "financials": [...] } ]
            if (Array.isArray(json) && json.length > 0 && json[0].financials) {
                return { financials: json[0].financials };
            }

            // 2. SENARYO (Alternatif): { "financials": [...] }
            if (json.financials && Array.isArray(json.financials)) {
                return { financials: json.financials };
            }

            // 3. SENARYO: Direkt veri dizisi [ {...}, {...} ]
            if (Array.isArray(json)) {
                return { financials: json };
            }

            return { financials: [] };
        }
    } catch (e) { 
        console.warn("Financials fetch failed", e); 
    }
    return { financials: [] };
}


/* ============================
   UI RENDER
============================ */
function renderHeaderFromCompanies(ticker){
  // 1. Ã–nce ÅŸirketi listeden bulup 'c' deÄŸiÅŸkenine atÄ±yoruz
  const c = findCompanyInList(ticker);

  // 2. Grup ismini belirliyoruz (c yoksa varsayÄ±lan BIST)
  let groupName = "BIST";
  if (c) {
      groupName = (c.exchange || c.group || "BIST").toUpperCase();
  }
  // Ä°steÄŸe baÄŸlÄ±: SP grubunu US olarak gÃ¶stermek isterseniz:
  if(groupName === 'SP') groupName = 'US'; 

  // 3. Ä°sim ve SektÃ¶r
  const name = c?.name || ticker;
  // TÃ¼rkÃ§e sektÃ¶r varsa onu, yoksa Ä°ngilizceyi, yoksa boÅŸ
  const secText = c?.sector_tr || c?.sector || "";
  const sector = secText ? `â€¢ ${secText}` : "";

  // 4. HTML GÃ¼ncellemeleri
  // Badge formatÄ±: GROUP: TICKER (Ã–rn: NYSE: AAPL)
  const pillEl = document.getElementById("tickerPill");
  if(pillEl) pillEl.innerText = `${groupName}: ${ticker}`;

  const titleEl = document.getElementById("companyTitle");
  if(titleEl) titleEl.innerText = name;

  const metaEl = document.getElementById("companyMeta");
  if(metaEl) metaEl.innerText = c ? `${groupName} ${sector}` : "Veri aranÄ±yor...";

  const chartTitleEl = document.getElementById("chartTitle");
  if(chartTitleEl) chartTitleEl.innerText = `${name} Hisse FiyatÄ±`;

  // 5. Logo Ä°ÅŸlemleri
  const logoEl = document.getElementById("companyLogo");
  const fbEl = document.getElementById("companyLogoFallback");
  const url = (c?.logourl || "").trim();

  if (logoEl && fbEl) {
      if (url){
        logoEl.src = url;
        logoEl.classList.remove("hidden");
        fbEl.classList.add("hidden");
        logoEl.onerror = () => {
          logoEl.classList.add("hidden");
          fbEl.classList.remove("hidden");
        };
      } else {
        logoEl.classList.add("hidden");
        fbEl.classList.remove("hidden");
      }
  }
}

function renderAbout(){
  const apiCompany = window.apiCompany || {};
  const c = window.currentCompany || {};
  const ticker = apiCompany.ticker || c.ticker || "-";

  // BaÅŸlÄ±k
  const titleEl = document.getElementById("detailTitle");
  if (titleEl) titleEl.textContent = `${c.name || apiCompany.name || ticker} (${ticker})`;

  // SaÄŸ Ã¼st snapshot alanlarÄ±
  const tickerVal = document.getElementById("tickerVal");
  if (tickerVal) tickerVal.textContent = ticker;

  const foundedEl = document.getElementById("foundedVal");
  const empEl = document.getElementById("empVal");
  const sectorEl = document.getElementById("sectorVal");
  const mcapEl = document.getElementById("mcapVal");

  const founded = apiCompany.founded || c.founded || "-";
  // R2 verisinde employees sayÄ± gelebilir, formatlayalÄ±m
  let employees = apiCompany.employees || c.employees || "-";
  if(typeof employees === 'number') employees = employees.toLocaleString('tr-TR');

  // TR Ã¶ncelikli sektÃ¶r
  const sector = c.sector_tr || apiCompany.sector || c.sector || "-";

  if (foundedEl) foundedEl.textContent = founded;
  if (empEl) empEl.textContent = employees;
  if (sectorEl) sectorEl.textContent = sector;

  // --- Market Cap ---
  if (mcapEl){
    const mcapRaw =
      c?.market_cap ?? c?.marketcap ?? c?.mcap ?? c?.marketCap ??
      apiCompany?.market_cap ?? apiCompany?.marketcap ?? apiCompany?.mcap ?? apiCompany?.marketCap ??
      null;

    let n = Number(mcapRaw);

    if (!Number.isFinite(n) || n === 0) {
      const bm = getBenchmarkValue(ticker, ["Piyasa DeÄŸeri", "Market Cap"]);
      if (Number.isFinite(bm)) n = bm;
    }

    const sym = currencySymbolForTicker(ticker); // SP -> $, BIST -> â‚º
    mcapEl.textContent = Number.isFinite(n) && n !== 0
      ? formatCompactWithSymbol(n, sym)
      : "-";
  }

  // Sol taraftaki aÃ§Ä±klama metni
  const aboutEl = document.getElementById("aboutText");
  if (aboutEl) aboutEl.textContent = apiCompany.about || apiCompany.description || "-";
}


function isMoneyMetricType(type){
  const s = String(type || "").toLowerCase().trim();

  // âœ… PARA BÄ°RÄ°MÄ° ASLA EKLENMEYECEKLER (Ã¶nce bunlarÄ± ele)
  if (
    /devir|turnover|sÃ¼re|sure|gÃ¼n|gun|days|cycle|dÃ¶ngÃ¼|dongu/.test(s) ||         // BorÃ§ Devir HÄ±zÄ±, Stok SÃ¼resi, Nakit DÃ¶ngÃ¼sÃ¼ vb.
    /oran|ratio|marj|margin|%|percent/.test(s) ||                               // oran/marj
    /\broic\b|\broa\b|\broe\b|\bbeta\b/.test(s) ||                              // RO* / beta
    /pd\/dd|p\/b|f\/k|p\/e|fiyat\/satÄ±ÅŸ|price\/sales/.test(s) ||                // Ã§arpanlar
    /borÃ§\/Ã¶z|debt\/equity/.test(s)                                             // BorÃ§/Ã–z Kaynak
  ) return false;

  // âœ… PARA BÄ°RÄ°MÄ° EKLENECEKLER (whitelist / daha gÃ¼venli)
  if (
    /piyasa deÄŸeri|market cap/.test(s) ||
    /firma deÄŸeri|enterprise value/.test(s) ||
    /satÄ±ÅŸ gelirleri|gelirler|revenue|sales/.test(s) ||
    /nakit ve nakit benzerleri|cash and cash equivalents/.test(s) ||
    /serbest nakit|free cash|fcf/.test(s) ||
    /net borÃ§\b|net debt\b/.test(s) ||                 // dikkat: "borÃ§ devir" deÄŸil, net borÃ§
    /Ã¶zkaynak|equity/.test(s)
  ) return true;

  return false;
}
function isPercentMetricType(type){
  const s = String(type || "").toLowerCase().trim();
  return (
    /brÃ¼t kar marjÄ±|brut kar marji/.test(s) ||
    /faaliyet k[Ã¢a]r marjÄ±|faaliyet kar marji/.test(s) ||
    /\broic\b|\broa\b|\broe\b|\bwacc\b/.test(s) ||
    /satÄ±ÅŸ bÃ¼yÃ¼mesi ttm|satis buyumesi ttm/.test(s) ||
    /faaliyet kar bÃ¼yÃ¼mesi ttm/.test(s)
  );
}
function isDaysMetricType(type){
  const s = String(type || "").toLowerCase().trim();
  return (
    /stok sÃ¼resi|stok suresi/.test(s) ||
    /alacak sÃ¼resi|alacak suresi/.test(s) ||
    /borÃ§ sÃ¼resi|borc suresi/.test(s) ||
    /nakit dÃ¶ngÃ¼sÃ¼|nakit dongusu/.test(s)
  );
}


function getActiveFinancialTab(){
  const btn = document.querySelector("#financialTabs .tab-btn.active");
  return btn ? btn.dataset.tab : "ratios";
}

function toggleOverviewMetricsCard(tab){
  const card = document.getElementById("overviewMetricsCard");
  const wrap = document.getElementById("financialTableWrap");

  const t = tab || getActiveFinancialTab();

  if (card) card.style.display = (t === "ratios") ? "block" : "none";
  if (wrap) wrap.style.display = (t === "ratios") ? "none" : "block";
}



// âœ… YENÄ°: OranlarÄ± ve Market Cap'i Finansallardan Hesapla
// âœ… YENÄ°: OranlarÄ± ve Market Cap'i Finansallardan Hesapla
async function renderBenchmarksMetrics() {
    const listEl = document.getElementById("overviewMetricsList") || document.getElementById("metricsList");
    if (!listEl) return;

    // 1. Veri KaynaÄŸÄ±: apiFinancials
    const rows = Array.isArray(window.apiFinancials) ? window.apiFinancials : [];
    
    // Helper: Finansal tablodan deÄŸer bul (BÃ¼yÃ¼k/kÃ¼Ã§Ã¼k harf ve TÃ¼rkÃ§e karakter duyarsÄ±z)
    const findVal = (keys) => {
        const keyList = Array.isArray(keys) ? keys : [keys];
        const hit = rows.find(r => 
            keyList.some(k => String(r.item || "").toLowerCase().replace(/Ä±/g,'i') === k.toLowerCase().replace(/Ä±/g,'i'))
        );
        if (!hit) return null;
        // TTM varsa onu, yoksa value'yu al
        const val = hit.ttm !== undefined ? hit.ttm : hit.value;
        return safeNum(val);
    };

    // Listenizde kullanÄ±lan helperlar
    const pick = (keys) => findVal(keys);
    const asPct01 = (v) => v; // DeÄŸer zaten 0.52 formatÄ±nda geliyor, iÅŸlem fmt iÃ§inde yapÄ±lÄ±yor (*100)

    // --- MARKET CAP HESAPLAMA ---
    let mcapDisplay = "-";
    
    // A. Hisse Adedini Bul
    const shareKeys = ["Total Common Shares Outstanding", "Hisse Adedi", "Shares Outstanding (Basic)"];
    const shares = findVal(shareKeys);
    
    // B. FiyatÄ± Bul
    const { current } = derived52w || { current: 0 };
    const live = getLivePriceFromGlobal(currentTicker);
    const price = (live.cur !== null && live.cur > 0) ? live.cur : current;

    if (shares && price) {
        let finalShares = shares;

        // C. ADR (DRS) KontrolÃ¼
        try {
            if (!window.__ADR_CACHE) {
                const path = `${window.FIN_DATA_BASE}/static/drs.json`;
                // Global proxyUrl varsa kullan
                const url = (typeof proxyUrl === 'function') ? proxyUrl(path) : path;
                const res = await fetch(url);
                if (res.ok) {
                    const rawAdr = await res.json();
                    window.__ADR_CACHE = {};
                    for (const [k, v] of Object.entries(rawAdr)) {
                        const p = v.split(':');
                        if (p.length === 2) window.__ADR_CACHE[k] = parseFloat(p[0]) / parseFloat(p[1]);
                    }
                }
            }

            const ratio = window.__ADR_CACHE ? window.__ADR_CACHE[currentTicker] : null;
            if (ratio && ratio > 0) {
                finalShares = shares / ratio;
            }
        } catch (e) { console.warn("ADR calc error", e); }

        const mcap = finalShares * price;
        const sym = currencySymbolForTicker(currentTicker);
        mcapDisplay = formatCompactWithSymbol(mcap, sym);

        // Header'daki Market Cap deÄŸerini de gÃ¼ncelle
        const headerMcap = document.getElementById("mcapVal");
        if (headerMcap) headerMcap.textContent = mcapDisplay;
    }

    // --- METRÄ°K LÄ°STESÄ° (TAM LÄ°STE) ---
    const items = [
      { label:"F/K", cat:"DeÄŸerleme", v: pick(["F/K", "Fiyat/KazanÃ§", "PE Ratio"]), fmt:(v)=>v.toFixed(2), ok:(v)=>v>0 && v<20 },
        { label:"PD/DD", cat:"DeÄŸerleme", v: pick(["PD/DD", "Price to Book"]), fmt:(v)=>v.toFixed(2), ok:(v)=>v<3 },
        { label:"Cari Oran", cat:"Likidite", v: pick(["Cari Oran"]), fmt:(v)=>v.toFixed(2), ok:(v)=>v>=1.5 },
        { label:"Asit Test OranÄ±", cat:"Likidite", v: pick(["Asit Test OranÄ±"]), fmt:(v)=>v.toFixed(2), ok:(v)=>v>=1.0 },

        { label:"BrÃ¼t Kar MarjÄ±", cat:"KÃ¢rlÄ±lÄ±k", v: asPct01(pick(["BrÃ¼t Kar MarjÄ±"])), fmt:(v)=>(v*100).toFixed(1)+"%", ok:(v)=>v>=0.30 },
        { label:"Faaliyet Kar MarjÄ±", cat:"KÃ¢rlÄ±lÄ±k", v: asPct01(pick(["Faaliyet KÃ¢r MarjÄ±","Faaliyet Kar MarjÄ±"])), fmt:(v)=>(v*100).toFixed(1)+"%", ok:(v)=>v>=0.15 },

        { label:"ROA", cat:"KÃ¢rlÄ±lÄ±k", v: asPct01(pick(["ROA"])), fmt:(v)=>(v*100).toFixed(1)+"%", ok:(v)=>v>=0.05 },
        { label:"ROE", cat:"KÃ¢rlÄ±lÄ±k", v: asPct01(pick(["ROE"])), fmt:(v)=>(v*100).toFixed(1)+"%", ok:(v)=>v>=0.12 },
        { label:"ROIC", cat:"KÃ¢rlÄ±lÄ±k", v: asPct01(pick(["ROIC"])), fmt:(v)=>(v*100).toFixed(1)+"%", ok:(v)=>v>=0.10 },

        { label:"BorÃ§ / Ã–z Kaynak", cat:"Risk", v: pick(["BorÃ§/Ã–z Kaynak","BorÃ§ / Ã–z Kaynak"]), fmt:(v)=>v.toFixed(2)+"x", ok:(v)=>v<=1.5 },

        { label:"Stok Devir HÄ±zÄ±", cat:"Verimlilik", v: pick(["Stok Devir HÄ±zÄ±"]), fmt:(v)=>v.toFixed(2), ok:(v)=>v>=4 },
        { label:"Alacak Devir HÄ±zÄ±", cat:"Verimlilik", v: pick(["Alacak Devir HÄ±zÄ±"]), fmt:(v)=>v.toFixed(2), ok:(v)=>v>=6 },
        { label:"BorÃ§ Devir HÄ±zÄ±", cat:"Verimlilik", v: pick(["BorÃ§ Devir HÄ±zÄ±"]), fmt:(v)=>v.toFixed(2), ok:(v)=>v>=6 },

        { label:"Nakit DÃ¶ngÃ¼sÃ¼", cat:"Verimlilik", v: pick(["Nakit DÃ¶ngÃ¼sÃ¼"]), fmt:(v)=>Math.round(v)+" gÃ¼n", ok:(v)=>v<=60 },
    ];

    listEl.innerHTML = items.map(it => {
        const has = (it.v !== null && it.v !== undefined);
        const num = Number(it.v);
        const good = has ? it.ok(num) : null;

        const badgeText = (good === null) ? "â€”" : (good ? "GÃœÃ‡LÃœ" : "ZAYIF");
        const badgeClass = (good === null) ? "badge" : (good ? "badge neon" : "badge");
        const display = has ? it.fmt(num) : "-";

        return `
      <div class="metric-row">
        <div class="flex flex-col">
          <span class="text-white text-sm font-semibold">${it.label}</span>
          <div class="mt-1"><span class="badge">${it.cat}</span></div>
        </div>
        <div class="flex items-center gap-3">
          <span class="text-white font-extrabold text-sm tracking-wide">${display}</span>
          <span class="${badgeClass}">${badgeText}</span>
        </div>
      </div>
    `;
    }).join("");

    toggleOverviewMetricsCard(getActiveFinancialTab());
}



/* Mini bar chart: son 4 dÃ¶nem Gelir & KÃ¢r */
function renderMiniBars(){
  const wrap = document.getElementById("miniBarsWrap");
  if (!wrap) return;

  const rows = Array.isArray(window.apiFinancials) ? window.apiFinancials : [];
  if (!rows.length){
    wrap.innerHTML = `<div style="text-align:center; padding:18px; color:#666; font-weight:900; width:100%;">Finansallar yÃ¼kleniyor...</div>`;
    return;
  }

  const norm = (s) =>
  String(s || "")
    .toLowerCase()
    .replace(/Ä±/g,"i").replace(/ÄŸ/g,"g").replace(/Ã¼/g,"u").replace(/ÅŸ/g,"s").replace(/Ã¶/g,"o").replace(/Ã§/g,"c")
    .trim();

const findRow = (type, keys) => rows.find(r => {
  if (r.type !== type) return false;
  const item = norm(r.item);
  return keys.some(k => item.includes(norm(k)));
});


  const rev = findRow("income", ["revenue", "sales", "ciro", "hasÄ±lat", "SatÄ±ÅŸ Gelirleri"]);
  const prof = findRow("income", ["net income", "net profit", "net", "kar", "DÃ¶nem KarÄ± (ZararÄ±)"]);

  if (!rev || !prof){
    wrap.innerHTML = `<div style="text-align:center; padding:18px; color:#666; font-weight:900; width:100%;">Gelir/KÃ¢r verisi bulunamadÄ±.</div>`;
    return;
  }

  const keys = ["tminus3","tminus2","tminus1","ttm"];
  const labels = ["D-3","D-2","D-1","TTM"];

  const revVals = keys.map(k => Number(rev[k]));
  const profVals = keys.map(k => Number(prof[k]));

  const maxRev = Math.max(...revVals.map(v => Number.isFinite(v) ? Math.abs(v) : 0), 1);
  const maxProf = Math.max(...profVals.map(v => Number.isFinite(v) ? Math.abs(v) : 0), 1);

  wrap.innerHTML = labels.map((lb, i)=>{
    const r = revVals[i];
    const p = profVals[i];

    const rh = Number.isFinite(r) ? Math.max(4, Math.round((Math.abs(r)/maxRev)*96)) : 4;
    const ph = Number.isFinite(p) ? Math.max(4, Math.round((Math.abs(p)/maxProf)*96)) : 4;

    const pCls = (!Number.isFinite(p)) ? "profit" : (p < 0 ? "profit neg" : "profit");

    return `
      <div class="mini-col">
        <div class="mini-bars-stack">
          <div class="mini-bar" style="height:${rh}px"></div>
          <div class="mini-bar ${pCls}" style="height:${ph}px"></div>
        </div>
        <div class="mini-label">${lb}</div>
      </div>
    `;
  }).join("");
}


function renderNews(){
  const container = document.getElementById("newsList");
  if (!Array.isArray(apiNews) || !apiNews.length){
    container.innerHTML = `<div class="p-4 text-sm text-[#888] font-semibold">Haber yok.</div>`;
    requestSendHeight(false);
    return;
  }

  container.innerHTML = apiNews.map(n => {
    const d = parseMMDDYYYY(n.date);
    const dateText = d ? fmtISODate(d.getTime()) : (n.date || "");
    const url = (n.link || "").trim();
    const isValid = !!url && url !== "#";
    const senti = (n.sentiment || "").trim();

    return `
      <a href="${isValid ? url : "javascript:void(0)"}" class="news-item group" ${isValid ? 'target="_blank" rel="noopener"' : ""}>
        <div class="flex justify-between items-center mb-1">
          <span class="text-[10px] text-[#888] font-extrabold uppercase tracking-widest">${n.source || "Kaynak"}</span>
          <span class="text-[10px] text-[#555] font-black uppercase tracking-widest">${dateText}</span>
        </div>
        <div class="text-[#ddd] text-xs font-semibold leading-snug group-hover:text-[#c2f50e] transition-colors">
          ${n.title || "-"}
        </div>
        ${senti ? `<div class="mt-2"><span class="badge neon">${senti}</span></div>` : ``}
      </a>
    `;
  }).join("");

  requestSendHeight(false);
}

function renderFinancialTable(tabName){
  const tbody = document.getElementById("financialsBody");
  // âœ… Genel BakÄ±ÅŸ (ratios) sekmesinde financial ratios tablosunu gÃ¶stermiyoruz
if (tabName === "ratios") {
  tbody.innerHTML = "";
  requestSendHeight(false);
  return;
}


  const rows = (Array.isArray(apiFinancials) ? apiFinancials : [])
  .filter(i => i.type === tabName)
  .map((r, idx) => ({ ...r, __idx: idx })); // âœ… API sÄ±rasÄ±nÄ± korumak iÃ§in

  // âœ… order_no ile sÄ±rala (yoksa en sona at)
const sorted = rows.slice().sort((a, b) => {
  const ao = Number(a?.order_no ?? a?.orderNo ?? a?.orderno);
  const bo = Number(b?.order_no ?? b?.orderNo ?? b?.orderno);

  const aHas = Number.isFinite(ao);
  const bHas = Number.isFinite(bo);

  if (aHas && bHas) return ao - bo;
  if (aHas && !bHas) return -1;
  if (!aHas && bHas) return 1;

  // âœ… order yoksa: API sÄ±rasÄ±
  return (a?.__idx ?? 0) - (b?.__idx ?? 0);
});



  if (!rows.length){
    tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:18px; color:#666; font-weight:900;">Veri yok.</td></tr>`;
    requestSendHeight(false);
    return;
  }

  tbody.innerHTML = sorted.map(r => `
    <tr>
      <td>${r.item || "-"}</td>
      <td style="color:#c2f50e; font-weight:900">${formatFinancial(r.ttm, r.value_type)}</td>
      <td>${formatFinancial(r.tminus1, r.value_type)}</td>
      <td>${formatFinancial(r.tminus2, r.value_type)}</td>
      <td>${formatFinancial(r.tminus3, r.value_type)}</td>
    </tr>
  `).join("");

  requestSendHeight(false);
}

/* ============================
   CHART + 52W
============================ */
function buildFullChartFromHistory(history){
  // R2 verisi: { t: 1104762600, c: 17.08, ... }
  // Eski API verisi: { date: "01012023", price: "12.5" }
  
  const cleaned = (Array.isArray(history) ? history : [])
    .map(p => {
        // Yeni format (R2) kontrolÃ¼
        if (p.t !== undefined && p.c !== undefined) {
            return {
                // t saniye cinsinden geliyor, JS ms ister -> * 1000
                x: p.t * 1000, 
                y: Number(p.c)
            };
        }
        
        // Eski format (Fallback - Geri uyumluluk)
        const d = parseMMDDYYYY(p.date);
        const price = safeNum(p.price);
        if (d && price !== null) {
            return { x: d.getTime(), y: price };
        }
        return null;
    })
    .filter(p => p !== null)
    .sort((a,b) => a.x - b.x);

  chartFull.points = cleaned;
}

function calc52wFromPoints(points){
  if (!points || !points.length) return { low: 0, high: 0, current: 0 };

  // 1. Son verinin tarihini al (Referans noktasÄ±)
  const lastPoint = points[points.length - 1];
  const lastDate = lastPoint.x; 
  const current = lastPoint.y;

  // 2. 365 GÃ¼n (1 YÄ±l) Ã¶ncesini hesapla (milisaniye cinsinden)
  const oneYearMs = 365 * 24 * 60 * 60 * 1000;
  const cutOff = lastDate - oneYearMs;

  // 3. Sadece son 1 yÄ±l iÃ§indeki noktalarÄ± tara
  let low = current;  // BaÅŸlangÄ±Ã§ deÄŸerleri olarak ÅŸimdiki fiyatÄ± ata
  let high = current;

  for (const p of points){
    // Tarih kontrolÃ¼: EÄŸer veri 1 yÄ±ldan eskiyse atla
    if (p.x < cutOff) continue;

    if (p.y < low) low = p.y;
    if (p.y > high) high = p.y;
  }

  return { low, high, current };
}

function render52w(){
  const { low, high, current } = derived52w || { low:0, high:0, current:0 };
  const denom = (high - low);
  let pct = denom > 0 ? ((current - low) / denom) * 100 : 0;
  pct = Math.max(0, Math.min(100, pct));

  document.getElementById("rangeFill").style.width = pct + "%";
  document.getElementById("rangeThumb").style.left = pct + "%";
  document.getElementById("currentPriceLabel").innerText = formatPrice(current);
  document.getElementById("lowPrice").innerText = formatPrice(low);
  document.getElementById("highPrice").innerText = formatPrice(high);

  // âœ… DÃœZELTME: Para birimi simgesini merkezi fonksiyondan al
// âœ… DÃœZELTME: Para birimi simgesini merkezi fonksiyondan al
  let sym = currencySymbolForTicker(currentTicker);

  // --- INDICATORS MAP KONTROLÃœ ---
  if (window.__INDICATORS_MAP) {
      const indKey = String(currentTicker).toLowerCase();
      const indObj = window.__INDICATORS_MAP[indKey];
      
      // EÄŸer bu varlÄ±k bir gÃ¶sterge ise (haritada varsa):
      if (indObj) {
          // Unit tanÄ±mlÄ±ysa onu kullan (Ã¶rn: â‚¬), tanÄ±mlÄ± deÄŸilse BOÅž string yap.
          // BÃ¶ylece varsayÄ±lan $ veya â‚º mantÄ±ÄŸÄ±nÄ± ezeriz.
          sym = indObj.unit || "";
      }
  }
  // ---------------------------------------------------------

  // CanlÄ± fiyatÄ± veya mevcut fiyatÄ± kullan
  const live = getLivePriceFromGlobal(currentTicker);
  const shownPrice = (live.cur !== null && live.cur > 0) ? live.cur : current;

  const hp = document.getElementById("headerPrice");
const hpVal = document.getElementById("headerPriceVal");
const hc = document.getElementById("headerCaret");

const priceText = (shownPrice ? sym + formatPrice(shownPrice) : "-");

// âœ… Yeni HTML varsa spanâ€™a yaz
if (hpVal) hpVal.innerText = priceText;

// âœ… Eski HTML varsa (tek div) ona yaz
else if (hp) hp.innerText = priceText;


// caret + renk (ÅŸirketler tablosu gibi)
let ch = null;
if (live.cur !== null && live.prev !== null && live.prev > 0) {
  ch = ((live.cur - live.prev) / live.prev) * 100;
}

const isUp = (ch !== null && ch > 0);
const isDown = (ch !== null && ch < 0);

// headerPrice rengi
if (hp) {
  hp.style.color = isUp ? "#c2f50e" : (isDown ? "#ff4d4d" : "#ffffff");
}

// caret ikonu
if (hc) {
  if (ch === null || ch === 0) {
    hc.classList.add("hidden");
    hc.innerHTML = "";
  } else {
    hc.classList.remove("hidden");
    hc.innerHTML = isUp
      ? '<i class="fa-solid fa-caret-up"></i>'
      : '<i class="fa-solid fa-caret-down"></i>';
  }
}


  // DeÄŸiÅŸim yÃ¼zdesi
  const el = document.getElementById("headerChange");
const elIcon = document.getElementById("headerTrendIcon");
const elVal = document.getElementById("headerChangeVal");

if (el){
  if (ch !== null){
    el.style.visibility = "visible";
    el.style.color = isUp ? "#c2f50e" : (isDown ? "#ff4d4d" : "#bdbdbd");
    if (elIcon) elIcon.className = `fa-solid ${isUp ? "fa-arrow-trend-up" : (isDown ? "fa-arrow-trend-down" : "fa-minus")}`;
    if (elVal) elVal.innerText = `${ch >= 0 ? "+" : ""}${ch.toFixed(2)}%`;
  } else {
    el.style.visibility = "hidden";
  }
}

}

function lockChartWheel(){
  const el = document.querySelector("#priceChart");
  if (!el) return;
  el.addEventListener("wheel", (e) => e.stopPropagation(), { passive: true });
}

function getRangeSlice(rangeKey){
  const pts = chartFull.points || [];
  const n = pts.length;
  if (!n) return { points: [] };

  const last = (k) => {
    const take = Math.max(1, Math.min(n, k));
    return { points: pts.slice(n - take) };
  };

  if (rangeKey === "1M") return last(21);
  if (rangeKey === "3M") return last(63);
  if (rangeKey === "6M") return last(126);
  // 1Y varsayÄ±lan (yaklaÅŸÄ±k 252 iÅŸlem gÃ¼nÃ¼)
  if (rangeKey === "1Y") return last(252);
  
  // MAX ve diÄŸerleri iÃ§in hepsi
  return { points: pts };
}

function tickAmountForRange(rangeKey){
  // screenshot gibi: az ama dÃ¼zenli
  if (rangeKey === "1M") return 5;
  if (rangeKey === "3M") return 6;
  if (rangeKey === "6M") return 7;
  return 7; // 1Y
}

function ensureChart(rangeKey){
  activeRange = rangeKey;
  const pack = getRangeSlice(rangeKey);
  const el = document.querySelector("#priceChart");
  if (!el) return;

  if (!pack.points || pack.points.length === 0){
    el.innerHTML = `<div style="padding:16px; color:#777; font-weight:900;">Fiyat verisi yok.</div>`;
    requestSendHeight(false);
    return;
  }

  const tickAmount = tickAmountForRange(rangeKey);

  const options = {
    series: [{ name: "Fiyat", data: pack.points }],
    chart: {
      type: "area",
      height: 300,
      fontFamily: "Inter",
      toolbar: { show: false },
      background: "transparent",
      zoom: { enabled: false },
      pan: { enabled: false }
    },
    theme: { mode: "dark" },
    colors: ["#c2f50e"],
    stroke: { curve: "smooth", width: 2 },
    fill: { type: "gradient", gradient: { shadeIntensity: 1, opacityFrom: 0.45, opacityTo: 0.06, stops: [0, 85, 100] } },
    dataLabels: { enabled: false },
    grid: { borderColor: "rgba(255,255,255,0.06)", strokeDashArray: 4, padding: { left: 10, right: 10 } },
    xaxis: {
      type: "datetime",
      tickAmount,
      labels: {
        rotate: -45,
        rotateAlways: true,
        hideOverlappingLabels: true,
        showDuplicates: false,
        style: { colors: "#ffffff", fontWeight: 800 },
        formatter: (val) => fmtISODate(val)
      },
      axisBorder: { show: false },
      axisTicks: { show: false }
    },
    yaxis: {
      labels: {
        style: { colors: "#ffffff", fontWeight: 800 },
        formatter: (v) => Number(v).toFixed(2)
      }
    },
    tooltip: { theme: "dark", x: { formatter: (val) => fmtISODate(val) } },
    markers: { size: 0 },
    legend: { show: false }
  };

  try{
    if (!chartInstance){
      el.innerHTML = ""; // placeholder temizle
      chartInstance = new ApexCharts(el, options);
      requestAnimationFrame(() => {
        chartInstance.render().then(() => {
          requestSendHeight(true);
          setTimeout(() => requestSendHeight(true), 250);
        });
      });
    } else {
      chartInstance.updateOptions({ xaxis: options.xaxis }, false, true);
      chartInstance.updateSeries([{ name: "Fiyat", data: pack.points }], true);
      requestSendHeight(false);
    }
  } catch(e){
    el.innerHTML = `<div style="padding:16px; color:#ff8888; font-weight:900;">Chart hatasÄ±: ${String(e && e.message ? e.message : e)}</div>`;
    requestSendHeight(true);
  }
}

/* ============================
   SEARCH (autocomplete from window.companies)
============================ */
function scoreMatch(q, c){
  // basit skorlama: ticker prefix > ticker contains > name contains
  const tq = q.toUpperCase();
  const t = String(c.ticker || "").toUpperCase();
  const n = String(c.name || "").toUpperCase();
  if (t.startsWith(tq)) return 3;
  if (t.includes(tq)) return 2;
  if (n.includes(tq)) return 1;
  return 0;
}

function renderSearchDropdown(query){
  const dd = document.getElementById("searchDD");
  const q = String(query || "").trim();
  const list = Array.isArray(window.companies) ? window.companies : [];

  if (!q || q.length < 1 || !list.length){
    dd.style.display = "none";
    dd.innerHTML = "";
    return;
  }

  const matches = list
    .map(c => ({ c, s: scoreMatch(q, c) }))
    .filter(x => x.s > 0)
    .sort((a,b) => b.s - a.s || String(a.c.ticker).localeCompare(String(b.c.ticker)))
    .slice(0, 10)
    .map(x => x.c);

  if (!matches.length){
    dd.style.display = "none";
    dd.innerHTML = "";
    return;
  }

  dd.innerHTML = matches.map(c => {
    const gl = groupLabel(c.group);
    const sec = c.sector ? c.sector : "â€”";
    return `
      <div class="dd-item" data-ticker="${String(c.ticker || "").toUpperCase()}">
        <div class="dd-left">
          <div class="dd-title">${c.name || c.ticker}</div>
          <div class="dd-sub">${gl} â€¢ ${sec}</div>
        </div>
        <div class="dd-right">
          <span class="badge">${gl}</span>
          <span class="dd-ticker">${String(c.ticker || "").toUpperCase()}</span>
        </div>
      </div>
    `;
  }).join("");

  dd.style.display = "block";
}

function hideSearchDropdown(){
  const dd = document.getElementById("searchDD");
  dd.style.display = "none";
  dd.innerHTML = "";
}

/* ============================
   LOAD FLOW (2 API)
============================ */
async function loadAll(ticker){
  const mySeq = ++loadSeq;
  currentTicker = sanitizeTicker(ticker);

  // header from companies list immediately
  renderHeaderFromCompanies(currentTicker);
  const tv = document.getElementById("tickerVal");
if (tv) tv.innerText = currentTicker;


  // placeholders
  setLoadingState(true);
  document.getElementById("aboutText").innerText = "YÃ¼kleniyor...";
  const om = document.getElementById("overviewMetricsList");
if (om){
  om.innerHTML = `<div style="text-align:center; padding:18px; color:#666; font-weight:900;">Metrikler yÃ¼kleniyor...</div>`;
}
const mb = document.getElementById("miniBarsWrap");
if (mb){
  mb.innerHTML = `<div style="text-align:center; padding:18px; color:#666; font-weight:900; width:100%;">Finansallar yÃ¼kleniyor...</div>`;
}

  document.getElementById("newsList").innerHTML = `<div class="p-4 text-sm text-[#888] font-semibold">Haberler yÃ¼kleniyor...</div>`;
  document.getElementById("financialsBody").innerHTML =
    `<tr><td colspan="5" style="text-align:center; padding:18px; color:#666; font-weight:900;">Finansallar yÃ¼kleniyor...</td></tr>`;

  // reset numeric UI
  document.getElementById("headerPrice").innerText = "-";
  document.getElementById("currentPriceLabel").innerText = "-";
  document.getElementById("lowPrice").innerText = "-";
  document.getElementById("highPrice").innerText = "-";
  document.getElementById("rangeFill").style.width = "0%";
  document.getElementById("rangeThumb").style.left = "0%";

  // reset state
  apiCompany = null;
  apiPriceHistory = [];
  apiNews = [];
  apiFinancials = [];
  window.apiCompany = {};
window.currentCompany = {};

  chartFull = { points: [] };
  derived52w = { low:0, high:0, current:0 };

  // destroy chart to avoid edge render issues
  if (chartInstance){
    try { chartInstance.destroy(); } catch(e){}
    chartInstance = null;
    const el = document.getElementById("priceChart");
    if (el) el.innerHTML = "";
  }

  try{
    // 1) comdetail: about + price_history + news
    const d = await fetchComDetail(currentTicker);
    if (mySeq !== loadSeq) return;

    apiCompany = d.company || {};
window.apiCompany = apiCompany;
window.currentCompany = findCompanyInList(currentTicker) || {};

apiPriceHistory = d.price_history || [];
apiNews = d.news || [];

// about
renderAbout();

    // --- YENÄ°: GÃ–STERGE MODU KONTROLÃœ (GRUP BAZLI) ---
    // Ã–nce varlÄ±ÄŸÄ± listede buluyoruz
    const cObj = findCompanyInList(currentTicker);
    
    // Sadece grubu BIST, NYSE, NASDAQ veya SP olanlar "Åžirket" kabul edilir.
    // DiÄŸerleri (DÃ¶viz, Emtia, Kripto vb.) listede olsa bile gÃ¶sterge muamelesi gÃ¶rÃ¼r.
    const stockGroups = ['bist', 'nyse', 'nasdaq', 'sp'];
    const isCompany = cObj && stockGroups.includes((cObj.group || '').toLowerCase());
    
    const cardAbout = document.getElementById("cardAbout");
    const cardFin = document.getElementById("cardFinancials");
    const cardSnap = document.getElementById("snapshotCard");

    if (cardAbout) cardAbout.style.display = isCompany ? "block" : "none";
    if (cardFin) cardFin.style.display = isCompany ? "flex" : "none";
    if (cardSnap) cardSnap.style.display = isCompany ? "block" : "none";
    // -------------------------------------


    // chart + 52w
    buildFullChartFromHistory(apiPriceHistory);
    derived52w = calc52wFromPoints(chartFull.points || []);
    render52w();
    ensureChart(activeRange || "1Y");

    // news + benchmarks
    renderNews();


    updateUrlTicker(currentTicker);
    requestSendHeight(true);

    // 2) comfinancials: table
    console.log("[DETAIL] financials call start", currentTicker);

try {
  const res = await fetchComFinancials(currentTicker);
  if (mySeq !== loadSeq) return;

  apiFinancials = (res && res.financials) ? res.financials : [];
  window.apiFinancials = apiFinancials;

  renderFinancialTable(getActiveTab());
  
  // âœ… VERÄ° GELDÄ°KTEN SONRA METRÄ°KLERÄ° VE MARKET CAP'Ä° HESAPLA
  if (typeof renderBenchmarksMetrics === "function") renderBenchmarksMetrics();
  
  if (typeof renderMiniBars === "function") renderMiniBars();
  if (typeof toggleOverviewMetricsCard === "function") toggleOverviewMetricsCard(getActiveTab());

  requestSendHeight(true);
  setTimeout(() => requestSendHeight(true), 150);

} catch (e) {
  if (mySeq !== loadSeq) return;

  document.getElementById("financialsBody").innerHTML =
    `<tr><td colspan="5" style="text-align:center; padding:18px; color:#ff8888; font-weight:900;">Finansal veri alÄ±namadÄ±.</td></tr>`;
  requestSendHeight(true);
}


  } catch(err){
    if (mySeq !== loadSeq) return;
    const msg = (err && err.message) ? err.message : "API hatasÄ±";
    document.getElementById("aboutText").innerText = "Veri alÄ±namadÄ±: " + msg;
    document.getElementById("newsList").innerHTML = `<div class="p-4 text-sm text-[#ff8888] font-semibold">Veri alÄ±namadÄ±.</div>`;
    document.getElementById("metricsList").innerHTML = `<div class="p-4 text-sm text-[#ff8888] font-semibold">Veri alÄ±namadÄ±.</div>`;
    document.getElementById("financialsBody").innerHTML =
      `<tr><td colspan="5" style="text-align:center; padding:18px; color:#ff8888; font-weight:900;">Veri alÄ±namadÄ±.</td></tr>`;
    requestSendHeight(true);
  } finally {
    if (mySeq === loadSeq) setLoadingState(false);
  }
}

/* ============================
   EVENTS
============================ */
function setActiveButtons(container, selector, matchFn){
  container.querySelectorAll(selector).forEach(btn => {
    const isActive = matchFn(btn);
    btn.classList.toggle("active", isActive);
    if (btn.getAttribute("role") === "tab"){
      btn.setAttribute("aria-selected", isActive ? "true" : "false");
    }
  });
}

function initTabs(){
  const tabs = document.getElementById("financialTabs");
  if (!tabs) return;

  tabs.addEventListener("click", (e) => {
    const btn = e.target.closest("button[data-tab]");
    if (!btn) return;
    const tab = btn.dataset.tab;
    setActiveButtons(tabs, "button[data-tab]", b => b.dataset.tab === tab);

    if (Array.isArray(apiFinancials) && apiFinancials.length) {
      renderFinancialTable(tab);
toggleOverviewMetricsCard(tab);
requestSendHeight(false);

    }
  });
}

function initRanges(){
  const rangeWrap = document.getElementById("rangeBtns");
  if (!rangeWrap) return;

  rangeWrap.addEventListener("click", (e) => {
    const btn = e.target.closest("button[data-range]");
    if (!btn) return;
    const range = btn.dataset.range;
    setActiveButtons(rangeWrap, "button[data-range]", b => b.dataset.range === range);
    ensureChart(range);
  });
}

function initSearch(){
  const inp = document.getElementById("tickerSearch");
  const btn = document.getElementById("searchBtn");   // artÄ±k opsiyonel
  const dd  = document.getElementById("searchDD");
  if (!inp || !dd) return; // âœ… buton yoksa da Ã§alÄ±ÅŸ

  const run = (t) => {
  const ticker = sanitizeTicker(t || inp.value);
  hideSearchDropdown();

  // âœ… kullanÄ±cÄ± aradÄ±ktan sonra input boÅŸalsÄ±n
  inp.value = "";
  inp.blur();

  loadAll(ticker);
};


  // âœ… buton varsa baÄŸla, yoksa sorun deÄŸil
  if (btn && !btn.__bound) {
    btn.__bound = true;
    btn.addEventListener("click", () => run());
  }

  // input / dropdown
  inp.addEventListener("input", () => renderSearchDropdown(inp.value));
  inp.addEventListener("focus", () => renderSearchDropdown(inp.value));

  inp.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      run();
    }
    if (e.key === "Escape") {
      hideSearchDropdown();
      inp.blur();
    }
  });

  dd.addEventListener("click", (e) => {
    const item = e.target.closest(".dd-item");
    if (!item) return;
    const t = item.getAttribute("data-ticker");
    run(t);
  });

  document.addEventListener("click", (e) => {
    const within = e.target.closest(".search-wrap");
    if (!within) hideSearchDropdown();
  });
}


/* ============================
   BOOT
============================ */
function finDetailInit(){
if (!window.ApexCharts){
    document.getElementById("priceChart").innerHTML =
      `<div style="padding:16px; color:#ff8888; font-weight:900;">ApexCharts yÃ¼klenemedi (CSP/blocked).</div>`;
  }

  setYearHeaders();
  initTabs();
  initRanges();
  initSearch();
  lockChartWheel();

  const urlTicker = getTickerFromQuery();
  document.getElementById("tickerSearch").value = urlTicker;

  // default range 1Y active already
  //loadAll(urlTicker);

  requestSendHeight(true);
  setTimeout(() => requestSendHeight(true), 300);
}


/* ============================
   IFRAME RESIZER
============================ */
let lastSent = 0, scheduled = false;

function computeHeight(){
  const b = document.body;
  const de = document.documentElement;
  return Math.ceil(Math.max(
    b ? b.scrollHeight : 0,
    de ? de.scrollHeight : 0,
    b ? b.offsetHeight : 0,
    de ? de.offsetHeight : 0
  ));
}
function postHeight(force){
  const h = computeHeight();
  if (!force && Math.abs(h - lastSent) < 2) return;
  lastSent = h;
  if (window.parent && window.parent !== window){
    window.parent.postMessage({ type: "resize-iframe", height: h }, "*");
  }
}
function requestSendHeight(force){
  // âœ… Companies ekranÄ± kendi iÃ§inde scroll ediyor.
  // ResizeObserver + iframe auto-height burada scroll'u bozuyor.
  if (document.querySelector('#view-companies.view-section.active')) return;

  if (scheduled) return;
  scheduled = true;
  requestAnimationFrame(() => {
    scheduled = false;
    postHeight(!!force);
  });
}

window.addEventListener("resize", () => requestSendHeight(false));
if ("ResizeObserver" in window){
  const ro = new ResizeObserver(() => requestSendHeight(false));
  ro.observe(document.documentElement);
}

// --- EXPORTS (for merged.html)
let __finDetailInited = false;
window.finDetailBootOnce = function(){
  if (__finDetailInited) return;
  __finDetailInited = true;

  try { finDetailInit(); } catch(e){ console.error('finDetailInit error', e); }

  // âœ… boot sonrasÄ±: storage/query'den ticker al ve 1 kere yÃ¼kle
  try {
    const t = getTickerFromQuery();
    if (t && window.finDetailLoad) window.finDetailLoad(t);
  } catch(e){}
};

window.finDetailLoad = function(ticker){
  try { loadAll(ticker); } catch(e){ console.error('finDetailLoad error', e); }
};
window.finDetailRefreshHeaderPrice = function(){
  try { render52w(); } catch(e){}
};

window.finOpenDetail = function(ticker){
  const t = String(ticker||'').toUpperCase().trim();
  if (!t) return;

  // 1) ticker'Ä± kaydet
  try { localStorage.setItem('finapsis_detail_ticker', t); } catch(e){}

  // 2) sekmeye geÃ§
  try { switchTab('detail'); } catch(e){}

  // 3) detail init (1 kere)
  try { window.finDetailBootOnce && window.finDetailBootOnce(); } catch(e){}

  // 4) âœ… EN Ã–NEMLÄ°: detail zaten inited ise de yeni ticker'Ä± yÃ¼kle
  setTimeout(() => {
    try { window.finDetailLoad && window.finDetailLoad(t); } catch(e){}
  }, 50);
};





})();


    // ============================================
    // SCREENER JAVASCRIPT
    // ============================================
    
    const METRIC_DEFINITIONS = [
        { id: 'fk', label: 'DÃœÅžÃœK F/K', dataKey: 'F/K', direction: 'low', icon: 'fa-tag' },
        { id: 'pddd', label: 'DÃœÅžÃœK PD/DD', dataKey: 'PD/DD', direction: 'low', icon: 'fa-layer-group' },
        { id: 'pd', label: 'YÃœKSEK PÄ°YASA DEÄž.', dataKey: 'Piyasa DeÄŸeri', direction: 'high', icon: 'fa-building' },
        { id: 'ps', label: 'DÃœÅžÃœK FÄ°YAT/SATIÅž', dataKey: 'Fiyat/SatÄ±ÅŸlar', direction: 'low', icon: 'fa-percent' },
        { id: 'ev_sales', label: 'DÃœÅžÃœK FD/SATIÅž', dataKey: 'Gelir Ã‡arpanÄ±', direction: 'low', icon: 'fa-money-bill-wave' },
        { id: 'ev_ebitda', label: 'DÃœÅžÃœK FD/FAVÃ–K', dataKey: 'FVÃ–K Ã‡arpanÄ±', direction: 'low', icon: 'fa-chart-pie' },
        { id: 'margin_op', label: 'YÃœKSEK FAAL. KAR MARJI', dataKey: 'Faaliyet KÃ¢r MarjÄ±', direction: 'high', icon: 'fa-chart-line', isPercent: true },
        { id: 'margin_gross', label: 'YÃœKSEK BRÃœT MARJ', dataKey: 'BrÃ¼t Kar MarjÄ±', direction: 'high', icon: 'fa-basket-shopping', isPercent: true },
        { id: 'roic', label: 'YÃœKSEK ROIC', dataKey: 'ROIC', direction: 'high', icon: 'fa-crown', isPercent: true },
        { id: 'roa', label: 'YÃœKSEK ROA', dataKey: 'ROA', direction: 'high', icon: 'fa-warehouse', isPercent: true },
        { id: 'roe', label: 'YÃœKSEK ROE', dataKey: 'ROE', direction: 'high', icon: 'fa-trophy', isPercent: true },
        { id: 'growth_sales', label: 'YÃœKSEK SATIÅž BÃœYÃœMESÄ°', dataKey: 'SatÄ±ÅŸ BÃ¼yÃ¼mesi TTM', direction: 'high', icon: 'fa-arrow-trend-up', isPercent: true },
        { id: 'growth_op', label: 'YÃœKSEK FAAL. KAR BÃœYÃœMESÄ°', dataKey: 'Faaliyet Kar BÃ¼yÃ¼mesi TTM', direction: 'high', icon: 'fa-rocket', isPercent: true },
        { id: 'acid', label: 'YÃœKSEK ASÄ°T TEST ORANI', dataKey: 'Asit Test OranÄ±', direction: 'high', icon: 'fa-flask' },
        { id: 'current', label: 'YÃœKSEK CARÄ° ORAN', dataKey: 'Cari Oran', direction: 'high', icon: 'fa-battery-full' },
        { id: 'debteq', label: 'DÃœÅžÃœK BORÃ‡/Ã–Z KAYNAK', dataKey: 'BorÃ§/Ã–z Kaynak', direction: 'low', icon: 'fa-scale-unbalanced' },
        { id: 'netdebt_ebitda', label: 'DÃœÅžÃœK NET BORÃ‡/FAVÃ–K', dataKey: 'Net BorÃ§/FAVÃ–K', direction: 'low', icon: 'fa-file-invoice-dollar' },
        { id: 'beta', label: 'DÃœÅžÃœK BETA', dataKey: 'Beta', direction: 'low', icon: 'fa-heart-pulse' }, 
        { id: 'inv_turn', label: 'YÃœKSEK STOK DEVÄ°R HIZI', dataKey: 'Stok Devir HÄ±zÄ±', direction: 'high', icon: 'fa-boxes-stacked' },
        { id: 'rec_turn', label: 'YÃœKSEK ALACAK DEVÄ°R HIZI', dataKey: 'Alacak Devir HÄ±zÄ±', direction: 'high', icon: 'fa-hand-holding-dollar' },
        { id: 'pay_turn', label: 'DÃœÅžÃœK BORÃ‡ DEVÄ°R HIZI', dataKey: 'BorÃ§ Devir HÄ±zÄ±', direction: 'low', icon: 'fa-file-invoice-dollar' },
        { id: 'ccc', label: 'DÃœÅžÃœK NAKÄ°T DÃ–NGÃœSÃœ', dataKey: 'Nakit DÃ¶ngÃ¼sÃ¼', direction: 'low', icon: 'fa-arrows-rotate' },
        { id: 'revenue', label: 'YÃœKSEK SATIÅž GELÄ°RÄ°', dataKey: 'SatÄ±ÅŸ Gelirleri', direction: 'high', icon: 'fa-sack-dollar' },
        { id: 'fcf', label: 'YÃœKSEK SERBEST NAKÄ°T AKIÅžI', dataKey: 'Serbest Nakit AkÄ±ÅŸÄ±', direction: 'high', icon: 'fa-faucet' },
        { id: 'cash', label: 'YÃœKSEK NAKÄ°T VARLIÄžI', dataKey: 'Nakit ve Nakit Benzerleri', direction: 'high', icon: 'fa-wallet' },
        { id: 'equity', label: 'YÃœKSEK Ã–Z KAYNAK', dataKey: 'Ana OrtaklÄ±ÄŸa Ait Ã–zkaynaklar', direction: 'high', icon: 'fa-landmark' }
    ];

    let processedData = [];
    let sectorStats = {};
    let globalStats = {};
    let activeMetrics = [];
    let comparisonMode = 'sector';
    let calculationMethod = 'median';

   function initScreener() {
        // âœ… 1. ADIM: Badgeleri HEMEN Ã§iz (Veri beklemeye gerek yok, state var)
        try { scUpdateFilterBadges(); } catch(e){ console.error(e); }

        // 2. ADIM: Veri kontrolÃ¼ ve Tablo Ã§izimi
        const isMapLoaded = window.__FIN_MAP && Object.keys(window.__FIN_MAP).length > 0;

        if (isMapLoaded) {
            // A. Veri zaten var, direkt Ã§iz.
            console.log("[Screener] Veri hazÄ±r, tablo Ã§iziliyor.");
            // Badge'i burada tekrar Ã§aÄŸÄ±rmÄ±yoruz, yukarÄ±da Ã§aÄŸÄ±rdÄ±k.
            try { processScreenerData(); } catch(e) { console.error(e); }
            try { renderMetricsPool(); } catch(e) {}
            try { renderScreenerResults(); } catch(e) {}
            try { setupDragAndDrop(); } catch(e) {}
        } else {
            // B. Veri yok, indir.
            console.log("[Screener] Metrics indiriliyor...");
            
            // KullanÄ±cÄ±ya bir yÃ¼kleniyor mesajÄ± gÃ¶ster
            const tbody = document.getElementById('screener-results-body');
            if(tbody) tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:40px; color:#666;"><div class="spinner" style="margin:0 auto 10px auto;"></div>Veriler YÃ¼kleniyor...</td></tr>';

            // Ä°ndirmeyi baÅŸlat
            finBuildMapForActiveGroup(() => {
                _renderScreenerUI(); // Ä°ndirme bitince her ÅŸeyi Ã§iz
            });
        }
    }

    // âœ… YENÄ°LENMÄ°Åž & ETKÄ°LEÅžÄ°MLÄ° BADGE SÄ°STEMÄ°
   // âœ… GÃœNCELLENMÄ°Åž BADGE RENDER FONKSÄ°YONU
    // âœ… DÃœZELTÄ°LMÄ°Åž & GARANTÄ° Ã‡ALIÅžAN BADGE FONKSÄ°YONU
    // âœ… GÃœNCELLENMÄ°Åž & TAMÄ°R EDÄ°LMÄ°Åž BADGE RENDER FONKSÄ°YONU
    // âœ… GÃœNCELLENMÄ°Åž BADGE RENDER (ALT SEKTÃ–R EKLENDÄ°)
    function scUpdateFilterBadges() {
        const area = document.getElementById("scActiveFiltersArea");
        if(!area) return;

        // 1. DeÄŸiÅŸkenleri HazÄ±rla
        let groupLabel = "BIST";
        if(window.activeGroup === 'nyse') groupLabel = "NYSE";
        if(window.activeGroup === 'nasdaq') groupLabel = "NASDAQ";

        const currentSec = window.scSectorSelection || "TÃœMÃœ";
        const hasSector = !!window.scSectorSelection;
        
        // Alt SektÃ¶r (Industry) DeÄŸiÅŸkenleri
        const currentInd = window.scIndustrySelection || "TÃœMÃœ";
        const hasIndustry = !!window.scIndustrySelection;

        const compLabel = (comparisonMode === 'global') ? 'GENEL' : 'SEKTÃ–R';
        const calcLabel = (calculationMethod === 'mean') ? 'ORTALAMA' : 'MEDYAN';

        // 2. HTML String OluÅŸtur
        let html = '';

        // --- A. BORSA BADGE ---
        html += `
            <div style="position:relative; display:inline-block;">
                <div class="sc-badge market-badge" onclick="scToggleMarketPopup(event)" title="Borsa DeÄŸiÅŸtir">
                    <i class="fa-solid fa-globe"></i>
                    BORSA: ${groupLabel} <i class="fa-solid fa-chevron-down" style="font-size:9px; opacity:0.5; margin-left:4px;"></i>
                </div>
                <div id="scMarketPopup" class="sc-market-popup" onclick="event.stopPropagation()">
                    <div class="sc-market-item ${window.activeGroup==='bist'?'active':''}" onclick="setGroup('bist')">BIST (Ä°stanbul)</div>
                    <div class="sc-market-item ${window.activeGroup==='nyse'?'active':''}" onclick="setGroup('nyse')">NYSE (New York)</div>
                    <div class="sc-market-item ${window.activeGroup==='nasdaq'?'active':''}" onclick="setGroup('nasdaq')">NASDAQ</div>
                </div>
            </div>
        `;

        // --- B. SEKTÃ–R BADGE ---
        html += `
            <div style="position:relative; display:inline-block;">
                <div class="sc-badge ${hasSector ? 'active' : ''}" onclick="scToggleSectorPopup(event)" title="SektÃ¶r Filtrele">
                    <i class="fa-solid fa-layer-group"></i>
                    SEKTÃ–R: <span style="color:#fff;">${currentSec}</span>
                    ${hasSector 
                        ? `<div class="sc-badge-close" onclick="event.stopPropagation(); scClearSectorFilter(event)"><i class="fa-solid fa-xmark"></i></div>` 
                        : '<i class="fa-solid fa-chevron-down" style="font-size:9px; opacity:0.5; margin-left:4px;"></i>'}
                </div>
                
                <div id="scSectorPopup" class="sc-sector-popup" onclick="event.stopPropagation()">
                    <div class="sc-sector-head">
                        <div class="sc-sector-title">SektÃ¶r SeÃ§imi</div>
                        <div class="sc-sector-actions">
                            <button class="sc-sector-clear" onclick="scClearSectorFilter(event)">Temizle</button>
                        </div>
                    </div>
                    <div style="padding:8px; border-bottom:1px solid rgba(255,255,255,0.1);">
                        <input type="text" id="scSectorSearchInput" placeholder="SektÃ¶r ara..." 
                               style="width:100%; background:#1a1a1a; border:1px solid #333; color:#fff; padding:8px 10px; border-radius:8px; font-size:12px; outline:none; font-weight:600;" 
                               oninput="scFilterListInPopup('sector', this.value)">
                    </div>
                    <div class="sc-sector-list" id="scSectorList"></div>
                </div>
            </div>
        `;

        // --- C. ALT SEKTÃ–R BADGE (YENÄ°) ---
        // SektÃ¶r seÃ§ili deÄŸilse tÄ±klanamaz (class: disabled)
        // class disabled iÃ§in CSS eklemediysen opacity dÃ¼ÅŸÃ¼rÃ¼rÃ¼z
        const indDisabledClass = !hasSector ? 'opacity-50 pointer-events-none grayscale' : '';
        
        html += `
            <div style="position:relative; display:inline-block;">
                <div class="sc-badge ${hasIndustry ? 'active' : ''}" style="${!hasSector ? 'opacity:0.4; pointer-events:none;' : ''}"
                     onclick="scToggleIndustryPopup(event)" title="Alt SektÃ¶r Filtrele">
                    <i class="fa-solid fa-industry"></i>
                    ALT SEKTÃ–R: <span style="color:#fff;">${currentInd}</span>
                    ${hasIndustry 
                        ? `<div class="sc-badge-close" onclick="event.stopPropagation(); scClearIndustryFilter(event)"><i class="fa-solid fa-xmark"></i></div>` 
                        : '<i class="fa-solid fa-chevron-down" style="font-size:9px; opacity:0.5; margin-left:4px;"></i>'}
                </div>
                
                <div id="scIndustryPopup" class="sc-sector-popup" onclick="event.stopPropagation()">
                    <div class="sc-sector-head">
                        <div class="sc-sector-title">Alt SektÃ¶r SeÃ§imi</div>
                        <div class="sc-sector-actions">
                            <button class="sc-sector-clear" onclick="scClearIndustryFilter(event)">Temizle</button>
                        </div>
                    </div>
                    <div style="padding:8px; border-bottom:1px solid rgba(255,255,255,0.1);">
                        <input type="text" id="scIndustrySearchInput" placeholder="Alt sektÃ¶r ara..." 
                               style="width:100%; background:#1a1a1a; border:1px solid #333; color:#fff; padding:8px 10px; border-radius:8px; font-size:12px; outline:none; font-weight:600;" 
                               oninput="scFilterListInPopup('industry', this.value)">
                    </div>
                    <div class="sc-sector-list" id="scIndustryList"></div>
                </div>
            </div>
        `;

        // --- D. KIYASLAMA BADGE ---
        html += `
            <div class="sc-badge" onclick="scToggleCompMode()" title="KÄ±yaslama: SektÃ¶r mÃ¼ Genel mi?">
                <i class="fa-solid fa-scale-balanced"></i>
                KIYAS: <span style="color:#fff;">${compLabel}</span>
                <i class="fa-solid fa-rotate" style="font-size:9px; opacity:0.5; margin-left:4px;"></i>
            </div>
        `;

        // --- E. HESAPLAMA BADGE ---
        html += `
            <div class="sc-badge" onclick="scToggleCalcMethod()" title="Hesaplama: Ortalama mÄ± Medyan mÄ±?">
                <i class="fa-solid fa-calculator"></i>
                HESAP: <span style="color:#fff;">${calcLabel}</span>
                <i class="fa-solid fa-rotate" style="font-size:9px; opacity:0.5; margin-left:4px;"></i>
            </div>
        `;

        // --- F. SIFIRLA BUTONU ---
        html += `
            <div class="sc-badge reset-btn" onclick="resetApp()" title="TÃ¼m filtreleri temizle">
                <i class="fa-solid fa-rotate-left"></i> SIFIRLA
            </div>
        `;

        area.innerHTML = html;
    }function _renderScreenerUI() {
    try { processScreenerData(); } catch(e) { console.error(e); }
    try { renderMetricsPool(); } catch(e) {}
    try { renderScreenerResults(); } catch(e) {}
    try { setupDragAndDrop(); } catch(e) {}
    
    // âœ… EKSÄ°K PARÃ‡A: UI ilk aÃ§Ä±ldÄ±ÄŸÄ±nda badge'leri Ã§iz!
    try { scUpdateFilterBadges(); } catch(e) { console.error("Badge hatasÄ±:", e); }
}
// --- YENÄ° ETKÄ°LEÅžÄ°M FONKSÄ°YONLARI ---

    // 1. KÄ±yaslama Modunu DeÄŸiÅŸtir (SektÃ¶r <-> Genel)
    function scToggleCompMode() {
        const newMode = (comparisonMode === 'sector') ? 'global' : 'sector';
        setComparisonMode(newMode); // Mevcut fonksiyonu kullanÄ±yoruz, o zaten badge'i gÃ¼ncelliyor
    }

    // 2. Hesaplama YÃ¶ntemini DeÄŸiÅŸtir (Medyan <-> Ortalama)
    function scToggleCalcMethod() {
        const newMethod = (calculationMethod === 'median') ? 'mean' : 'median';
        setCalcMethod(newMethod);
    }

    // 3. Market Popup AÃ§/Kapa
    function scToggleMarketPopup(e) {
        if(e) e.stopPropagation();
        const pop = document.getElementById("scMarketPopup");
        if(pop) {
            // DiÄŸer popuplarÄ± kapat
            scCloseSectorPopup();
            
            const isVisible = pop.style.display === "block";
            pop.style.display = isVisible ? "none" : "block";
        }
    }

    function processScreenerData() {
        // Eski 'window.benchmarks' dizisi artÄ±k yok. 
        // Veriler 'window.__FIN_MAP' iÃ§inde hazÄ±r (ticker -> {Metric: Value}).
        
        const map = window.__FIN_MAP || {};
        
        // Metrik tanÄ±mlarÄ±nÄ± hÄ±zlÄ± eriÅŸim iÃ§in haritala
        const defMap = {};
        METRIC_DEFINITIONS.forEach(m => defMap[m.dataKey] = m);

        // Sadece aktif gruba ait ÅŸirketleri al ve metriklerle birleÅŸtir
        processedData = window.companies
            .filter(c => c.group === activeGroup) 
            .map(comp => {
                const ticker = comp.ticker;
                
                // Bu ÅŸirketin metriklerini al (Yoksa boÅŸ obje)
                // __FIN_MAP zaten temizlenmiÅŸ sayÄ±sal deÄŸerler iÃ§eriyor
                const rawMetrics = map[ticker] || {};
                const preparedMetrics = {};

                // Screener mantÄ±ÄŸÄ±na gÃ¶re bazÄ± yÃ¼zde deÄŸerlerini 100 ile Ã§arpmak gerekebilir
                // (Eski kodda 'val < 5 ise Ã§arp' mantÄ±ÄŸÄ± vardÄ±, onu koruyalÄ±m)
                for (const [key, val] of Object.entries(rawMetrics)) {
                    if (val === null || val === undefined) continue;
                    
                    let finalVal = val;
                    const def = defMap[key];
                    
                    // EÄŸer metrik yÃ¼zde ise ve ham veri 0.15 (yani %15) gibi gelmiÅŸse, UI 15 bekliyor olabilir.
                    // Veri kaynaÄŸÄ±ndaki formata gÃ¶re burayÄ± ayarlamak gerekebilir.
                    // Åžimdilik eski mantÄ±ÄŸÄ± (kÃ¼Ã§Ã¼kse 100'le Ã§arp) koruyoruz:
                    if (def && def.isPercent && Math.abs(finalVal) < 5) {
                        finalVal = finalVal * 100;
                    }
                    
                    preparedMetrics[key] = finalVal;
                }

                return { ...comp, ...preparedMetrics, score: 0, matches: [] };
            });
    }

    let __screenerStatsKey = "";

function ensureScreenerStats(){
  const keys = (activeMetrics || []).map(m => m.dataKey).filter(Boolean);
  keys.sort();

  const keyStr = `${activeGroup}|${keys.join(",")}`;
  if (__screenerStatsKey === keyStr) return;   // aynÄ± metrik seti ise tekrar hesaplama
  __screenerStatsKey = keyStr;

  sectorStats = {};
  globalStats = {};

  if (!keys.length) return;

  const secValues = {};
  const globValues = {};

  for (const comp of (processedData || [])) {
    const sec = comp.sector || "DiÄŸer";
    if (!secValues[sec]) secValues[sec] = {};
    const secObj = secValues[sec];

    for (let i=0; i<keys.length; i++){
      const k = keys[i];
      const v = comp[k];
      if (v === undefined || v === null) continue;

      (secObj[k] ||= []).push(v);
      (globValues[k] ||= []).push(v);
    }
  }

  const getStats = (arr) => {
    if (!arr || arr.length === 0) return { mean: null, median: null };
    arr.sort((a,b) => a-b);
    let sum = 0;
    for (let i=0;i<arr.length;i++) sum += arr[i];
    const mid = Math.floor(arr.length/2);
    const median = (arr.length % 2) ? arr[mid] : (arr[mid-1] + arr[mid]) / 2;
    return { mean: sum / arr.length, median };
  };

  // sector stats
  for (const sec in secValues){
    sectorStats[sec] = {};
    for (let i=0;i<keys.length;i++){
      const k = keys[i];
      if (secValues[sec][k]) sectorStats[sec][k] = getStats(secValues[sec][k]);
    }
  }

  // global stats
  for (let i=0;i<keys.length;i++){
    const k = keys[i];
    if (globValues[k]) globalStats[k] = getStats(globValues[k]);
  }
}


    function setComparisonMode(mode) {
        comparisonMode = mode;
        
        // Tablo baÅŸlÄ±ÄŸÄ±nÄ± gÃ¼ncelle (Varsa)
        const lbl = document.getElementById('comp-label');
        if(lbl) lbl.innerText = mode === 'sector' ? 'SEKTÃ–R' : 'GENEL';
        
        // Badge ve Tabloyu gÃ¼ncelle
        scUpdateFilterBadges(); 
        renderScreenerResults();
    }

    function setCalcMethod(method) {
        calculationMethod = method;
        
        // Tablo baÅŸlÄ±ÄŸÄ±nÄ± gÃ¼ncelle (Varsa)
        const lbl = document.getElementById('calc-label');
        if(lbl) lbl.innerText = method === 'mean' ? 'ORT' : 'MEDYAN';
        
        // Badge ve Tabloyu gÃ¼ncelle
        scUpdateFilterBadges(); 
        renderScreenerResults();
    }

    function renderMetricsPool() {
        const pool = document.getElementById('metrics-pool');
        const term = document.getElementById('metric-search').value.toLowerCase();
        
        const fragment = document.createDocumentFragment();
        METRIC_DEFINITIONS.forEach(m => {
            if (activeMetrics.find(am => am.id === m.id) || (term && !m.label.toLowerCase().includes(term))) return;
            const el = document.createElement('div');
            el.className = 'metric-item';
            el.draggable = true;
            const iconColor = m.direction === 'high' ? 'var(--finapsis-neon)' : 'var(--finapsis-red)';
            el.innerHTML = `<div class="metric-icon" style="color:${iconColor}"><i class="fa-solid ${m.icon}"></i></div><div style="font-size:10px; font-weight:600; color:rgba(255,255,255,0.7);">${m.label}</div>`;
            el.addEventListener('dragstart', (e) => { e.dataTransfer.setData('text/plain', m.id); el.style.opacity = '0.5'; });
            el.addEventListener('dragend', () => el.style.opacity = '1');
            fragment.appendChild(el);
        });
        pool.innerHTML = '';
        pool.appendChild(fragment);
    }
    // --- SCREENER POPUP LOGIC ---
    // =========================================================
    // âœ… SCREENER SEKTÃ–R & ALT SEKTÃ–R YÃ–NETÄ°MÄ°
    // =========================================================

    window.scSectorSelection = "";
    window.scIndustrySelection = ""; // Yeni State

    // 1. Liste OluÅŸturucu (Generic: type = 'sector' veya 'industry')
    window.scBuildList = function(type){
        const listEl = document.getElementById(type === 'sector' ? "scSectorList" : "scIndustryList");
        if(!listEl) return;

        let items = [];
        
        if (type === 'sector') {
            // TÃ¼m sektÃ¶rler
            items = [...new Set(window.companies
                .filter(c => c.group === activeGroup)
                .map(c => c.sector))]
                .filter(Boolean)
                .sort((a,b) => a.localeCompare(b,'tr'));
        } else {
            // Sadece seÃ§ili sektÃ¶rÃ¼n alt sektÃ¶rleri
            if(!window.scSectorSelection) return;
            items = [...new Set(window.companies
                .filter(c => c.group === activeGroup && c.sector === window.scSectorSelection)
                .map(c => c.industry))]
                .filter(Boolean)
                .sort((a,b) => a.localeCompare(b,'tr'));
        }

        // HTML oluÅŸtur
        const currentVal = type === 'sector' ? window.scSectorSelection : window.scIndustrySelection;
        const selectFn = type === 'sector' ? 'scSelectSector' : 'scSelectIndustry';
        const label = type === 'sector' ? 'TÃ¼m SektÃ¶rler' : 'TÃ¼m Alt SektÃ¶rler';

        let html = `<div class="sc-sector-item ${currentVal==="" ? "active":""}" onclick="${selectFn}('')">${label}</div>`;
        html += items.map(s => {
            const isActive = (s === currentVal) ? "active" : "";
            const safeS = s.replace(/"/g, '&quot;');
            return `<div class="sc-sector-item ${isActive}" onclick="${selectFn}('${safeS}')">${s}</div>`;
        }).join("");

        listEl.innerHTML = html;
    };

    // 2. SektÃ¶r Popup AÃ§/Kapa
    window.scToggleSectorPopup = function(e) {
        if(e) e.stopPropagation();
        scCloseAllPopups(); // Ã–nce diÄŸerlerini kapat

        const pop = document.getElementById("scSectorPopup");
        const isOpen = (pop.style.display === 'block');
        
        if (!isOpen) {
            scBuildList('sector');
            const inp = document.getElementById("scSectorSearchInput");
            if(inp) { inp.value = ""; scFilterListInPopup('sector', ""); }
            pop.style.display = 'block';
        }
    };

    // 3. Alt SektÃ¶r Popup AÃ§/Kapa
    window.scToggleIndustryPopup = function(e) {
        if(e) e.stopPropagation();
        // EÄŸer sektÃ¶r seÃ§ili deÄŸilse aÃ§ma (GerÃ§i HTML'de disabled yaptÄ±k ama gÃ¼venlik olsun)
        if(!window.scSectorSelection) return;

        scCloseAllPopups();

        const pop = document.getElementById("scIndustryPopup");
        const isOpen = (pop.style.display === 'block');
        
        if (!isOpen) {
            scBuildList('industry');
            const inp = document.getElementById("scIndustrySearchInput");
            if(inp) { inp.value = ""; scFilterListInPopup('industry', ""); }
            pop.style.display = 'block';
        }
    };

    // 4. SektÃ¶r SeÃ§imi
    window.scSelectSector = function(sec){
        window.scSectorSelection = sec;
        window.scIndustrySelection = ""; // SektÃ¶r deÄŸiÅŸirse alt sektÃ¶r sÄ±fÄ±rlanÄ±r!
        
        renderScreenerResults();
        scUpdateFilterBadges();
    };

    // 5. Alt SektÃ¶r SeÃ§imi
    window.scSelectIndustry = function(ind){
        window.scIndustrySelection = ind;
        
        renderScreenerResults();
        scUpdateFilterBadges();
    };

    // 6. Temizleyiciler
    window.scClearSectorFilter = function(e){
        if(e) { e.preventDefault(); e.stopPropagation(); }
        scSelectSector(""); // Bu iÅŸlem alt sektÃ¶rÃ¼ de temizler
    };

    window.scClearIndustryFilter = function(e){
        if(e) { e.preventDefault(); e.stopPropagation(); }
        scSelectIndustry("");
    };

    // 7. Popup Ä°Ã§i Arama
    window.scFilterListInPopup = function(type, term){
        const t = String(term || "").toLocaleLowerCase('tr');
        const listId = type === 'sector' ? "scSectorList" : "scIndustryList";
        const items = document.querySelectorAll(`#${listId} .sc-sector-item`);
        
        items.forEach(el => {
            const txt = el.textContent.toLocaleLowerCase('tr');
            if(el.textContent.includes("TÃ¼m") || txt.includes(t)) {
                el.style.display = "block";
            } else {
                el.style.display = "none";
            }
        });
    };

    // Helper: TÃ¼m popuplarÄ± kapat
    function scCloseAllPopups() {
        document.querySelectorAll('.sc-sector-popup, .sc-market-popup').forEach(el => el.style.display = 'none');
    }

    // DÄ±ÅŸarÄ± tÄ±klama (Popup kapat)
    document.addEventListener("click", (e) => {
        if (!e.target.closest('.sc-badge') && !e.target.closest('.sc-sector-popup') && !e.target.closest('.sc-market-popup')) {
            scCloseAllPopups();
        }
    });

    window.scToggleSectorPopup = function(e){
      // Varsa Market popup'Ä±nÄ± kapat
   const mPop = document.getElementById("scMarketPopup");
   if(mPop) mPop.style.display = "none";
        if(e) e.stopPropagation();
        const pop = document.getElementById("scSectorPopup");
        if(!pop) return;

        // Listeyi oluÅŸtur
        scBuildSectorList();
        
        // Input temizle
        const inp = document.getElementById("scSectorSearchInput");
        if(inp) { inp.value = ""; scFilterSectorListInPopup(""); }

        const isOpen = (pop.style.display === "block");
        pop.style.display = isOpen ? "none" : "block";
    };

    window.scCloseSectorPopup = function(e){
        if(e) e.stopPropagation();
        const pop = document.getElementById("scSectorPopup");
        if(pop) pop.style.display = "none";
    };

    window.scBuildSectorList = function(){
        const list = document.getElementById("scSectorList");
        if(!list) return;

        // Aktif gruptaki sektÃ¶rleri al
        const sectors = [...new Set(window.companies
            .filter(c => c.group === activeGroup)
            .map(c => c.sector))]
            .filter(Boolean)
            .sort((a,b) => a.localeCompare(b,'tr'));

        let html = `<div class="sc-sector-item ${window.scSectorSelection==="" ? "active":""}" onclick="scSelectSector('')">TÃ¼m SektÃ¶rler</div>`;
        html += sectors.map(s => {
            const isActive = (s === window.scSectorSelection) ? "active" : "";
            const safeS = s.replace(/"/g, '&quot;');
            return `<div class="sc-sector-item ${isActive}" onclick="scSelectSector('${safeS}')">${s}</div>`;
        }).join("");

        list.innerHTML = html;
        // Not: Buton rengini artÄ±k scUpdateFilterBadges fonksiyonu hallediyor.
    };

    window.scSelectSector = function(sec){
        window.scSectorSelection = sec;
        renderScreenerResults(); // Tabloyu yeniden Ã§iz (Filtreli)
        scCloseSectorPopup();
        scBuildSectorList(); 
        scUpdateFilterBadges(); // âœ… Badge'leri gÃ¼ncelle
    };
    

  
    window.scFilterSectorListInPopup = function(term){
        const t = String(term || "").toLocaleLowerCase('tr');
        const items = document.querySelectorAll("#scSectorList .sc-sector-item");
        items.forEach(el => {
            const txt = el.textContent.toLocaleLowerCase('tr');
            if(el.textContent === "TÃ¼m SektÃ¶rler" || txt.includes(t)) el.style.display = "block";
            else el.style.display = "none";
        });
    };
    
    // DÄ±ÅŸarÄ± tÄ±klayÄ±nca kapat
    document.addEventListener("click", (e) => {
        const pop = document.getElementById("scSectorPopup");
        const btn = document.getElementById("scSectorBtn");
        if(pop && pop.style.display === "block") {
            if(!pop.contains(e.target) && !btn.contains(e.target)) {
                pop.style.display = "none";
            }
        }
    });
    function filterMetrics() { renderMetricsPool(); }

    function renderScreenerResults() {
        const tbody = document.getElementById('screener-results-body');
        if (!tbody) return;

        // 1. Metrik KontrolÃ¼
        if (!activeMetrics || activeMetrics.length === 0) {
            tbody.innerHTML = `
                <tr>
                  <td colspan="5" style="padding:40px; color:rgba(255,255,255,0.4); font-weight:600; text-align:center;">
                    <i class="fa-solid fa-filter" style="font-size:24px; margin-bottom:10px; display:block;"></i>
                    SonuÃ§larÄ± gÃ¶rmek iÃ§in soldan metrik sÃ¼rÃ¼kleyip ekleyin.
                  </td>
                </tr>`;
            return;
        }

        // 2. Ä°statistikleri Hesapla
        ensureScreenerStats();

        // 3. Puanlama ve Veri HazÄ±rlÄ±ÄŸÄ±
        const rankedData = processedData.map(comp => {
            let score = 0;
            let matchDetails = [];
            
            // SektÃ¶r filtresi varsa sadece o sektÃ¶rÃ¼ iÅŸle (Performans)
            if (window.scSectorSelection && comp.sector !== window.scSectorSelection) {
                return null; // Filtreye takÄ±lanÄ± hesaplama
            }
            // Alt SektÃ¶r filtresi varsa (Industry)
            if (window.scIndustrySelection && comp.industry !== window.scIndustrySelection) {
                return null;
            }

            activeMetrics.forEach(metric => {
                const val = comp[metric.dataKey];
                const statObj = comparisonMode === 'sector' 
                    ? (sectorStats[comp.sector] ? sectorStats[comp.sector][metric.dataKey] : null) 
                    : globalStats[metric.dataKey];
                
                const avg = statObj ? statObj[calculationMethod] : null;

                if (val !== undefined && val !== null && avg !== undefined && avg !== null) {
                    let isGood = false;
                    
                    // --- KRÄ°TÄ°K DÃœZELTME 1: NEGATÄ°F DEÄžER KONTROLÃœ ---
                    // DÃ¼ÅŸÃ¼k F/K, PD/DD gibi oranlarda negatif deÄŸer "iyi" deÄŸildir, zarardÄ±r.
                    // Bu yÃ¼zden "Low" ararken deÄŸerin 0'dan bÃ¼yÃ¼k olmasÄ±nÄ± ÅŸart koÅŸuyoruz.
                    if (metric.direction === 'low') {
                        if (val > 0 && val < avg) isGood = true; 
                    } 
                    // YÃ¼ksek ararken (High) normal mantÄ±k (val > avg)
                    else if (metric.direction === 'high') {
                        if (val > avg) isGood = true;
                    }

                    if (isGood) score++;
                    matchDetails.push({ 
                        id: metric.id, // SÄ±ralama iÃ§in ID lazÄ±m
                        shortLabel: metric.dataKey, 
                        val, 
                        avg, 
                        good: isGood, 
                        isPercent: metric.isPercent 
                    });
                }
            });
            return { ...comp, score, matchDetails };
        }).filter(Boolean); // Null dÃ¶nenleri (sektÃ¶r dÄ±ÅŸÄ±) temizle

        // --- KRÄ°TÄ°K DÃœZELTME 2: AKILLI SIRALAMA (Smart Sort) ---
        // Kural 1: Skoru yÃ¼ksek olan en Ã¼ste.
        // Kural 2: Skorlar eÅŸitse, kullanÄ±cÄ±nÄ±n seÃ§tiÄŸi Ä°LK metriÄŸe gÃ¶re en iyi olan Ã¼ste.
        // Kural 3: O da eÅŸitse ikinci metriÄŸe bak...
        
        rankedData.sort((a, b) => {
            // 1. Ã–nce Skora Bak (BÃ¼yÃ¼kten kÃ¼Ã§Ã¼ÄŸe)
            if (b.score !== a.score) return b.score - a.score;

            // 2. Skorlar eÅŸitse, SeÃ§ili Metrik SÄ±rasÄ±na GÃ¶re KarÅŸÄ±laÅŸtÄ±r
            for (const metric of activeMetrics) {
                const valA = a[metric.dataKey];
                const valB = b[metric.dataKey];

                // Verisi olmayan alta dÃ¼ÅŸsÃ¼n
                const aValid = (valA !== null && valA !== undefined);
                const bValid = (valB !== null && valB !== undefined);
                if (!aValid && bValid) return 1;
                if (aValid && !bValid) return -1;
                if (!aValid && !bValid) continue;

                // DeÄŸerler farklÄ±ysa sÄ±rala
                if (valA !== valB) {
                    // EÄŸer "DÃ¼ÅŸÃ¼k" iyiyse (F/K gibi): KÃ¼Ã§Ã¼k olan (A) Ã¶ne geÃ§sin (a - b)
                    // EÄŸer "YÃ¼ksek" iyiyse (ROE gibi): BÃ¼yÃ¼k olan (A) Ã¶ne geÃ§sin (b - a)
                    
                    // Not: Negatifleri yukarÄ±da eledik ama sÄ±ralarken de
                    // pozitif kÃ¼Ã§Ã¼kler, pozitif bÃ¼yÃ¼klerden iyidir mantÄ±ÄŸÄ± gÃ¼dÃ¼yoruz.
                    if (metric.direction === 'low') {
                        // Pozitif olan negatiften her zaman iyidir (SÄ±ralamada)
                        if (valA > 0 && valB <= 0) return -1;
                        if (valA <= 0 && valB > 0) return 1;
                        return valA - valB; 
                    } else {
                        return valB - valA;
                    }
                }
            }
            
            // 3. Her ÅŸey eÅŸitse isme gÃ¶re
            return a.ticker.localeCompare(b.ticker);
        });

        // Ekrana Basma (Limitli)
        const displayLimit = 50; 
        const dataToRender = rankedData.slice(0, displayLimit);

        const htmlRows = dataToRender.map((comp, index) => {
            // Detay kutularÄ±nÄ±, activeMetrics sÄ±rasÄ±na gÃ¶re dizelim ki
            // kullanÄ±cÄ± neyi Ã¶ne koyduysa tabloda da o sÄ±ra olsun.
            let detailsHtml = '';
            
            // matchDetails iÃ§inde veriyi bulup activeMetrics sÄ±rasÄ±na gÃ¶re render ediyoruz
            const sortedDetails = activeMetrics.map(m => comp.matchDetails.find(d => d.id === m.id)).filter(Boolean);

            if(sortedDetails.length > 0) {
                 const boxes = sortedDetails.map(d => {
                     const className = d.good ? 'result-box good' : 'result-box bad';
                     let valStr, avgStr;

                     if (d.isPercent) {
                         valStr = `%${Number(d.val).toLocaleString('tr-TR', { maximumFractionDigits: 1 })}`;
                         avgStr = `%${Number(d.avg).toLocaleString('tr-TR', { maximumFractionDigits: 1 })}`;
                     } else {
                         valStr = finFormatMoneyCompact(d.val, { decimals: 1 });
                         avgStr = finFormatMoneyCompact(d.avg, { decimals: 1 });
                     }
                     
                     return `
                        <div class="${className}">
                            <div class="res-label" title="${d.shortLabel}">${d.shortLabel}</div>
                            <div class="res-val">${valStr}</div>
                            <div class="res-avg">${calculationMethod==='mean'?'ORT':'MED'}: ${avgStr}</div>
                        </div>`;
                 }).join('');
                 detailsHtml = `<div style="display:flex; gap:4px; justify-content:flex-end; flex-wrap:wrap; align-items:center;">${boxes}</div>`;
            }

            const badgeClass = comp.score > 0 ? "score-badge active" : "score-badge inactive";
            
            // Åžirket Logosunu GÃ¼venli Al
            const logo = comp.logourl || ""; 

            return `
                <tr>
                    <td style="text-align:center; color:rgba(255,255,255,0.3); font-size:10px;">${index + 1}</td>
                    <td>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <img src="${logo}" style="width:24px; height:24px; object-fit:contain; background:#fff; border-radius:4px; padding:2px;" onerror="this.style.display='none'">
                            <div>
                                <div style="font-weight:700; color:#eee; font-size:13px;">${comp.ticker}</div>
                                <div style="margin-top:4px;">
                                    <button class="fp-menu-btn" title="Ä°ÅŸlemler" onclick="event.stopPropagation(); fpOpenRowMenu('${comp.ticker}', event)">
                                        <i class="fa-solid fa-ellipsis-vertical"></i>
                                    </button>
                                </div>
                                <div style="font-size:10px; color:rgba(255,255,255,0.4); text-transform:uppercase; margin-top:2px;">${comp.name}</div>
                            </div>
                        </div>
                    </td>
                    <td><span style="font-size:9px; font-weight:700; background:rgba(255,255,255,0.06); padding:4px 8px; border-radius:4px; color:rgba(255,255,255,0.6); text-transform:uppercase;">${comp.sector}</span></td>
                    <td style="text-align:center;"><div class="${badgeClass}">${comp.score}</div></td>
                    <td style="text-align:right;">${detailsHtml}</td>
                </tr>
            `;
        }).join('');

        tbody.innerHTML = htmlRows;
        if (rankedData.length > displayLimit) {
            tbody.innerHTML += `<tr><td colspan="5" style="text-align:center; padding:10px; font-size:10px; color:#555;">...ve ${rankedData.length - displayLimit} ÅŸirket daha</td></tr>`;
        }
    }
    function setupDragAndDrop() {
        const container = document.querySelector('.drop-zone-container');
        
        container.ondragover = e => { 
            e.preventDefault(); 
            // Sadece soldan (yeni) geliyorsa yeÅŸil yak, iÃ§eridekine karÄ±ÅŸma
            // Bunu anlamak zor olduÄŸu iÃ§in genel olarak class ekleyebiliriz
            document.getElementById('active-criteria').classList.add('drag-over'); 
        };
        
        container.ondragleave = () => document.getElementById('active-criteria').classList.remove('drag-over');
        
        container.ondrop = e => { 
            e.preventDefault(); 
            document.getElementById('active-criteria').classList.remove('drag-over'); 
            
            // Veriyi al
            const rawData = e.dataTransfer.getData('text/plain');
            
            // EÄŸer JSON ise (iÃ§erideki sÄ±ralama iÅŸlemidir), updateDropZoneUI iÃ§indeki listener halleder.
            // Biz sadece "ID" stringi gelirse (soldan yeni ekleme) yakalayalÄ±m.
            if (!rawData.startsWith('{')) {
                addMetric(rawData);
            }
        };
        
        updateDropZoneUI();
    }
    function addMetric(id) {
        if (!activeMetrics.find(m => m.id === id)) { 
            const def = METRIC_DEFINITIONS.find(m => m.id === id);
            if(def) activeMetrics.push(def);
            updateDropZoneUI();
        }
    }

    function removeMetric(id) {
        activeMetrics = activeMetrics.filter(m => m.id !== id);
        updateDropZoneUI();
    }

    // âœ… METRÄ°K HAVUZU & SIRALAMA YÃ–NETÄ°CÄ°SÄ°
    function updateDropZoneUI() {
        const zone = document.getElementById('active-criteria');
        zone.innerHTML = '';
        
        if (activeMetrics.length === 0) {
            zone.innerHTML = '<span style="width:100%; text-align:center; font-size:11px; color:rgba(255,255,255,0.2); font-style:italic; pointer-events:none; margin-top:10px;">METRÄ°KLERÄ° BURAYA SÃœRÃœKLEYÄ°N</span>';
        } else {
            activeMetrics.forEach((m, index) => {
                const el = document.createElement('div');
                el.className = 'active-metric-tag';
                el.draggable = true; // SÃ¼rÃ¼klenebilir yap
                el.dataset.index = index; // SÄ±rasÄ±nÄ± bil
                
                el.innerHTML = `
                    <i class="fa-solid fa-grip-lines" style="opacity:0.3; cursor:grab; margin-right:4px;"></i>
                    <i class="fa-solid ${m.icon}" style="font-size:10px;"></i>
                    <span>${m.label}</span>
                    <i class="fa-solid fa-times remove-btn" onclick="removeMetric('${m.id}')"></i>
                `;

                // --- KENDÄ° Ä°Ã‡Ä°NDE SIRALAMA EVENTLERÄ° ---
                
                // SÃ¼rÃ¼kleme BaÅŸladÄ±
                el.addEventListener('dragstart', (e) => {
                    e.dataTransfer.effectAllowed = "move";
                    e.dataTransfer.setData('text/plain', JSON.stringify({ type: 'reorder', fromIndex: index }));
                    el.style.opacity = '0.4';
                });

                // SÃ¼rÃ¼kleme Bitti
                el.addEventListener('dragend', () => {
                    el.style.opacity = '1';
                });

                // Ãœzerine Gelindi (Hedef)
                el.addEventListener('dragover', (e) => {
                    e.preventDefault(); // Drop'a izin ver
                    el.style.borderColor = '#c2f50e'; // GÃ¶rsel ipucu
                });

                // Ãœzerinden AyrÄ±ldÄ±
                el.addEventListener('dragleave', () => {
                    el.style.borderColor = 'rgba(194, 245, 14, 0.2)'; // Eski haline dÃ¶n
                });

                // BÄ±rakÄ±ldÄ± (DeÄŸiÅŸimi Yap)
                el.addEventListener('drop', (e) => {
                    e.preventDefault();
                    el.style.borderColor = 'rgba(194, 245, 14, 0.2)';
                    
                    try {
                        const data = JSON.parse(e.dataTransfer.getData('text/plain'));
                        
                        // Sadece "reorder" tipindeyse iÅŸlem yap (Soldan yeni geleni karÄ±ÅŸtÄ±rma)
                        if (data && data.type === 'reorder') {
                            const fromIdx = data.fromIndex;
                            const toIdx = index;

                            if (fromIdx !== toIdx) {
                                // Dizide yer deÄŸiÅŸtir
                                const item = activeMetrics.splice(fromIdx, 1)[0];
                                activeMetrics.splice(toIdx, 0, item);
                                
                                // UI ve Tabloyu Yenile
                                updateDropZoneUI();
                                renderScreenerResults();
                            }
                        }
                    } catch (err) {
                        // EÄŸer JSON parse edilemezse (Soldan yeni metrik geliyordur),
                        // bu olayÄ± drop-zone-container'a bÄ±rak (propagation), o halletsin.
                        // Bir ÅŸey yapmaya gerek yok.
                    }
                });

                zone.appendChild(el);
            });
        }
        
        renderMetricsPool(); 
        renderScreenerResults();
    }
    function resetApp() { 
    activeMetrics = []; 
    comparisonMode = 'sector';
    calculationMethod = 'median';
    window.scSectorSelection = "";
    window.scIndustrySelection = ""; // âœ… Eklendi
    
    updateDropZoneUI(); 
    scUpdateFilterBadges(); 
}

    // ===== SEKTORLER TAB STATE =====
let secMap = {}; // ticker -> { metric:value }
let secSort = { key: 'Piyasa DeÄŸeri', asc: false };
let secInited = false;

function secParseNumber(v){
  if (v === null || v === undefined) return null;
  if (typeof v === "number") return v;
  let s = String(v).replace(/[â‚º$â‚¬%]/g, "").replace(/,/g, ".");
  const n = parseFloat(s);
  return isNaN(n) ? null : n;
}
function secMedian(arr){
  const values = (arr || []).filter(v => v !== null && v !== undefined).sort((a,b)=>a-b);
  if (!values.length) return null;
  const half = Math.floor(values.length / 2);
  return values.length % 2 === 0 ? (values[half - 1] + values[half]) / 2 : values[half];
}
function secSum(arr){
  return (arr || []).reduce((acc, curr) => acc + (secParseNumber(curr) || 0), 0);
}

function secBuildMap(){
  // ArtÄ±k benchmarks array yok, direkt dolu olan __FIN_MAP'i kullanÄ±yoruz.
  // __FIN_MAP zaten { TICKER: { "Piyasa DeÄŸeri": 123, ... } } formatÄ±nda.
  // SektÃ¶r hesaplamasÄ± iÃ§in bunu klonlamaya gerek yok, direkt kullanabiliriz 
  // ama mevcut yapÄ± secMap Ã¼zerinden yÃ¼rÃ¼yor, onu referanslayalÄ±m.
  secMap = window.__FIN_MAP || {};
}
// âœ… YENÄ°: SektÃ¶re tÄ±klayÄ±nca Åžirketler listesine filtreli git
window.secGoToCompanyList = function(sectorName){
  // 1. Åžirketler sekmesine geÃ§
  switchTab('companieslist.html');

  // 2. Sekme deÄŸiÅŸiminden hemen sonra filtreyi uygula
  // (DOM elementlerinin gÃ¶rÃ¼nÃ¼r olmasÄ± iÃ§in minik bir gecikme iyidir)
  setTimeout(() => {
    if(window.clSelectSector) {
        window.clSelectSector(sectorName);
    }
  }, 50);
};

function secRenderTable(){
  const tbody = document.getElementById("sec-tbody");
  if (!tbody) return;
  tbody.innerHTML = "";

  // aktif gruba gÃ¶re ÅŸirketler (BIST/SP)
  const companies = (window.companies || []).filter(c => c.group === activeGroup);

  // sector -> tickers
  const sectorGroups = {};
  companies.forEach(c => {
    const s = (c.sector && String(c.sector).trim()) ? c.sector : "DiÄŸer";
    if (!sectorGroups[s]) sectorGroups[s] = [];
    sectorGroups[s].push(String(c.ticker).toUpperCase());
  });

  const medianKeys = ["Cari Oran","Asit Test OranÄ±","BrÃ¼t Kar MarjÄ±","Faaliyet KÃ¢r MarjÄ±","BorÃ§/Ã–z Kaynak",
    "Stok Devir HÄ±zÄ±","Alacak Devir HÄ±zÄ±","BorÃ§ Devir HÄ±zÄ±","Nakit DÃ¶ngÃ¼sÃ¼","Stok SÃ¼resi","Alacak SÃ¼resi","BorÃ§ SÃ¼resi",
    "ROIC","ROA","ROE"
  ];

  let sectorStats = Object.keys(sectorGroups).map(name => {
    const tickers = sectorGroups[name];
    const st = { name, count: tickers.length };
    st.iconClass = sectorIcons[name] || "fa-solid fa-briefcase";

    st["Piyasa DeÄŸeri"] = secSum(tickers.map(t => secMap[t]?.["Piyasa DeÄŸeri"] ?? 0));
    st["Firma DeÄŸeri"]  = secSum(tickers.map(t => secMap[t]?.["Firma DeÄŸeri"] ?? 0));

    medianKeys.forEach(k => {
      const vals = tickers.map(t => (secMap[t] ? secMap[t][k] : null));
      st[k] = secMedian(vals);
    });

    return st;
  });

  // sort
  sectorStats.sort((a,b) => {
    let va = a[secSort.key];
    let vb = b[secSort.key];
    if (secSort.key === "name") { va = a.name; vb = b.name; }
    if (va === null) return 1;
    if (vb === null) return -1;
    const res = (typeof va === "string") ? va.localeCompare(vb, "tr") : (va - vb);
    return secSort.asc ? res : -res;
  });

  // format helpers (gÃ¼n / % / normal)
  const num = (v) => (v === null || v === undefined) ? `<span class="muted">-</span>` : Number(v).toLocaleString("tr-TR", { maximumFractionDigits: 2 });
  const pct = (v) => (v === null || v === undefined) ? `<span class="muted">-</span>` : (Number(v) * 100).toFixed(1) + "%";
  const cls = (v) => (v > 0 ? "pos" : (v < 0 ? "neg" : ""));
  const money = (v) => (v === null || v === undefined) ? `<span class="muted">-</span>` : finFormatMoneyCompact(v, { decimals: 1 });

  // render rows
  // render rows
  sectorStats.forEach(s => {
    // Link oluÅŸturma kodlarÄ±nÄ± sildik Ã§Ã¼nkÃ¼ artÄ±k sayfa deÄŸiÅŸtirmeyeceÄŸiz.

    const tr = document.createElement("tr");
    // TÄ±rnak iÅŸaretleri sorun Ã§Ä±karmasÄ±n diye escape yapÄ±yoruz
    const safeName = s.name.replace(/'/g, "\\'"); 

    tr.innerHTML = `
      <td>
        <div class="sector-link" onclick="secGoToCompanyList('${safeName}')">
          <div class="indicator-icon"><i class="${s.iconClass}"></i></div>
          <div style="display:flex;flex-direction:column;">
            <span class="sector-name" style="line-height:1.2;">${s.name}</span>
            <span class="comp-count" style="margin-top:2px;">${s.count} Åžirket</span>
          </div>
        </div>
      </td>

      <td data-label="Toplam Piyasa DeÄŸeri">${money(s["Piyasa DeÄŸeri"])}</td>
      <td data-label="Toplam Firma DeÄŸeri">${money(s["Firma DeÄŸeri"])}</td>

      <td data-label="Medyan BrÃ¼t Kar MarjÄ±" class="${cls(s["BrÃ¼t Kar MarjÄ±"])}">${pct(s["BrÃ¼t Kar MarjÄ±"])}</td>
      <td data-label="Medyan Faaliyet MarjÄ±" class="${cls(s["Faaliyet KÃ¢r MarjÄ±"])}">${pct(s["Faaliyet KÃ¢r MarjÄ±"])}</td>

      <td data-label="Medyan Cari Oran">${num(s["Cari Oran"])}</td>
      <td data-label="Medyan Asit Test OranÄ±">${num(s["Asit Test OranÄ±"])}</td>
      <td data-label="Medyan BorÃ§/Ã–zkaynak">${num(s["BorÃ§/Ã–z Kaynak"])}</td>

      <td data-label="Medyan Nakit DÃ¶ngÃ¼sÃ¼">${num(s["Nakit DÃ¶ngÃ¼sÃ¼"])} GÃ¼n</td>
      <td data-label="Medyan Stok Devir HÄ±zÄ±">${num(s["Stok Devir HÄ±zÄ±"])}</td>
      <td data-label="Medyan Stok SÃ¼resi">${num(s["Stok SÃ¼resi"])} GÃ¼n</td>

      <td data-label="Medyan Alacak Devir HÄ±zÄ±">${num(s["Alacak Devir HÄ±zÄ±"])}</td>
      <td data-label="Medyan Alacak SÃ¼resi">${num(s["Alacak SÃ¼resi"])} GÃ¼n</td>

      <td data-label="Medyan BorÃ§ Devir HÄ±zÄ±">${num(s["BorÃ§ Devir HÄ±zÄ±"])}</td>
      <td data-label="Medyan BorÃ§ SÃ¼resi">${num(s["BorÃ§ SÃ¼resi"])} GÃ¼n</td>

      <td data-label="Medyan ROIC" class="${cls(s["ROIC"])}">${pct(s["ROIC"])}</td>
      <td data-label="Medyan ROA" class="${cls(s["ROA"])}">${pct(s["ROA"])}</td>
      <td data-label="Medyan ROE" class="${cls(s["ROE"])}">${pct(s["ROE"])}</td>
    `;
    tbody.appendChild(tr);
  });

  // sort header highlight
  document.querySelectorAll("#sec-thead th").forEach(th => {
    th.classList.remove("active-sort");
    if (th.dataset.key === secSort.key){
      th.classList.add("active-sort");
      th.setAttribute("data-icon", secSort.asc ? " â†‘" : " â†“");
    }
  });
}

// âœ… SEKTÃ–RLER BADGE YÃ–NETÄ°MÄ°
    window.secUpdateBadges = function() {
        const area = document.getElementById("secBadgeArea");
        if(!area) return;

        let groupLabel = "BIST";
        if(activeGroup === 'nyse') groupLabel = "NYSE";
        if(activeGroup === 'nasdaq') groupLabel = "NASDAQ";

        // Market Popup HTML'i
        const marketPopupHTML = `
            <div id="secMarketPopup" class="sc-market-popup" onclick="event.stopPropagation()">
                <div class="sc-market-item ${activeGroup==='bist'?'active':''}" onclick="setGroup('bist')">BIST (Ä°stanbul)</div>
                <div class="sc-market-item ${activeGroup==='nyse'?'active':''}" onclick="setGroup('nyse')">NYSE (New York)</div>
                <div class="sc-market-item ${activeGroup==='nasdaq'?'active':''}" onclick="setGroup('nasdaq')">NASDAQ</div>
            </div>
        `;

        area.innerHTML = `
            <div style="position:relative; display:inline-block;">
                <div class="sc-badge market-badge" onclick="secToggleMarketPopup(event)" title="Borsa DeÄŸiÅŸtir">
                    <i class="fa-solid fa-globe"></i>
                    BORSA: ${groupLabel} <i class="fa-solid fa-chevron-down" style="font-size:9px; opacity:0.5; margin-left:4px;"></i>
                </div>
                ${marketPopupHTML}
            </div>
        `;
    };

    window.secToggleMarketPopup = function(e) {
        if(e) e.stopPropagation();
        const pop = document.getElementById("secMarketPopup");
        if(pop) {
            const isVisible = pop.style.display === "block";
            // DiÄŸer popuplarÄ± kapatma mantÄ±ÄŸÄ± eklenebilir
            pop.style.display = isVisible ? "none" : "block";
        }
    };

    // DÄ±ÅŸarÄ± tÄ±klayÄ±nca kapat
    document.addEventListener('click', (e) => {
        const pop = document.getElementById("secMarketPopup");
        if(pop && pop.style.display === "block" && !e.target.closest('.market-badge')) {
            pop.style.display = "none";
        }
    });

// âœ… YENÄ°: SektÃ¶r tablosunu isme gÃ¶re filtrele
// âœ… DÃœZELTÄ°LMÄ°Åž SEKTÃ–R FÄ°LTRELEME (Tree View KorumalÄ±)
window.secFilterTable = function(term){
  const t = String(term || "").toLocaleLowerCase('tr').trim();
  const allRows = document.querySelectorAll("#sec-tbody tr");

  // 1. DURUM: Arama Kutusunu Temizlediyse -> AÄžACI KAPAT (Sadece Ana SektÃ¶rler)
  if (t.length < 1) {
      allRows.forEach(row => {
          if (row.classList.contains("sec-row-level-1")) {
              row.style.display = ""; // Ana sektÃ¶rler gÃ¶rÃ¼nsÃ¼n
              // Caret'i kapat
              const caret = row.querySelector(".sec-caret");
              if(caret && caret.parentElement) {
                  caret.parentElement.parentElement.classList.remove("sec-expanded");
              }
          } else {
              row.style.display = "none"; // Alt sektÃ¶r ve ÅŸirketler gizlensin
          }
      });
      
      // Master caret'i de sÄ±fÄ±rla
      const master = document.getElementById("secMasterCaret");
      if(master) master.classList.remove("sec-expanded");
      
      return; 
  }

  // 2. DURUM: Arama YapÄ±lÄ±yorsa -> EÅŸleÅŸenleri ve Ebeveynlerini AÃ§
  // Ã–nce hepsini gizle
  allRows.forEach(r => r.style.display = "none");

  // EÅŸleÅŸenleri bul
  const matchedRows = [];
  allRows.forEach(row => {
      // SektÃ¶r/Åžirket ismi (cell-inner iÃ§indeki span)
      const nameSpan = row.querySelector(".sec-cell-inner span"); 
      // Veya direkt textContent (biraz kirli olabilir ama Ã§alÄ±ÅŸÄ±r)
      const txt = nameSpan ? nameSpan.textContent.toLocaleLowerCase('tr') : "";
      
      if(txt.includes(t)){
          matchedRows.push(row);
      }
  });

  // EÅŸleÅŸenleri ve ebeveynlerini aÃ§
  matchedRows.forEach(row => {
      // Kendisini gÃ¶ster
      row.style.display = "";

      // EÄŸer bu bir ÅŸirketse (Level 3), Level 2 (Ind) ve Level 1 (Sec) aÃ§Ä±lmalÄ±
      // EÄŸer bu bir alt sektÃ¶rse (Level 2), Level 1 (Sec) aÃ§Ä±lmalÄ±
      
      const parentId = row.getAttribute("data-parent");
      if(parentId){
          // Ebeveyn satÄ±rÄ±nÄ± bul (Ã¶r: ind_0_1 veya sec_0)
          const parentRow = document.querySelector(`tr[data-id="${parentId}"]`);
          if(parentRow) {
              parentRow.style.display = "";
              // Ebeveynin caret'ini "aÃ§Ä±k" yap
              const pCaret = parentRow.querySelector(".sec-caret");
              if(pCaret) pCaret.parentElement.parentElement.classList.add("sec-expanded");

              // EÄŸer ebeveynin de ebeveyni varsa (Level 3 -> Level 2 -> Level 1)
              const grandParentId = parentRow.getAttribute("data-parent");
              if(grandParentId){
                  const grandParentRow = document.querySelector(`tr[data-id="${grandParentId}"]`);
                  if(grandParentRow) {
                      grandParentRow.style.display = "";
                      const gpCaret = grandParentRow.querySelector(".sec-caret");
                      if(gpCaret) gpCaret.parentElement.parentElement.classList.add("sec-expanded");
                  }
              }
          }
      }
  });
};
// âœ… MASTER TOGGLE: Hepsini AÃ§ / Kapat
window.secToggleAllRows = function(e){
    // SÄ±ralama (sorting) Ã§alÄ±ÅŸmasÄ±n diye eventi durdur
    if(e) e.stopPropagation();

    const masterBtn = document.getElementById("secMasterCaret");
    const isExpanded = masterBtn.classList.contains("sec-expanded");
    
    const level1Rows = document.querySelectorAll(".sec-row-level-1");
    const level2Rows = document.querySelectorAll(".sec-row-level-2");
    
    // NOT: Level 3 (Åžirketler) Ã§ok fazla yer kapladÄ±ÄŸÄ± iÃ§in "Hepsini AÃ§"ta sadece 
    // SektÃ¶r -> Alt SektÃ¶r seviyesini aÃ§mak daha performanslÄ± ve ÅŸÄ±ktÄ±r.
    // EÄŸer ÅŸirketleri de aÃ§mak istersen level3Rows ekleyebilirsin.

    if (isExpanded) {
        // --- HEPSÄ°NÄ° KAPAT ---
        masterBtn.classList.remove("sec-expanded");
        
        // 1. Ana sektÃ¶r caretlerini dÃ¼zelt
        level1Rows.forEach(row => {
            const caret = row.querySelector(".sec-caret");
            if(caret) caret.parentElement.parentElement.classList.remove("sec-expanded");
        });

        // 2. Alt satÄ±rlarÄ± gizle
        level2Rows.forEach(row => {
            row.style.display = "none";
            // Alt sektÃ¶r caretlerini de kapat
            const caret = row.querySelector(".sec-caret");
            if(caret) caret.parentElement.parentElement.classList.remove("sec-expanded");
        });
        
        // Åžirketleri gizle
        document.querySelectorAll(".sec-row-level-3").forEach(r => r.style.display = "none");

    } else {
        // --- HEPSÄ°NÄ° AÃ‡ (SektÃ¶r ve Alt SektÃ¶rleri) ---
        masterBtn.classList.add("sec-expanded");

        // 1. Ana sektÃ¶rleri "aÃ§Ä±k" iÅŸaretle
        level1Rows.forEach(row => {
            const caret = row.querySelector(".sec-caret");
            if(caret) caret.parentElement.parentElement.classList.add("sec-expanded");
        });

        // 2. Alt sektÃ¶rleri gÃ¶ster
        level2Rows.forEach(row => row.style.display = "");
        
        // Ä°stersen ÅŸirketleri de aÃ§mak iÃ§in:
        // document.querySelectorAll(".sec-row-level-3").forEach(r => r.style.display = "");
        // level2Rows.forEach(r => r.querySelector(".sec-caret")...add("sec-expanded"));
    }
};

// âœ… YENÄ°: Åžirket ismi girilince sektÃ¶rÃ¼nÃ¼ bul ve filtrele
window.secFindSectorByCompany = function(val){
  const t = String(val || "").toLocaleLowerCase('tr').trim();
  const secInput = document.getElementById("secSearchName");

  // Arama boÅŸsa filtreyi temizle
  if(t.length < 2) { 
      if(secInput.value !== "") {
          secInput.value = "";
          secFilterTable(""); 
      }
      return; 
  }

  // Aktif gruptaki ÅŸirketlerde ara (Ticker veya Ä°sim)
  const found = (window.companies || []).find(c => 
      c.group === activeGroup && 
      (c.ticker.toLocaleLowerCase('tr').includes(t) || c.name.toLocaleLowerCase('tr').includes(t))
  );

  if(found && found.sector) {
      // Åžirket bulunduysa, sektÃ¶rÃ¼nÃ¼ diÄŸer kutuya yaz ve filtrele
      secInput.value = found.sector;
      secFilterTable(found.sector);
  }
};

// âœ… SECTORS INIT (Header Click Binding)
function initSectorList(){
  // Header click sort baÄŸla
  document.querySelectorAll("#sec-thead th").forEach(th => {
    // Daha Ã¶nce baÄŸlandÄ±ysa geÃ§
    if(th.__secBound) return;
    th.__secBound = true;

    th.onclick = () => {
      const key = th.dataset.key;
      if(!key) return;

      // AynÄ± sÃ¼tuna tÄ±klandÄ±ysa ters Ã§evir, farklÄ±ysa default (Desc)
      if (secSort.key === key) {
          secSort.asc = !secSort.asc;
      } else {
          secSort.key = key;
          secSort.asc = (key === 'name'); // Ä°simse A-Z, Rakam ise BÃ¼yÃ¼kten KÃ¼Ã§Ã¼ÄŸe
      }
      
      secRenderTable();
    };
  });

  secRenderTable();
}
// âœ… SECTORS INIT (VERÄ° YÃœKLEME GARANTÄ°LÄ°)
// âœ… SECTORS INIT (VERÄ° YÃœKLEME & SPINNER FIX)
window.secInitOnce = function(){
  // 1. Temel ÅŸirket listesini kontrol et
  finEnsureCompanies();
  finEnsureBenchmarks();
  
  // 2. EÄŸer veri (Map) henÃ¼z yoksa kullanÄ±cÄ±ya "YÃ¼kleniyor" gÃ¶ster
  const tbody = document.getElementById("sec-tbody");
  const isMapEmpty = !window.__FIN_MAP || Object.keys(window.__FIN_MAP).length === 0;

  if (tbody && isMapEmpty) {
      // âœ… FIX: colspan="18" olan hÃ¼creye inline style ile geniÅŸlik ve pozisyon sÄ±fÄ±rlamasÄ± yapÄ±yoruz.
      // BÃ¶ylece CSS'teki "ilk sÃ¼tun 360px olsun" kuralÄ±nÄ± eziyoruz.
      tbody.innerHTML = `
        <tr>
            <td colspan="18" style="text-align:center; padding:60px; color:#666; width:100% !important; max-width:none !important; position:static !important; background:transparent !important;">
                <div class="spinner" style="margin:0 auto 15px auto;"></div>
                <div style="font-size:14px; font-weight:600;">SektÃ¶r Verileri Analiz Ediliyor...</div>
            </td>
        </tr>`;
  }

  // 3. Veriyi Ä°ndir
  if (typeof finBuildMapForActiveGroup === "function") {
    finBuildMapForActiveGroup(() => {
      secMap = window.__FIN_MAP || {};
      if (!secInited) { 
          secInited = true; 
          initSectorList(); 
      } else { 
          secRenderTable(); 
      }
    });
  } else {
    if (!secInited) { secInited = true; initSectorList(); }
    else secRenderTable();
  }
};
// âœ… HÄ°YERARÅžÄ°K SEKTÃ–R TABLOSU (SektÃ¶r -> Alt SektÃ¶r -> Åžirket)
    // âœ… GÃœNCELLENMÄ°Åž & SIRALAMA DESTEKLÄ° SEKTÃ–R TABLOSU
    // âœ… HÄ°YERARÅžÄ°K SEKTÃ–R TABLOSU (HÄ°ZALAMA SORUNU GÄ°DERÄ°LDÄ°)
    window.secRenderTable = function(){
        const tbody = document.getElementById("sec-tbody");
        if (!tbody) return;
        tbody.innerHTML = "";

        if(window.secUpdateBadges) window.secUpdateBadges();
        updateSecSortHeaderUI();

        const companies = (window.companies || []).filter(c => c.group === activeGroup);
        const tree = {};

        companies.forEach(c => {
            const secName = (c.sector && String(c.sector).trim()) ? c.sector : "DiÄŸer";
            const indName = (c.industry && String(c.industry).trim()) ? c.industry : "DiÄŸer";
            const t = String(c.ticker).toUpperCase();

            if (!tree[secName]) tree[secName] = { name: secName, companies: [], industries: {} };
            tree[secName].companies.push(t);
            if (!tree[secName].industries[indName]) tree[secName].industries[indName] = [];
            tree[secName].industries[indName].push(t);
        });

        const calcStats = (tickerList) => {
            const stats = {};
            const keys = ["BrÃ¼t Kar MarjÄ±","Faaliyet KÃ¢r MarjÄ±","Cari Oran","Asit Test OranÄ±","BorÃ§/Ã–z Kaynak",
                "Nakit DÃ¶ngÃ¼sÃ¼","Stok Devir HÄ±zÄ±","Stok SÃ¼resi","Alacak Devir HÄ±zÄ±","Alacak SÃ¼resi",
                "BorÃ§ Devir HÄ±zÄ±","BorÃ§ SÃ¼resi","ROIC","ROA","ROE"];
            
            stats["Piyasa DeÄŸeri"] = secSum(tickerList.map(t => secMap[t]?.["Piyasa DeÄŸeri"] ?? 0));
            stats["Firma DeÄŸeri"]  = secSum(tickerList.map(t => secMap[t]?.["Firma DeÄŸeri"] ?? 0));

            keys.forEach(k => {
                const vals = tickerList.map(t => (secMap[t] ? secMap[t][k] : null));
                stats[k] = secMedian(vals);
            });
            return stats;
        };

        let sectorList = Object.values(tree).map(secNode => {
            const secStats = calcStats(secNode.companies);
            let industryList = Object.keys(secNode.industries).map(indName => {
                const indTickers = secNode.industries[indName];
                return { name: indName, tickers: indTickers, stats: calcStats(indTickers) };
            });
            return { name: secNode.name, stats: secStats, industries: industryList };
        });

        const sortFn = (a, b) => {
            let valA, valB;
            if (secSort.key === 'name') {
                valA = a.name; valB = b.name;
                return secSort.asc ? valA.localeCompare(valB, 'tr') : valB.localeCompare(valA, 'tr');
            } else {
                valA = a.stats[secSort.key]; valB = b.stats[secSort.key];
                if (valA === null || valA === undefined) return 1;
                if (valB === null || valB === undefined) return -1;
                return secSort.asc ? valA - valB : valB - valA;
            }
        };

        sectorList.sort(sortFn);

        const renderRowCells = (st) => `
            <td data-label="Piyasa DeÄŸeri">${money(st["Piyasa DeÄŸeri"])}</td>
            <td data-label="Firma DeÄŸeri">${money(st["Firma DeÄŸeri"])}</td>
            <td class="${cls(st["BrÃ¼t Kar MarjÄ±"])}">${pct(st["BrÃ¼t Kar MarjÄ±"])}</td>
            <td class="${cls(st["Faaliyet KÃ¢r MarjÄ±"])}">${pct(st["Faaliyet KÃ¢r MarjÄ±"])}</td>
            <td>${num(st["Cari Oran"])}</td>
            <td>${num(st["Asit Test OranÄ±"])}</td>
            <td>${num(st["BorÃ§/Ã–z Kaynak"])}</td>
            <td>${num(st["Nakit DÃ¶ngÃ¼sÃ¼"])} GÃ¼n</td>
            <td>${num(st["Stok Devir HÄ±zÄ±"])}</td>
            <td>${num(st["Stok SÃ¼resi"])} GÃ¼n</td>
            <td>${num(st["Alacak Devir HÄ±zÄ±"])}</td>
            <td>${num(st["Alacak SÃ¼resi"])} GÃ¼n</td>
            <td>${num(st["BorÃ§ Devir HÄ±zÄ±"])}</td>
            <td>${num(st["BorÃ§ SÃ¼resi"])} GÃ¼n</td>
            <td class="${cls(st["ROIC"])}">${pct(st["ROIC"])}</td>
            <td class="${cls(st["ROA"])}">${pct(st["ROA"])}</td>
            <td class="${cls(st["ROE"])}">${pct(st["ROE"])}</td>
        `;

        sectorList.forEach((secNode, secIdx) => {
            const secId = `sec_${secIdx}`;
            const totalComps = secNode.industries.reduce((acc, curr) => acc + curr.tickers.length, 0);

            const secTr = document.createElement("tr");
            secTr.className = "sec-row-level-1";
            secTr.setAttribute("data-id", secId);
            
            // DÃœZELTME: td style="display:flex" KALDIRILDI -> div class="sec-cell-inner" EKLENDÄ°
            secTr.innerHTML = `
                <td onclick="secToggleRow('${secId}')">
                    <div class="sec-cell-inner">
                        <i class="fa-solid fa-chevron-right sec-caret" id="caret_${secId}"></i>
                        <span class="sector-name" title="${secNode.name}">${secNode.name}</span>
                        <span class="comp-count">${totalComps}</span>
                    </div>
                </td>
                ${renderRowCells(secNode.stats)}
            `;
            tbody.appendChild(secTr);

            secNode.industries.sort(sortFn);

            secNode.industries.forEach((indNode, indIdx) => {
                const indId = `ind_${secIdx}_${indIdx}`;
                const indTr = document.createElement("tr");
                indTr.className = "sec-row-level-2";
                indTr.setAttribute("data-parent", secId);
                indTr.setAttribute("data-id", indId);
                indTr.style.display = "none";
                
                indTr.innerHTML = `
                    <td onclick="secToggleRow('${indId}')">
                        <div class="sec-cell-inner">
                            <i class="fa-solid fa-chevron-right sec-caret" id="caret_${indId}"></i>
                            <span title="${indNode.name}">${indNode.name}</span>
                            <span class="comp-count">${indNode.tickers.length}</span>
                        </div>
                    </td>
                    ${renderRowCells(indNode.stats)}
                `;
                tbody.appendChild(indTr);

                // Level 3 Sort
                indNode.tickers.sort((tA, tB) => {
                    if(secSort.key === 'name') return secSort.asc ? tA.localeCompare(tB) : tB.localeCompare(tA);
                    const vA = secMap[tA] ? secMap[tA][secSort.key] : null;
                    const vB = secMap[tB] ? secMap[tB][secSort.key] : null;
                    if (vA === null) return 1; if (vB === null) return -1;
                    return secSort.asc ? vA - vB : vB - vA;
                });

                indNode.tickers.forEach(ticker => {
                    const cData = secMap[ticker] || {};
                    const cInfo = companies.find(x => x.ticker === ticker) || {};
                    const compTr = document.createElement("tr");
                    compTr.className = "sec-row-level-3";
                    compTr.setAttribute("data-parent", indId);
                    compTr.style.display = "none";
                    // âœ… Åžirkete tÄ±klayÄ±nca VarlÄ±k Detayâ€™a git
compTr.style.cursor = "pointer";
compTr.addEventListener("click", (e) => {
  e.stopPropagation();
  if (window.finOpenDetail) window.finOpenDetail(ticker);
});

                    const logoHtml = cInfo.logourl ? `<img src="${cInfo.logourl}" class="sec-comp-logo">` : '';
                    
                    compTr.innerHTML = `
  <td>
    <div class="sec-cell-inner">
      ${logoHtml}
      <span>${ticker}</span>
      <span class="muted" style="margin-left:6px; font-size:10px;">${cInfo.name || ''}</span>

      <!-- âœ… saÄŸdaki aksiyon menÃ¼sÃ¼ -->
      <span class="sec-row-actions">
        <span class="fp-menu-btn" title="Ä°ÅŸlemler"
              onclick="event.stopPropagation(); fpOpenRowMenu('${ticker}', event);">
          <i class="fa-solid fa-ellipsis"></i>
        </span>
      </span>
    </div>
  </td>
  ${renderRowCells(cData)}
`;

                    tbody.appendChild(compTr);
                });
            });
        });
    };
    // Format Helpers (Scope iÃ§inde veya global tanÄ±mlÄ± olmalÄ±)
    const num = (v) => (v === null || v === undefined) ? `<span class="muted">-</span>` : Number(v).toLocaleString("tr-TR", { maximumFractionDigits: 2 });
    const pct = (v) => (v === null || v === undefined) ? `<span class="muted">-</span>` : (Number(v) * 100).toFixed(1) + "%";
    const cls = (v) => (v > 0 ? "pos" : (v < 0 ? "neg" : ""));
    const money = (v) => (v === null || v === undefined) ? `<span class="muted">-</span>` : finFormatMoneyCompact(v, { decimals: 1 });

    // UI Helper: Header OklarÄ±nÄ± GÃ¼ncelle
    function updateSecSortHeaderUI(){
        document.querySelectorAll("#sec-thead th").forEach(th => {
            th.classList.remove("active-sort");
            th.removeAttribute("data-icon");
            
            // EÄŸer key eÅŸleÅŸiyorsa (veya varsayÄ±lan Name ise)
            if (th.dataset.key === secSort.key) {
                th.classList.add("active-sort");
                th.setAttribute("data-icon", secSort.asc ? " â†‘" : " â†“");
            }
        });
    }
    // âœ… TOGGLE (AÃ‡/KAPA) FONKSÄ°YONU
    window.secToggleRow = function(id) {
        const caret = document.getElementById(`caret_${id}`);
        const rows = document.querySelectorAll(`tr[data-parent="${id}"]`);
        
        // Durumu caret class'Ä±ndan anla
        const isExpanded = caret.parentElement.parentElement.classList.contains("sec-expanded");
        
        if (isExpanded) {
            // KAPAT (Collapse)
            caret.parentElement.parentElement.classList.remove("sec-expanded");
            rows.forEach(row => {
                row.style.display = "none";
                // EÄŸer bu bir alt sektÃ¶rse, onun Ã§ocuklarÄ±nÄ± da kapat (Recursive kapa)
                const childId = row.getAttribute("data-id");
                if (childId) { // EÄŸer bu satÄ±rÄ±n da Ã§ocuklarÄ± varsa (yani Level 2 ise)
                    const childCaret = document.getElementById(`caret_${childId}`);
                    if(childCaret) {
                        childCaret.parentElement.parentElement.classList.remove("sec-expanded");
                        const childRows = document.querySelectorAll(`tr[data-parent="${childId}"]`);
                        childRows.forEach(cr => cr.style.display = "none");
                    }
                }
            });
        } else {
            // AÃ‡ (Expand)
            caret.parentElement.parentElement.classList.add("sec-expanded");
            rows.forEach(row => row.style.display = "table-row");
        }
    };


    // ============================================
    // COMPANIES LIST JAVASCRIPT
    // ============================================
    
    // âœ… Companies List, global benchmark mapâ€™i kullanÄ±r
const map = window.__FIN_MAP || (window.__FIN_MAP = Object.create(null));

    let clLimit = 200; // ilk aÃ§Ä±lÄ±ÅŸta 200 satÄ±r
    let __clLastKey = "";
let __clRenderedCount = 0;
let __clAppendRequested = false;

function clLoadMore(){
  __clAppendRequested = true;   // âœ… yeni satÄ±rlar eklenecek
  clLimit += 200;
  renderCompanyList();
}


let __clIO = null;
let __clLoading = false;

function clSetupInfiniteScroll(){
  const wrapper = document.querySelector('#view-companies .table-wrapper');
  const sentinel = document.getElementById('clSentinel');
  if (!wrapper || !sentinel) return;

  if (__clIO) { try { __clIO.disconnect(); } catch(e){} }

  __clIO = new IntersectionObserver((entries) => {
    const e = entries[0];
    if (!e || !e.isIntersecting) return;
    if (__clLoading) return;

    __clLoading = true;
    clLoadMore();

    // render bitince tekrar izin ver (kÃ¼Ã§Ã¼k gecikme yeterli)
    setTimeout(() => { __clLoading = false; }, 150);
  }, { root: wrapper, rootMargin: '600px 0px 600px 0px', threshold: 0.01 });



  __clIO.observe(sentinel);
}
function clRoot(){
  return document.querySelector('#view-companies.view-section.active')
      || document.querySelector('#view-companies.view-section')
      || document.getElementById('view-companies');
}
function clQ(sel){
  const r = clRoot();
  return r ? r.querySelector(sel) : null;
}
function clQA(sel){
  const r = clRoot();
  return r ? Array.from(r.querySelectorAll(sel)) : [];
}


    let currentSort = { key: 'Piyasa DeÄŸeri', asc: false };
  

    let activeFilters = { name: "", sector: "", ranges: {} };
    const filterKeys = ["Piyasa DeÄŸeri", "Firma DeÄŸeri", "SatÄ±ÅŸ Gelirleri", "Cari Oran", "BorÃ§/Ã–z Kaynak", "BrÃ¼t Kar MarjÄ±", "Faaliyet KÃ¢r MarjÄ±", "ROIC", "ROE", "PD/DD", "F/K"];

    function toggleFilter() {
        const overlay = document.getElementById("filterOverlay");
        const isVisible = overlay.style.display === "block";
        overlay.style.display = isVisible ? "none" : "block";
    }

    const parseNumber = (v) => finParseBenchmarkValue(v);
    // const num = (v) => (v === null || v === undefined) ? "-" : v.toLocaleString("tr-TR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    const mlnTL = (v) => (v === null || v === undefined) ? "-" : finFormatMoneyCompact(v);
    // const pct = (v) => (v === null || v === undefined) ? "-" : "% " + (v * 100).toLocaleString("tr-TR", { minimumFractionDigits: 1, maximumFractionDigits: 1 });
    const days = (v) => (v === null || v === undefined) ? "-" : Math.round(v) + " GÃ¼n";
    // const cls = (v) => v > 0 ? "val-up" : (v < 0 ? "val-down" : "");

    let __clSearchT = 0;

    
    function clearFilters() {
        document.getElementById("f_sector").value = "";
        filterKeys.forEach(k => { 
            const minEl = document.getElementById(`min_${k}`);
            const maxEl = document.getElementById(`max_${k}`);
            if(minEl) minEl.value = ""; 
            if(maxEl) maxEl.value = ""; 
        });
        activeFilters.ranges = {};
        renderCompanyList();
    }

    function applyFilters() {
        activeFilters.sector = document.getElementById("f_sector").value;
        filterKeys.forEach(k => {
            const minEl = document.getElementById(`min_${k}`);
            const maxEl = document.getElementById(`max_${k}`);
            activeFilters.ranges[k] = {
                min: minEl ? (parseFloat(minEl.value) || null) : null,
                max: maxEl ? (parseFloat(maxEl.value) || null) : null
            };
        });
        toggleFilter();
        renderCompanyList();
    }

    function renderCompanyList() {
  const tbody = clQ("#cl-tbody");
if (!tbody) return;


  // âœ… Filtre/sort/group deÄŸiÅŸti mi? Key ile anlayalÄ±m
  const keyObj = {
    g: activeGroup,
    sKey: currentSort.key,
    sAsc: currentSort.asc,
    name: (activeFilters.name || "").toLowerCase(),
    sector: activeFilters.sector || "",
    ranges: activeFilters.ranges || {}
  };
  const key = JSON.stringify(keyObj);

  const append = (__clAppendRequested && key === __clLastKey);
  __clAppendRequested = false;

  // âœ… append deÄŸilse tabloyu sÄ±fÄ±rla (filtre/sort deÄŸiÅŸmiÅŸ demektir)
  if (!append) {
    tbody.innerHTML = "";
    __clRenderedCount = 0;
    __clLastKey = key;
  }


        // BURADA FILTRELEME EKLENDI: c.group === activeGroup
        let filtered = window.companies.filter(c => {
            // 1. Grup KontrolÃ¼
            if(c.group !== activeGroup) return false;

            // 2. SektÃ¶r Filtresi (Varsa)
            if (window.clFilters && window.clFilters.sector) {
                if (c.sector !== window.clFilters.sector) return false;
            }

            // 3. Alt SektÃ¶r Filtresi (Varsa)
            if (window.clFilters && window.clFilters.industry) {
                if (c.industry !== window.clFilters.industry) return false;
            }

            const d = map[c.ticker] || {};
            
            const q = String(activeFilters.name || "").toLocaleLowerCase('tr').trim();
const nm = String(c.name || "").toLocaleLowerCase('tr');
const tk = String(c.ticker || "").toLocaleLowerCase('tr');

const matchName = (q.length < 1)
  ? true
  : (nm.includes(q) || tk.includes(q));


            const matchSector = activeFilters.sector === "" || c.sector === activeFilters.sector;
            let matchRanges = true;
            for (let key in activeFilters.ranges) {
                const val = d[key]; const range = activeFilters.ranges[key];
                let compareVal = val;
                if (key.includes("DeÄŸeri") && val) compareVal = val / 1_000_000;
                else if ((key.includes("MarjÄ±") || key.includes("RO")) && val) compareVal = val * 100;
                if (range.min !== null && (val === null || compareVal < range.min)) matchRanges = false;
                if (range.max !== null && (val === null || compareVal > range.max)) matchRanges = false;
            }
            return matchName && matchSector && matchRanges;
        });

filtered.sort((a, b) => {
            // Ä°sim sÄ±ralamasÄ± ise Ã¶zel iÅŸlem
            if (currentSort.key === 'name') {
                return currentSort.asc 
                    ? a.name.localeCompare(b.name, "tr") 
                    : b.name.localeCompare(a.name, "tr");
            }

            // Metrik sÄ±ralamasÄ± (Piyasa DeÄŸeri vs.)
            // map[ticker] yoksa boÅŸ obje {}, oradan da deÄŸeri al
            const dataA = map[a.ticker] || {};
            const dataB = map[b.ticker] || {};
            
            let valA = dataA[currentSort.key];
            let valB = dataB[currentSort.key];

            // DeÄŸer yoksa (null/undefined) en dÃ¼ÅŸÃ¼ÄŸÃ¼ ver ki en alta gitsin
            // Not: Infinity kullanmÄ±yoruz, null kontrolÃ¼ yapÄ±yoruz.
            const hasA = (valA !== null && valA !== undefined);
            const hasB = (valB !== null && valB !== undefined);

            if (!hasA && !hasB) return 0;
            if (!hasA) return 1;  // A yoksa, A bÃ¼yÃ¼ktÃ¼r (alta git)
            if (!hasB) return -1; // B yoksa, B bÃ¼yÃ¼ktÃ¼r (alta git)

            // SayÄ±sal karÅŸÄ±laÅŸtÄ±rma
            return currentSort.asc ? valA - valB : valB - valA;
        });
        // Arama varken limit uygulama: NVDA gibi sonuÃ§lar scroll istemeden gelsin
const __q = String(activeFilters.name || "").trim();
if (__q) {
  // arama sonuÃ§larÄ±nÄ± gÃ¶ster (Ã§ok bÃ¼yÃ¼rse diye Ã¼st sÄ±nÄ±r)
  filtered = filtered.slice(0, 5000);
} else {
  const __q = String(activeFilters.name || "").trim();
if (__q) {
  // arama sonuÃ§larÄ±nÄ± gÃ¶ster (Ã§ok bÃ¼yÃ¼rse diye Ã¼st sÄ±nÄ±r)
  filtered = filtered.slice(0, 5000);
} else {
  // Arama varken limit uygulama (NVDA/GOOGL/TSLA scroll'suz gelsin)
const __q = String(activeFilters.name || "").trim();
if (__q) {
  filtered = filtered.slice(0, 5000);
} else {
  filtered = filtered.slice(0, clLimit);
}

}

}



       // âœ… Chunk render: bÃ¼yÃ¼k listelerde donmayÄ± keser
window.__clRenderToken = (window.__clRenderToken || 0) + 1;
const token = window.__clRenderToken;

let i = __clRenderedCount;
const BATCH = 70;

function pump(){
  if (token !== window.__clRenderToken) return;

  const frag = document.createDocumentFragment();
  const end = Math.min(i + BATCH, filtered.length);

  for (; i < end; i++){
    const c = filtered[i];
    const d = map[c.ticker] || {};
    
    // --- FÄ°YAT HESAPLAMA ---
    const price = window.currentPriceData[c.ticker] || 0;
    const prev = window.prevPriceData[c.ticker] || price;
    
    let priceHtml = '<span class="muted">-</span>';
    if (price > 0) {
        const diff = price - prev;
        const isUp = diff > 0;
        const isDown = diff < 0;
        
        // Renk ve Ä°kon Belirleme
        const color = isUp ? 'color:#c2f50e;' : (isDown ? 'color:#ff4d4d;' : 'color:#eee;');
        const icon = isUp ? '<i class="fa-solid fa-caret-up"></i>' : (isDown ? '<i class="fa-solid fa-caret-down"></i>' : '');
        const sym = (['sp','nyse','nasdaq','doviz','emtia','kripto'].includes(c.group)) ? '$' : 'â‚º';

        priceHtml = `
            <div style="display:flex; align-items:center; justify-content:flex-end; gap:6px; font-weight:700; ${color}">
                ${icon} <span>${sym}${price.toLocaleString("tr-TR", {minimumFractionDigits:2, maximumFractionDigits:2})}</span>
            </div>
        `;
    }
    // -----------------------

    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>
        <div style="display:flex; align-items:center; gap:12px;">
          <img src="${c.logourl}" loading="lazy" style="width:32px; height:32px; object-fit:contain; background:#111; border-radius:6px; flex-shrink: 0;" onerror="this.style.display='none'">
          <div style="display: flex; flex-direction: column; justify-content: center; gap: 4px; overflow: hidden;">
            <a href="https://finapsis.co/comdetail/${c.slug}" target="_top" style="font-weight:600; font-size:14px; color:#fff; text-decoration:none;">${c.name}</a>
            <div style="font-size:11px; color:#666;">${c.ticker} â€¢ ${c.sector}</div>
          </div>
          <button class="fp-menu-btn" title="Ä°ÅŸlemler" onclick="event.stopPropagation(); fpOpenRowMenu('${c.ticker}', event)">
            <i class="fa-solid fa-ellipsis-vertical"></i>
          </button>
        </div>
      </td>

      <td data-label="Fiyat">${priceHtml}</td>

      <td data-label="Piyasa DeÄŸeri">${mlnTL(d["Piyasa DeÄŸeri"])}</td>
      <td data-label="Firma DeÄŸeri">${mlnTL(d["Firma DeÄŸeri"])}</td>
      <td data-label="SatÄ±ÅŸ Gelirleri">${mlnTL(d["SatÄ±ÅŸ Gelirleri"])}</td>

      <td data-label="BrÃ¼t Kar MarjÄ±" class="${cls(d["BrÃ¼t Kar MarjÄ±"])}">${pct(d["BrÃ¼t Kar MarjÄ±"])}</td>
      <td data-label="Faaliyet KÃ¢r MarjÄ±" class="${cls(d["Faaliyet KÃ¢r MarjÄ±"])}">${pct(d["Faaliyet KÃ¢r MarjÄ±"])}</td>

      <td data-label="Cari Oran">${num(d["Cari Oran"])}</td>
      <td data-label="Asit Test OranÄ±">${num(d["Asit Test OranÄ±"])}</td>
      <td data-label="BorÃ§/Ã–z Kaynak">${num(d["BorÃ§/Ã–z Kaynak"])}</td>

      <td data-label="Nakit DÃ¶ngÃ¼sÃ¼">${days(d["Nakit DÃ¶ngÃ¼sÃ¼"])}</td>
      <td data-label="Stok Devir HÄ±zÄ±">${num(d["Stok Devir HÄ±zÄ±"])}</td>
      <td data-label="Stok SÃ¼resi">${days(d["Stok SÃ¼resi"])}</td>
      <td data-label="Alacak Devir HÄ±zÄ±">${num(d["Alacak Devir HÄ±zÄ±"])}</td>
      <td data-label="Alacak SÃ¼resi">${days(d["Alacak SÃ¼resi"])}</td>
      <td data-label="BorÃ§ Devir HÄ±zÄ±">${num(d["BorÃ§ Devir HÄ±zÄ±"])}</td>
      <td data-label="BorÃ§ SÃ¼resi">${days(d["BorÃ§ SÃ¼resi"])}</td>

      <td data-label="ROIC" class="${cls(d["ROIC"])}">${pct(d["ROIC"])}</td>
      <td data-label="ROA" class="${cls(d["ROA"])}">${pct(d["ROA"])}</td>
      <td data-label="ROE" class="${cls(d["ROE"])}">${pct(d["ROE"])}</td>

      <td data-label="PD/DD">${num(d["PD/DD"])}</td>
      <td data-label="F/K">${num(d["F/K"])}</td>
      <td data-label="Fiyat/SatÄ±ÅŸlar">${num(d["Fiyat/SatÄ±ÅŸlar"])}</td>
    `;

    frag.appendChild(tr);
  }

  tbody.appendChild(frag);

  // ara ara iframe Ã¶lÃ§
  if (i % (BATCH*3) === 0) window.pfFinapsisResize?.();

  if (i < filtered.length) requestAnimationFrame(pump);
else {
  __clRenderedCount = filtered.length;   // âœ… kaÃ§ satÄ±r basÄ±ldÄ± hatÄ±rla
  window.pfFinapsisResize?.();
}

}

requestAnimationFrame(pump);

    }
  // ==========================================
// YENÄ° COMPANIES FILTER LOGIC (PORTFOLIO STYLE)
// ==========================================

// Popup AÃ§/Kapa

// Popup Kapat
window.clCloseSectorPopup = function(e){
  if(e) e.stopPropagation();
  const pop = document.getElementById("clSectorPopup");
  if(pop) pop.style.display = "none";
};

// Listeyi OluÅŸtur

// SektÃ¶r SeÃ§imi
window.clSelectSector = function(sec){
  // activeFilters global deÄŸiÅŸkenini gÃ¼ncelle
  if(!activeFilters) activeFilters = {};
  activeFilters.sector = sec;
  
  // Listeyi yeniden Ã§iz
  renderCompanyList();
  
  // Popup'Ä± kapat ve listeyi gÃ¼ncelle (buton rengi iÃ§in)
  clCloseSectorPopup();
  clBuildSectorList(); 
};

// Filtreyi Temizle
window.clClearSectorFilter = function(e){
  if(e) e.stopPropagation();
  clSelectSector("");
};

// Popup Ä°Ã§i Arama
window.clFilterSectorListInPopup = function(term){
  const t = String(term || "").toLocaleLowerCase('tr');
  const items = document.querySelectorAll("#clSectorList .cl-sector-item");
  
  items.forEach(el => {
    const txt = el.textContent.toLocaleLowerCase('tr');
    // "TÃ¼m SektÃ¶rler" seÃ§eneÄŸi her zaman gÃ¶rÃ¼nsÃ¼n veya eÅŸleÅŸme varsa
    if(el.textContent === "TÃ¼m SektÃ¶rler" || txt.includes(t)) {
      el.style.display = "block";
    } else {
      el.style.display = "none";
    }
  });
};

// DÄ±ÅŸarÄ± tÄ±klayÄ±nca kapat
document.addEventListener("click", (e) => {
  const pop = document.getElementById("clSectorPopup");
  const btn = document.getElementById("clSectorBtn");
  const inp = document.getElementById("clSectorSearchInput"); // Inputa tÄ±klayÄ±nca kapanmasÄ±n

  if(pop && pop.style.display === "block") {
    if(!pop.contains(e.target) && !btn.contains(e.target)) {
      pop.style.display = "none";
    }
  }
});  

    // SektÃ¶r dropdown'unu aktif gruba gÃ¶re yenileme
    function updateCompanyListSectorDropdown() {
        const s = document.getElementById("f_sector");
        s.innerHTML = '<option value="">TÃ¼m SektÃ¶rler</option>'; // Reset
        
        // Sadece aktif gruptaki ÅŸirketlerin sektÃ¶rlerini al
        const sectors = [...new Set(window.companies
            .filter(c => c.group === activeGroup)
            .map(c => c.sector))]
            .filter(Boolean)
            .sort();

        sectors.forEach(sec => {
            let o = document.createElement("option"); 
            o.value = sec; 
            o.innerText = sec; 
            s.appendChild(o);
        });
    }

    function initCompaniesList() {
  if (window.__companiesListInited) return;
  window.__companiesListInited = true;

  finEnsureCompanies();
  finEnsureBenchmarks();

  // sektÃ¶r dropdown Ã¶nce companies ile dolsun
  updateCompanyListSectorDropdown();

  // map arkada dolsun; dolunca tabloyu tekrar Ã§iz
  finBuildMapForActiveGroup(() => {
    renderCompanyList();
  });

  // ilk etapta tabloyu Ã§iz (map henÃ¼z dolmamÄ±ÅŸ olabilir)
  renderCompanyList();
  clSetupInfiniteScroll();


  // search input event (1 kere baÄŸla)
  const searchEl = clQ("#mainSearch");
  if (searchEl && !searchEl.__fpBound) {
    searchEl.__fpBound = true;
    searchEl.addEventListener("input", applyMainSearch);
  }
}


    

    // ============================================
    // PORTFOLYO (Ä°ZOLE) SCRIPT
    // ============================================

(function() {
  // --- CONFIG KAYNAKLARI ---
  // 1) window.FINAPSIS_CONFIG (Ã¶nerilen)
  // 2) Bubble'Ä±n global deÄŸiÅŸkenleri (window.BUBBLE_USER_ID / window.BUBBLE_USERNAME vb.)
  const CFG = window.FINAPSIS_CONFIG || {};

  const BUBBLE_USER_ID = String((CFG.BUBBLE_USER_ID || window.BUBBLE_USER_ID || window.BUBBLE_USERID || '')).trim();
  const BUBBLE_USER_NAME = String((CFG.BUBBLE_USER_NAME || window.BUBBLE_USERNAME || window.BUBBLE_USER_NAME || '')).trim();
  const BUBBLE_API_TOKEN = String((CFG.BUBBLE_API_TOKEN || window.BUBBLE_API_TOKEN || '')).trim();

  const API_BASE = String((CFG.API_BASE || 'https://eap-35848.bubbleapps.io/api/1.1/wf')).replace(/\/\s*$/, '');
  const GOOGLE_CLIENT_ID = String((CFG.GOOGLE_CLIENT_ID || '')).trim();
  const REDIRECT_URI = String((CFG.REDIRECT_URI || window.location.href.split('?')[0])).trim();

  const currentPriceData = window.currentPriceData || {};
  const prevPriceData = window.prevPriceData || {};

  let prices = {}, prevPrices = {};
  for(let k in currentPriceData) prices[k] = parseFloat(currentPriceData[k]);
  for(let k in prevPriceData) prevPrices[k] = parseFloat(prevPriceData[k]);

  // ===== MIDAS (BIST) PRICE REFRESH via n8n proxy =====
// ===== PRICE REFRESH via Google Apps Script (ALL groups) =====
// ARTIK KULLANILMIYOR - Fiyatlar baÅŸlangÄ±Ã§ta R2'dan yÃ¼kleniyor.
// ===== PRICE REFRESH via Google Apps Script (ALL groups) =====
// ARTIK KULLANILMIYOR - Fiyatlar baÅŸlangÄ±Ã§ta R2'dan yÃ¼kleniyor.
// ===== PRICE REFRESH via R2 (Detail JSON) =====

// âœ… DEÄžÄ°ÅžKEN TANIMI
let __priceInFlight = false; 

// Fonksiyonu doÄŸrudan window'a atayarak veya declare ederek tekilleÅŸtiriyoruz
window.pfRefreshPricesFromProxy = async function(){
  if (__priceInFlight) return;
  __priceInFlight = true;

  try{
    console.log("[PriceUpdate] Fiyatlar detail.v1.json Ã¼zerinden gÃ¼ncelleniyor...");
    
    // Proxy yerine yeni detail dosyasÄ±nÄ± Ã§ekiyoruz (Cache-busting iÃ§in time parametresi ekledik)
    const res = await fetch(`${window.FIN_DATA_BASE}/price/detail.v1.json?t=${Date.now()}`);
    
    if (res.ok) {
        const rawDetail = await res.json();
        const detailList = (Array.isArray(rawDetail) && rawDetail[0]?.data) ? rawDetail[0].data : [];

        // Global deÄŸiÅŸkenleri gÃ¼ncelle
        detailList.forEach(item => {
            if (item.ticker) {
                const t = String(item.ticker).trim().toUpperCase();
                const p = Number(item.price);
                const prev = Number(item.prev);

                window.currentPriceData[t] = p;
                window.prevPriceData[t] = prev;

                // Map ve SÄ±ralama verilerini gÃ¼ncelle
                if(!window.__FIN_MAP) window.__FIN_MAP = {};
                if(!window.__FIN_MAP[t]) window.__FIN_MAP[t] = {};
                
                window.__FIN_MAP[t]["price"] = p;
                window.__FIN_MAP[t]["prev"] = prev;
            }
        });

        // UI Yenilemeleri
        try { if(window.pfRenderMarketList) window.pfRenderMarketList(); } catch(e){}
        try { if(window.pfRenderDashboard) window.pfRenderDashboard(); } catch(e){}
        
        // EÄŸer Åžirketler listesi aÃ§Ä±ksa orayÄ± da gÃ¼ncelle (Fiyat sÃ¼tunu iÃ§in)
        try { 
            const cl = document.getElementById("view-companies");
            if (cl && cl.classList.contains("active") && window.renderCompanyList) {
                window.renderCompanyList();
            }
        } catch(e){}

        // Detay sayfasÄ± aÃ§Ä±ksa fiyatÄ± tazele
        try {
          const det = document.getElementById("view-detail");
          if (det && det.classList.contains("active")) {
            if (window.finDetailRefreshHeaderPrice) window.finDetailRefreshHeaderPrice();
          }
        } catch(e){}
        
        console.log(`[PriceUpdate] ${detailList.length} enstrÃ¼man gÃ¼ncellendi.`);
    }
  } catch(e){
    console.warn("[PriceUpdate] GÃ¼ncelleme hatasÄ±:", e);
  } finally{
    __priceInFlight = false;
  }
}


// debug iÃ§in dÄ±ÅŸarÄ± aÃ§ (opsiyonel)
window.pfRefreshPricesFromProxy = pfRefreshPricesFromProxy;

  

  const ALL_KEY = "__ALL__";

  // state
  let state = {
    user: null,
    token: null,
    portfolios: [],
    activePortfolio: null,       // only for single view
    activePortfolioId: null,     // can be ALL_KEY
    cashBalance: 0,
    activeGroup: 'bist',
    sectorFilter: "",
    trade: { ticker: null, side: 'buy', inputMode: 'qty', portfolioId: null },
    isLogin: true,
    activeTab: 'assets',
    // caches
    portfolioCache: {},          // { [portfolioId]: detailResponse }
    allCombined: null            // { positions:[], transactions:[], portfolioNamesById:{} }
  };

  let charts = {};

  const getItem = (ticker) => (window.companies || []).find(c => c.ticker === ticker);
  const getGroup = (ticker) => getItem(ticker)?.group;

  const isUSD = (ticker) => {
    const item = getItem(ticker);
    return item && (item.group === 'sp' || item.group === 'emtia' || item.group === 'kripto');
  };

  const getSym = (ticker) => isUSD(ticker) ? '$' : 'â‚º';

  const getQtyUnitLabel = (ticker) => {
    const item = getItem(ticker);
    const g = item?.group;

    // Sadece emtia unit
    if (g === 'emtia') return item?.unit || 'Birim';

    // DÃ¶viz qty modunda baz dÃ¶vizi gÃ¶ster (USDTRY -> USD)
    if (g === 'doviz') return (typeof ticker === 'string' && ticker.length >= 3) ? ticker.slice(0,3) : 'Birim';

    // Hisse/fon/sp
    return 'Adet';
  };

  const getDefaultInputMode = (ticker) => {
    if (getGroup(ticker) === 'doviz') return 'amount';
    return 'qty';
  };

  const setTradePlaceholder = () => {
    const t = state.trade.ticker;
    const input = document.getElementById('tradeQty');
    if (!t || !input) return;

    const sym = getSym(t);
    const g = getGroup(t);

    if (state.trade.inputMode === 'amount') {
      input.placeholder = `Tutar (${sym}) giriniz...`;
    } else {
      if (g === 'doviz') input.placeholder = `Miktar (${getQtyUnitLabel(t)}) giriniz...`;
      else input.placeholder = `${getQtyUnitLabel(t)} giriniz...`;
    }
  };

  async function api(ep, body) {
    const headers = { "Content-Type": "application/json" };
    const token = state.token || BUBBLE_API_TOKEN;
    if(token) headers["Authorization"] = "Bearer " + token;
    try {
      return await (await fetch(`${API_BASE}/${ep}/`, { method: "POST", headers, body: JSON.stringify(body) })).json();
    } catch(e) {
      return { status: "error" };
    }
  }

  async function getPortfolioDetailCached(pfId) {
    if (!pfId) return null;
    if (state.portfolioCache[pfId]) return state.portfolioCache[pfId];
    const res = await api('portfolio-detail', { portfolio: pfId });
    if (res.status === "success") state.portfolioCache[pfId] = res.response;
    return state.portfolioCache[pfId] || null;
  }

  function combineAll(detailsList, portfolioNamesById) {
    const map = {}; // ticker -> { ticker, quantity, costSum, anyAvgCostRef }
    const allTx = [];

    detailsList.forEach(d => {
      if (!d) return;
      const pfId = d.portfolio?.portfolio_id;
      const pfName = portfolioNamesById[pfId] || d.portfolio?.name || "PortfÃ¶y";
      const positions = (d.positions || []).filter(pos => (Number(pos.quantity) || 0) > 0);
      const transactions = d.transactions || [];

      positions.forEach(p => {
        const t = p.ticker;
        const q = Number(p.quantity) || 0;
        const avg = Number(p.avg_cost) || 0;
        if (!map[t]) map[t] = { ticker: t, quantity: 0, costSum: 0 };
        map[t].quantity += q;
        map[t].costSum += (avg * q);
      });

      transactions.forEach(tx => {
        allTx.push({
          ...tx,
          __pf_id: pfId,
          __pf_name: pfName
        });
      });
    });

    const combinedPositions = Object.values(map)
      .filter(x => x.quantity > 0)
      .map(x => ({
        ticker: x.ticker,
        quantity: x.quantity,
        avg_cost: x.quantity > 0 ? (x.costSum / x.quantity) : 0
      }));

    const combinedTransactions = allTx
      .slice()
      .sort((a,b) => new Date(b.executed_at) - new Date(a.executed_at));

    return { positions: combinedPositions, transactions: combinedTransactions, portfolioNamesById };
  }

  async function loadAllPortfolios() {
    state.activePortfolioId = ALL_KEY;
    state.activePortfolio = null;

    // preload all details
    const nameMap = {};
    state.portfolios.forEach(p => nameMap[p.portfolio_id] = p.name);

    const ids = state.portfolios.map(p => p.portfolio_id);
    const details = await Promise.all(ids.map(id => getPortfolioDetailCached(id)));

    state.allCombined = combineAll(details, nameMap);
    pfRenderDashboard();
  }

  async function loadPortfolioDetail(pfId) {
    state.activePortfolioId = pfId;
    const detail = await getPortfolioDetailCached(pfId);
    if (detail) {
      state.activePortfolio = detail;
      pfRenderDashboard();
    } else {
      pfRenderCreate();
    }
  }

  async function refreshData() {
    document.getElementById('mainPanel').innerHTML = `<div class="loader-wrap"><div class="spinner"></div><p>Veriler YÃ¼kleniyor...</p></div>`;
    const res = await api('portfolio-list', { user: state.user.id });

    if(res.status === "success") {
      state.portfolios = res.response.portfolios || [];
      state.cashBalance = res.response.cash_balance || 0;

      if (state.portfolios.length === 0) {
        pfRenderCreate();
        return;
      }

      // If active not set, default first portfolio
      if (!state.activePortfolioId) state.activePortfolioId = state.portfolios[0].portfolio_id;

      if (state.activePortfolioId === ALL_KEY) {
        await loadAllPortfolios();
      } else {
        // ensure it still exists
        const exists = state.portfolios.some(p => p.portfolio_id === state.activePortfolioId);
        const targetId = exists ? state.activePortfolioId : state.portfolios[0].portfolio_id;
        await loadPortfolioDetail(targetId);
      }
    } else {
      pfRenderCreate();
    }
  }

  function init() {
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');
    const saved = localStorage.getItem('finapsis_real_user');

    if (code) {
      fetch(`${API_BASE}/google-auth-callback/`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ code: code })
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === "success" || data.status === "ok") {
          const userData = { user: { id: data.user.id, name: data.user.name || "Google User" }, token: data.token };
          localStorage.setItem('finapsis_real_user', JSON.stringify(userData));
          try { localStorage.setItem('finapsis_active_main_tab', 'portfolio.html'); } catch(e) {}
          state.user = userData.user; state.token = userData.token;
          window.history.replaceState({}, document.title, window.location.pathname);
          refreshData();
        } else {
          alert("Hata: " + data.message);
          pfRenderAuth();
        }
      }).catch(() => pfRenderAuth());
    } else if (BUBBLE_USER_ID) {
      state.user = { id: BUBBLE_USER_ID, name: BUBBLE_USER_NAME || "User" };
      if(BUBBLE_API_TOKEN) state.token = BUBBLE_API_TOKEN;
      refreshData();
    } else if (saved) {
      const parsed = JSON.parse(saved);
      state.user = parsed.user; state.token = parsed.token;
      refreshData();
    } else {
      pfRenderAuth();
    }

    // ilk aÃ§Ä±lÄ±ÅŸta bir kez Ã§ek
pfRefreshPricesFromProxy();

// 15 dakikada bir yenile (tab gÃ¶rÃ¼nmÃ¼yorken Ã§alÄ±ÅŸtÄ±rma)
setInterval(() => {
  if (document.visibilityState === "hidden") return;
  pfRefreshPricesFromProxy();
}, 15 * 60 * 1000);

document.addEventListener("visibilitychange", () => {
  if (document.visibilityState === "visible") pfRefreshPricesFromProxy();
});


  }

  function pfNormSector(s){
  const v = String(s || "").trim();
  return v ? v : "DiÄŸer";
}
function pfCanSectorFilter(){
  return state.activeGroup === "bist" || state.activeGroup === "sp";
}

window.pfBuildSectorList = function(){
  const list = document.getElementById("pfSectorList");
  const btn  = document.getElementById("pfSectorBtn");
  if (!list || !btn) return;

  // sadece bist/sp iÃ§in aktif
  if (!pfCanSectorFilter()){
    btn.classList.add("disabled");
    btn.classList.remove("active");
    list.innerHTML = `<div style="padding:12px;color:#777;font-size:12px;">Bu grupta sektÃ¶r filtresi yok.</div>`;
    return;
  }

  btn.classList.remove("disabled");
  const comps = (window.companies || []).filter(c => c.group === state.activeGroup);
  const sectors = Array.from(new Set(comps.map(c => pfNormSector(c.sector)))).sort((a,b)=>a.localeCompare(b,"tr"));

  const cur = state.sectorFilter || "";
  let html = `<div class="pf-sector-item ${cur==="" ? "active":""}" data-sec="">TÃ¼m SektÃ¶rler</div>`;
  html += sectors.map(s => {
    const on = (s === cur) ? "active" : "";
    return `<div class="pf-sector-item ${on}" data-sec="${s.replace(/"/g,'&quot;')}">${s}</div>`;
  }).join("");

  list.innerHTML = html;

  // buton highlight
  if (cur) btn.classList.add("active");
  else btn.classList.remove("active");
};
// âœ… YENÄ° EKLENEN: SektÃ¶r listesi iÃ§inde arama yapma fonksiyonu
window.pfFilterSectorList = function(term){
  const t = String(term || "").toLocaleLowerCase('tr'); // TÃ¼rkÃ§e karakter uyumlu kÃ¼Ã§Ã¼k harf
  const items = document.querySelectorAll("#pfSectorList .pf-sector-item");
  
  items.forEach(el => {
    const secName = el.textContent.toLocaleLowerCase('tr');
    const isAllOption = el.getAttribute("data-sec") === ""; // "TÃ¼m SektÃ¶rler" seÃ§eneÄŸi
    
    // "TÃ¼m SektÃ¶rler" her zaman gÃ¶rÃ¼nsÃ¼n veya arama terimi iÃ§eriyorsa gÃ¶ster
    if (isAllOption || secName.includes(t)) {
      el.style.display = "block";
    } else {
      el.style.display = "none";
    }
  });
};

window.pfToggleSectorPopup = function(e){
  if (e) e.stopPropagation();
  try { window.finEnsureCompanies && window.finEnsureCompanies(); } catch(_){}

  const pop = document.getElementById("pfSectorPopup");
  if (!pop) return;

  
  // listeyi her aÃ§Ä±lÄ±ÅŸta gÃ¼ncelle
  pfBuildSectorList();

  // âœ… YENÄ° EKLENEN: Popup aÃ§Ä±lÄ±rken arama kutusunu temizle
  const inp = document.getElementById("pfSectorSearchInput");
  if(inp) { 
      inp.value = ""; 
      if(window.pfFilterSectorList) window.pfFilterSectorList(""); 
  }

  const open = (pop.style.display === "block");
  pop.style.display = open ? "none" : "block";
};

window.pfCloseSectorPopup = function(e){
  if (e) e.stopPropagation();
  const pop = document.getElementById("pfSectorPopup");
  if (pop) pop.style.display = "none";
};

window.pfClearSectorFilter = function(e){
  if (e) e.stopPropagation();
  state.sectorFilter = "";
  pfBuildSectorList();
  pfRenderMarketList();
};

// seÃ§enek tÄ±klama
document.addEventListener("click", (e) => {
  const pop = document.getElementById("pfSectorPopup");
  if (!pop || pop.style.display !== "block") return;

  // popup iÃ§indeki item seÃ§imi
  const item = e.target.closest("#pfSectorList .pf-sector-item");
  if (item) {
    const sec = item.getAttribute("data-sec") || "";
    state.sectorFilter = sec;
    pfBuildSectorList();
    pfRenderMarketList();
    pop.style.display = "none";
    return;
  }

  // popup dÄ±ÅŸÄ±na tÄ±klanÄ±nca kapat
  const within = e.target.closest("#pfSearchBox");
  if (!within) pop.style.display = "none";
});

  window.pfSetGroup = function(g, el) {
  state.activeGroup = g;

  // âœ… grup deÄŸiÅŸince sektÃ¶r filtresi reset
  state.sectorFilter = "";
  try { pfBuildSectorList(); } catch(e){}

  document.querySelectorAll('.cat-item').forEach(i => i.classList.remove('active'));
  el.classList.add('active');
  pfRenderMarketList();
};


  window.pfRenderMarketList = function() {
    try { window.finEnsureCompanies && window.finEnsureCompanies(); } catch(e){}
    const term = document.getElementById('searchInput')?.value.toLowerCase() || "";
    const list = document.getElementById('marketList');
    const sector = state.sectorFilter || "";

const filtered = (window.companies || []).filter(c => {
  if (c.group !== state.activeGroup) return false;

  // âœ… sektÃ¶r filtresi sadece bist/sp
  if (pfCanSectorFilter() && sector) {
    if (pfNormSector(c.sector) !== sector) return false;
  }

  return (c.ticker.toLowerCase().includes(term) || c.name.toLowerCase().includes(term));
});

    list.innerHTML = filtered.map(c => {
      const cur = prices[c.ticker] || 0; const prev = prevPrices[c.ticker] || cur;
      let change = 0; if (prev > 0) change = ((cur - prev) / prev) * 100;
      const color = change >= 0 ? 'text-green' : 'text-red';
      const sign = change > 0 ? '+' : '';
      const sym = getSym(c.ticker);
      return `<div class="market-item" onclick="pfOpenTradeModal('${c.ticker}')">
        <img src="${c.logourl}" class="ticker-logo" onerror="this.style.display='none'">
        <div style="flex:1;">
          <span class="ticker-symbol">${c.ticker}</span>
          <span class="ticker-name">${c.name}</span>
        </div>
        <div style="text-align:right;">
          <span class="price-val">${sym}${cur.toFixed(2)}</span>
          <span class="price-change ${color}">${sign}${change.toFixed(2)}%</span>
        </div>
        <button class="fp-menu-btn"
  title="Ä°ÅŸlemler"
  onclick="event.stopPropagation(); fpOpenRowMenu('${c.ticker}', event)">
  <i class="fa-solid fa-ellipsis-vertical"></i>
</button>

      </div>`;
    }).join('');
  };

  function getActiveData() {
    // returns {positions, transactions, portfolioObjForHeader?}
    if (state.activePortfolioId === ALL_KEY) {
      const d = state.allCombined || { positions: [], transactions: [] };
      return { positions: d.positions || [], transactions: d.transactions || [], isAll: true };
    }
    const p = state.activePortfolio || { positions: [], transactions: [] };
    return { positions: p.positions || [], transactions: p.transactions || [], isAll: false, portfolio: p.portfolio };
  }
window.pfHasPosition = function(ticker){
  try{
    const t = String(ticker||"").toUpperCase();
    const data = getActiveData(); // IIFE iÃ§indeki fonksiyon
    const pos = (data.positions || []).find(p => String(p.ticker||"").toUpperCase() === t);
    return !!pos && (Number(pos.quantity) || 0) > 0;
  } catch(e){
    return false;
  }
};

  // --- DASHBOARD ---
  window.pfRenderDashboard = function() {
    if (!state.user) { pfRenderAuth(); return; }
    if (state.portfolios.length === 0) { pfRenderCreate(); return; }

    const data = getActiveData();
    const positions = (data.positions || []).filter(p => (Number(p.quantity) || 0) > 0);
    const transactions = data.transactions || [];
    const cash = state.cashBalance;
    const usdRate = prices['USDTRY'] || 1;

    let stockValTRY = 0, totalCostTRY = 0, dayGainTRY = 0;

    positions.forEach(pos => {
      const curPrice = prices[pos.ticker] || pos.avg_cost;
      const prevPrice = prevPrices[pos.ticker] || curPrice;
      const isU = isUSD(pos.ticker);

      const mVal = curPrice * pos.quantity;
      const costVal = pos.avg_cost * pos.quantity;
      const prevMVal = prevPrice * pos.quantity;

      const mValTRY = isU ? mVal * usdRate : mVal;
      const costValTRY = isU ? costVal * usdRate : costVal;
      const prevMValTRY = isU ? prevMVal * usdRate : prevMVal;

      stockValTRY += mValTRY;
      totalCostTRY += costValTRY;
      dayGainTRY += (mValTRY - prevMValTRY);
    });

    const totalEquity = cash + stockValTRY;
    const totalPnl = stockValTRY - totalCostTRY;
    const totalPnlPerc = totalCostTRY > 0 ? (totalPnl/totalCostTRY)*100 : 0;

    // asset rows (all mode: clicking should open trade modal but sell will require portfolio selection)
    const assetRows = positions.map(pos => {
      const sym = getSym(pos.ticker);
      const isU = isUSD(pos.ticker);
      const cur = prices[pos.ticker] || pos.avg_cost;
      const item = getItem(pos.ticker) || {};
const nm = item.name || "";

      const totalVal = cur * pos.quantity;
      const totalValTRY = isU ? totalVal * usdRate : totalVal;

      const pnl = (cur * pos.quantity) - (pos.avg_cost * pos.quantity);
      const pnlPerc = (pnl / (pos.avg_cost * pos.quantity)) * 100;
      const color = pnl >= 0 ? 'text-green' : 'text-red';

      // in ALL mode, force open with buy (sell requires choosing portfolio)
      const clickSide = (state.activePortfolioId === ALL_KEY) ? 'buy' : 'sell';

      return `
      <tr onclick="pfOpenTradeModal('${pos.ticker}', '${clickSide}')">
        <td>
  <div class="table-ticker">
    <div style="width:6px; height:6px; border-radius:50%; background:${color==='text-green'?'var(--success)':'var(--danger)'}"></div>

    <div class="asset-id">
      <div class="asset-ticker">${pos.ticker}</div>
      <div class="asset-name">${nm || pos.ticker}</div>
    </div>

    <!-- âœ… TarihÃ§e ikonu (row click'i bozmasÄ±n) -->
    <button class="pf-hist-btn" title="TarihÃ§e"
      onclick="event.stopPropagation(); pfOpenHistoryModal('${pos.ticker}')">
      <i class="fa-solid fa-clock-rotate-left"></i>
    </button>
  </div>
</td>
        <td>${pos.quantity}</td>
        <td>${sym}${pos.avg_cost.toFixed(2)}</td>
        <td>${sym}${cur.toFixed(2)}</td>
        <td>${sym}${totalVal.toLocaleString(undefined, {minimumFractionDigits:0, maximumFractionDigits:0})}</td>
        <td>â‚º${totalValTRY.toLocaleString('tr-TR', {minimumFractionDigits:0, maximumFractionDigits:0})}</td>
        <td style="text-align:right;" class="${color}">${pnl>=0?'+':''}${sym}${pnl.toFixed(0)} (%${pnlPerc.toFixed(1)})</td>
      </tr>`;
    }).join('');

    // transactions rows: ALL mode show pf name in date column
    const sortedTrans = transactions.slice().sort((a,b) => new Date(b.executed_at) - new Date(a.executed_at));
    const transRows = sortedTrans.map(tx => {
      const sideStr = (tx.side || "").toString().toLowerCase().trim();
      let isBuy = true;
      if(sideStr === 'sell') isBuy = false;
      else if(tx.quantity < 0) isBuy = false;
      else if(sideStr === 'buy') isBuy = true;

      const color = isBuy ? 'text-green' : 'text-red';
      const type = isBuy ? 'ALIM' : 'SATIM';

      const dateBase = new Date(tx.executed_at).toLocaleString('tr-TR', { day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit' });
      const date = (state.activePortfolioId === ALL_KEY && tx.__pf_name) ? `${dateBase} Â· ${tx.__pf_name}` : dateBase;

      const sym = getSym(tx.ticker);
      const isU = isUSD(tx.ticker);

      const total = Math.abs(tx.quantity * tx.price);
      const totalTRY = isU ? total * usdRate : total;

      return `
      <tr>
        <td><span style="font-weight:700; color:#fff;">${tx.ticker}</span></td>
        <td><span class="${color}" style="font-weight:600; font-size:11px; border:1px solid; padding:2px 6px; border-radius:4px;">${type}</span></td>
        <td>${Math.abs(tx.quantity)}</td>
        <td>${sym}${tx.price.toFixed(2)}</td>
        <td>${sym}${total.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
        <td>â‚º${totalTRY.toLocaleString('tr-TR', {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
        <td>${date}</td>
      </tr>`;
    }).join('');

    const pfOptions =
      `<option value="${ALL_KEY}" ${state.activePortfolioId===ALL_KEY?'selected':''}>TÃœMÃœ</option>` +
      state.portfolios.map(port => `<option value="${port.portfolio_id}" ${port.portfolio_id === state.activePortfolioId ? 'selected' : ''}>${port.name}</option>`).join('');

    const showAssets = state.activeTab === 'assets';
    const headerTitle = (state.activePortfolioId === ALL_KEY) ? "PortfÃ¶y Ã–zeti (TÃ¼mÃ¼)" : "PortfÃ¶y Ã–zeti";

    document.getElementById('mainPanel').innerHTML = `
      <div class="dash-header">
        <div>
          <h2 style="margin:0; font-size:24px;">${headerTitle}</h2>
          <span style="color:#666; font-size:12px;">HoÅŸ geldin, ${state.user.name}</span>
        </div>

        <div style="display:flex; gap:10px; align-items:center;">
          <select class="portfolio-select" onchange="pfSwitchPortfolio(this.value)">${pfOptions}</select>

          <div class="settings-wrap">
  <button class="portfolio-select settings-btn" style="width:auto; background:#222;" onclick="pfToggleSettingsMenu(event)">
    <i class="fa-solid fa-gear"></i>
  </button>
  <div id="settingsMenu" class="settings-menu">
    <div class="settings-item" onclick="pfOpenTransferModal(); pfCloseSettingsMenu();">
      <i class="fa-solid fa-right-left"></i> Virman
    </div>
    <div class="settings-item" onclick="pfRenderCreate(); pfCloseSettingsMenu();">
      <i class="fa-solid fa-plus"></i> Yeni PortfÃ¶y
    </div>
    <div class="settings-item danger" onclick="pfLogout(); pfCloseSettingsMenu();">
      <i class="fa-solid fa-power-off"></i> Ã‡Ä±kÄ±ÅŸ
    </div>
  </div>
</div>

        </div>
      </div>

      <div class="stats-row">
        <div class="stat-card primary">
          <span class="stat-label">Toplam VarlÄ±k (TL)</span>
          <span class="stat-val">â‚º${totalEquity.toLocaleString('tr-TR', {minimumFractionDigits:0, maximumFractionDigits:0})}</span>
        </div>

        <div class="stat-card">
          <span class="stat-label">GÃ¼nlÃ¼k DeÄŸiÅŸim</span>
          <span class="stat-val ${dayGainTRY>=0?'text-green':'text-red'}">${dayGainTRY>=0?'+':''}â‚º${Math.abs(dayGainTRY).toLocaleString('tr-TR', {maximumFractionDigits:0})}</span>
        </div>

        <div class="stat-card">
          <span class="stat-label">Kar/Zarar</span>
          <span class="stat-val ${totalPnl>=0?'text-green':'text-red'}">${totalPnl>=0?'+':''}â‚º${Math.abs(totalPnl).toLocaleString('tr-TR', {maximumFractionDigits:0})}</span>
          <span class="stat-sub ${totalPnl>=0?'text-green':'text-red'}">%${Math.abs(totalPnlPerc).toFixed(2)}</span>
        </div>

        <div class="stat-card">
          <span class="stat-label">Nakit Bakiye</span>
          <span class="stat-val">â‚º${cash.toLocaleString('tr-TR', {maximumFractionDigits:0})}</span>
        </div>
      </div>

      <div class="charts-grid">
        <div class="chart-box">
          <div class="chart-title">VarlÄ±k DaÄŸÄ±lÄ±mÄ±</div>
          <div class="chart-wrapper"><canvas id="chartAllocation"></canvas></div>
        </div>
        <div class="chart-box">
          <div class="chart-title">Kar/Zarar Analizi</div>
          <div class="chart-wrapper"><canvas id="chartPnL"></canvas></div>
        </div>
      </div>

      <div class="tab-header">
        <div class="tab-btn ${showAssets?'active':''}" onclick="pfSetTab('assets')">VarlÄ±klarÄ±m</div>
        <div class="tab-btn ${!showAssets?'active':''}" onclick="pfSetTab('transactions')">GeÃ§miÅŸ Ä°ÅŸlemler</div>
      </div>

      <div class="asset-table-wrap">
        <table class="asset-table" style="display:${showAssets?'table':'none'}">
          <thead>
            <tr>
              <th>HÄ°SSE</th><th>ADET</th><th>MALÄ°YET</th><th>FÄ°YAT</th><th>TOPLAM</th><th>TOPLAM (TL)</th><th style="text-align:right;">K/Z</th>
            </tr>
          </thead>
          <tbody>${assetRows || '<tr><td colspan="7" style="text-align:center; padding:30px; color:#555;">HenÃ¼z varlÄ±ÄŸÄ±nÄ±z bulunmuyor.</td></tr>'}</tbody>
        </table>

        <table class="asset-table" style="display:${!showAssets?'table':'none'}">
          <thead>
            <tr>
              <th>ENSTRÃœMAN</th><th>Ä°ÅžLEM</th><th>ADET</th><th>FÄ°YAT</th><th>TOPLAM</th><th>TOPLAM (TL)</th><th>TARÄ°H</th>
            </tr>
          </thead>
          <tbody>${transRows || '<tr><td colspan="7" style="text-align:center; padding:30px; color:#555;">Ä°ÅŸlem geÃ§miÅŸi boÅŸ.</td></tr>'}</tbody>
        </table>
      </div>
    `;

    setTimeout(() => initCharts(positions, cash, usdRate), 100);
    if (window.pfFinapsisResize) setTimeout(window.pfFinapsisResize, 50);

  };

  // --- CREATE SCREEN ---
  window.pfRenderCreate = function() {
    const isFirst = state.portfolios.length === 0;
    const cancelBtn = isFirst ? '' : `<button class="btn" style="width:100%; background:#222; color:#fff; margin-top:10px;" onclick="pfRenderDashboard()">Ä°ptal</button>`;
    const title = isFirst ? "HoÅŸ Geldiniz!" : "Yeni PortfÃ¶y";
    const msg = isFirst ? "BaÅŸlamak iÃ§in ilk portfÃ¶yÃ¼nÃ¼zÃ¼ oluÅŸturun." : "PortfÃ¶yÃ¼nÃ¼ isimlendir.";
    document.getElementById('mainPanel').innerHTML = `
      <div class="center-card">
        <h2>${title}</h2>
        <p style="color:#888; margin-bottom:30px;">${msg}</p>
        <input type="text" id="pfName" class="form-input" placeholder="Ã–rn: TemettÃ¼ PortfÃ¶yÃ¼">
        <button class="btn btn-primary" style="width:100%;" onclick="pfCreatePfAction()">OluÅŸtur</button>
        ${cancelBtn}
      </div>`;
  };
  window.pfToggleSettingsMenu = function(e){
  if(e) e.stopPropagation();
  const m = document.getElementById('settingsMenu');
  if(!m) return;
  m.classList.toggle('show');
};

window.pfCloseSettingsMenu = function(){
  const m = document.getElementById('settingsMenu');
  if(m) m.classList.remove('show');
};

// sayfada herhangi yere tÄ±klayÄ±nca kapat
document.addEventListener('click', function(){
  window.pfCloseSettingsMenu();
});


  // --- AUTH RENDER & ACTIONS ---
  window.pfToggleAuthMode = function() { state.isLogin = !state.isLogin; pfRenderAuth(); };
  window.pfRenderAuth = function() {
    document.getElementById('mainPanel').innerHTML = `
      <div class="center-card">
        <h2>Finapsis Pro</h2>
        <p style="color:var(--text-muted); font-size:14px; margin-bottom:40px;">Profesyonel portfÃ¶y yÃ¶netimi.</p>
        ${!state.isLogin ? `<input type="text" id="nameInput" class="form-input" placeholder="Ad Soyad">` : ''}
        <input type="email" id="emailInput" class="form-input" placeholder="E-posta adresi">
        <input type="password" id="passInput" class="form-input" placeholder="Åžifre">
        <button class="btn btn-primary" style="width:100%;" onclick="pfAuthAction()">${state.isLogin ? 'GiriÅŸ Yap' : 'Hesap OluÅŸtur'}</button>
        <button class="btn btn-google" onclick="pfGoogleLogin()">
          <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18"> Google ile Devam Et
        </button>
        <div style="margin-top:25px; font-size:13px; color:#666; cursor:pointer;" onclick="pfToggleAuthMode()">
          ${state.isLogin ? 'HesabÄ±n yok mu? KayÄ±t Ol' : 'GiriÅŸ Yap'}
        </div>
      </div>`;
  };

  window.pfSetTab = function(t) { state.activeTab = t; pfRenderDashboard(); };

  // --- PORTFOLIO SWITCH (including ALL) ---
  window.pfSwitchPortfolio = async function(id) {
    if (id === ALL_KEY) {
      document.getElementById('mainPanel').innerHTML = `<div class="loader-wrap"><div class="spinner"></div><p>PortfÃ¶yler BirleÅŸtiriliyor...</p></div>`;
      await loadAllPortfolios();
    } else {
      document.getElementById('mainPanel').innerHTML = `<div class="loader-wrap"><div class="spinner"></div><p>PortfÃ¶y YÃ¼kleniyor...</p></div>`;
      await loadPortfolioDetail(id);
    }
  };

  // --- TRADE FLOW ---
  window.pfUserClickSide = function(s) {
    const t = state.trade.ticker;

    // determine available qty from selected portfolio
    const pfId = state.trade.portfolioId;
    let pos = null;
    if (state.activePortfolioId === ALL_KEY) {
      const d = state.portfolioCache[pfId];
      pos = d?.positions?.find(p => p.ticker === t);
    } else {
      pos = state.activePortfolio?.positions?.find(p => p.ticker === t);
    }

    if (s === 'sell' && (!pos || pos.quantity <= 0)) return;
    pfSetSide(s);
  };

  window.pfSetTradePortfolio = function(pfId) {
    state.trade.portfolioId = pfId;
    pfUpdateModalLimit();
    // if sell tab is currently selected but user has 0, force buy
    const t = state.trade.ticker;
    const d = state.portfolioCache[pfId];
    const pos = d?.positions?.find(p => p.ticker === t);
    if (state.trade.side === 'sell' && (!pos || pos.quantity <= 0)) {
      pfSetSide('buy');
    } else {
      // update sell tab availability visuals
      const tSell = document.getElementById('tabSell');
      if (tSell) {
        if (!pos || pos.quantity <= 0) { tSell.style.opacity = '0.3'; tSell.style.cursor = 'not-allowed'; }
        else { tSell.style.opacity = '1'; tSell.style.cursor = 'pointer'; }
      }
    }
  };

  window.pfSetInputMode = function(mode) {
    state.trade.inputMode = mode;

    const mq = document.getElementById('modeQty');
    const ma = document.getElementById('modeAmt');

    if (mq && ma) {
      if (mode === 'qty') {
        mq.style.background = 'rgba(194,245,14,0.15)'; mq.style.color = '#fff';
        ma.style.background = 'transparent'; ma.style.color = '#666';
      } else {
        ma.style.background = 'rgba(194,245,14,0.15)'; ma.style.color = '#fff';
        mq.style.background = 'transparent'; mq.style.color = '#666';
      }
    }

    const input = document.getElementById('tradeQty');
    if (input) input.value = '';
    document.getElementById('tradeTotal').innerText = '0.00';
    document.getElementById('tradeTotalTry').innerText = '';
    const hint = document.getElementById('tradeHint');
    if (hint) hint.innerText = '';

    const btn = document.getElementById('btnConfirmTrade');
    if (btn) btn.disabled = true;

    setTradePlaceholder();
    pfUpdateModalLimit();
  };

  window.pfOpenTradeModal = async function(t, s='buy') {
    if(!state.user) { pfRenderAuth(); return; }

    state.trade.ticker = t;

    const item = getItem(t);
    const sym = getSym(t);

    document.getElementById('tradeModal').style.display = 'flex';
    document.getElementById('modalTicker').innerText = t;
    document.getElementById('modalPrice').innerText = `${sym}${(prices[t]||0).toFixed(2)}`;
    document.getElementById('modalImg').src = item ? item.logourl : '';

    const pfSelect = document.getElementById('modalPortfolioSelect');

    if (state.activePortfolioId === ALL_KEY) {
      // show portfolio selector
      pfSelect.style.display = 'block';
      pfSelect.innerHTML = state.portfolios.map(p => `<option value="${p.portfolio_id}">${p.name}</option>`).join('');

      // default to first portfolio
      const defaultPfId = state.portfolios[0]?.portfolio_id;
      state.trade.portfolioId = defaultPfId;
      pfSelect.value = defaultPfId;

      // ensure cached detail
      await getPortfolioDetailCached(defaultPfId);

      // set sell availability based on selected pf
      const d = state.portfolioCache[defaultPfId];
      const pos = d?.positions?.find(p => p.ticker === t);
      const qtyOwned = pos ? pos.quantity : 0;
      const tSell = document.getElementById('tabSell');
      if(qtyOwned <= 0) {
        tSell.style.opacity = '0.3'; tSell.style.cursor = 'not-allowed';
        if(s==='sell') s='buy';
      } else {
        tSell.style.opacity = '1'; tSell.style.cursor = 'pointer';
      }
    } else {
      // single portfolio mode
      pfSelect.style.display = 'none';
      state.trade.portfolioId = state.activePortfolio?.portfolio?.portfolio_id;

      const pos = state.activePortfolio?.positions?.find(p => p.ticker === t);
      const qtyOwned = pos ? pos.quantity : 0;
      const tSell = document.getElementById('tabSell');
      if(qtyOwned <= 0) {
        tSell.style.opacity = '0.3'; tSell.style.cursor = 'not-allowed';
        if(s==='sell') s='buy';
      } else {
        tSell.style.opacity = '1'; tSell.style.cursor = 'pointer';
      }
    }

    const defMode = getDefaultInputMode(t);
    pfSetInputMode(defMode);
    pfSetSide(s);
    if (window.pfFinapsisResize) setTimeout(window.pfFinapsisResize, 50);

  };

  window.pfSetSide = function(s) {
    state.trade.side = s;
    const tb = document.getElementById('tabBuy'),
          ts = document.getElementById('tabSell'),
          btn = document.getElementById('btnConfirmTrade');

    if(s === 'buy') {
      tb.style.background = 'var(--success)'; tb.style.color = '#000';
      ts.style.background = 'transparent'; ts.style.color = '#666';
      btn.style.background = 'var(--primary)'; btn.innerText = 'ALIÅž EMRÄ° GÃ–NDER';
    } else {
      tb.style.background = 'transparent'; tb.style.color = '#666';
      ts.style.background = 'var(--danger)'; ts.style.color = '#fff';
      btn.style.background = 'var(--danger)'; btn.innerText = 'SATIÅž EMRÄ° GÃ–NDER';
    }

    document.getElementById('tradeQty').value = '';
    document.getElementById('tradeTotal').innerText = '0.00';
    document.getElementById('tradeTotalTry').innerText = '';
    const hint = document.getElementById('tradeHint');
    if (hint) hint.innerText = '';
    btn.disabled = true;

    pfUpdateModalLimit();
    setTradePlaceholder();
  };

  window.pfUpdateModalLimit = function() {
    const t = state.trade.ticker;
    const pfId = state.trade.portfolioId;

    if(state.trade.side === 'buy') {
      document.getElementById('modalLimit').innerText = `Nakit: â‚º${state.cashBalance.toLocaleString('tr-TR')}`;
    } else {
      let pos = null;
      if (state.activePortfolioId === ALL_KEY) {
        const d = state.portfolioCache[pfId];
        pos = d?.positions?.find(p => p.ticker === t);
      } else {
        pos = state.activePortfolio?.positions?.find(p => p.ticker === t);
      }
      document.getElementById('modalLimit').innerText = `Eldeki: ${pos?pos.quantity:0}`;
    }
  };

  window.pfCalcTotal = function() {
    const raw = parseFloat(document.getElementById('tradeQty').value);
    const t = state.trade.ticker;
    const price = prices[t] || 0;
    const sym = getSym(t);
    const isU = isUSD(t);
    const usdRate = prices['USDTRY'] || 1;

    const el = document.getElementById('tradeTotal');
    const elTry = document.getElementById('tradeTotalTry');
    const hint = document.getElementById('tradeHint');
    const btn = document.getElementById('btnConfirmTrade');

    if (!raw || raw <= 0 || price <= 0) {
      el.innerText = '0.00';
      elTry.innerText = '';
      if (hint) hint.innerText = '';
      btn.disabled = true;
      el.style.color = '#888';
      return;
    }

    let qty = 0;
    let totalAssetCur = 0;

    if (state.trade.inputMode === 'amount') {
      totalAssetCur = raw;
      qty = totalAssetCur / price;
    } else {
      qty = raw;
      totalAssetCur = qty * price;
    }

    const totalTRY = isU ? totalAssetCur * usdRate : totalAssetCur;

    el.innerText = `${sym}${totalAssetCur.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    if (isU && totalAssetCur > 0) elTry.innerText = `â‰ˆ â‚º${totalTRY.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    else elTry.innerText = '';

    if (hint) {
      if (state.trade.inputMode === 'amount') {
        const unit = getQtyUnitLabel(t);
        hint.innerText = `â‰ˆ ${qty.toLocaleString('tr-TR', { maximumFractionDigits: 6 })} ${unit}`.trim();
      } else {
        hint.innerText = '';
      }
    }

    let ok = false;

    if (state.trade.side === 'buy') {
      if (totalTRY > state.cashBalance) {
        el.style.color = 'var(--danger)';
        ok = false;
      } else {
        el.style.color = '#fff';
        ok = true;
      }
    } else {
      const pfId = state.trade.portfolioId;
      let pos = null;

      if (state.activePortfolioId === ALL_KEY) {
        const d = state.portfolioCache[pfId];
        pos = d?.positions?.find(p => p.ticker === t);
      } else {
        pos = state.activePortfolio?.positions?.find(p => p.ticker === t);
      }

      const maxQty = pos ? pos.quantity : 0;
      if (qty > maxQty) {
        el.style.color = 'var(--danger)';
        ok = false;
      } else {
        el.style.color = '#fff';
        ok = true;
      }
    }

    btn.disabled = !ok;
  };

  window.pfSubmitTrade = async function() {
    const raw = parseFloat(document.getElementById('tradeQty').value);
    const btn = document.getElementById('btnConfirmTrade');
    const side = state.trade.side;
    const ticker = state.trade.ticker;
    const portfolioId = state.trade.portfolioId;

    const price = prices[ticker] || 0;
    if (!raw || raw <= 0 || price <= 0) { alert("GeÃ§ersiz giriÅŸ."); return; }

    const qty = (state.trade.inputMode === 'amount') ? (raw / price) : raw;

    const isU = isUSD(ticker);
    const usdRate = prices['USDTRY'] || 1;
    const currency = isU ? "USD" : "TRY";
    const rate = isU ? usdRate : 1;
    const tryPrice = price * rate;

    btn.innerText = "Ä°ÅžLENÄ°YOR...";
    btn.disabled = true;

    const payload = {
      portfolio: portfolioId,
      ticker: ticker,
      price: price,
      quantity: qty,
      side: side,
      m: side === 'buy' ? 1 : -1,
      currency: currency,
      rate: rate,
      TRY_price: tryPrice
    };

    const res = await api('transaction-single', payload);

    if(res.status === "success") {
      if(res.response.cash_balance !== undefined) state.cashBalance = res.response.cash_balance;

      // refresh cache for affected portfolio
      state.portfolioCache[portfolioId] = null;
      delete state.portfolioCache[portfolioId];
      await getPortfolioDetailCached(portfolioId);

      // refresh view
      if (state.activePortfolioId === ALL_KEY) await loadAllPortfolios();
      else await loadPortfolioDetail(portfolioId);

      pfCloseTradeModal();
    } else {
      alert(res.message || "Ä°ÅŸlem hatasÄ±.");
      btn.innerText = side === 'buy' ? 'ALIÅž EMRÄ° GÃ–NDER' : 'SATIÅž EMRÄ° GÃ–NDER';
      btn.disabled = false;
    }
  };

  window.pfCloseTradeModal = function() { document.getElementById('tradeModal').style.display = 'none'; if (window.pfFinapsisResize) setTimeout(window.pfFinapsisResize, 50);
};
// =====================
// PORTFOLIO HISTORY CHART
// =====================
let __pfHistChart = null;
const __pfHistCache = Object.create(null);

function pfIsBuyTx(tx){
  const side = String(tx?.side || "").toLowerCase().trim();
  if (side === "buy") return true;
  if (side === "sell") return false;
  return (Number(tx?.quantity) || 0) > 0;
}

function pfParseDateAny(s){
  if (!s) return null;
  // varsa mevcut helper'Ä±nÄ± kullan
  try { if (typeof parseMMDDYYYY === "function") { const d = parseMMDDYYYY(s); if (d) return d; } } catch(e){}
  const d2 = new Date(s);
  if (!isNaN(d2)) return d2;
  return null;
}

function pfSafeNum(v){
  const n = Number(v);
  return Number.isFinite(n) ? n : null;
}

function pfFirstBuyDateForTicker(ticker){
  try{
    const t = String(ticker||"").toUpperCase();
    const data = getActiveData();
    const txs = Array.isArray(data?.transactions) ? data.transactions : [];
    const buys = txs.filter(tx => String(tx?.ticker||"").toUpperCase() === t && pfIsBuyTx(tx));
    if (!buys.length) return null;
    let min = null;
    for (const tx of buys){
      const d = pfParseDateAny(tx.executed_at);
      if (!d) continue;
      if (!min || d < min) min = d;
    }
    return min; // Date
  } catch(e){
    return null;
  }
}

async function pfGetPriceHistory(ticker){
  const t = String(ticker||"").toUpperCase();
  if (__pfHistCache[t]) return __pfHistCache[t];

  // âœ… En pratik: mevcut comdetail endpoint'inden price_history al
  const fn = window.fetchComDetail;
if (typeof fn !== "function") throw new Error("fetchComDetail not available");
const d = await fn(t);

  const ph = Array.isArray(d?.price_history) ? d.price_history : [];
  __pfHistCache[t] = ph;
  return ph;
}

window.pfCloseHistoryModal = function(){
  const m = document.getElementById("pfHistModal");
  if (m) m.style.display = "none";
  const l = document.getElementById("pfHistLoading");
  if (l) l.innerText = "";
  if (__pfHistChart) { try { __pfHistChart.destroy(); } catch(e){} __pfHistChart = null; }
};

window.pfOpenHistoryModal = async function(ticker){
  const t = String(ticker||"").toUpperCase().trim();
  if (!t) return;

  const m = document.getElementById("pfHistModal");
  const titleEl = document.getElementById("pfHistTitle");
  const subEl = document.getElementById("pfHistSub");
  const loadingEl = document.getElementById("pfHistLoading");
  const canvas = document.getElementById("pfHistCanvas");

  if (!m || !titleEl || !subEl || !loadingEl || !canvas) return;

  m.style.display = "flex";
  titleEl.innerText = `${t} â€¢ TarihÃ§e`;
  loadingEl.innerText = "YÃ¼kleniyor...";
  subEl.innerText = "";

  // ilk alÄ±m tarihi
  const buyDate = pfFirstBuyDateForTicker(t);
  const buyText = buyDate ? buyDate.toLocaleDateString("tr-TR") : "bilinmiyor";

  try{
    const hist = await pfGetPriceHistory(t);

    // normalize: {date, price}
    const pts = (hist || [])
      .map(p => {
        const d = pfParseDateAny(p?.date);
        const price = pfSafeNum(p?.price);
        return { d, price };
      })
      .filter(x => x.d && x.price !== null)
      .sort((a,b) => a.d - b.d);

    // satÄ±n alma tarihinden itibaren filtrele
    const filtered = buyDate ? pts.filter(x => x.d >= buyDate) : pts;
    subEl.innerText = `Ä°lk alÄ±m: ${buyText} â€¢ Nokta: ${filtered.length}`;

    if (!filtered.length){
      loadingEl.innerText = "Bu varlÄ±k iÃ§in yeterli fiyat verisi bulunamadÄ±.";
      return;
    }

    // chart hazÄ±rlÄ±k
    const labels = filtered.map(x => x.d.toLocaleDateString("tr-TR", { day:"2-digit", month:"2-digit", year:"2-digit" }));
    const data = filtered.map(x => x.price);

    if (__pfHistChart) { try { __pfHistChart.destroy(); } catch(e){} __pfHistChart = null; }

    loadingEl.innerText = "";

    __pfHistChart = new Chart(canvas.getContext("2d"), {
      type: "line",
      data: {
        labels,
        datasets: [{
          label: t,
          data,
          borderWidth: 2,
          pointRadius: 0,
          tension: 0.25,
          borderColor: "#c2f50e"
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { maxTicksLimit: 8 }, grid: { display: false } },
          y: { ticks: { maxTicksLimit: 6 }, grid: { color: "rgba(255,255,255,0.06)" } }
        }
      }
    });

  } catch(err){
    loadingEl.innerText = "TarihÃ§e yÃ¼klenemedi.";
    subEl.innerText = `Ä°lk alÄ±m: ${buyText}`;
    console.error(err);
  }
};


  // --- VIRMAN (TRANSFER) ---
  window.pfOpenTransferModal = async function() {
    if (!state.user) { pfRenderAuth(); return; }
    if (!state.portfolios || state.portfolios.length < 2) { alert("Virman iÃ§in en az 2 portfÃ¶y gerekir."); return; }

    document.getElementById('transferModal').style.display = 'flex';

    const fromSel = document.getElementById('trFrom');
    const toSel = document.getElementById('trTo');

    const options = state.portfolios.map(p => `<option value="${p.portfolio_id}">${p.name}</option>`).join('');
    fromSel.innerHTML = options;
    toSel.innerHTML = options;

    // default from: active if single else first
    const defFrom = (state.activePortfolioId && state.activePortfolioId !== ALL_KEY) ? state.activePortfolioId : state.portfolios[0].portfolio_id;
    fromSel.value = defFrom;

    // default to: first different
    const defTo = state.portfolios.find(p => p.portfolio_id !== defFrom)?.portfolio_id || state.portfolios[0].portfolio_id;
    toSel.value = defTo;

    document.getElementById('trQty').value = '';
    document.getElementById('btnConfirmTransfer').disabled = true;

    await pfOnTransferFromChange(defFrom);
  };

  window.pfCloseTransferModal = function() {
    document.getElementById('transferModal').style.display = 'none';
  };

  // Portfolio cash helper (portfÃ¶y bazlÄ± varsa onu, yoksa user cash)
const getPortfolioCash = (pfId) => {
  const d = state.portfolioCache?.[pfId];
  return (typeof d?.cash_balance === "number") ? d.cash_balance : (state.cashBalance || 0);
};

const getDetailUrl = (ticker) => {
  const item = getItem(ticker) || (window.companies || []).find(c => c.ticker === ticker);
  if(!item) return null;

  const slug = (item.slug || ticker || "").toString().toLowerCase();
  const isCompany = (item.group === "bist" || item.group === "sp");
  const root = isCompany ? "https://finapsis.co/comdetail/" : "https://finapsis.co/itemdetail/";
  return root + encodeURIComponent(slug);
};


window.pfOnTransferFromChange = async function(fromId) {
  await getPortfolioDetailCached(fromId);

  const detail = state.portfolioCache[fromId] || {};
  const positions = (detail.positions || []).filter(p => (Number(p.quantity) || 0) > 0);

  const tickerSel = document.getElementById('trTicker');

  // Nakit opsiyonu (â‚º) en Ã¼ste
  const cashOption = `<option value="__CASH__">Nakit (â‚º)</option>`;
  const posOptions = positions.length
    ? positions.map(p => `<option value="${p.ticker}">${p.ticker}</option>`).join('')
    : '';

  tickerSel.innerHTML = cashOption + posOptions;

  const qtyInput = document.getElementById('trQty');
  qtyInput.value = '';
  qtyInput.placeholder = "Tutar (â‚º) giriniz..."; // default nakit seÃ§ili

  pfUpdateTransferLimit();
  pfValidateTransfer();
};


  window.pfUpdateTransferLimit = function() {
  const fromId = document.getElementById('trFrom').value;
  const t = document.getElementById('trTicker').value;
  const qtyInput = document.getElementById('trQty');

  if (t === "__CASH__") {
    const maxCash = getPortfolioCash(fromId);
    document.getElementById('trLimit').innerText = `Eldeki: â‚º${maxCash.toLocaleString('tr-TR')}`;
    qtyInput.placeholder = "Tutar (â‚º) giriniz...";
    return;
  }

  const d = state.portfolioCache[fromId];
  const pos = d?.positions?.find(p => p.ticker === t);
  const maxQty = pos ? pos.quantity : 0;

  document.getElementById('trLimit').innerText = `Eldeki: ${maxQty}`;
  qtyInput.placeholder = "Miktar giriniz...";
};


  window.pfValidateTransfer = function() {
  const btn = document.getElementById('btnConfirmTransfer');

  const fromId = document.getElementById('trFrom').value;
  const toId = document.getElementById('trTo').value;
  const t = document.getElementById('trTicker').value;
  const qty = parseFloat(document.getElementById('trQty').value);

  if (!fromId || !toId || !t || !qty || qty <= 0) { btn.disabled = true; return; }
  if (fromId === toId) { btn.disabled = true; return; }

  if (t === "__CASH__") {
    const maxCash = getPortfolioCash(fromId);
    btn.disabled = !(qty <= maxCash);
    return;
  }

  const d = state.portfolioCache[fromId];
  const pos = d?.positions?.find(p => p.ticker === t);
  const maxQty = pos ? pos.quantity : 0;

  btn.disabled = !(qty <= maxQty);
};


  window.pfSubmitTransfer = async function() {
  const btn = document.getElementById('btnConfirmTransfer');
  const fromId = document.getElementById('trFrom').value;
  const toId = document.getElementById('trTo').value;
  const t = document.getElementById('trTicker').value;
  const qty = parseFloat(document.getElementById('trQty').value);

  if (!fromId || !toId || !t || !qty || qty <= 0 || fromId === toId) return;

  btn.disabled = true;
  btn.innerText = "Ä°ÅžLENÄ°YOR...";

  // Nakit transferi
  if (t === "__CASH__") {
    const ticker = "CASH";
    const price = 1;
    const currency = "TRY";
    const rate = 1;
    const tryPrice = 1;

    const sellRes = await api('transaction-single', {
      portfolio: fromId,
      ticker,
      price,
      quantity: qty,
      side: "sell",
      m: -1,
      currency,
      rate,
      TRY_price: tryPrice
    });

    if (sellRes.status !== "success") {
      alert(sellRes.message || "Virman (1/2) - Nakit Ã§Ä±kÄ±ÅŸÄ± hatasÄ±.");
      btn.innerText = "VÄ°RMAN YAP";
      btn.disabled = false;
      return;
    }

    const buyRes = await api('transaction-single', {
      portfolio: toId,
      ticker,
      price,
      quantity: qty,
      side: "buy",
      m: 1,
      currency,
      rate,
      TRY_price: tryPrice
    });

    if (buyRes.status !== "success") {
      alert(buyRes.message || "Virman (2/2) - Nakit giriÅŸi hatasÄ±. (Ã‡Ä±kÄ±ÅŸ gerÃ§ekleÅŸti)");
      btn.innerText = "VÄ°RMAN YAP";
      btn.disabled = false;
      return;
    }

    // cache refresh
    delete state.portfolioCache[fromId];
    delete state.portfolioCache[toId];
    await getPortfolioDetailCached(fromId);
    await getPortfolioDetailCached(toId);

    if (state.activePortfolioId === ALL_KEY) await loadAllPortfolios();
    else await loadPortfolioDetail(state.activePortfolioId);

    pfCloseTransferModal();
    return;
  }

  // VarlÄ±k transferi (mevcut davranÄ±ÅŸ)
  const price = prices[t] || 0;
  if (price <= 0) {
    alert("Fiyat bulunamadÄ±.");
    btn.innerText = "VÄ°RMAN YAP";
    btn.disabled = false;
    return;
  }

  const isU = isUSD(t);
  const usdRate = prices['USDTRY'] || 1;
  const currency = isU ? "USD" : "TRY";
  const rate = isU ? usdRate : 1;
  const tryPrice = price * rate;

  const sellRes = await api('transaction-single', {
    portfolio: fromId, ticker: t, price, quantity: qty, side: "sell", m: -1,
    currency, rate, TRY_price: tryPrice
  });

  if (sellRes.status !== "success") {
    alert(sellRes.message || "Virman (1/2) - Kaynak satÄ±m hatasÄ±.");
    btn.innerText = "VÄ°RMAN YAP";
    btn.disabled = false;
    return;
  }

  const buyRes = await api('transaction-single', {
    portfolio: toId, ticker: t, price, quantity: qty, side: "buy", m: 1,
    currency, rate, TRY_price: tryPrice
  });

  if (buyRes.status !== "success") {
    alert(buyRes.message || "Virman (2/2) - Hedef alÄ±m hatasÄ±. (Kaynak satÄ±mÄ± gerÃ§ekleÅŸti)");
    btn.innerText = "VÄ°RMAN YAP";
    btn.disabled = false;
    return;
  }

  delete state.portfolioCache[fromId];
  delete state.portfolioCache[toId];
  await getPortfolioDetailCached(fromId);
  await getPortfolioDetailCached(toId);

  if (state.activePortfolioId === ALL_KEY) await loadAllPortfolios();
  else await loadPortfolioDetail(state.activePortfolioId);

  pfCloseTransferModal();
};


  // --- AUTH / PF CREATE ---
  window.pfAuthAction = async function() {
    const email = document.getElementById('emailInput').value,
          pass = document.getElementById('passInput').value,
          name = document.getElementById('nameInput')?.value;
    if(!email || !pass) return;
    const res = await api(state.isLogin ? 'login' : 'create-user', { email, password: pass, name });
    if(res.status === "success" || res.status === "ok") {
      const d = { user: { id: res.user.id||res.user_id, name: name||"User" }, token: res.token };
      localStorage.setItem('finapsis_real_user', JSON.stringify(d));
      state.user = d.user; state.token = d.token;
      refreshData();
    } else alert("Hata");
  };

  window.pfCreatePfAction = async function() {
    const name = document.getElementById('pfName').value;
    if(!name) return;
    const res = await api('portfolio', { user: state.user.id, name, note: "Web" });
    if(res.status === "success") {
      // clear all cache, refresh list
      state.portfolioCache = {};
      state.allCombined = null;
      await refreshData();
    }
  };

  window.pfLogout = function() {
    localStorage.removeItem('finapsis_real_user');
    state.user = null;
    state.token = null;
    state.portfolios = [];
    state.activePortfolio = null;
    state.activePortfolioId = null;
    state.cashBalance = 0;
    state.portfolioCache = {};
    state.allCombined = null;
    pfRenderAuth();
  };

  window.pfGoogleLogin = function() {
    try { localStorage.setItem('finapsis_active_main_tab', 'portfolio.html'); } catch(e) {}
    if(!GOOGLE_CLIENT_ID){
      alert('Google ile giriÅŸ iÃ§in GOOGLE_CLIENT_ID eksik. window.FINAPSIS_CONFIG.GOOGLE_CLIENT_ID set edilmeli.');
      return;
    }
    const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?redirect_uri=${encodeURIComponent(REDIRECT_URI)}&client_id=${encodeURIComponent(GOOGLE_CLIENT_ID)}&access_type=offline&response_type=code&prompt=consent&scope=${encodeURIComponent('email profile')}`;
    window.top.location.href = authUrl;
  };

  // --- CHARTS ---
  function initCharts(pos, cash, usdRate) {
    if(charts.alloc) charts.alloc.destroy();
    if(charts.pnl) charts.pnl.destroy();

    Chart.defaults.color = '#666';
    Chart.defaults.borderColor = '#222';
    Chart.defaults.font.family = "'Inter', sans-serif";

    const ctxAlloc = document.getElementById('chartAllocation');
    if(ctxAlloc && (pos.length > 0 || cash > 0)) {
      const lbl = pos.map(p=>p.ticker);
      const dt = pos.map(p=>{
        const cur = prices[p.ticker]||0;
        const val = cur*p.quantity;
        return isUSD(p.ticker)?val*usdRate:val;
      });
      lbl.push('Nakit'); dt.push(cash);

      charts.alloc = new Chart(ctxAlloc, {
        type: 'doughnut',
        data: { labels: lbl, datasets: [{ data: dt, backgroundColor: ['#c2f50e', '#00e676', '#2979ff', '#ff1744', '#aa00ff', '#333'], borderWidth: 0 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10, color:'#888' } } } }
      });
    }

    const ctxPnl = document.getElementById('chartPnL');
    if(ctxPnl && pos.length > 0) {
      const plbl = pos.map(p=>p.ticker);
      const pdt = pos.map(p=>{
        const cur=prices[p.ticker]||0;
        const diff=(cur*p.quantity)-(p.avg_cost*p.quantity);
        return isUSD(p.ticker)?diff*usdRate:diff;
      });

      charts.pnl = new Chart(ctxPnl, {
        type: 'bar',
        data: { labels: plbl, datasets: [{ label: 'K/Z (TL)', data: pdt, backgroundColor: pdt.map(v=>v>=0?'#00e676':'#ff1744'), borderRadius: 4 }] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: { y: { beginAtZero: true, grid: { color:'#222' } }, x: { grid: { display:false } } },
          plugins: { legend: { display: false } }
        }
      });
    }
  }
// --- IFRAME AUTO-RESIZE (CHILD SENDER) ---
(function () {
  function readHeight() {
    return Math.max(
      document.documentElement.scrollHeight || 0,
      document.body ? document.body.scrollHeight : 0,
      document.documentElement.offsetHeight || 0,
      document.body ? document.body.offsetHeight : 0
    );
  }

  function postHeight() {
    const h = readHeight();
    try {
      (window.parent || window.top).postMessage({ type: "resize-iframe", height: h }, "*");
    } catch (e) {}
  }

  // ilk aÃ§Ä±lÄ±ÅŸ / chart render
  window.addEventListener("load", () => {
    postHeight();
    setTimeout(postHeight, 150);
    setTimeout(postHeight, 600);
  });

  // âœ… DonmayÄ± bitiren resize: MutationObserver + setInterval yok
let __pfResizeRaf = 0;

function pfScheduleResize(){
  if (__pfResizeRaf) return;
  __pfResizeRaf = requestAnimationFrame(() => {
    __pfResizeRaf = 0;
    try { postHeight(); } catch(e) {}
  });
}

window.addEventListener("resize", pfScheduleResize, { passive: true });

// DÄ±ÅŸarÄ±dan Ã§aÄŸÄ±rmak iÃ§in (tab switch / tablo render sonrasÄ± Ã§aÄŸÄ±racaÄŸÄ±z)
window.pfFinapsisResize = pfScheduleResize;

// ilk aÃ§Ä±lÄ±ÅŸta 2 kez Ã¶lÃ§
window.addEventListener("load", () => {
  pfScheduleResize();
  setTimeout(pfScheduleResize, 250);
}, { once:true });

})();

  init();
})();

// ============================================
    // GLOBAL BAÅžLATICI
    // ============================================
    // Not: Fonksiyonu async yaptÄ±k
    // ============================================
// GLOBAL BAÅžLATICI (VERÄ° MOTORU)
// ============================================
document.addEventListener("DOMContentLoaded", async function() {

  // 1. TEMEL LÄ°STELERÄ° Ã‡EK (Åžirketler Listesi + Fiyatlar)
  await loadFinapsisData();

  // 2. METRÄ°K VERÄ°LERÄ°NÄ° BAÅžLAT (ARKA PLANDA)
  // KullanÄ±cÄ± sekmeye gitmese bile veriler inmeye baÅŸlasÄ±n.
  if (typeof finBuildMapForActiveGroup === "function") {
      console.log("ðŸš€ [System] Veri motoru baÅŸlatÄ±lÄ±yor...");
      finBuildMapForActiveGroup(() => {
          console.log("âœ… [System] TÃ¼m veriler hazÄ±r.");
          // EÄŸer ÅŸu an aÃ§Ä±k olan bir sekme veri bekliyorsa onu tetikle
          const activeTab = localStorage.getItem('finapsis_active_main_tab');
          if (activeTab === 'karsilastirma.html' && window.cmpRender) window.cmpRender();
          if (activeTab === 'screener.html' && typeof renderScreenerResults === "function") renderScreenerResults();
      });
  }

  // YÃ¼kleme ekranÄ±nÄ± gizle
  const hidePL = () => {
    const pl = document.getElementById("preloader");
    if (pl) pl.style.display = "none";
  };

  // --- TAB RESTORE & INIT ---
  try {
    const params = new URLSearchParams(window.location.search);
    const hasCode = params.get('code');
    const forced = (params.get('tab') || '').toLowerCase().trim();
    const saved = (localStorage.getItem('finapsis_active_main_tab') || '').trim();

    let target = 'screener.html';
    if (forced in {'portfolio':1,'portfolio.html':1,'pf':1}) target = 'portfolio.html';
    else if (forced in {'companies':1,'companieslist':1,'companieslist.html':1,'list':1}) target = 'companieslist.html';
    else if (forced in {'sectors':1,'sector':1}) target = 'sectors';
    else if (forced in {'diagrams':1,'diyagramlar':1,'diyagram':1}) target = 'diagrams';
    else if (forced in {'detail':1,'detail.html':1,'comdetail':1}) target = 'detail';
    else if (forced in {'karsilastirma':1,'karsilastirma.html':1,'compare':1}) target = 'karsilastirma.html';
    else if (hasCode) target = 'portfolio.html';
    else if (saved) target = saved;

    setTimeout(() => {
        switchTab(target);
        requestAnimationFrame(hidePL);
    }, 10);

  } catch(e) {
    requestAnimationFrame(hidePL);
  }
}, { once: true });

// ============================================
// âœ… DIYAGRAMLAR MODÃœLÃœ (STATE & DATA SYNC FIX)
// ============================================

(function(){
  let dgInited = false;
  let chartObj = null;

  // Analiz TÃ¼rleri
  const ANALYSIS_OPTS = [
    { id: 'pe_margin', label: 'F/K vs Net KÃ¢r MarjÄ±' },
    { id: 'ccc', label: 'Nakit DÃ¶ngÃ¼sÃ¼ (GÃ¼n)' },
    { id: 'assets_roa', label: 'Toplam VarlÄ±klar vs ROA' },
    { id: 'roic_wacc', label: 'ROIC vs AOSM' },
    { id: 'np_fcf', label: 'Net Kar vs Serbest Nakit AkÄ±ÅŸÄ±' },
    { id: 'growth', label: 'Gelir vs Kar BÃ¼yÃ¼mesi' },
    { id: 'de_roe', label: 'BorÃ§/Ã–z Kaynak vs ROE' },
    { id: 'roa_profit', label: 'Kar MarjÄ± vs VarlÄ±k Devir HÄ±zÄ±' },
    { id: 'capex', label: 'VarlÄ±k AlÄ±mlarÄ± vs Gelir BÃ¼yÃ¼mesi' }
  ];

  // âœ… STATE BAÅžLANGIÃ‡ AYARI
  window.dgState = { 
      analysis: 'pe_margin', // VarsayÄ±lan analiz kesin olarak atandÄ±
      sector: 'all',
      industry: 'all' 
  };

  const colors = {
    green: 'rgba(194, 245, 14, 0.12)',
    red: 'rgba(255, 60, 60, 0.08)',
    neutral: 'rgba(255, 255, 255, 0.02)'
  };

  function updateHeight(){
    try{ if (window.pfFinapsisResize) window.pfFinapsisResize(); }catch(e){}
  }

  function dgCompanies(){
    const list = Array.isArray(window.companies) ? window.companies : [];
    return list.filter(c => (c.group || 'bist') === activeGroup);
  }

  // --- BADGE RENDER ---
  window.dgUpdateBadges = function() {
      const area = document.getElementById("dgBadgeArea");
      if(!area) return;

      let groupLabel = "BIST";
      if(activeGroup === 'nyse') groupLabel = "NYSE";
      if(activeGroup === 'nasdaq') groupLabel = "NASDAQ";

      // State'ten okuyoruz
      const currentAnalysisObj = ANALYSIS_OPTS.find(x => x.id === window.dgState.analysis) || ANALYSIS_OPTS[0];
      
      const currentSector = window.dgState.sector === 'all' ? 'TÃœMÃœ' : window.dgState.sector;
      const isSectorActive = window.dgState.sector !== 'all';

      const currentIndustry = window.dgState.industry === 'all' ? 'TÃœMÃœ' : window.dgState.industry;
      const isIndustryActive = window.dgState.industry !== 'all';
      const indStyle = isSectorActive ? '' : 'opacity:0.4; pointer-events:none; filter:grayscale(1);';

      let html = '';

      // A. BORSA
      html += `
          <div style="position:relative;">
              <div class="sc-badge market-badge" onclick="dgTogglePopup('market', event)">
                  <i class="fa-solid fa-globe"></i>
                  BORSA: ${groupLabel} <i class="fa-solid fa-chevron-down" style="font-size:9px; opacity:0.5; margin-left:4px;"></i>
              </div>
              <div id="dgPopup_market" class="cl-popup-menu" onclick="event.stopPropagation()">
                  <div class="cl-popup-list">
                      <div class="cl-popup-item ${activeGroup==='bist'?'selected':''}" onclick="setGroup('bist')">BIST (Ä°stanbul)</div>
                      <div class="cl-popup-item ${activeGroup==='nyse'?'selected':''}" onclick="setGroup('nyse')">NYSE (New York)</div>
                      <div class="cl-popup-item ${activeGroup==='nasdaq'?'selected':''}" onclick="setGroup('nasdaq')">NASDAQ</div>
                  </div>
              </div>
          </div>
      `;

      // B. ANALÄ°Z (State'e gÃ¶re seÃ§ili gelir)
      html += `
          <div style="position:relative;">
              <div class="sc-badge active" onclick="dgTogglePopup('analysis', event)">
                  <i class="fa-solid fa-chart-scatter"></i>
                  ANALÄ°Z: <span style="color:#fff;">${currentAnalysisObj.label}</span>
                  <i class="fa-solid fa-chevron-down" style="font-size:9px; opacity:0.5; margin-left:4px;"></i>
              </div>
              <div id="dgPopup_analysis" class="cl-popup-menu" onclick="event.stopPropagation()">
                  <div class="cl-popup-list">
                      ${ANALYSIS_OPTS.map(opt => `
                          <div class="cl-popup-item ${window.dgState.analysis === opt.id ? 'selected' : ''}" 
                               onclick="dgSelectAnalysis('${opt.id}')">
                               ${opt.label}
                          </div>
                      `).join('')}
                  </div>
              </div>
          </div>
      `;

      // C. SEKTÃ–R
      html += `
          <div style="position:relative;">
              <div class="sc-badge ${isSectorActive ? 'active' : ''}" onclick="dgTogglePopup('sector', event)">
                  <i class="fa-solid fa-layer-group"></i>
                  SEKTÃ–R: <span style="color:#fff;">${currentSector}</span>
                  ${isSectorActive 
                      ? `<div class="sc-badge-close" onclick="event.stopPropagation(); dgSelectSector('all')"><i class="fa-solid fa-xmark"></i></div>` 
                      : '<i class="fa-solid fa-chevron-down" style="font-size:9px; opacity:0.5; margin-left:4px;"></i>'}
              </div>
              <div id="dgPopup_sector" class="cl-popup-menu" onclick="event.stopPropagation()">
                  <div class="cl-popup-search">
                      <input type="text" class="cl-popup-input" placeholder="SektÃ¶r ara..." oninput="dgFilterListInPopup('sector', this.value)">
                  </div>
                  <div id="dgList_sector" class="cl-popup-list"></div>
              </div>
          </div>
      `;

      // D. ALT SEKTÃ–R
      html += `
          <div style="position:relative;">
              <div class="sc-badge ${isIndustryActive ? 'active' : ''}" style="${indStyle}" onclick="dgTogglePopup('industry', event)">
                  <i class="fa-solid fa-industry"></i>
                  ALT SEKTÃ–R: <span style="color:#fff;">${currentIndustry}</span>
                  ${isIndustryActive 
                      ? `<div class="sc-badge-close" onclick="event.stopPropagation(); dgSelectIndustry('all')"><i class="fa-solid fa-xmark"></i></div>` 
                      : '<i class="fa-solid fa-chevron-down" style="font-size:9px; opacity:0.5; margin-left:4px;"></i>'}
              </div>
              <div id="dgPopup_industry" class="cl-popup-menu" onclick="event.stopPropagation()">
                  <div class="cl-popup-search">
                      <input type="text" class="cl-popup-input" placeholder="Alt SektÃ¶r ara..." oninput="dgFilterListInPopup('industry', this.value)">
                  </div>
                  <div id="dgList_industry" class="cl-popup-list"></div>
              </div>
          </div>
      `;

      area.innerHTML = html;
  };

  // --- POPUP FONKSÄ°YONLARI ---
  window.dgTogglePopup = function(type, e) {
      if(e) e.stopPropagation();
      const targetId = `dgPopup_${type}`;
      const target = document.getElementById(targetId);
      const wasOpen = target.style.display === 'block';

      document.querySelectorAll('#view-diagrams .cl-popup-menu').forEach(el => el.style.display = 'none');

      if (!wasOpen) {
          if (type === 'sector' || type === 'industry') {
              const listEl = document.getElementById(`dgList_${type}`);
              let items = [];

              if (type === 'sector') {
                  items = [...new Set(dgCompanies().map(c => c.sector))].filter(Boolean).sort((a,b) => a.localeCompare(b,'tr'));
              } else {
                  items = [...new Set(dgCompanies()
                      .filter(c => c.sector === window.dgState.sector)
                      .map(c => c.industry))]
                      .filter(Boolean)
                      .sort((a,b) => a.localeCompare(b,'tr'));
              }
              
              const currentVal = type === 'sector' ? window.dgState.sector : window.dgState.industry;
              const clickFn = type === 'sector' ? 'dgSelectSector' : 'dgSelectIndustry';

              let html = `<div class="cl-popup-item" onclick="${clickFn}('all')">TÃœMÃœ</div>`;
              html += items.map(s => {
                  const isSel = currentVal === s;
                  const safeS = s.replace(/"/g, '&quot;');
                  return `<div class="cl-popup-item ${isSel?'selected':''}" onclick="${clickFn}('${safeS}')">${s}</div>`;
              }).join('');
              
              listEl.innerHTML = html;
              const inp = document.getElementById(`dgPopup_${type}`).querySelector('input');
              if(inp) inp.value = "";
          }
          target.style.display = 'block';
      }
  };

  // SEÃ‡Ä°M FONKSÄ°YONLARI
  window.dgSelectAnalysis = function(id) {
      window.dgState.analysis = id;
      dgUpdateBadges();
      dgStartAnalysis();
  };

  window.dgSelectSector = function(sec) {
      window.dgState.sector = sec;
      window.dgState.industry = 'all';
      dgUpdateBadges();
      dgStartAnalysis();
  };

  window.dgSelectIndustry = function(ind) {
      window.dgState.industry = ind;
      dgUpdateBadges();
      dgStartAnalysis();
  };

  window.dgFilterListInPopup = function(type, term) {
      const t = String(term||"").toLocaleLowerCase('tr');
      const items = document.querySelectorAll(`#dgList_${type} .cl-popup-item`);
      items.forEach(el => {
          const txt = el.textContent.toLocaleLowerCase('tr');
          el.style.display = (txt.includes(t) || el.textContent === "TÃœMÃœ") ? "block" : "none";
      });
  };

  document.addEventListener('click', (e) => {
      if(!e.target.closest('.sc-badge') && !e.target.closest('.cl-popup-menu')) {
          document.querySelectorAll('#view-diagrams .cl-popup-menu').forEach(el => el.style.display = 'none');
      }
  });

  // --- ANALÄ°Z MANTIÄžI & Ã‡Ä°ZÄ°M ---
  function cleanValue(v){
    if (typeof finParseBenchmarkValue === "function") {
      const n = finParseBenchmarkValue(v);
      return Number.isFinite(n) ? n : NaN;
    }
    const n = Number(String(v ?? "").replace(",", ".").replace(/[^0-9.\-]/g,""));
    return Number.isFinite(n) ? n : NaN;
  }

  function calculateSmartLimit(values) {
    const sorted = [...values].filter(v => !isNaN(v)).sort((a, b) => a - b);
    if (!sorted.length) return 100;
    const p50 = sorted[Math.floor(sorted.length * 0.50)];
    let limit = p50 > 0 ? p50 * 1.1 : Math.max(...sorted) * 1.1;
    return limit || 100;
  }

  function getMedian(values) {
    const sorted = [...values].filter(v => !isNaN(v)).sort((a, b) => a - b);
    if (!sorted.length) return 0;
    const mid = Math.floor(sorted.length / 2);
    return (sorted.length % 2) ? sorted[mid] : (sorted[mid-1] + sorted[mid]) / 2;
  }

  const ANALYSES = {
    pe_margin: {
      titleX: 'Net KÃ¢r MarjÄ± (%)', titleY: 'F/K OranÄ± (x)',
      zoneType: 'quadrant', qConfig: [2,0,1,0],
      calc: (d) => {
        let x = cleanValue(d["Faaliyet KÃ¢r MarjÄ±"]); let y = cleanValue(d["F/K"]);
        return (isNaN(x) || isNaN(y)) ? null : { x: x*100, y: y };
      }
    },
    ccc: {
      titleX: 'BorÃ§ Ã–deme SÃ¼resi', titleY: 'Stok+Alacak SÃ¼resi',
      greenZone: 'below-diagonal', 
      calc: (d) => {
        let x = cleanValue(d["BorÃ§ SÃ¼resi"]); let y1 = cleanValue(d["Stok SÃ¼resi"]); let y2 = cleanValue(d["Alacak SÃ¼resi"]);
        return (isNaN(x) || isNaN(y1) || isNaN(y2)) ? null : { x: x, y: y1 + y2 };
      }
    },
    roic_wacc: {
      titleX: 'WACC (%)', titleY: 'ROIC (%)',
      greenZone: 'top-left', 
      calc: (d) => {
        let y = cleanValue(d["ROIC"]); let x = cleanValue(d["WACC"]);
        return (isNaN(y) || isNaN(x)) ? null : { x: x*100, y: y*100 };
      }
    },
    np_fcf: {
      titleX: 'Net Kar', titleY: 'Serbest Nakit AkÄ±ÅŸÄ±',
      greenZone: 'top-left',
      calc: (d) => {
        let x = cleanValue(d["DÃ¶nem KarÄ± (ZararÄ±)"]); let y = cleanValue(d["Serbest Nakit AkÄ±ÅŸÄ±"]);
        return (isNaN(x) || isNaN(y)) ? null : { x: x/1e6, y: y/1e6 };
      }
    },
    assets_roa: {
      titleX: 'Toplam VarlÄ±klar', titleY: 'ROA (%)',
      zoneType: 'quadrant', qConfig: [2,0,0,1],
      calc: (d) => {
        let x = cleanValue(d["Toplam VarlÄ±klar"]); let y = cleanValue(d["ROA"]);
        return (isNaN(x) || isNaN(y)) ? null : { x: x/1e6, y: y*100 };
      }
    },
    growth: {
      titleX: 'Gelir BÃ¼yÃ¼mesi (%)', titleY: 'Faaliyet Kar BÃ¼yÃ¼mesi (%)',
      greenZone: 'top-left',
      calc: (d) => {
        let x = cleanValue(d["SatÄ±ÅŸ BÃ¼yÃ¼mesi TTM"]); let y = cleanValue(d["Faaliyet Kar BÃ¼yÃ¼mesi TTM"]);
        return (isNaN(x) || isNaN(y)) ? null : { x: x*100, y: y*100 };
      }
    },
    de_roe: {
      titleX: 'BorÃ§/Ã–z Kaynak', titleY: 'ROE',
      zoneType: 'quadrant', qConfig: [2,0,0,1],
      calc: (d) => {
        let x = cleanValue(d["BorÃ§/Ã–z Kaynak"]); let y = cleanValue(d["ROE"]);
        return (isNaN(x) || isNaN(y)) ? null : { x: x, y: y*100 };
      }
    },
    roa_profit: {
      titleX: 'VarlÄ±k Devir HÄ±zÄ±', titleY: 'Faaliyet Kar MarjÄ± (%)',
      zoneType: 'quadrant', qConfig: [0,2,1,0],
      calc: (d) => {
        let x = cleanValue(d["SatÄ±ÅŸ Gelirleri"]) / cleanValue(d["Toplam VarlÄ±klar"]); let y = cleanValue(d["Faaliyet KÃ¢r MarjÄ±"]);
        return (isNaN(x) || isNaN(y)) ? null : { x: x, y: y*100 };
      }
    },
    capex: {
      titleX: 'VarlÄ±k AlÄ±mlarÄ±', titleY: 'Gelir BÃ¼yÃ¼mesi',
      greenZone: 'top-left',
      calc: (d) => {
        let x = cleanValue(d["VarlÄ±k AlÄ±mlarÄ±"]); let y = cleanValue(d["SatÄ±ÅŸ BÃ¼yÃ¼mesi Net"]);
        return (isNaN(x) || isNaN(y)) ? null : { x: x/1e6, y: y/1e6 };
      }
    }
  };

  function buildDataMap(){ return window.__FIN_MAP || {}; }

  function drawZones(ctx, chart, config, dMaxX, dMaxY){
    const area = chart.chartArea;
    if (!area) return;

    const left = area.left, right = area.right, top = area.top, bottom = area.bottom;
    const midX = config.currentMidX ?? dMaxX/2;
    const midY = config.currentMidY ?? dMaxY/2;

    ctx.save();

    if (config.zoneType === 'quadrant') {
      const q = config.qConfig || [0,0,0,0];
      const xMidPx = chart.scales.x.getPixelForValue(midX);
      const yMidPx = chart.scales.y.getPixelForValue(midY);

      const rects = [
        { x:left, y:top, w:xMidPx-left, h:yMidPx-top, c:q[0] },         
        { x:xMidPx, y:top, w:right-xMidPx, h:yMidPx-top, c:q[1] },      
        { x:left, y:yMidPx, w:xMidPx-left, h:bottom-yMidPx, c:q[2] },   
        { x:xMidPx, y:yMidPx, w:right-xMidPx, h:bottom-yMidPx, c:q[3] } 
      ];

      rects.forEach(r => {
        if (r.c === 2) ctx.fillStyle = colors.green;
        else if (r.c === 1) ctx.fillStyle = colors.red;
        else ctx.fillStyle = colors.neutral;
        ctx.fillRect(r.x, r.y, r.w, r.h);
      });

      ctx.strokeStyle = 'rgba(255,255,255,0.15)';
      ctx.lineWidth = 1;
      ctx.setLineDash([6,6]);
      ctx.beginPath();
      ctx.moveTo(xMidPx, top); ctx.lineTo(xMidPx, bottom);
      ctx.moveTo(left, yMidPx); ctx.lineTo(right, yMidPx);
      ctx.stroke();
      ctx.setLineDash([]);

    } else {
      ctx.fillStyle = colors.neutral;
      ctx.fillRect(left, top, right-left, bottom-top);

      ctx.strokeStyle = 'rgba(255,255,255,0.18)';
      ctx.lineWidth = 1.5;
      ctx.setLineDash([6,6]);
      ctx.beginPath();
      ctx.moveTo(chart.scales.x.getPixelForValue(0), chart.scales.y.getPixelForValue(0));
      ctx.lineTo(chart.scales.x.getPixelForValue(dMaxX), chart.scales.y.getPixelForValue(dMaxY));
      ctx.stroke();
      ctx.setLineDash([]);

      ctx.beginPath();
      ctx.moveTo(left, bottom); 
      ctx.lineTo(left, top);
      ctx.lineTo(right, top);
      ctx.closePath();
      
      if (config.greenZone === 'top-left') {
          ctx.fillStyle = colors.green;
          ctx.fill();
      } else if (config.greenZone === 'below-diagonal') {
          ctx.fillStyle = colors.red; 
          ctx.fill();
      }

      ctx.beginPath();
      ctx.moveTo(left, bottom);
      ctx.lineTo(right, bottom);
      ctx.lineTo(right, top);
      ctx.closePath();

      if (config.greenZone === 'below-diagonal') {
          ctx.fillStyle = colors.green;
          ctx.fill();
      } else if (config.greenZone === 'top-left') {
          ctx.fillStyle = colors.red;
          ctx.fill();
      }
    }
    ctx.restore();
  }

  function draw(points, config, dMaxX, dMaxY){
    const canvas = document.getElementById('matrixChart');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    if (chartObj) chartObj.destroy();

    chartObj = new Chart(ctx, {
      type: 'scatter',
      data: { datasets: [{ data: points, backgroundColor: '#c2f50e', borderWidth: 1, pointRadius: 6, pointHoverRadius: 12 }] },
      options: {
        responsive: true, maintainAspectRatio: false,
        animation: { onComplete: () => setTimeout(updateHeight, 50) },
        onClick: (evt, elements) => {
          if (!elements?.length) return;
          const p = elements[0];
          const row = chartObj.data.datasets[p.datasetIndex].data[p.index];
          if (row?.ticker && window.finOpenDetail) window.finOpenDetail(row.ticker);
        },
        layout: { padding: { top: 20, right: 30, bottom: 10, left: 10 } },
        scales: {
          x: { min: 0, max: dMaxX, title: { display: true, text: config.titleX, color: '#888' }, grid: { color: '#1a1a1a' }, ticks: { color: '#555' } },
          y: { min: 0, max: dMaxY, title: { display: true, text: config.titleY, color: '#888' }, grid: { color: '#1a1a1a' }, ticks: { color: '#555' } }
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: '#111', borderColor: '#333', borderWidth: 1, padding: 12,
            callbacks: {
              label: (c) => [
                `Åžirket: ${c.raw.ticker}`,
                `${config.titleX}: ${Number(c.raw.origX).toFixed(2)}${config.unitX || ''}`,
                `${config.titleY}: ${Number(c.raw.origY).toFixed(2)}${config.unitY || ''}`
              ]
            }
          }
        }
      },
      plugins: [{
        id: 'zone-bg',
        beforeDraw: (chart) => {
          const ctx = chart.ctx;
          drawZones(ctx, chart, config, dMaxX, dMaxY);
        }
      }]
    });

    setTimeout(updateHeight, 100);
  }

  window.dgStartAnalysis = function(){
    const type = window.dgState.analysis;
    const sector = window.dgState.sector;
    const industry = window.dgState.industry;
    
    const config = ANALYSES[type];
    if (!config) return;

    const companies = dgCompanies();
    const map = buildDataMap();

    const validPoints = companies
      .filter(c => {
          if (sector !== 'all' && c.sector !== sector) return false;
          if (industry !== 'all' && c.industry !== industry) return false;
          return true;
      })
      .map(c => {
        const d = map[String(c.ticker).toUpperCase()] || {};
        const res = config.calc(d);
        return res ? { x: res.x, y: res.y, origX: res.x, origY: res.y, ticker: String(c.ticker).toUpperCase() } : null;
      })
      .filter(Boolean);

    // BoÅŸ veri olsa da grafiÄŸi Ã§izelim ki (0,0) eksenleri ve arka plan gÃ¶rÃ¼nsÃ¼n
    if (validPoints.length === 0) {
        draw([], config, 100, 100);
        return;
    }

    let curMaxX = config.maxX || calculateSmartLimit(validPoints.map(p => p.origX));
    let curMaxY = config.maxY || calculateSmartLimit(validPoints.map(p => p.origY));

    if (config.zoneType !== 'quadrant') {
      const unifiedMax = Math.max(curMaxX, curMaxY);
      curMaxX = unifiedMax;
      curMaxY = unifiedMax;
    }

    if (config.zoneType === 'quadrant') {
      config.currentMidX = getMedian(validPoints.map(p => p.origX));
      config.currentMidY = getMedian(validPoints.map(p => p.origY));
    }

    const finalDataset = validPoints.map(p => ({
      x: Math.max(0, Math.min(p.origX, curMaxX)),
      y: Math.max(0, Math.min(p.origY, curMaxY)),
      origX: p.origX,
      origY: p.origY,
      ticker: p.ticker
    }));

    draw(finalDataset, config, curMaxX, curMaxY);

    const interp = document.getElementById('interp-content');
    if (interp && window.INTERPRETATIONS) interp.innerHTML = window.INTERPRETATIONS[type] || '';
    
    setTimeout(updateHeight, 100);
  };

  // Metin Sabitleri
  window.INTERPRETATIONS = {
    pe_margin: `<b>Analiz:</b> DeÄŸerleme vs. KÃ¢rlÄ±lÄ±k analizi.<br><br><b style="color: #c2f50e;">YeÅŸil BÃ¶lge (Kelepir):</b> SektÃ¶r ortalamasÄ±ndan daha yÃ¼ksek kÃ¢rlÄ±lÄ±ÄŸa sahip olmasÄ±na raÄŸmen, piyasanÄ±n henÃ¼z "pahalÄ±" fiyatlamadÄ±ÄŸÄ± ÅŸirketler.<br><br><b style="color: #ff4444;">KÄ±rmÄ±zÄ± BÃ¶lge (Riskli):</b> KÃ¢r marjÄ± dÃ¼ÅŸÃ¼k olmasÄ±na raÄŸmen, fiyatÄ± (F/K) Ã§ok yÃ¼kselmiÅŸ ÅŸirketler.`,
    ccc: `<b>Analiz:</b> Nakit yÃ¶netim verimliliÄŸi.<br><br><b style="color: #c2f50e;">Ã‡aprazÄ±n AltÄ± (Verimli):</b> BorÃ§ Ã¶deme sÃ¼resi, stok ve alacak sÃ¼resinden uzundur. Åžirket faizsiz krediyle iÅŸini dÃ¶ndÃ¼rÃ¼yor demektir.<br><br><b style="color: #ff4444;">Ã‡aprazÄ±n ÃœstÃ¼ (SÄ±kÄ±ÅŸÄ±k):</b> Åžirket sattÄ±ÄŸÄ± malÄ±n parasÄ±nÄ± tahsil etmeden Ã¶deme yapmak zorunda kalÄ±yor.`,
    roic_wacc: `<b>Analiz:</b> Ekonomik Katma DeÄŸer (EVA).<br><br><b style="color: #c2f50e;">ROIC > WACC (DeÄŸer Yaratan):</b> Åžirket sermaye maliyetinin Ã¼zerinde getiri saÄŸlÄ±yor.<br><br><b style="color: #ff4444;">ROIC < WACC (DeÄŸer YÄ±kÄ±cÄ±):</b> Åžirket hissedarÄ±n parasÄ±nÄ± reel olarak eritiyor olabilir.`,
    np_fcf: `<b>Analiz:</b> KÃ¢rÄ±n Nakit Kalitesi.<br><br><b style="color: #c2f50e;">Ã‡aprazÄ±n ÃœstÃ¼ (GÃ¼Ã§lÃ¼):</b> Serbest nakit akÄ±ÅŸÄ± net kÃ¢rdan yÃ¼ksek. Nakit Ã¼retebilen ÅŸirket.<br><br><b style="color: #ff4444;">Ã‡aprazÄ±n AltÄ± (ZayÄ±f):</b> KÃ¢r var ama nakit yok. Tahsilat/sermaye harcamasÄ± baskÄ±sÄ± olabilir.`,
    assets_roa: `<b>Analiz:</b> Ã–lÃ§ek vs. Verimlilik.<br><br><b style="color: #c2f50e;">SaÄŸ-Ãœst (Ä°yi):</b> BÃ¼yÃ¼k Ã¶lÃ§ek ve yÃ¼ksek ROA.<br><br><b style="color: #ff4444;">Sol-Alt (ZayÄ±f):</b> KÃ¼Ã§Ã¼k Ã¶lÃ§ek ve dÃ¼ÅŸÃ¼k ROA.`,
    growth: `<b>Analiz:</b> BÃ¼yÃ¼me Kalitesi.<br><br><b style="color: #c2f50e;">SaÄŸ-Ãœst (Kaliteli):</b> Hem gelir hem kÃ¢r bÃ¼yÃ¼yor.<br><br><b style="color: #ff4444;">Sol-Alt (ZayÄ±f):</b> BÃ¼yÃ¼me dÃ¼ÅŸÃ¼k / kÃ¢r bÃ¼yÃ¼mÃ¼yor.`,
    de_roe: `<b>Analiz:</b> Finansal SaÄŸlÄ±k vs. Getiri.<br><br><b style="color: #c2f50e;">Sol-Ãœst (Ä°deal):</b> DÃ¼ÅŸÃ¼k borÃ§, yÃ¼ksek ROE.<br><br><b style="color: #ff4444;">SaÄŸ-Alt (Riskli):</b> YÃ¼ksek borÃ§, dÃ¼ÅŸÃ¼k ROE.`,
    roa_profit: `<b>Analiz:</b> DuPont Verimlilik Analizi.<br><br><b style="color: #c2f50e;">SaÄŸ-Ãœst:</b> YÃ¼ksek devir + yÃ¼ksek marj.<br><br><b style="color: #ff4444;">Sol-Alt:</b> DÃ¼ÅŸÃ¼k devir + dÃ¼ÅŸÃ¼k marj.`,
    capex: `<b>Analiz:</b> YatÄ±rÄ±mÄ±n Geri DÃ¶nÃ¼ÅŸÃ¼.<br><br><b style="color: #c2f50e;">SaÄŸ-Ãœst (Ä°yi):</b> YatÄ±rÄ±m var ve bÃ¼yÃ¼me geliyor.<br><br><b style="color: #ff4444;">Sol-Alt (ZayÄ±f):</b> YatÄ±rÄ±m var ama bÃ¼yÃ¼me yok.`
  };

  window.dgRender = function(){
    dgUpdateBadges();
    window.dgStartAnalysis();
    updateHeight();
  };

  // âœ… INIT: Veri Beklemeli
  window.dgInitOnce = function(){
    finEnsureCompanies();
    finEnsureBenchmarks();
    
    // Veri (Map) henÃ¼z yoksa bekleyelim
    if(typeof finBuildMapForActiveGroup === "function") {
        finBuildMapForActiveGroup(() => {
            if (dgInited) return;
            dgInited = true;
            window.dgRender();
        });
    } else {
        // Fallback
        if (dgInited) return;
        dgInited = true;
        window.dgRender();
    }
  };

})();    // ============================================
    // KARÅžILAÅžTIRMA (BIST/SP) - window.benchmarks + window.companies
    // ============================================

    (function(){
      let cmpInited = false;
      let cmpMapData = {};
      let cmpSelected = [];

      const CMP_DEFAULTS = {
        bist: ['ASELS','THYAO','ENKAI','EREGL'],
        nyse: ['BABA','TSM','JPM','V'],
        nasdaq: ['AAPL','NVDA','MSFT','GOOGL'] // Defaultlar eklendi
      };
      const CMP_MAX = 8;

      // --- BADGE RENDER (BORSA SEÃ‡Ä°MÄ°) ---
      window.cmpUpdateMarketBadge = function() {
          const area = document.getElementById("cmpMarketBadge");
          if(!area) return;

          let groupLabel = "BIST";
          if(activeGroup === 'nyse') groupLabel = "NYSE";
          if(activeGroup === 'nasdaq') groupLabel = "NASDAQ";

          // HTML: Sadece Borsa Badge'i
          area.innerHTML = `
              <div style="position:relative;">
                  <div class="sc-badge market-badge" onclick="cmpToggleMarketPopup(event)" title="Borsa DeÄŸiÅŸtir">
                      <i class="fa-solid fa-globe"></i>
                      BORSA: ${groupLabel} <i class="fa-solid fa-chevron-down" style="font-size:9px; opacity:0.5; margin-left:4px;"></i>
                  </div>
                  <div id="cmpPopup_market" class="cl-popup-menu" onclick="event.stopPropagation()">
                      <div class="cl-popup-list">
                          <div class="cl-popup-item ${activeGroup==='bist'?'selected':''}" onclick="setGroup('bist')">BIST (Ä°stanbul)</div>
                          <div class="cl-popup-item ${activeGroup==='nyse'?'selected':''}" onclick="setGroup('nyse')">NYSE (New York)</div>
                          <div class="cl-popup-item ${activeGroup==='nasdaq'?'selected':''}" onclick="setGroup('nasdaq')">NASDAQ</div>
                      </div>
                  </div>
              </div>
          `;
      };

      window.cmpToggleMarketPopup = function(e) {
          if(e) e.stopPropagation();
          const pop = document.getElementById("cmpPopup_market");
          if(pop) {
              // DiÄŸer aÃ§Ä±k popuplarÄ± kapat (global class)
              document.querySelectorAll('.cl-popup-menu').forEach(el => {
                  if(el !== pop) el.style.display = 'none';
              });
              const isVisible = pop.style.display === "block";
              pop.style.display = isVisible ? "none" : "block";
          }
      };

      // DÄ±ÅŸarÄ± tÄ±klayÄ±nca kapat
      document.addEventListener('click', (e) => {
          if(!e.target.closest('.sc-badge') && !e.target.closest('.cl-popup-menu')) {
              const pop = document.getElementById("cmpPopup_market");
              if(pop) pop.style.display = 'none';
          }
      });

      // --- CORE LOGIC ---

      function cmpStorageKey(group){ return 'finapsis_cmp_selected_' + group; }

      function cmpLoadSelection(group){
        try{
          const raw = localStorage.getItem(cmpStorageKey(group));
          if(raw){
            const arr = JSON.parse(raw);
            if(Array.isArray(arr)) return arr.filter(Boolean);
          }
        }catch(e){}
        return (CMP_DEFAULTS[group] || []).slice();
      }

      function cmpSaveSelection(group){
        try{ localStorage.setItem(cmpStorageKey(group), JSON.stringify(cmpSelected)); }catch(e){}
      }

      // Aktif grup ÅŸirketlerini getir
      function cmpCompanies() {
        const list = Array.isArray(window.companies) ? window.companies : [];
        return list.filter(c => c.group === activeGroup); // activeGroup globalden gelir
      }

      function cmpRebuildMap() {
        cmpMapData = window.__FIN_MAP || {};
      }

      function cmpEnsureSelection() {
        const allowed = new Set(cmpCompanies().map(c => c.ticker));
        cmpSelected = cmpSelected.filter(t => allowed.has(t) && cmpMapData[t]);

        if (cmpSelected.length === 0) {
          cmpSelected = cmpLoadSelection(activeGroup);
          // Tekrar filtrele (yeni grup verisi yÃ¼klenmemiÅŸ olabilir)
          cmpSelected = cmpSelected.filter(t => allowed.has(t) && cmpMapData[t]);
        }

        if (cmpSelected.length > CMP_MAX) cmpSelected = cmpSelected.slice(0, CMP_MAX);
        cmpSaveSelection(activeGroup);
      }

      function cmpUpdateHeight() {
        try {
          const root = document.getElementById('cmpHeightWrapper') || document.getElementById('view-compare');
          const h = Math.max(600, Math.ceil((root && root.scrollHeight) ? root.scrollHeight : 800) + 20);
          if(window.parent) window.parent.postMessage({ type: 'resize-iframe', height: h }, '*');
        } catch(e) {}
      }

      // --- SEARCH LOGIC (FIXED) ---
      function cmpInitSearch() {
        const input = document.getElementById('cmpSearch');
        const results = document.getElementById('cmpSearchResults');
        if (!input || !results) return;

        input.addEventListener('input', (e) => {
          cmpRebuildMap(); // __FIN_MAP gÃ¼ncelse onu yakala
          const term = (e.target.value || '').toLocaleLowerCase('tr').trim();
          results.innerHTML = '';
          
          if (term.length < 1) { 
              results.style.display = 'none'; 
              return; 
          }

          // Aktif gruptaki ÅŸirketlerde ara
          const filtered = cmpCompanies()
            .filter(c => {
              const nameMatch = String(c.name || '').toLocaleLowerCase('tr').includes(term);
              const tickerMatch = String(c.ticker || '').toLocaleLowerCase('tr').includes(term);
              // Sadece verisi olanlarÄ± getir
                  return (nameMatch || tickerMatch) && cmpMapData[c.ticker];

            })
            .slice(0, 10);

          if (filtered.length) {
            filtered.forEach(c => {
              const div = document.createElement('div');
              div.className = 'cmp-result-item';
              div.innerHTML = `
                <img src="${c.logourl || ''}" onerror="this.style.display='none'">
                <span>${c.ticker} <small style="color:rgba(255,255,255,0.4); margin-left:6px; font-weight:400;">${c.name || ''}</small></span>
              `;
              div.onclick = () => {
                if (!cmpSelected.includes(c.ticker)) {
                  if (cmpSelected.length >= CMP_MAX) cmpSelected.shift(); // FIFO
                  cmpSelected.push(c.ticker);
                  cmpSaveSelection(activeGroup);
                  window.cmpRender();
                }
                input.value = '';
                results.style.display = 'none';
              };
              results.appendChild(div);
            });
            results.style.display = 'block';
          } else {
            results.style.display = 'none';
          }
        });
      }

      function cmpRemoveTicker(t) {
        cmpSelected = cmpSelected.filter(x => x !== t);
        cmpSaveSelection(activeGroup);
        window.cmpRender();
      }

      // --- RENDER ---
      window.cmpRender = function cmpRender() {
        const view = document.getElementById('view-compare');
        if (!view || !view.classList.contains('active')) return;

        // Badge'i gÃ¼ncelle (Grup deÄŸiÅŸmiÅŸ olabilir)
        if(window.cmpUpdateMarketBadge) window.cmpUpdateMarketBadge();

        document.getElementById('cmp-preloader').style.display = 'flex';

        cmpRebuildMap();
        cmpEnsureSelection();

        const thead = document.getElementById('cmpThead');
        const tbody = document.getElementById('cmpTbody');
        const badgeArea = document.getElementById('cmpBadgeArea');
        if (!thead || !tbody || !badgeArea) return;

        badgeArea.innerHTML = '';
        thead.innerHTML = '';
        tbody.innerHTML = '';

        if (!cmpSelected.length) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:60px; color:#666;">KarÅŸÄ±laÅŸtÄ±rmak iÃ§in ÅŸirket arayÄ±n.</td></tr>';
          document.getElementById('cmp-preloader').style.display = 'none';
          cmpUpdateHeight();
          return;
        }

        const comps = cmpCompanies();

        // Header
        let hRow = '<tr><th>GÃ–STERGELER</th>';
        cmpSelected.forEach(t => {
          const c = comps.find(x => x.ticker === t) || (window.companies||[]).find(x => x.ticker === t);
          const logoUrl = c ? (c.logourl || '') : '';
          
          hRow += `<th>
            <img src="${logoUrl}" class="cmp-flag-head" onerror="this.style.display='none'">
            <span class="cmp-country-title">${t}</span>
            <div style="margin-top:6px; display:flex; justify-content:center;">
                <button class="fp-add-btn" onclick="event.stopPropagation(); finOpenAddToPortfolio('${t}')" title="PortfÃ¶ye ekle"><i class="fa-solid fa-plus"></i></button>
            </div>
          </th>`;

          const b = document.createElement('div');
          b.className = 'cmp-badge';
          b.innerHTML = `${t} <button type="button" class="cmp-xbtn" data-x="${t}" title="KaldÄ±r">Ã—</button>`;
          badgeArea.appendChild(b);
        });
        hRow += '</tr>';
        thead.innerHTML = hRow;

        // Remove buttons
        badgeArea.querySelectorAll('button.cmp-xbtn[data-x]').forEach(btn => {
          btn.addEventListener('click', () => cmpRemoveTicker(btn.getAttribute('data-x')));
        });

        // Config & Rows
        const sym = (activeGroup === 'sp' || activeGroup === 'nyse' || activeGroup === 'nasdaq') ? '$' : 'â‚º';
        
        // Helper funcs
        const money = (v) => {
            if(v===null||v===undefined) return '<span class="muted">-</span>';
            return finFormatMoneyCompact(v);
        };
        const num = (v) => {
            if(v===null||v===undefined) return '<span class="muted">-</span>';
            return Number(v).toLocaleString('tr-TR', { maximumFractionDigits: 2 });
        };

        const cfg = [
          { label: 'Piyasa DeÄŸeri', key: 'Piyasa DeÄŸeri', format: v => money(v), better: 'high' },
          { label: 'Firma DeÄŸeri', key: 'Firma DeÄŸeri', format: v => money(v), better: 'high' },
          { label: 'Gelirler (12 Ay)', key: 'SatÄ±ÅŸ Gelirleri', format: v => money(v), better: 'high' },
          { label: 'BrÃ¼t Kar MarjÄ±', key: 'BrÃ¼t Kar MarjÄ±', format: v => `% ${num(v*100)}`, better: 'high' },
          { label: 'Faaliyet MarjÄ±', key: 'Faaliyet KÃ¢r MarjÄ±', format: v => `% ${num(v*100)}`, better: 'high' },
          { label: 'F/K', key: 'F/K', format: v => num(v), better: 'low' },
          { label: 'PD/DD', key: 'PD/DD', format: v => num(v), better: 'low' },
          { label: 'Cari Oran', key: 'Cari Oran', format: v => num(v), better: 'high' },
          { label: 'BorÃ§/Ã–z Kaynak', key: 'BorÃ§/Ã–z Kaynak', format: v => num(v), better: 'low' },
          { label: 'ROE', key: 'ROE', format: v => `% ${num(v*100)}`, better: 'high' },
          { label: 'ROIC', key: 'ROIC', format: v => `% ${num(v*100)}`, better: 'high' }
        ];

        cfg.forEach(row => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td class="label-text">${row.label}</td>`;

          // SÄ±ralama (Renk) iÃ§in deÄŸerleri al
          const rowValues = cmpSelected
            .map(t => ({ ticker: t, val: (cmpMapData[t] ? cmpMapData[t][row.key] : null) }))
            .filter(x => x.val !== null && !Number.isNaN(Number(x.val)));

          if (rowValues.length > 1 && row.better) {
            rowValues.sort((a,b) => row.better === 'high' ? (b.val - a.val) : (a.val - b.val));
          }

          cmpSelected.forEach(t => {
            const val = (cmpMapData[t] ? cmpMapData[t][row.key] : null);
            const formatted = row.format(val);
            const c = comps.find(x => x.ticker === t);
            const logoUrl = c ? (c.logourl || '') : '';

            let colorClass = '';
            if (rowValues.length > 1 && val !== null) {
              const rank = rowValues.findIndex(x => x.ticker === t);
              if (rank === 0) colorClass = 'cell-green';
              else if (rank === rowValues.length - 1) colorClass = 'cell-red';
            }

            tr.innerHTML += `<td class="${colorClass}">
              <div class="cmp-mobile-meta">
                <img src="${logoUrl}" onerror="this.style.display='none'">
                <span>${t}</span>
              </div>
              ${formatted}
            </td>`;
          });

          tbody.appendChild(tr);
        });

        document.getElementById('cmp-preloader').style.display = 'none';
        cmpUpdateHeight();
      };

      // Grup deÄŸiÅŸince tetiklenir (setGroup iÃ§inden)
      window.cmpOnGroupChange = function(group){
        // SeÃ§imleri yenile
        cmpSelected = cmpLoadSelection(group);
        
        // Search kutusunu temizle ve placeholder gÃ¼ncelle
        const inp = document.getElementById('cmpSearch');
        if(inp) {
            inp.value = '';
            if(group === 'nasdaq') inp.placeholder = "Åžirket ara (Ã¶rn: AAPL, NVDA...)";
            else if(group === 'nyse') inp.placeholder = "Åžirket ara (Ã¶rn: BABA, TSM...)";
            else inp.placeholder = "Åžirket ara (Ã¶rn: MGROS, THYAO...)";
        }
        
        // Badge'i gÃ¼ncelle
        if(window.cmpUpdateMarketBadge) window.cmpUpdateMarketBadge();
      };

      // INIT
      // INIT (Veri Beklemeli)
      window.cmpInitOnce = function cmpInitOnce() {
        finEnsureCompanies();
        finEnsureBenchmarks();

        // 1. UI BaÅŸlat (Search, Badge vb. veri gerektirmez)
        if (!cmpInited) {
            cmpInited = true;
            cmpInitSearch();
            if(window.cmpUpdateMarketBadge) window.cmpUpdateMarketBadge();
        }

        // 2. Tabloyu Ã‡iz (Veri Gerektirir)
        // EÄŸer global fetch zaten bitmiÅŸse callback hemen Ã§alÄ±ÅŸÄ±r.
        // BitmemiÅŸse, bitince Ã§alÄ±ÅŸÄ±r.
        if (typeof finBuildMapForActiveGroup === "function") {
            // YÃ¼kleniyor gÃ¶stergesi
            const tbody = document.getElementById('cmpTbody');
            if(tbody && (!cmpSelected.length || Object.keys(cmpMapData).length === 0)) {
                 document.getElementById('cmp-preloader').style.display = 'flex';
            }

            finBuildMapForActiveGroup(() => {
                if (window.cmpRender) window.cmpRender();
            });
        } else {
            // Fallback
            setTimeout(() => { if (window.cmpRender) window.cmpRender(); }, 0);
        }
      };

    })();    // =============================
// âœ… FINAL OVERRIDES (STABLE)
// =============================

// Header highlight
function clUpdateSortHeaderUI(){
  clQA("#cl-thead th").forEach(th => {
    th.classList.remove("active-sort");
    th.removeAttribute("data-icon");
    const key = th.getAttribute("data-key");
    if (key === currentSort.key){
      th.classList.add("active-sort");
      th.setAttribute("data-icon", currentSort.asc ? " â†‘" : " â†“");
    }
  });
}

// Header click sort baÄŸla (1 kere)
function clBindHeaderSortOnce(){
  document.querySelectorAll("#cl-thead th").forEach(th => {
    if (th.__clSortBound) return;
    th.__clSortBound = true;

    th.onclick = () => {
      const k = th.getAttribute("data-key");
      if (!k) return;

      // aynÄ± kolon => ters Ã§evir, yeni kolon => name asc, diÄŸerleri desc
      currentSort.asc = (currentSort.key === k) ? !currentSort.asc : (k === "name");
      currentSort.key = k;

      // infinite scroll varsa limit resetlemek istiyorsan:
      if (typeof clLimit !== "undefined") clLimit = 200;

      clUpdateSortHeaderUI();
      renderCompanyList();

      // tablo wrapper yukarÄ± (opsiyonel)
      const w = document.getElementById("fin-container");
      if (w) w.scrollTop = 0;
    };
  });
}



// âœ… Companies init override: ilk yÃ¼kte BIST map build + sort Ã§alÄ±ÅŸsÄ±n
// âœ… Companies init override: Ä°lk yÃ¼kte sÄ±ralamayÄ± ve veriyi garantiye al
window.initCompaniesList = function(){
  // EÄŸer zaten init edildiyse tekrar etme
  if (window.__companiesListInited) return;
  window.__companiesListInited = true;

  // 1. Veri kaynaklarÄ±nÄ± kontrol et
  try { finEnsureCompanies && finEnsureCompanies(); } catch(e){}
  
  // 2. SektÃ¶r dropdown'Ä±nÄ± doldur
  try { updateCompanyListSectorDropdown(); } catch(e){}

  // 3. VarsayÄ±lan SÄ±ralamayÄ± KÄ°LÄ°TLE (Piyasa DeÄŸeri - Azalan)
  currentSort = { key: 'Piyasa DeÄŸeri', asc: false };
  
  // 4. Header UI'Ä±nÄ± buna gÃ¶re gÃ¼ncelle (Ok iÅŸaretini koy)
  clBindHeaderSortOnce();
  clUpdateSortHeaderUI();
  // 5. Badge'leri Ã‡iz
  if(window.clUpdateFilterBadges) window.clUpdateFilterBadges();

  // 5. Tabloya "YÃ¼kleniyor..." koy (KullanÄ±cÄ± yanlÄ±ÅŸ liste gÃ¶rmesin)
  const tbody = document.getElementById("cl-tbody");
  if(tbody) tbody.innerHTML = '<tr><td colspan="20" style="text-align:center; padding:50px; color:#666;"><div class="spinner" style="margin:0 auto 10px auto;"></div>Veriler Analiz Ediliyor...</td></tr>';

  // 6. Map verisini indir ve bitince tabloyu Ã§iz
  if (typeof finBuildMapForActiveGroup === "function") {
    finBuildMapForActiveGroup(() => {
      // Veri indi, ÅŸimdi sÄ±ralÄ± ÅŸekilde Ã§iz
      clUpdateSortHeaderUI(); // UI'Ä± tazele
      renderCompanyList();    // Tabloyu Ã§iz
    });
  } else {
    // Fonksiyon yoksa (fallback) direkt Ã§iz
    renderCompanyList();
  }

  // Infinite scroll'u baÅŸlat
  try { clSetupInfiniteScroll(); } catch(e){}
};// âœ… Companies List search fix (duplicate mainSearch id sorunu)
window.applyMainSearch = function(src){
  clearTimeout(__clSearchT);
  __clSearchT = setTimeout(() => {
    // state reset
    try { __clAppendRequested = false; __clRenderedCount = 0; } catch(e){}
    try { clLimit = 200; } catch(e){}

    const el =
      (src && src.tagName === "INPUT") ? src :
      (src && src.target && src.target.tagName === "INPUT") ? src.target :
      document.querySelector('#view-companies.view-section.active #mainSearch') ||
      document.querySelector('#view-companies #mainSearch') ||
      document.getElementById("mainSearch");

    const val = el ? String(el.value || "") : "";

    try { if (typeof activeFilters === "object" && activeFilters) activeFilters.name = val; } catch(e){}

    try { if (typeof renderCompanyList === "function") renderCompanyList(); } catch(e){}
    try { if (typeof clSetupInfiniteScroll === "function") clSetupInfiniteScroll(); } catch(e){}
  }, 180);
};



// ============================================
// GÃ–STERGELER (INDICATORS) JS LOGIC
// ============================================
window.indCleanNum = function(v) {
    if (v === null || v === undefined || v === "" || v === "null") return null;
    let n = parseFloat(v.toString().replace(",", "."));
    return isNaN(n) ? null : n;
};

window.indFormatDisplay = function(item, fieldType = 'current') {
    if (item.type === "Text") return fieldType === 'current' ? (item.text || "-") : (item.prev_text || "-");
    let val = (fieldType === 'current') ? indCleanNum(item.val) : indCleanNum(item.prev);
    if (val === null) return "-";
    let displayVal = (item.type === "Percentage") ? val * 100 : val;
    const digits = item.is4d ? 4 : 2;
    let formatted = displayVal.toLocaleString("tr-TR", { minimumFractionDigits: digits, maximumFractionDigits: digits });
    return item.type === "Percentage" ? "%" + formatted : formatted;
};

window.indCls = function(n) {
    if (n === null || Math.abs(n) < 0.00000001) return "";
    return n > 0 ? "pos" : "neg";
};

window.indFormatDate = function(dateStr, isPeriodical) {
    if (!isPeriodical || !dateStr || !dateStr.includes('/')) return dateStr || "";
    const parts = dateStr.split('/');
    if (parts.length < 3) return dateStr;
    const aylar = ["Oca", "Åžub", "Mar", "Nis", "May", "Haz", "Tem", "AÄŸu", "Eyl", "Eki", "Kas", "Ara"];
    const ayIsmi = aylar[parseInt(parts[1]) - 1];
    const yilKisa = parts[2].toString().slice(-2);
    return `${ayIsmi}/${yilKisa}`;
};

// GÃ¶stergeler Filtre State
window.indFilterState = {
    group: "all" // VarsayÄ±lan: Hepsi
};

// âœ… GÃ–STERGELER: ÃœST GRUP BADGE SATIRI (PILL)
// Map formatÄ±n: { usdtry:{...}, eurtry:{...} }  (flat object)
// (Eski wrapper formatÄ± gelirse {map:{...}}'i de destekliyoruz)
window.indUpdateBadge = function () {
  const area = document.getElementById("indBadgeArea");
  if (!area || !window.__INDICATORS_MAP) return;

  const root = window.__INDICATORS_MAP || {};
  const mapObj = (root && typeof root === "object" && root.map && typeof root.map === "object")
    ? root.map
    : root;

  const items = Object.entries(mapObj).map(([k, v]) => ({ key: String(k), v: (v || {}) }));

  // grup listesi (order ile)
  const groupMap = new Map();
  for (const it of items) {
    const g = (it.v.group || "").trim();
    if (!g) continue;
    const order = (it.v.group_order_no ?? 9999);
    if (!groupMap.has(g)) groupMap.set(g, order);
    else groupMap.set(g, Math.min(groupMap.get(g), order));
  }

  const groups = Array.from(groupMap.entries())
    .sort((a, b) => (a[1] - b[1]) || a[0].localeCompare(b[0], "tr"));

  const active = (window.indFilterState?.group || "all");

  const badges = [];
  badges.push(`
    <div class="ind-badge ${active === "all" ? "active" : ""}" data-g="all">
      TÃœMÃœ
    </div>
  `);

  for (const [g] of groups) {
    badges.push(`
      <div class="ind-badge ${active === g ? "active" : ""}" data-g="${g}">
        ${g}
      </div>
    `);
  }

  area.innerHTML = badges.join("");

  area.querySelectorAll(".ind-badge").forEach((btn) => {
    btn.onclick = () => {
      const g = btn.getAttribute("data-g") || "all";
      window.indFilterState.group = g;

      // tabloyu yeniden Ã§iz
      if (typeof window.renderIndicators === "function") window.renderIndicators();

      // active class refresh
      window.indUpdateBadge();
    };
  });
};




window.indToggleGroupPopup = function(e) {
    if(e) e.stopPropagation();
    const pop = document.getElementById("indGroupPopup");
    if(pop) {
        const isVisible = pop.style.display === "block";
        pop.style.display = isVisible ? "none" : "block";
    }
};

window.indSelectGroup = function(g) {
    window.indFilterState.group = g;
    document.getElementById("indGroupPopup").style.display = "none";
    indUpdateBadge();
    if (typeof window.renderIndicators === "function") window.renderIndicators();
};

// DÄ±ÅŸarÄ± tÄ±klama kapatmasÄ±
document.addEventListener("click", () => {
    const pop = document.getElementById("indGroupPopup");
    if(pop) pop.style.display = "none";
});

// (Eski window.indicatorsData satÄ±rlarÄ±nÄ± sildik Ã§Ã¼nkÃ¼ artÄ±k yukarÄ±dan geliyor)

window.renderIndicators = function() {
    indUpdateBadge();
    const tbody = document.getElementById("indicators-tbody");
    if (!tbody || !window.__INDICATORS_MAP || !window.__INDICATORS_SUMMARY) return;

const map = window.__INDICATORS_MAP;

// âœ… summary artÄ±k { asOf, items }
const summaryObj = window.__INDICATORS_SUMMARY || { asOf: null, items: [] };
const summaryArr = Array.isArray(summaryObj.items) ? summaryObj.items : [];

// âœ… "Son gÃ¼ncelleme" yaz
const asOfEl = document.getElementById("indAsOf");
if (asOfEl) asOfEl.textContent = `Son gÃ¼ncelleme: ${summaryObj.asOf || "-"}`;


    

    // --- 1. MADDE: DINAMIK TARIH FORMATLAMA ---
    const formatDate = (dateStr, format) => {
  if (dateStr === null || dateStr === undefined) return "-";
  const s = String(dateStr).trim();
  if (!s || s === "-" || s.toLowerCase() === "null") return "-";

  // âœ… Senin yeni standardÄ±n: DD/MM/YYYY
  // (cd/pd artÄ±k bÃ¶yle geliyor dedin)
  // âœ… Standard: dd-mm-yyyy (summary.v1.json)
// AyrÄ±ca dd/mm/yyyy ve dd.mm.yyyy de destekle
let d = null;

// normalize: 28/01/2026 -> 28-01-2026, 28.01.2026 -> 28-01-2026
const norm = s.replaceAll("/", "-").replaceAll(".", "-");

// dd-mm-yyyy
let m = norm.match(/^(\d{2})-(\d{2})-(\d{4})$/);
if (m) {
  const dd = parseInt(m[1], 10);
  const mm = parseInt(m[2], 10);
  const yyyy = parseInt(m[3], 10);
  d = new Date(yyyy, mm - 1, dd);
} else {
  // fallback (ISO gibi)
  const tryD = new Date(s);
  if (!isNaN(tryD.getTime())) d = tryD;
}


  if (!d || isNaN(d.getTime())) return s;

  const dd = String(d.getDate()).padStart(2, "0");
  const mm2 = String(d.getMonth() + 1).padStart(2, "0");
  const yyyy = d.getFullYear();

  // MMM iÃ§in: tr kÄ±sa ay ismi (Oca, Åžub, Mar...) - sondaki noktayÄ± kÄ±rp
  const MMM = new Intl.DateTimeFormat("tr-TR", { month: "short" })
    .format(d)
    .replace(".", "");

  const f = String(format || "dd/mm/yyyy").trim().toLowerCase();

  // âœ… indicatorsmap.json'dan gelen date_format destekleri
  if (f === "mmm-yyyy") return `${MMM}-${yyyy}`;
  if (f === "mm-yyyy")  return `${mm2}-${yyyy}`;
  if (f === "yyyy")     return `${yyyy}`;

  if (f === "dd-mm-yyyy") return `${dd}-${mm2}-${yyyy}`;
  if (f === "dd.mm.yyyy") return `${dd}.${mm2}.${yyyy}`;

  // default: senin standart formatÄ±n
  return `${dd}/${mm2}/${yyyy}`;
};

    const formatInd = (val, info) => {
        if (val === null || val === undefined || isNaN(val)) return "-";
        let n = parseFloat(val);
        if (info.value_type === "percentage") {
            return "%" + (n * 100).toLocaleString("tr-TR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
        const digits = info.is4d ? 4 : 2;
        return n.toLocaleString("tr-TR", { minimumFractionDigits: digits, maximumFractionDigits: digits }) + (info.unit ? " " + info.unit : "");
    };

    const getDiff = (v1, v2, info) => {
        if (v1 == null || v2 == null || v2 === 0 || isNaN(v1) || isNaN(v2)) return { txt: "-", cls: "" };
        const diff = v1 - v2;
        const pct = (diff / Math.abs(v2)) * 100;
        const isPos = diff > 0.00000001;
        const isNeg = diff < -0.00000001;
        const icon = isPos ? '<i class="fa-solid fa-caret-up"></i>' : (isNeg ? '<i class="fa-solid fa-caret-down"></i>' : '');
        const color = isPos ? 'var(--finapsis-neon)' : (isNeg ? 'var(--finapsis-red)' : '#aaa');
        
        return { 
            txt: `<div style="color:${color}; font-weight:700;">${icon} %${Math.abs(pct).toFixed(2)}</div>
                  <div style="font-size:10px; opacity:0.7;">${isPos ? '+' : ''}${formatInd(diff, info)}</div>`,
            cls: isPos ? "pos" : (isNeg ? "neg" : "")
        };
    };

    const getS = (id) => (summaryArr.find(x => x.i === id)?.v) || {};

// last kalktÄ±: â€œanlÄ±k deÄŸerâ€ zaten summary.cv / summary.cd
const getL = (id) => {
  const s = getS(id);
  return { value: s.cv, date: s.cd };
};

const usd_l = parseFloat(getL("usdtry").value);
const usd_s = getS("usdtry");

const eur_l = parseFloat(getL("eurusd").value);
const eur_s = getS("eurusd");

const gbp_l = parseFloat(getL("gbpusd").value);
const gbp_s = getS("gbpusd");

    // TÃ¼m Ã¶ÄŸeleri topla ve filtrele
    let allItems = [];
    Object.keys(map).forEach(key => {
        const info = map[key];
        // GRUP FÄ°LTRESÄ°
        if (window.indFilterState.group !== "all" && info.group !== window.indFilterState.group) return;

        const s = getS(key);

// Tek kaynak: summary
let cv = s.cv;
let cd = s.cd;

        let pv = s.pv;
        let pd = s.pd;
        let ytdv = s.ytdv;
        let tm12v = s.tm12v;

        if (key === "eurtry") {
            if (usd_l && eur_l) { cv = usd_l * eur_l; cd = getL("usdtry").date; }
            if (usd_s.pv && eur_s.pv) { pv = usd_s.pv * eur_s.pv; pd = usd_s.pd; }
            if (usd_s.ytdv && eur_s.ytdv) ytdv = usd_s.ytdv * eur_s.ytdv;
            if (usd_s.tm12v && eur_s.tm12v) tm12v = usd_s.tm12v * eur_s.tm12v;
        }
        if (key === "gbptry") {
            if (usd_l && gbp_l) { cv = usd_l * gbp_l; cd = getL("usdtry").date; }
            if (usd_s.pv && gbp_s.pv) { pv = usd_s.pv * gbp_s.pv; pd = usd_s.pd; }
            if (usd_s.ytdv && gbp_s.ytdv) ytdv = usd_s.ytdv * gbp_s.ytdv;
            if (usd_s.tm12v && gbp_s.tm12v) tm12v = usd_s.tm12v * gbp_s.tm12v;
        }

        allItems.push({ id: key, ...info, cv, cd, pv, pd, ytdv, tm12v });
    });

    // Ã–nce Grup SÄ±rasÄ±na (group_order_no), sonra Ã¶ÄŸe sÄ±rasÄ±na (order_no) gÃ¶re diz
    allItems.sort((a, b) => {
        if (a.group_order_no !== b.group_order_no) return a.group_order_no - b.group_order_no;
        return (a.order_no || 0) - (b.order_no || 0);
    });

   tbody.innerHTML = allItems.map(item => {
        const d1 = getDiff(item.cv, item.pv, item);
        const dYtd = getDiff(item.cv, item.ytdv, item);
        const dY12 = getDiff(item.cv, item.tm12v, item);
        
        const priceColor = d1.cls === "pos" ? "var(--finapsis-neon)" : (d1.cls === "neg" ? "var(--finapsis-red)" : "#fff");
        const iconBg = d1.cls === 'pos' ? 'rgba(194, 245, 14, 0.15)' : (d1.cls === 'neg' ? 'rgba(255, 77, 77, 0.15)' : 'rgba(255, 255, 255, 0.05)');

        // TÄ±klama olayÄ± (VarlÄ±k Detaya git) ve cursor:pointer eklendi
        return `
        <tr onclick="finOpenDetail('${item.id}')" style="cursor:pointer;">
            <td style="width: 250px;"> <div class="company-cell">
                    <div class="indicator-icon" style="background:${iconBg}; color:${priceColor};">
                        <div style="font-weight:900; font-size:11px;">${item.badge || ""}</div>
                    </div>
                    <div class="name-wrap">
                        <div class="company-name">${item.label}</div>
                    </div>
                </div>
            </td>
            <td style="font-weight:700; text-align:right;">
  <div style="color:${priceColor}; font-weight:600;">
    ${formatInd(item.cv, item)}
  </div>
  <div style="font-size:9px; color:#9CA3AF;">
    ${formatDate(item.cd, item.date_format)}
  </div>
</td>

            <td class="muted" style="font-size:14px; text-align:right;">
                <div style="color:#eee; font-weight:600;">${formatInd(item.pv, item)}</div>
                
                <div style="font-size:9px; opacity:0.5;">${formatDate(item.pd, item.date_format)}</div>
                
            </td>
            <td style="text-align:right;">${d1.txt}</td>
            <td style="text-align:right;">${dYtd.txt}</td>
            <td style="text-align:right;">${dY12.txt}</td>
        </tr>`;
    }).join("");
};
window.dgToggleIndGroup = function(gId) {
    const rows = document.querySelectorAll(`.${gId}`);
    const groupRow = rows[0].previousElementSibling;
    const isCollapsed = groupRow.classList.toggle("collapsed");
    rows.forEach(r => r.style.display = isCollapsed ? "none" : "table-row");
};// ============================================
// CALENDAR LIST FILTER LOGIC (FIXED)
// ============================================

// 1. EKSÄ°K OLAN YARDIMCI FONKSÄ°YONLAR (HATA BURADAYDI)
window.calCheckPastDate = function(dateStr) {
    if(!dateStr) return false;
    return new Date(dateStr) < new Date();
};

window.calGetImpactSVG = function(level) {
    let html = '<div style="display:flex; gap:1px;">';
    for(let i=1; i<=3; i++) {
        const activeColor = i <= level ? '#c2f50e' : '#333';
        html += `<svg width="14" height="14" viewBox="0 0 24 24" fill="${activeColor}"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>`;
    }
    return html + '</div>';
};

// 2. VERÄ° YÃœKLEYÄ°CÄ°
// ============================================
// CALENDAR LIST (R2)
// ============================================
window.__CAL_LIST_PROMISE = window.__CAL_LIST_PROMISE || null;

function __calPad2(n){ return String(n).padStart(2,'0'); }

// epoch seconds -> "30/01/2026 - 13:05 Cuma" (TR)
function __calDateFullTR(epochSec){
  try{
    const d = new Date(epochSec * 1000);
    const dd = __calPad2(d.getDate());
    const mm = __calPad2(d.getMonth()+1);
    const yyyy = d.getFullYear();
    const hh = __calPad2(d.getHours());
    const mi = __calPad2(d.getMinutes());
    const dow = ["Pazar","Pazartesi","SalÄ±","Ã‡arÅŸamba","PerÅŸembe","Cuma","Cumartesi"][d.getDay()];
    return `${dd}/${mm}/${yyyy} - ${hh}:${mi} ${dow}`;
  } catch(e){
    return "";
  }
}

function __calNormalizeFromR2(doc){
  // R2 format: { asOf, range:{from,to}, items:[{id,t,cc,imp,n,e,a,p,u}] }
  const arr = Array.isArray(doc?.items) ? doc.items : [];
  return arr.map(x => {
    const t = Number(x?.t || 0) || 0; // epoch seconds (IST->UTC Ã§evrilmiÅŸ olabilir ama UI sadece sÄ±ralama/filter iÃ§in kullanÄ±yor)
    const iso = x?.u ? String(x.u) : (t ? new Date(t*1000).toISOString() : "");
    return {
      id: String(x?.id || ""),
      country_code: String(x?.cc || "").toLowerCase(),
      impact: Number(x?.imp || 1) || 1,
      name: String(x?.n || ""),
      expected: String(x?.e || ""),
      actual: String(x?.a || ""),
      prev: String(x?.p || ""),
      timestamp: iso,                 // UI bunu Date(...) ile parse ediyor
      date_full: t ? __calDateFullTR(t) : ""  // UIâ€™da gÃ¶sterim iÃ§in
    };
  });
}

// 2. VERÄ° YÃœKLEYÄ°CÄ° (R2'dan Ã§ekilecek)
window.finEnsureCalendarList = async function(force = false){
  // zaten yÃ¼klendiyse Ã§Ä±k
  if (!force && window.__CALENDAR_LIST_LOADED === true && Array.isArray(window.calendarList)) return;

  try {
    // FIN_DATA_BASE zaten kodun baÅŸka yerlerinde var varsayÄ±yorum.
    const url = `${FIN_DATA_BASE}/calendar/latest.v1.json?ts=${Date.now()}`;

    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error(`calendar latest fetch failed: ${res.status}`);

    const payload = await res.json();

    // payload iki ÅŸekilde gelebilir:
    // 1) eski: [ {timestamp,country_code,impact,name,expected,actual,prev,...} ]
    // 2) yeni: { asOf, range, items:[ {id,t,cc,imp,n,e,a,p,u} ] }
    if (Array.isArray(payload)) {
      window.calendarList = payload;
    } else if (payload && Array.isArray(payload.items)) {
      window.calendarList = payload.items;
    } else {
      window.calendarList = [];
    }

    window.__CALENDAR_LIST_LOADED = true;

  } catch(e){
    console.error("Calendar load error:", e);
    window.calendarList = [];
    window.__CALENDAR_LIST_LOADED = true; // sonsuz deneme yapmasÄ±n diye
  }
};



// 3. STATE (VarsayÄ±lan: BUGÃœN)
window.calListState = {
    time: 'today',    // âœ… VarsayÄ±lan: BugÃ¼n
    regions: [],      
    minImpact: 1,     
    search: ''        
};

// 4. FÄ°LTRE FONKSÄ°YONLARI
window.calListSetTime = function(period, btn) {
    window.calListState.time = period;
    // UI GÃ¼ncelle
    const container = btn.parentElement;
    container.querySelectorAll('.cal-pill').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    renderCalendarList();
};

window.calListSetImpact = function(level, e) {
    if(e) e.stopPropagation();
    window.calListState.minImpact = level;
    const el = document.getElementById("calImpactFilter");
    if(el) el.setAttribute("data-level", level);
    renderCalendarList();
};

window.calListToggleFilter = function(type, val, btn) {
    if (type !== 'region') return;
    const arr = window.calListState.regions;
    const idx = arr.indexOf(val);
    if (idx > -1) arr.splice(idx, 1);
    else arr.push(val);
    btn.classList.toggle('active');
    renderCalendarList();
};

window.calListSearch = function(val) {
    window.calListState.search = String(val).toLowerCase().trim();
    renderCalendarList();
};

// 5. TARÄ°H HESAPLAMA
function calGetDateRange(period) {
    const now = new Date();
    // Saatleri sÄ±fÄ±rla
    const start = new Date(now); start.setHours(0,0,0,0);
    const end = new Date(now); end.setHours(23,59,59,999);

    if (period === 'today') return { start, end };
    
    if (period === 'tomorrow') {
        start.setDate(now.getDate() + 1);
        end.setDate(now.getDate() + 1);
        return { start, end };
    }
    
    if (period === 'yesterday') {
        start.setDate(now.getDate() - 1);
        end.setDate(now.getDate() - 1);
        return { start, end };
    }


    // BU HAFTA (Pazartesi - Pazar) âœ… ay geÃ§iÅŸi gÃ¼venli
if (period === 'this-week') {
    const day = now.getDay(); // 0(Pazar)..6(Cumartesi)
    const mondayOffset = (day === 0 ? -6 : 1 - day); // Pazartesiye kay
    start.setDate(now.getDate() + mondayOffset);

    // âœ… end'i start Ã¼zerinden Ã¼ret (ay geÃ§iÅŸi bug'Ä±nÄ± bitirir)
    const end2 = new Date(start);
    end2.setHours(23,59,59,999);
    end2.setDate(start.getDate() + 6);

    return { start, end: end2 };
}


    // YENÄ°: BU AY (AyÄ±n 1'i - Son gÃ¼nÃ¼)
    if (period === 'this-month') {
        start.setDate(1);
        end.setMonth(end.getMonth() + 1);
        end.setDate(0);
        return { start, end };
    }
    
    if (period === 'next-week') {
    const day = now.getDay();
    // sonraki haftanÄ±n Pazartesi'si:
    // Pazar(0) ise +1, diÄŸer gÃ¼nler iÃ§in + (8 - day)
    const diff = (day === 0 ? 1 : 8 - day);

    start.setDate(now.getDate() + diff);

    // âœ… end'i start Ã¼zerinden Ã¼ret (ay geÃ§iÅŸi gÃ¼venli)
    const end2 = new Date(start);
    end2.setHours(23,59,59,999);
    end2.setDate(start.getDate() + 6);

    return { start, end: end2 };
}


    if (period === 'prev-week') {
        const day = now.getDay();
        const diff = (day === 0 ? -6 : 1) - 7; 
        const lastWeek = new Date(now);
        lastWeek.setDate(now.getDate() - 7);
        const lwDay = lastWeek.getDay() || 7; 
        start.setTime(lastWeek.getTime());
        start.setDate(lastWeek.getDate() - lwDay + 1);
        end.setTime(start.getTime());
        end.setDate(start.getDate() + 6);
        return { start, end };
    }

    if (period === 'next-month') {
        start.setMonth(now.getMonth() + 1, 1); 
        end.setMonth(now.getMonth() + 2, 0);   
        return { start, end };
    }

    if (period === 'prev-month') {
        start.setMonth(now.getMonth() - 1, 1);
        end.setMonth(now.getMonth(), 0);
        return { start, end };
    }

    return null; // 'all'
}

// 6. RENDER
// 6. RENDER
window.renderCalendarList = async function() {
  await finEnsureCalendarList(); // âœ… artÄ±k async

  const tbody = document.getElementById("calendar-list-tbody");
  if(!tbody) return;

  let data = window.calendarList || [];
  const s = window.calListState;

  data = data.filter(item => {
    // âœ… eski/yeni ÅŸema uyumlu alanlar
    const tsStr = item.timestamp || item.u || (item.t ? new Date(item.t * 1000).toISOString() : null);
    const ts = tsStr ? new Date(tsStr) : new Date(0);

    const countryCode = (item.country_code || item.cc || "").toLowerCase();
    const impact = Number(item.impact ?? item.imp ?? 1);

    const name = (item.name || item.n || "");
    const txt = String(name).toLowerCase();

    // âœ… ARAMA: her zaman isim Ã¼zerinden Ã§alÄ±ÅŸsÄ±n
    if (s.search) {
        if (!txt.includes(s.search)) return false;
        // NOT: arama varken zaman filtresi uygulanmasÄ±n istiyorsan buraya dokunmayÄ±z;
        // istersen aÅŸaÄŸÄ±daki zaman filtresini "else" iÃ§ine alÄ±rÄ±z.
    }

    // ZAMAN FÄ°LTRESÄ° (arama yokken veya arama varken de Ã§alÄ±ÅŸsÄ±n istiyorsan bu haliyle kalsÄ±n)
    if (!s.search && s.time !== 'all') {
        const range = calGetDateRange(s.time);
        if (range && (ts < range.start || ts > range.end)) return false;
    }

    // BÃ–LGE
    if (s.regions.length > 0) {
        if (!s.regions.includes(countryCode)) return false;
    }

    // ETKÄ°
    if (impact < s.minImpact) return false;

    return true;
});


  // âœ… sort: eski/yeni ÅŸema
  data.sort((a,b) => {
    const at = a.timestamp ? new Date(a.timestamp).getTime() : (a.t ? a.t * 1000 : 0);
    const bt = b.timestamp ? new Date(b.timestamp).getTime() : (b.t ? b.t * 1000 : 0);
    return at - bt;
  });

  if(data.length === 0) {
    tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:30px; color:#666;">SeÃ§ilen kriterlere uygun etkinlik yok.</td></tr>`;
    return;
  }

  tbody.innerHTML = data.map(c => {
    // âœ… eski/yeni ÅŸema uyumu
    const tsStr =
      c.timestamp
        ? c.timestamp
        : (c.t ? new Date(c.t * 1000).toISOString() : null);

    const impact = Number(c.impact ?? c.imp ?? 1);
    const countryCode = (c.country_code || c.cc || "").toLowerCase();

    const name = (c.name || c.n || "");
    const id = c.id;     
    const expected = (c.expected || c.e || "");
    const actual = (c.actual || c.a || "");
    const prev = (c.prev || c.p || "");

    const isPast = calCheckPastDate(tsStr);
    const flagUrl = countryCode ? `https://flagcdn.com/w40/${countryCode}.png` : '';
    const impactSVG = calGetImpactSVG(impact);

    return `
      <tr>
        <td>
          <div class="company-cell">
            <div style="width:38px; height:38px; border-radius:8px; display:flex; align-items:center; justify-content:center; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); flex-shrink:0;">
              ${flagUrl ? `<img class="flag-img" src="${flagUrl}" alt="${countryCode}">` : `<span class="muted">â€”</span>`}
            </div>
            <div>
              <div class="data-name">${name}</div>
              <div class="date-sub ${isPast ? 'muted' : ''}">${tsStr ? new Date(tsStr).toLocaleString('tr-TR') : ''}</div>
            </div>
          </div>
        </td>
        <td>${impactSVG}</td>
        <td>${expected || '<span class="muted">â€”</span>'}</td>
        <td>${actual || '<span class="muted">â€”</span>'}</td>
        <td>${prev || '<span class="muted">â€”</span>'}</td>
        <td style="text-align:center;">
            <button
  class="notify-btn"
  ${isPast ? "disabled title='Etkinlik geÃ§ti'" : ""}
  onclick="${isPast ? "return false;" : `calOpenListModal('${String(c.id || "").replace(/'/g, "\\'")}')`}"
>
  <i class="fa-regular fa-bell"></i>
</button>
            
        </td>
      </tr>
    `;
  }).join("");
};

// ==========================================
    // âœ… KESÄ°N Ã‡Ã–ZÃœM: GLOBAL TOGGLE FONKSÄ°YONLARI
    // ==========================================

    // 1. KÄ±yaslama Modu (SektÃ¶r <-> Genel)
    window.scToggleCompMode = function() {
        // Mevcut mod neyse tersine Ã§evir
        const current = window.comparisonMode || 'sector'; 
        const newMode = (current === 'sector') ? 'global' : 'sector';
        
        // DeÄŸiÅŸkeni gÃ¼ncelle
        window.comparisonMode = newMode;
        
        // Varsa eski fonksiyonu Ã§aÄŸÄ±r, yoksa manuel gÃ¼ncelle
        if (typeof setComparisonMode === 'function') {
            setComparisonMode(newMode);
        } else {
            // Yedek plan: Fonksiyon yoksa bile badge'i gÃ¼ncelle
            try { scUpdateFilterBadges(); } catch(e){}
            try { renderScreenerResults(); } catch(e){}
        }
    };

    // 2. Hesaplama Modu (Medyan <-> Ortalama)
    window.scToggleCalcMethod = function() {
        const current = window.calculationMethod || 'median';
        const newMethod = (current === 'median') ? 'mean' : 'median';
        
        window.calculationMethod = newMethod;
        
        if (typeof setCalcMethod === 'function') {
            setCalcMethod(newMethod);
        } else {
            try { scUpdateFilterBadges(); } catch(e){}
            try { renderScreenerResults(); } catch(e){}
        }
    };

    // 3. SektÃ¶r Popup AÃ§/Kapa (Ã‡akÄ±ÅŸma KorumalÄ±)
    window.scToggleSectorPopup = function(e) {
        if(e) e.stopPropagation();

        // DiÄŸer popuplarÄ± kapat (Market popup vb.)
        const marketPop = document.getElementById("scMarketPopup");
        if(marketPop) marketPop.style.display = "none";

        // Bizim hedef popup'Ä± bul (Dinamik oluÅŸturulanÄ±)
        // scUpdateFilterBadges fonksiyonu Ã§alÄ±ÅŸtÄ±ÄŸÄ± iÃ§in bu element DOM'da olmalÄ±.
        const pop = document.getElementById("scSectorPopup");
        
        if(!pop) {
            console.error("Popup bulunamadÄ±! scUpdateFilterBadges fonksiyonu Ã§alÄ±ÅŸmamÄ±ÅŸ olabilir.");
            return;
        }

        // Listeyi doldur (EÄŸer boÅŸsa)
        if(typeof scBuildSectorList === 'function') scBuildSectorList();

        // Input'u temizle
        const inp = document.getElementById("scSectorSearchInput");
        if(inp) inp.value = "";

        // GÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼ deÄŸiÅŸtir
        const isVisible = (pop.style.display === "block");
        pop.style.display = isVisible ? "none" : "block";
    };
    
    // 4. SektÃ¶r SeÃ§imi (Global)
    window.scSelectSector = function(sec){
        window.scSectorSelection = sec;
        
        // Popup'Ä± kapat
        const pop = document.getElementById("scSectorPopup");
        if(pop) pop.style.display = "none";
        
        // Badge'leri ve tabloyu gÃ¼ncelle
        try { scUpdateFilterBadges(); } catch(e){}
        try { renderScreenerResults(); } catch(e){}
    };

    // =========================================================
    // âœ… SCREENER SEKTÃ–R FÄ°LTRELEME MOTORU (TAMÄ°R EDÄ°LDÄ°)
    // =========================================================

    // 1. Liste OluÅŸturucu (Hayaletlerden ArÄ±ndÄ±rÄ±lmÄ±ÅŸ)
    window.scBuildSectorList = function(){
        const list = document.getElementById("scSectorList");
        if(!list) return; // Liste yoksa sessizce Ã§Ä±k (Hata verme)

        // Aktif gruptaki sektÃ¶rleri Ã§ek
        const sectors = [...new Set(window.companies
            .filter(c => c.group === activeGroup)
            .map(c => c.sector))]
            .filter(Boolean)
            .sort((a,b) => a.localeCompare(b,'tr'));

        // HTML oluÅŸtur
        let html = `<div class="sc-sector-item ${window.scSectorSelection==="" ? "active":""}" onclick="scSelectSector('')">TÃ¼m SektÃ¶rler</div>`;
        html += sectors.map(s => {
            const isActive = (s === window.scSectorSelection) ? "active" : "";
            const safeS = s.replace(/"/g, '&quot;');
            return `<div class="sc-sector-item ${isActive}" onclick="scSelectSector('${safeS}')">${s}</div>`;
        }).join("");

        list.innerHTML = html;
        // Not: Eski buton (scSectorBtn) referansÄ± buradan kaldÄ±rÄ±ldÄ±.
    };

    // 2. SeÃ§im YapÄ±cÄ± (Optimize Edildi)
    window.scSelectSector = function(sec){
        window.scSectorSelection = sec;
        
        // Ã–nce tabloyu gÃ¼ncelle
        try { renderScreenerResults(); } catch(e){}
        
        // Sonra arayÃ¼zÃ¼ (Badge'leri) gÃ¼ncelle
        // Bu iÅŸlem popup'Ä± zaten yeniden oluÅŸturup kapatacaÄŸÄ± iÃ§in 
        // manuel kapatmaya veya listeyi yeniden kurmaya gerek yok.
        try { scUpdateFilterBadges(); } catch(e){}
    };

    // 3. Temizleyici (Olay YakalayÄ±cÄ± Ä°yileÅŸtirildi)
    window.scClearSectorFilter = function(e){
        // TÄ±klama olayÄ±nÄ±n popup'Ä± kapatmasÄ±nÄ± veya baÅŸka tetiklemeleri engelle
        if(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        // Input kutusu varsa temizle
        const inp = document.getElementById("scSectorSearchInput");
        if(inp) inp.value = "";

        // SeÃ§imi sÄ±fÄ±rla
        scSelectSector("");
    };
    
    // 4. Popup Ä°Ã§i Arama (Filtreleme)
    window.scFilterSectorListInPopup = function(term){
        const t = String(term || "").toLocaleLowerCase('tr');
        const items = document.querySelectorAll("#scSectorList .sc-sector-item");
        
        items.forEach(el => {
            const txt = el.textContent.toLocaleLowerCase('tr');
            // "TÃ¼m SektÃ¶rler" her zaman kalsÄ±n
            if(el.textContent === "TÃ¼m SektÃ¶rler" || txt.includes(t)) {
                el.style.display = "block";
            } else {
                el.style.display = "none";
            }
        });
    };
    // ==========================================
    // âœ… COMPANIES LIST MODERN FILTRELEME (SEKTÃ–R & ALT SEKTÃ–R)
    // ==========================================

    // Filtre State
    window.clFilters = {
        sector: "",
        industry: "" // Alt SektÃ¶r
    };

    // 1. Badge'leri Ã‡iz (Render)
  
    window.clUpdateFilterBadges = function() {
        const area = document.getElementById("clFilterBadges");
        if(!area) return;

        const secName = clFilters.sector || "TÃœMÃœ";
        const indName = clFilters.industry || "TÃœMÃœ";
        const isSecSelected = !!clFilters.sector;
        
        // Aktif Borsa Etiketi
        let marketLabel = "BIST";
        if(activeGroup === 'nyse') marketLabel = "NYSE";
        if(activeGroup === 'nasdaq') marketLabel = "NASDAQ";

        let html = "";

        // --- 1. BORSA (MARKET) BADGE ---
        html += `
            <div style="position:relative;">
                <div class="cl-badge market-badge" onclick="clTogglePopup('market', event)">
                    <i class="fa-solid fa-globe"></i>
                    BORSA: ${marketLabel}
                    <i class="fa-solid fa-chevron-down" style="font-size:10px; opacity:0.5;"></i>
                </div>
                <div id="clPopup_market" class="cl-popup-menu" onclick="event.stopPropagation()">
                    <div class="cl-popup-list">
                        <div class="cl-popup-item ${activeGroup==='bist'?'selected':''}" onclick="setGroup('bist')">BIST (Ä°stanbul)</div>
                        <div class="cl-popup-item ${activeGroup==='nyse'?'selected':''}" onclick="setGroup('nyse')">NYSE (New York)</div>
                        <div class="cl-popup-item ${activeGroup==='nasdaq'?'selected':''}" onclick="setGroup('nasdaq')">NASDAQ</div>
                    </div>
                </div>
            </div>
        `;

        // --- 2. SEKTÃ–R BADGE ---
        html += `
            <div style="position:relative;">
                <div class="cl-badge ${isSecSelected ? 'active' : ''}" onclick="clTogglePopup('sector', event)">
                    <i class="fa-solid fa-layer-group"></i>
                    SEKTÃ–R: ${secName}
                    ${isSecSelected ? '<i class="fa-solid fa-xmark" onclick="clClearFilter(\'sector\', event)" style="opacity:0.6;"></i>' : '<i class="fa-solid fa-chevron-down" style="font-size:10px; opacity:0.5;"></i>'}
                </div>
                <div id="clPopup_sector" class="cl-popup-menu" onclick="event.stopPropagation()">
                    <div class="cl-popup-search">
                        <input type="text" class="cl-popup-input" placeholder="SektÃ¶r ara..." oninput="clFilterPopupList('sector', this.value)">
                    </div>
                    <div id="clList_sector" class="cl-popup-list"></div>
                </div>
            </div>
        `;

        // --- 3. ALT SEKTÃ–R BADGE ---
        html += `
            <div style="position:relative;">
                <div class="cl-badge ${!isSecSelected ? 'disabled' : (clFilters.industry ? 'active' : '')}" 
                     onclick="${isSecSelected ? "clTogglePopup('industry', event)" : ''}">
                    <i class="fa-solid fa-industry"></i>
                    ALT SEKTÃ–R: ${indName}
                    ${clFilters.industry ? '<i class="fa-solid fa-xmark" onclick="clClearFilter(\'industry\', event)" style="opacity:0.6;"></i>' : '<i class="fa-solid fa-chevron-down" style="font-size:10px; opacity:0.5;"></i>'}
                </div>
                <div id="clPopup_industry" class="cl-popup-menu" onclick="event.stopPropagation()">
                    <div class="cl-popup-search">
                        <input type="text" class="cl-popup-input" placeholder="Alt sektÃ¶r ara..." oninput="clFilterPopupList('industry', this.value)">
                    </div>
                    <div id="clList_industry" class="cl-popup-list"></div>
                </div>
            </div>
        `;

        area.innerHTML = html;
    };
    
    
    // 2. Popup AÃ§/Kapa (Market DesteÄŸi Eklendi)
    window.clTogglePopup = function(type, e) {
        if(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        const targetPopup = document.getElementById(`clPopup_${type}`);
        if(!targetPopup) return;

        // AÃ§Ä±k mÄ± kontrolÃ¼
        const isAlreadyOpen = (targetPopup.style.display === 'block');

        // Ã–nce hepsini kapat
        document.querySelectorAll('.cl-popup-menu').forEach(el => el.style.display = 'none');

        // EÄŸer zaten aÃ§Ä±ktÄ±ysa kapalÄ± kalsÄ±n, deÄŸilse aÃ§alÄ±m
        if (!isAlreadyOpen) {
            
            // --- MARKET Ä°Ã‡Ä°N Ã–ZEL DURUM (Liste oluÅŸturmaya gerek yok) ---
            if (type === 'market') {
                targetPopup.style.display = 'block';
                return;
            }

            // --- SEKTÃ–R / ALT SEKTÃ–R Ä°Ã‡Ä°N LÄ°STE OLUÅžTUR ---
            const listEl = document.getElementById(`clList_${type}`);
            let items = [];
            
            if (type === 'sector') {
                items = [...new Set(window.companies
                    .filter(c => c.group === activeGroup)
                    .map(c => c.sector))].filter(Boolean).sort((a,b) => a.localeCompare(b,'tr'));
            } 
            else if (type === 'industry') {
                if(!clFilters.sector) return; 
                items = [...new Set(window.companies
                    .filter(c => c.group === activeGroup && c.sector === clFilters.sector)
                    .map(c => c.industry))].filter(Boolean).sort((a,b) => a.localeCompare(b,'tr'));
            }

            // HTML Bas
            let listHtml = `<div class="cl-popup-item" onclick="clSelectFilter('${type}', '')">TÃœMÃœ</div>`;
            listHtml += items.map(i => {
                const isSel = (clFilters[type] === i);
                const safeVal = i.replace(/"/g, '&quot;');
                return `<div class="cl-popup-item ${isSel?'selected':''}" onclick="clSelectFilter('${type}', '${safeVal}')">${i}</div>`;
            }).join('');

            if(listEl) listEl.innerHTML = listHtml;

            // Arama kutusunu temizle
            const inp = targetPopup.querySelector('input');
            if(inp) inp.value = "";

            // GÃ¶ster
            targetPopup.style.display = "block";
        }
    };    // 3. SeÃ§im Yap
    window.clSelectFilter = function(type, val) {
        clFilters[type] = val;

        // SektÃ¶r deÄŸiÅŸirse, alt sektÃ¶rÃ¼ sÄ±fÄ±rla
        if (type === 'sector') {
            clFilters.industry = ""; 
        }

        // 1. Badge'leri gÃ¼ncelle
        clUpdateFilterBadges();
        
        // 2. Tabloyu Filtrele (renderCompanyList fonksiyonuna bu mantÄ±ÄŸÄ± ekleyeceÄŸiz)
        renderCompanyList(); 
        
        // Popup kapat
        document.querySelectorAll('.cl-popup-menu').forEach(el => el.style.display = 'none');
    };

    // 4. Temizle (X butonu)
    window.clClearFilter = function(type, e) {
        if(e) e.stopPropagation();
        clSelectFilter(type, "");
    };

    // 5. Popup Ä°Ã§i Arama
    window.clFilterPopupList = function(type, term) {
        const t = term.toLocaleLowerCase('tr');
        const items = document.querySelectorAll(`#clList_${type} .cl-popup-item`);
        items.forEach(el => {
            const txt = el.textContent.toLocaleLowerCase('tr');
            el.style.display = (txt.includes(t) || el.textContent === "TÃœMÃœ") ? "block" : "none";
        });
    };

    // DÄ±ÅŸarÄ± tÄ±klayÄ±nca kapat
    document.addEventListener('click', () => {
        document.querySelectorAll('.cl-popup-menu').forEach(el => el.style.display = 'none');
    });
</script>

<div id="fpRowMenuOverlay" onclick="fpCloseRowMenu()">
  <div id="fpRowMenu" onclick="event.stopPropagation()">
    <div class="fpMenuHead">
      <div class="fpMenuTitle">Ä°ÅŸlemler â€¢ <span id="fpMenuTicker" class="fpMenuTicker">-</span></div>
      <div class="fpMenuClose" onclick="fpCloseRowMenu()"><i class="fa-solid fa-xmark"></i></div>
    </div>

    <div class="fpMenuItem" id="fpMenuDetail">
      <div class="fpMenuIcon"><i class="fa-solid fa-arrow-up-right-from-square"></i></div>
      Detaya Git
    </div>

    <div class="fpMenuItem" id="fpMenuBuy">
      <div class="fpMenuIcon"><i class="fa-solid fa-cart-shopping"></i></div>
      Al
    </div>

    <div class="fpMenuItem" id="fpMenuSell">
      <div class="fpMenuIcon"><i class="fa-solid fa-right-left"></i></div>
      Sat
    </div>

    <div class="fpMenuItem" id="fpMenuWatch">
      <div class="fpMenuIcon"><i class="fa-solid fa-eye"></i></div>
      Ä°zle
    </div>
  </div>
</div>
</body>

</html>
